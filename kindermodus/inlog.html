<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kindermodus inloggen</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png">
  <style>
    body{background:#f8f6e1;color:#6f4e1a;font-family:Arial,sans-serif;margin:0}
    .topbar{background:#6f4e1a;color:#fff;padding:14px 28px;font-size:1.13em;font-weight:bold;text-align:center;letter-spacing:.04em}
    main{max-width:410px;margin:60px auto 0;background:#fffef9;padding:33px 28px;border-radius:20px;box-shadow:0 6px 32px #d7cbb122;display:flex;flex-direction:column;align-items:center}
    h1{margin-bottom:24px;color:#7bb235;font-size:1.9em}
    label{display:block;margin-top:22px;font-weight:bold;font-size:1.05em}
    select,input[type=password]{width:100%;padding:10px 13px;margin-top:7px;border:1.2px solid #bba868;border-radius:7px;background:#fcfaf5;font-size:1.06em}
    button{margin-top:28px;width:100%;padding:13px 0;background:#7bb235;color:#fff;font-weight:bold;font-size:1.12em;border:none;border-radius:8px;cursor:pointer;transition:background .15s;box-shadow:0 1.5px 9px #b3db8d45}
    button:hover{background:#5e8f1c}
    #melding{margin-top:18px;color:#e24343;font-weight:bold;min-height:30px;text-align:center}
    .kinder-avatar{margin:20px auto 5px;display:block;width:70px;height:70px;border-radius:50%;border:2.5px solid #dab97a;background:#fff8eb;box-shadow:0 1.5px 7px #dab97a22;object-fit:cover}
    @media (max-width:480px){main{max-width:98vw;padding:15px 4vw}}
  </style>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="topbar">Kindermodus â€“ Inloggen</div>

  <main>
    <h1>Kindermodus</h1>

    <form id="kinderLoginForm" autocomplete="off">
      <label for="kindSelect">Kies je naam:</label>
      <select id="kindSelect" required>
        <option value="">-- Kies je naam --</option>
      </select>

      <img id="kindAvatar" class="kinder-avatar" src="" style="display:none" alt="Avatar kind">

      <label for="kinderWachtwoord">Wachtwoord:</label>
      <input type="password" id="kinderWachtwoord" placeholder="Je geheime code" required autocomplete="off">

      <button type="submit">Inloggen</button>
      <div id="melding"></div>
    </form>
  </main>

  <script>
    // Firebase init
    const firebaseConfig = {
      apiKey:"AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
      authDomain:"orthodoxeweg.firebaseapp.com",
      projectId:"orthodoxeweg",
      storageBucket:"orthodoxeweg.appspot.com",
      messagingSenderId:"408582263618",
      appId:"1:408582263618:web:0a20f4bf0704989d3ceedb"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Deze 2 MOETEN al in localStorage staan van de ouderlogin:
    const parochieId = localStorage.getItem("ingelogdeParochie");
    const ouderLogin = localStorage.getItem("loginKeuze");

    const kindSelect = document.getElementById('kindSelect');
    const kindAvatar = document.getElementById('kindAvatar');
    const melding    = document.getElementById('melding');
    let kinderen = [];

    async function laadKinderen(){
      if (!parochieId || !ouderLogin){
        melding.textContent = "Je moet eerst als ouder inloggen.";
        kindSelect.disabled = true;
        return;
      }
      try{
        const snap = await db.collection("parochies").doc(parochieId)
          .collection("leden").doc(ouderLogin)
          .collection("kinderen").get();

        kinderen = [];
        kindSelect.innerHTML = '<option value="">-- Kies je naam --</option>';

        snap.forEach(doc=>{
          const kind = { id: doc.id, ...doc.data() };
          kinderen.push(kind);
          const opt = document.createElement('option');
          opt.value = kind.id;
          opt.textContent = kind.voornaam ? (kind.voornaam + (kind.achternaam ? " " + kind.achternaam : "")) : kind.id;
          kindSelect.appendChild(opt);
        });

        if (kinderen.length === 0){
          melding.textContent = "Er zijn geen kinderen gekoppeld aan je profiel.";
          kindSelect.disabled = true;
        }
      }catch(e){
        console.error(e);
        melding.textContent = "Fout bij laden kinderen.";
        kindSelect.disabled = true;
      }
    }
    window.addEventListener('DOMContentLoaded', laadKinderen);

    kindSelect.onchange = function(){
      const k = kinderen.find(x => x.id === kindSelect.value);
      if (k && k.avatarURL){ kindAvatar.src = k.avatarURL; kindAvatar.style.display = "block"; }
      else { kindAvatar.style.display = "none"; }
      melding.textContent = "";
    };

    document.getElementById('kinderLoginForm').onsubmit = async function(e){
      e.preventDefault();
      melding.textContent = "";

      const kindId     = kindSelect.value;
      const wachtwoord = document.getElementById('kinderWachtwoord').value.trim();

      if (!kindId){ melding.textContent = "Kies je naam."; return; }

      const kind = kinderen.find(k => k.id === kindId);
      if (!kind){ melding.textContent = "Onbekend kind."; return; }

      if (!wachtwoord || wachtwoord !== (kind.wachtwoord || "")){
        melding.textContent = "Fout wachtwoord.";
        return;
      }

      // âœ… Zet ALLE sleutels die de header/layout verwacht
      localStorage.setItem("kindIngelogd", "ja");       // jouw sleutel
      localStorage.setItem("kind_ingelogd", "true");    // compat
      localStorage.setItem("ingelogdKindId", kind.id);
      localStorage.setItem("ingelogdKindVoornaam", kind.voornaam || "Kind");
      localStorage.setItem("kindAvatarURL", kind.avatarURL || "");
      localStorage.setItem("kindPunten", String(kind.punten || "0")); // cache

      // Oudersleutels blijven staan (parochieId, ouderLogin) â€” die zetten we NIET opnieuw

      // ðŸ§­ Door naar startpagina
      window.location.href = "https://kathy-torfs.github.io/Orthodoxeweg/kindermodus/startpagina.html";
    };
  </script>
</body>
</html>
