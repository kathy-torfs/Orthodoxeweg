<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kinderdagboek – Dag</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png">
  <style>
    :root{--ink:#3b2a12;--bg:#fffaf0;--card:#fffef7;--line:#e9d8b6;--accent:#7a5f35;--btn:#b08c58}
    body{background:#fff7e6;margin:0;font-family:Arial,Helvetica,sans-serif;color:var(--ink)}
    .wrap{max-width:880px;margin:28px auto;padding:0 14px}
    h1{margin:0 0 14px 0;font-size:1.6rem;color:var(--accent)}
    .path{font-size:.85rem;color:#8b6f3f;background:#fffdf4;border:1px solid var(--line);padding:8px 10px;border-radius:8px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px 16px;margin-top:14px}
    .btn{background:var(--btn);color:#fff;border:none;border-radius:10px;padding:8px 14px;cursor:pointer}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .q{margin:10px 0;padding:10px;border:1px solid var(--line);border-radius:10px}
    .opt{display:block;margin:6px 0}
    .msg{margin-top:10px;color:#8b6f3f}
    .err{color:#b9311e}
    textarea{width:100%;min-height:140px;border:1px solid var(--line);border-radius:10px;padding:10px;background:#fffdf5}
    .row{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:10px}
    .score{font-size:.95rem;color:#6a4f28}
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Kinderdagboek</h1>
    <div class="path" id="pathInfo"></div>

    <div class="card">
      <h3 id="titel">Vragen</h3>
      <div id="vragen"></div>
      <div class="row">
        <button class="btn" id="nakijkBtn">Nakijken en opslaan</button>
      </div>
      <div class="score" id="scoreMsg"></div>
    </div>

    <div class="card">
      <h3>Mijn reflectie (+20 punten éénmalig)</h3>
      <textarea id="reflectie" placeholder="Schrijf hier je gedachte of gebed…"></textarea>
      <div class="row">
        <button class="btn" id="saveReflectie">Reflectie bewaren</button>
      </div>
      <div class="msg" id="reflectieMsg"></div>
    </div>

    <div class="card">
      <div id="statusMsg" class="msg"></div>
    </div>
  </div>

<script>
/* ---------- Firebase ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
  authDomain: "orthodoxeweg.firebaseapp.com",
  projectId: "orthodoxeweg",
  storageBucket: "orthodoxeweg.appspot.com",
  messagingSenderId: "408582263618",
  appId: "1:408582263618:web:0a20f4bf0704989d3ceedb"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
function getParam(name, def=null){
  const u = new URL(window.location.href);
  return u.searchParams.get(name) || def;
}
function radioName(i){ return `q_${i}`; }
function makeRadio(name, value, labelText){
  const label = document.createElement('label');
  label.className = 'opt';
  const inp = document.createElement('input');
  inp.type = 'radio'; inp.name = name; inp.value = value;
  label.appendChild(inp);
  label.appendChild(document.createTextNode(' ' + labelText));
  return label;
}
function shuffle(arr){ // Fisher–Yates
  for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
  return arr;
}

/* ---------- Context uit sessionStorage (zoals bij jou) ---------- */
const parochieId = sessionStorage.getItem("dagboek_parochieId") || "hasselt-drie-hierarchen";
const ouderId    = sessionStorage.getItem("dagboek_userId") || "Kathy";
const kindId     = getParam("kid", "__4285");          // ?kid=__4285
const dagId      = getParam("id", "dag001");           // ?id=dag001

$("pathInfo").textContent =
  `/parochies/${parochieId}/leden/${ouderId}/kinderen/${kindId}/kinderdagboek/${dagId}`;

const kindRef   = db.collection("parochies").doc(parochieId)
                    .collection("leden").doc(ouderId)
                    .collection("kinderen").doc(kindId);
const dagRef    = kindRef.collection("kinderdagboek").doc(dagId);
const tplRef    = db.collection("VlaamsOrthodoxeKinderdagboek").doc(dagId);

let vragenData = [];   // [{vraag, opties[], correct}]
let puntenDelta = 0;

/* ---------- Laden: eerst kind-doc, daarna pas sjabloon ---------- */
(async function init(){
  try{
    // 1) Probeer bestaande dag van het kind
    const childSnap = await dagRef.get();
    if (childSnap.exists){
      renderFromDoc(childSnap.data(), /*alreadyExists=*/true);
      return;
    }

    // 2) Zo niet: pak sjabloon en kopieer
    const tplSnap = await tplRef.get();
    if (tplSnap.exists){
      const tpl = tplSnap.data();
      const payload = {
        titel: tpl.titel || "Dag",
        vragen: tpl.vragen || [],
        antwoorden: {},              // gekozen opties van dit kind
        puntenVerdient: false,       // reflectiepunten
        score: 0,                    // behaalde quizscore
        aangemaaktOp: firebase.firestore.FieldValue.serverTimestamp()
      };
      await dagRef.set(payload);
      renderFromDoc(payload, /*alreadyExists=*/false);
      $("statusMsg").textContent = "De vragen zijn uit het sjabloon geladen.";
    } else {
      $("statusMsg").classList.add("err");
      $("statusMsg").textContent = `Kon bron niet vinden: VlaamsOrthodoxeKinderdagboek/${dagId}. Je kunt deze dag pas gebruiken nadat het sjabloon is aangemaakt.`;
      disableUI(true);
    }
  }catch(e){
    $("statusMsg").classList.add("err");
    $("statusMsg").textContent = "Fout bij laden: " + e.message;
    console.error(e);
  }
})();

function disableUI(dis){
  $("nakijkBtn").disabled = dis;
  $("saveReflectie").disabled = dis;
}

/* ---------- Render ---------- */
function renderFromDoc(doc, alreadyExists){
  $("titel").textContent = doc.titel || "Vragen";
  vragenData = Array.isArray(doc.vragen) ? doc.vragen : [];
  const container = $("vragen");
  container.innerHTML = "";

  if (!vragenData.length){
    container.innerHTML = "<div class='msg'>Geen vragen gevonden voor deze dag.</div>";
    $("nakijkBtn").disabled = true;
  } else {
    $("nakijkBtn").disabled = false;
    vragenData.forEach((v,i)=>{
      const box = document.createElement("div");
      box.className = "q";
      const q = document.createElement("div");
      q.textContent = (i+1)+". "+v.vraag;
      box.appendChild(q);

      // opties (random volgorde)
      const opts = shuffle([...(v.opties||[])]);
      opts.forEach(opt=>{
        box.appendChild( makeRadio(radioName(i), opt, opt) );
      });
      container.appendChild(box);
    });
  }

  $("reflectie").value = doc.reflectie || "";
  $("scoreMsg").textContent = doc.score ? `Reeds behaald: ${doc.score} punten` : "";
  if (doc.puntenVerdient){
    $("reflectieMsg").textContent = "Je reflectiepunten (+20) zijn al toegekend.";
  } else {
    $("reflectieMsg").textContent = "";
  }
}

/* ---------- Nakijken + opslaan (10 punten per juist antwoord) ---------- */
$("nakijkBtn").addEventListener("click", async ()=>{
  if (!vragenData.length) return;
  let score = 0;
  const antwoorden = {};
  vragenData.forEach((v,i)=>{
    const sel = document.querySelector(`input[name="${radioName(i)}"]:checked`);
    const gekozen = sel ? sel.value : null;
    antwoorden[i] = gekozen;
    if (gekozen && String(gekozen) === String(v.correct)) score += 10;
  });

  try{
    await dagRef.set({antwoorden, score}, {merge:true});
    $("scoreMsg").textContent = `Behaald: ${score} punten`;
    $("statusMsg").textContent = "Antwoorden opgeslagen.";
  }catch(e){
    $("statusMsg").classList.add("err");
    $("statusMsg").textContent = "Kon antwoorden niet opslaan: " + e.message;
  }
});

/* ---------- Reflectie opslaan (+20 éénmalig) ---------- */
$("saveReflectie").addEventListener("click", async ()=>{
  const txt = $("reflectie").value.trim();
  if (!txt){ $("reflectieMsg").textContent = "Schrijf eerst iets kleins (1–2 zinnen)."; return; }

  try{
    const snap = await dagRef.get();
    const al = snap.exists && snap.data().puntenVerdient === true;
    const update = {reflectie: txt};
    if (!al){ update.puntenVerdient = true; }
    await dagRef.set(update, {merge:true});
    $("reflectieMsg").textContent = al ? "Reflectie bijgewerkt." : "Reflectie opgeslagen (+20 punten).";
  }catch(e){
    $("reflectieMsg").classList.add("err");
    $("reflectieMsg").textContent = "Kon reflectie niet opslaan: " + e.message;
  }
});
</script>
</body>
</html>
