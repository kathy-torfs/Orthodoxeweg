<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kinderdagboek – Dag</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
    body{font-family:system-ui,Arial,sans-serif;margin:0;padding:16px;background:#fffef8;color:#2b1e10}
    h1{margin:.2em 0 .4em}
    .wrap{max-width:920px;margin:0 auto}
    .card{background:#fff;border:1px solid #e9dfc7;border-radius:12px;padding:14px 16px;margin:12px 0}
    .tekst p{margin:.5em 0;line-height:1.6}
    .vraag{margin:.6em 0 1em}
    .opt{display:block;margin:.25em 0}
    .row{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:12px}
    button{background:#7a5f35;color:#fff;border:none;border-radius:8px;padding:9px 14px;cursor:pointer}
    button.secondary{background:#b09765}
    .hint{font-size:.92em;color:#7a6a4c}
    .badge{font-size:.9em;color:#7a6a4c}
    textarea{width:100%;min-height:110px;border:1px solid #e2d2a8;border-radius:8px;padding:10px;background:#fffdf4}
    .ok{color:#1f7a3a}
    .err{color:#b9311e}
  </style>
</head>
<body>
<div class="wrap">
  <h1 id="titel">Kinderdagboek</h1>
  <div class="badge" id="padBadge"></div>

  <div class="card tekst">
    <div id="tekst"></div>
  </div>

  <div class="card">
    <h3>Vragen</h3>
    <form id="quizForm"></form>
    <div class="row">
      <span class="hint" id="quizHint"></span>
      <button id="btnNakijken">Nakijken en opslaan</button>
    </div>
  </div>

  <div class="card">
    <h3>Mijn reflectie (+20 punten éénmalig)</h3>
    <textarea id="reflectie" placeholder="Schrijf hier je gedachte of gebed…"></textarea>
    <div class="row">
      <span class="hint" id="refHint"></span>
      <button class="secondary" id="btnSaveRef">Reflectie bewaren</button>
    </div>
  </div>

  <div class="card">
    <div id="status" class="hint"></div>
  </div>
</div>

<script>
  // ---------- Firebase init ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
    authDomain: "orthodoxeweg.firebaseapp.com",
    projectId: "orthodoxeweg",
    storageBucket: "orthodoxeweg.appspot.com",
    messagingSenderId: "408582263618",
    appId: "1:408582263618:web:0a20f4bf0704989d3ceedb"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ---------- Config via URL of localStorage ----------
  const params = new URLSearchParams(location.search);
  const PAROCHIE_ID = params.get("parochieId") || localStorage.getItem("parochieId") || "hasselt-drie-hierarchen";
  const OUDER_ID    = params.get("ouderId")    || localStorage.getItem("ouderId")    || "Kathy";
  const KIND_ID     = params.get("kindId")     || localStorage.getItem("kindId")     || "__4285";
  const DAY_ID      = params.get("dagId")      || localStorage.getItem("dagId")      || "dag001";
  localStorage.setItem("parochieId", PAROCHIE_ID);
  localStorage.setItem("ouderId", OUDER_ID);
  localStorage.setItem("kindId", KIND_ID);
  localStorage.setItem("dagId", DAY_ID);

  const BRON_COL = "VlaamsOrthodoxeKinderdagboek";

  // ---------- Firestore refs ----------
  function childRef(){
    return db.collection("parochies").doc(PAROCHIE_ID)
      .collection("leden").doc(OUDER_ID)
      .collection("kinderen").doc(KIND_ID);
  }
  function dayDocRef(dayId){
    return childRef().collection("kinderdagboek").doc(dayId);
  }

  // ---------- Seed dag voor kind (lui) ----------
  async function ensureDayForChild(dayId){
    const dest = dayDocRef(dayId);
    const snap = await dest.get();
    if (snap.exists) return snap.data();

    const src = await db.collection(BRON_COL).doc(dayId).get();
    if (!src.exists) throw new Error(`Bron ontbreekt: ${dayId}`);
    const d = src.data();

    const payload = {
      titel: d.titel,
      tekst: d.tekst,               // array van zinnen
      vragen: d.vragen,             // [{vraag,opties[],correct}]
      gegevenAntwoorden: [],        // indices 0..3
      score: 0,                     // 0..50
      reflectie: "",
      reflectiePuntenToegekend: false,
      aangemaaktOp: firebase.firestore.FieldValue.serverTimestamp(),
      laatsteUpdate: firebase.firestore.FieldValue.serverTimestamp()
    };
    await dest.set(payload);
    return payload;
  }

  // ---------- Render ----------
  const elTitel = document.getElementById("titel");
  const elTekst = document.getElementById("tekst");
  const elForm  = document.getElementById("quizForm");
  const elQuizHint = document.getElementById("quizHint");
  const elRef   = document.getElementById("reflectie");
  const elRefHint = document.getElementById("refHint");
  const elStatus = document.getElementById("status");
  const elPad = document.getElementById("padBadge");

  elPad.textContent = `/parochies/${PAROCHIE_ID}/leden/${OUDER_ID}/kinderen/${KIND_ID}/kinderdagboek/${DAY_ID}`;

  function esc(s=""){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}

  function renderDay(d){
    elTitel.textContent = d.titel || "Kinderdagboek";
    elTekst.innerHTML = (Array.isArray(d.tekst)? d.tekst:[])
      .map(line=>`<p>${esc(line)}</p>`).join("");

    const vragen = Array.isArray(d.vragen) ? d.vragen : [];
    elForm.innerHTML = "";
    vragen.forEach((q, qi) => {
      const f = document.createElement("fieldset"); f.className = "vraag";
      const lg = document.createElement("legend"); lg.textContent = (qi+1)+". "+q.vraag; f.appendChild(lg);
      (q.opties||[]).forEach((opt, oi) => {
        const id = `q${qi}_o${oi}`;
        const label = document.createElement("label"); label.className = "opt"; label.setAttribute("for", id);
        const input = document.createElement("input");
        input.type = "radio"; input.name = `q${qi}`; input.id = id; input.value = oi;
        label.appendChild(input);
        label.append(" "+opt);
        f.appendChild(label);
      });
      elForm.appendChild(f);
    });

    // bestaand ingevuld (optioneel)
    (d.gegevenAntwoorden||[]).forEach((idx, qi)=>{
      const radio = elForm.querySelector(`input[name="q${qi}"][value="${idx}"]`);
      if (radio) radio.checked = true;
    });
    elRef.value = d.reflectie || "";
  }

  // ---------- Laden ----------
  async function load(){
    elStatus.textContent = "Laden…";
    try{
      await ensureDayForChild(DAY_ID);
      const snap = await dayDocRef(DAY_ID).get();
      renderDay(snap.data());
      elStatus.textContent = "Klaar.";
    }catch(e){
      elStatus.innerHTML = `<span class="err">Fout: ${esc(e.message)}</span>`;
    }
  }

  // ---------- Nakijken & opslaan (met punten) ----------
  async function gradeAndSave(){
    elQuizHint.textContent = "";
    const chosen = [];
    for (let i=0;i<5;i++){
      const r = elForm.querySelector(`input[name="q${i}"]:checked`);
      chosen.push(r ? Number(r.value) : -1);
    }
    if (chosen.some(v=>v<0)){ elQuizHint.innerHTML = '<span class="err">Beantwoord alle 5 vragen.</span>'; return; }

    try{
      const res = await db.runTransaction(async (tx)=>{
        const dRef = dayDocRef(DAY_ID);
        const kRef = childRef();

        const [dSnap, kSnap] = await Promise.all([tx.get(dRef), tx.get(kRef)]);
        if (!dSnap.exists) throw new Error("Dag ontbreekt (seed mislukt).");
        const d = dSnap.data();
        const vragen = d.vragen || [];

        let correctCount = 0;
        for (let i=0;i<5;i++){
          const q = vragen[i]; if (!q) continue;
          const ansIdx = chosen[i];
          const userAns = (q.opties||[])[ansIdx];
          if (userAns === q.correct) correctCount++;
        }
        const newScore = correctCount * 10;
        const prevScore = d.score || 0;
        const verbetering = Math.max(0, newScore - prevScore);

        const huidigePunten = (kSnap.exists ? (kSnap.data().punten||0) : 0);
        const puntenDelta = verbetering;

        tx.set(dRef, {
          gegevenAntwoorden: chosen,
          score: Math.max(prevScore, newScore),
          laatsteUpdate: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});

        if (puntenDelta>0){
          tx.set(kRef, { punten: huidigePunten + puntenDelta }, {merge:true});
        }

        return {correctCount, newScore: Math.max(prevScore,newScore), puntenDelta};
      });

      elQuizHint.innerHTML = `<span class="ok">Juist: ${res.correctCount}/5 • Dagscore: ${res.newScore} • +${res.puntenDelta} punten bij kind.</span>`;
    }catch(e){
      elQuizHint.innerHTML = `<span class="err">Fout bij opslaan: ${esc(e.message)}</span>`;
    }
  }

  // ---------- Reflectie bewaren (+20 éénmalig) ----------
  async function saveReflection(){
    elRefHint.textContent = "";
    const text = (elRef.value||"").trim();
    try{
      const res = await db.runTransaction(async (tx)=>{
        const dRef = dayDocRef(DAY_ID);
        const kRef = childRef();

        const [dSnap, kSnap] = await Promise.all([tx.get(dRef), tx.get(kRef)]);
        if (!dSnap.exists) throw new Error("Dag ontbreekt (seed mislukt).");
        const d = dSnap.data();

        let bonus = 0;
        if (!d.reflectiePuntenToegekend && text.length>0){
          bonus = 20;
        }
        tx.set(dRef, {
          reflectie: text.length>0 ? text : (d.reflectie||""),
          reflectiePuntenToegekend: d.reflectiePuntenToegekend || (bonus>0),
          laatsteUpdate: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});

        if (bonus>0){
          const huidige = (kSnap.exists ? (kSnap.data().punten||0) : 0);
          tx.set(kRef, { punten: huidige + bonus }, {merge:true});
        }
        return {bonus};
      });

      if (res.bonus>0) elRefHint.innerHTML = `<span class="ok">Reflectie opgeslagen • +${res.bonus} punten toegekend.</span>`;
      else elRefHint.textContent = "Reflectie opgeslagen.";
    }catch(e){
      elRefHint.innerHTML = `<span class="err">Fout bij opslaan: ${esc(e.message)}</span>`;
    }
  }

  // ---------- Events ----------
  document.getElementById("btnNakijken").addEventListener("click", (e)=>{ e.preventDefault(); gradeAndSave(); });
  document.getElementById("btnSaveRef").addEventListener("click", (e)=>{ e.preventDefault(); saveReflection(); });

  // ---------- Start ----------
  load();
</script>
</body>
</html>
