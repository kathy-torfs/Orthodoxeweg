<!DOCTYPE html> 
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kinderbijbel â€“ Orthodoxe Kinderpagina</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png" />
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

  <style>
    :root{
      --primair:#7bb235; --donker:#67510C;
      --pastel1:#fff6e5; --pastel2:#fffde6; --pastel3:#ffe8ec; --pastel4:#e7f8ff;
      --pastel5:#e6ffe5; --pastel6:#fff2fb; --pastel7:#f5ffe5; --pastel8:#f5e8ff;
      --pastel9:#fff6fb; --pastel10:#e7fff9; --pastel11:#f3e6ff; --pastel12:#ffeae6;
      --pastel13:#ecffe9; --pastel14:#f7fff3; --pastel15:#eafffa; --pastel16:#fff4ea;
    }
    body{
      margin:0; font-family:'Patrick Hand', cursive;
      min-height:100vh; background:var(--pastel1); transition:background .6s;
      display:flex; flex-direction:column;
    }
    .book {
      flex:1;
      width:95%; max-width:1200px; height:85vh;
      background:#fdfbf7;
      box-shadow:0 0 30px rgba(0,0,0,0.2);
      border-radius:14px;
      display:flex;
      overflow:hidden;
      margin:20px auto;
      position:relative;
    }
    .page {
      width:50%; padding:30px; overflow-y:auto;
      background:#fffef9;
    }
    .left { border-right:2px solid #d4c5a5; }
    h2 { margin-top:0; color:var(--primair); }
    .vraag {
      margin-bottom:18px; padding:10px;
      border:1px dashed #ccc; border-radius:8px;
      background:#fffdf5;
    }
    .antwoord { display:block; margin-left:15px; cursor:pointer; }
    .juist { color:green; font-weight:bold; }
    .fout { color:red; font-weight:bold; }
    textarea {
      width:100%; min-height:100px; border-radius:10px;
      border:1.5px solid #ccc; padding:10px;
      font-family:'Patrick Hand', cursive; font-size:1em;
      resize:vertical; background:#fdfdf9;
    }
    button {
      margin-top:10px; background:#7bb235; border:none;
      border-radius:8px; color:white;
      padding:8px 16px; font-size:1em; cursor:pointer;
    }

    /* subtiele pijltjes in de hoekjes */
    .navBtn {
      position:absolute;
      background:none;
      border:none;
      font-size:2em;
      color:#888;
      cursor:pointer;
      padding:4px;
      transition:color .2s;
    }
    .navBtn:hover { color:#333; }

    #prevBtn { bottom:10px; left:10px; }  /* linksonder */
    #nextBtn { bottom:10px; right:10px; } /* rechtsonder */
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script defer src="common/layout.js"></script>
</head>
<body>
  <!-- Header + menubalk -->
  <div id="kinder-header" data-header-src="common/header.html"></div>

  <div class="book">
    <button id="prevBtn" class="navBtn" onclick="prevDag()">âŸ¨</button>
    <div class="page left">
      <h2 id="titel">Titel</h2>
      <div id="verhaal">Laden...</div>
    </div>
    <div class="page right">
      <h2>Vragen</h2>
      <div id="vragen"></div>
      <button id="nakijkBtn" onclick="nakijken()">Nakijken</button>

      <h2>Mijn Reflectie</h2>
      <textarea id="reflectie" placeholder="Schrijf hier jouw eigen gedachten..."></textarea>
      <button onclick="saveReflectie()">Verstuur reflectie</button>
    </div>
    <button id="nextBtn" class="navBtn" onclick="nextDag()">âŸ©</button>
  </div>

  <script>
    // random pastel achtergrond
    (function(){
      const p=['var(--pastel1)','var(--pastel2)','var(--pastel3)','var(--pastel4)',
               'var(--pastel5)','var(--pastel6)','var(--pastel7)','var(--pastel8)',
               'var(--pastel9)','var(--pastel10)','var(--pastel11)','var(--pastel12)',
               'var(--pastel13)','var(--pastel14)','var(--pastel15)','var(--pastel16)'];
      document.body.style.background = p[Math.floor(Math.random()*p.length)];
    })();

    // Firebase init
    const firebaseConfig = {
      apiKey:"AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
      authDomain:"orthodoxeweg.firebaseapp.com",
      projectId:"orthodoxeweg",
      storageBucket:"orthodoxeweg.appspot.com",
      messagingSenderId:"408582263618",
      appId:"1:408582263618:web:0a20f4bf0704989d3ceedb"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let huidigeVragen=[]; 
    let eersteKeerNakijken=true;
    let huidigeDag=1;
    let kindStatus=null;

    function formatDag(nr){ return "dag"+nr.toString().padStart(3,"0"); }

    async function loadDagboek(dagNr){
      huidigeDag=dagNr; eersteKeerNakijken=true;
      document.getElementById("nakijkBtn").disabled=false;
      document.getElementById("reflectie").value="";

      const ref=db.collection("VlaamsOrthodoxekinderdagboek").doc(formatDag(dagNr));
      const snap=await ref.get();
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");

      kindStatus=null;
      if(parochieId&&ouderLogin&&kindId){
        const dagRef=db.collection("parochies").doc(parochieId)
                       .collection("leden").doc(ouderLogin)
                       .collection("kinderen").doc(kindId)
                       .collection("dagboek").doc(formatDag(huidigeDag));
        const statSnap=await dagRef.get();
        if(statSnap.exists) kindStatus=statSnap.data();
      }

      if(snap.exists){
        const data=snap.data();
        document.getElementById("titel").textContent=data.titel||"Bijbelverhaal";
        document.getElementById("verhaal").innerHTML=data.tekst||"";
        const vragenDiv=document.getElementById("vragen");
        vragenDiv.innerHTML=""; huidigeVragen=data.vragen||[];
        huidigeVragen.forEach((v,idx)=>{
          const blok=document.createElement("div");
          blok.className="vraag";
          const vraagTekst=document.createElement("p");
          vraagTekst.textContent=v.vraag||`Vraag ${idx+1}`;
          blok.appendChild(vraagTekst);

          if(Array.isArray(v.opties)){
            v.opties.forEach(optie=>{
              const label=document.createElement("label");
              label.className="antwoord";
              const radio=document.createElement("input");
              radio.type="radio"; radio.name="vraag"+idx; radio.value=optie;
              label.appendChild(radio);
              label.appendChild(document.createTextNode(" "+optie));
              blok.appendChild(label);
            });
          }
          vragenDiv.appendChild(blok);
        });

        // als al voltooid â†’ invullen en blokkeren
        if(kindStatus && kindStatus.voltooid){
          huidigeVragen.forEach((v,idx)=>{
            const gegeven=kindStatus.antwoorden?kindStatus.antwoorden[idx]:null;
            document.querySelectorAll(`input[name="vraag${idx}"]`).forEach(r=>{
              if(r.value===gegeven) r.checked=true;
              r.disabled=true;
              if(r.checked){
                if(r.value===v.correct) r.parentElement.classList.add("juist");
                else r.parentElement.classList.add("fout");
              }
            });
          });
          document.getElementById("nakijkBtn").disabled=true;
        }

        // reflectie invullen
        if(kindStatus && kindStatus.reflectie){
          document.getElementById("reflectie").value=kindStatus.reflectie;
        }
      } else {
        document.getElementById("titel").textContent="Geen inhoud";
        document.getElementById("verhaal").innerHTML="Voor deze dag is nog geen verhaal beschikbaar.";
        document.getElementById("vragen").innerHTML="";
      }
    }

    async function nakijken(){
      if(kindStatus && kindStatus.voltooid){
        alert("Deze dag is al nagekeken âœ…");
        return;
      }

      let score=0,fouten=0; let antwoordenKind=[];
      huidigeVragen.forEach((v,idx)=>{
        const gekozen=document.querySelector(`input[name="vraag${idx}"]:checked`);
        antwoordenKind.push(gekozen?gekozen.value:null);
        if(gekozen && gekozen.value===v.correct) score+=10;
        else fouten++;
      });

      if(eersteKeerNakijken && fouten>0){
        alert("Kijk nog eens goed na? ðŸ˜Š");
        eersteKeerNakijken=false;
        return;
      }

      huidigeVragen.forEach((v,idx)=>{
        document.querySelectorAll(`input[name="vraag${idx}"]`).forEach(r=>{
          r.disabled=true;
          if(r.checked){
            if(r.value===v.correct) r.parentElement.classList.add("juist");
            else r.parentElement.classList.add("fout");
          }
        });
      });

      if(score>0) alert("Goed gedaan! +"+score+" punten ðŸŽ‰");
      else alert("Dit keer geen juiste antwoorden.");

      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(parochieId&&ouderLogin&&kindId){
        const dagRef=db.collection("parochies").doc(parochieId)
                      .collection("leden").doc(ouderLogin)
                      .collection("kinderen").doc(kindId)
                      .collection("dagboek").doc(formatDag(huidigeDag));
        await dagRef.set({
          antwoorden:antwoordenKind,
          score:score,
          voltooid:true,
          timestamp:new Date()
        },{merge:true});
        const kindRef=db.collection("parochies").doc(parochieId)
                      .collection("leden").doc(ouderLogin)
                      .collection("kinderen").doc(kindId);
        await kindRef.set({
          punten:firebase.firestore.FieldValue.increment(score)
        },{merge:true});
      }

      document.getElementById("nakijkBtn").disabled=true;
      kindStatus={voltooid:true,antwoorden:antwoordenKind,score:score};
    }

    async function saveReflectie(){
      const tekst=document.getElementById("reflectie").value.trim();
      if(!tekst) return alert("Schrijf eerst iets!");
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(parochieId&&ouderLogin&&kindId){
        const dagRef=db.collection("parochies").doc(parochieId)
                      .collection("leden").doc(ouderLogin)
                      .collection("kinderen").doc(kindId)
                      .collection("dagboek").doc(formatDag(huidigeDag));
        const statSnap=await dagRef.get();
        const eersteKeer=!statSnap.exists||!statSnap.data().reflectiePunten;
        await dagRef.set({
          reflectie:tekst,
          timestamp:new Date(),
          reflectiePunten:eersteKeer?true:statSnap.data().reflectiePunten
        },{merge:true});
        if(eersteKeer){
          const kindRef=db.collection("parochies").doc(parochieId)
                        .collection("leden").doc(ouderLogin)
                        .collection("kinderen").doc(kindId);
          await kindRef.set({
            punten:firebase.firestore.FieldValue.increment(20)
          },{merge:true});
          alert("Reflectie opgeslagen! +20 punten ðŸŒŸ");
        } else {
          alert("Reflectie aangepast (geen extra punten).");
        }
      }
    }

    function prevDag(){ if(huidigeDag>1) loadDagboek(huidigeDag-1); }
    function nextDag(){ loadDagboek(huidigeDag+1); }

    // start bij dag 1
    loadDagboek(1);

    // Header/mnbl
    (function boot(){
      if(!(window.KinderLayout)) return setTimeout(boot,120);
      const el=document.getElementById('kinder-header');
      window.KinderLayout.mountHeader({
        rootId:'kinder-header',
        headerSrc:el.dataset.headerSrc
      });
    })();
  </script>
</body>
</html>
