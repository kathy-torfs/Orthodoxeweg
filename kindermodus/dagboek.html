<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orthodoxeweg ‚Äì Kinderdagboek</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#fff9ef; --paper:#fffdf7; --ink:#3b2f1a; --muted:#6f4e1a;
      --brand:#7a5f35; --accent:#d28f2c; --good:#2e7d32; --bad:#c62828;
      --chip:#f0e3c6; --chip2:#f7efd9;
    }
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--ink);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; line-height:1.6; }

    /* Topbar + menu (zelfde stijl als elders, kindvriendelijker spacing) */
    .topbar{background:#6f4e1a;color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .topbar .hi{font-weight:600}
    .topbar .who{font-weight:400; opacity:.95}
    .uitlog-link{background:#8722aa;color:#fff;border:none;padding:8px 16px;border-radius:18px;cursor:pointer;font-weight:700}

    nav.menu{background:#7a5f35;padding:10px 14px;display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center}
    nav.menu a,nav.menu button{color:#f5e9b8;text-decoration:none;font-weight:700;font-size:16px;padding:6px 10px;border-radius:8px;transition:.2s;background:none;border:none;display:flex;align-items:center;cursor:pointer}
    nav.menu a:hover,nav.menu button:hover{background:#5d4726;text-decoration:underline}
    .menu-avatar{padding:0!important;background:none!important;border:none!important;margin-left:2px}
    .menu-avatar img{height:2.1em;width:2.1em;border-radius:50%;border:2px solid #dab97a;background:#fff8eb}

    /* Shell */
    .wrap{max-width:980px;margin:18px auto 28px;padding:0 12px}
    .crumb{font-size:.9rem;color:#8a6a32;margin-bottom:10px}

    /* Controls */
    .controls{
      background:var(--chip2);
      border:1px solid #e8d7ab; border-radius:16px; padding:10px;
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
      box-shadow: 0 2px 10px #00000010 inset;
    }
    .controls .left,.controls .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .btn{appearance:none;border:none;background:var(--brand);color:#fff;padding:9px 14px;border-radius:12px;font-weight:800;cursor:pointer}
    .btn.secondary{background:#b58a4b}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    select{background:#fff;border:1px solid #e1d3ac;padding:8px 10px;border-radius:10px;min-width:150px;font-weight:700;color:var(--muted)}
    .score-chip{background:var(--chip);border:1px solid #e6d5ad;border-radius:999px;padding:6px 12px;font-weight:800}

    /* Card */
    .card{background:var(--paper);border:1px solid #efdfb7;border-radius:18px;margin-top:14px;padding:16px;box-shadow:0 6px 28px #00000012}
    .card h2{margin:0 0 4px;font-size:1.35rem;color:#5d441f}
    .sub{color:#8a6a32;margin:0 0 12px;font-size:.95rem}

    /* Story */
    .story p{margin:10px 0}
    .divider{height:1px;background:#efdcb3;margin:16px 0}

    /* Quiz */
    .q{margin:12px 0;padding:12px;border:1px dashed #e7d4a7;border-radius:12px;background:#fffbf1}
    .q-title{font-weight:800;margin-bottom:8px}
    .opt{display:flex;gap:8px;align-items:flex-start;padding:6px 8px;border-radius:8px;cursor:pointer;user-select:none}
    .opt:hover{background:#f9f1db}
    .feedback{margin-top:6px;font-weight:800}
    .ok{color:var(--good)} .nok{color:var(--bad)}

    /* Reflectie */
    .reflect{background:#fffef6;border:1.2px solid #dbc592;border-radius:12px;padding:14px 16px}
    .reflect textarea{width:100%;min-height:110px;border:1.2px solid #dbc592;border-radius:10px;background:#faf5e1;padding:10px;resize:vertical;font-family:inherit}

    /* Progress */
    .progress{height:10px;background:#f1e6c7;border-radius:999px;overflow:hidden;box-shadow:inset 0 1px 3px #00000015}
    .progress > span{display:block;height:100%;background:linear-gradient(90deg,#8fbf57,#2e7d32);width:0%}

    @media (max-width:640px){select{min-width:140px}}
  </style>
</head>
<body>

  <!-- Top + menu (zelfde componenten als elders) -->
  <div class="topbar">
    <div>
      <div class="hi" id="welkom">Welkom!</div>
      <div class="who" id="parochie">(parochie onbekend)</div>
    </div>
    <button class="uitlog-link" id="uitlog">üö™ Uitloggen</button>
  </div>
  <nav class="menu">
    <a href="https://kathy-torfs.github.io/Orthodoxeweg/kindermodus/index.html" title="Home">üè†</a>
    <a href="https://kathy-torfs.github.io/Orthodoxeweg/kindermodus/bijbel.html">üìñ Bijbel</a>
    <a href="https://kathy-torfs.github.io/Orthodoxeweg/kindermodus/gebeden.html">üôè Gebeden</a>
    <a href="https://kathy-torfs.github.io/Orthodoxeweg/kindermodus/dagboek_index.html" title="Dagboek index">üìî Dagboek</a>
    <a href="https://kathy-torfs.github.io/Orthodoxeweg/kindermodus/profiel.html" class="menu-avatar" title="Mijn profiel">
      <img id="menu-avatar-img" src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" alt="Mijn profiel">
    </a>
  </nav>

  <div class="wrap">
    <div class="crumb" id="crumb"></div>

    <!-- Bediening -->
    <div class="controls">
      <div class="left">
        <button class="btn" id="prevBtn">‚óÄ Vorige</button>
        <button class="btn" id="nextBtn">Volgende ‚ñ∂</button>
        <select id="daySelect" title="Kies dag">
          <option value="1">Dag 001</option>
          <option value="2">Dag 002</option>
          <option value="3">Dag 003</option>
          <option value="4">Dag 004</option>
          <option value="5">Dag 005</option>
          <option value="6">Dag 006</option>
          <option value="7">Dag 007</option>
        </select>
      </div>
      <div class="right">
        <span class="score-chip">Punten: <span id="weekScore">0</span></span>
      </div>
    </div>

    <!-- Verhaal + quiz -->
    <div class="card">
      <h2 id="title">Dag ‚Äî</h2>
      <p class="sub" id="subtitle">VlaamsOrthodoxekinderdagboek</p>

      <div id="story" class="story"></div>
      <div class="divider"></div>
      <div id="quiz"></div>

      <div style="display:flex;gap:10px;justify-content:space-between;align-items:center;margin-top:10px">
        <div>
          <button class="btn" id="checkBtn">Nakijken</button>
          <button class="btn secondary" id="resetBtn" title="Opnieuw">Opnieuw</button>
        </div>
        <div style="font-weight:900;color:#5d441f">Score vandaag: <span id="todayScore">0</span> / 50</div>
      </div>
    </div>

    <!-- Reflectie -->
    <div class="card reflect">
      <h3 style="margin:0 0 8px 0;color:#7a5f35">Mijn reflectie (+20 punten √©√©nmalig)</h3>
      <textarea id="reflectieText" placeholder="Schrijf hier je gedachte of gebed‚Ä¶"></textarea>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
        <button class="btn" id="saveReflectie">Reflectie bewaren</button>
      </div>
    </div>

    <!-- Voortgang -->
    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>Voortgang week</strong>
        <span id="progressLabel">0%</span>
      </div>
      <div class="progress"><span id="progressBar"></span></div>
    </div>
  </div>

  <script>
    /* ===================  BEGROETING & MENU  =================== */
    (function greet(){
      const loginNaam  = localStorage.getItem("loginKeuze") || "vriend";
      const parochieNm = localStorage.getItem("ingelogdeParochieNaam")
                       || localStorage.getItem("ingelogdeParochie")
                       || "onbekende parochie";
      document.getElementById('welkom').textContent = `Welkom, ${loginNaam}!`;
      document.getElementById('parochie').textContent = `Je bent ingelogd in de ${parochieNm}.`;
      const av = localStorage.getItem("avatarURL");
      if (av) document.getElementById('menu-avatar-img').src = av;

      document.getElementById('uitlog').onclick = ()=>{
        sessionStorage.removeItem("dagboek_userId");
        sessionStorage.removeItem("dagboek_parochieId");
        sessionStorage.removeItem("dagboek_authed");
        window.location.href = "dagboek_index.html";
      };
    })();

    /* ===================  FIREBASE  =================== */
    const firebaseConfig = {
      apiKey: "AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
      authDomain: "orthodoxeweg.firebaseapp.com",
      projectId: "orthodoxeweg",
      storageBucket: "orthodoxeweg.appspot.com",
      messagingSenderId: "408582263618",
      appId: "1:408582263618:web:0a20f4bf0704989d3ceedb",
      measurementId: "G-C942F2NYQV"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ===================  UI refs  =================== */
    const daySelect   = document.getElementById('daySelect');
    const prevBtn     = document.getElementById('prevBtn');
    const nextBtn     = document.getElementById('nextBtn');
    const titleEl     = document.getElementById('title');
    const subtitleEl  = document.getElementById('subtitle');
    const storyEl     = document.getElementById('story');
    const quizEl      = document.getElementById('quiz');
    const checkBtn    = document.getElementById('checkBtn');
    const resetBtn    = document.getElementById('resetBtn');
    const todayScoreEl= document.getElementById('todayScore');
    const weekScoreEl = document.getElementById('weekScore');
    const progressBar = document.getElementById('progressBar');
    const progressLbl = document.getElementById('progressLabel');
    const crumbEl     = document.getElementById('crumb');

    /* ===================  Helpers  =================== */
    const pad3 = (n)=> String(n).padStart(3,'0');
    const docIdFor = (n)=> `dag${pad3(n)}`;

    function renderStory(multilineText){
      storyEl.innerHTML = '';
      const parts = (multilineText || '').split('\n').filter(s=>s.trim().length);
      for(const line of parts){
        const p = document.createElement('p');
        p.textContent = line.trim();
        storyEl.appendChild(p);
      }
    }
    function renderQuiz(questions){
      quizEl.innerHTML = '';
      (questions || []).forEach((q, idx)=>{
        const box = document.createElement('div');
        box.className = 'q';
        const title = document.createElement('div');
        title.className = 'q-title';
        title.textContent = `Vraag ${idx+1}: ${q.vraag}`;
        box.appendChild(title);

        const name = `q_${idx}`;
        (q.opties || []).forEach((opt, oi)=>{
          const id = `${name}_${oi}`;
          const label = document.createElement('label');
          label.className = 'opt';
          label.setAttribute('for', id);

          const input = document.createElement('input');
          input.type = 'radio'; input.name = name; input.id = id; input.value = opt;

          const span = document.createElement('span');
          span.textContent = opt;

          label.appendChild(input); label.appendChild(span);
          box.appendChild(label);
        });

        const fb = document.createElement('div');
        fb.className = 'feedback'; fb.id = `fb_${idx}`;
        box.appendChild(fb);
        quizEl.appendChild(box);
      });
    }

    /* ===================  Context uit sessie/URL  =================== */
    const parochieId = sessionStorage.getItem("dagboek_parochieId") || "hasselt-drie-hierarchen";
    const ouderId    = sessionStorage.getItem("dagboek_userId")     || "Kathy";
    const usp        = new URLSearchParams(location.search);
    const kindId     = usp.get("kid") || "__4285";

    const childRef = db.collection("parochies").doc(parochieId)
                       .collection("leden").doc(ouderId)
                       .collection("kinderen").doc(kindId);

    /* ===================  State  =================== */
    let CURRENT_DAY = 1;
    let CURRENT_QUESTIONS = [];
    let CURRENT_DAGREF = null;

    /* ===================  Punten tonen/bijwerken  =================== */
    async function refreshKindPunten(){
      const s = await childRef.get();
      const pts = s.exists && typeof s.data().punten === 'number' ? s.data().punten : 0;
      weekScoreEl.textContent = pts;
      const pct = Math.max(0, Math.min(100, Math.round((pts % 350)/350*100)));
      progressBar.style.width = pct + '%';
      progressLbl.textContent = pct + '%';
    }

    /* ===================  Dag laden  =================== */
    async function loadDay(dayNum){
      CURRENT_DAY = dayNum;
      const dagId = docIdFor(dayNum);
      CURRENT_DAGREF = childRef.collection("kinderdagboek").doc(dagId);

      daySelect.value = String(dayNum);
      prevBtn.disabled = (dayNum <= 1);
      nextBtn.disabled = (dayNum >= 7);

      crumbEl.textContent = `/parochies/${parochieId}/leden/${ouderId}/kinderen/${kindId}/kinderdagboek/${dagId}`;

      titleEl.textContent = 'Laden‚Ä¶';
      storyEl.innerHTML = '<p style="color:#98784a">Even geduld‚Ä¶</p>';
      quizEl.innerHTML  = '';

      // 1) Sjabloon (verhaal + vragen)
      const tplSnap = await db.collection('VlaamsOrthodoxekinderdagboek').doc(dagId).get();
      if (!tplSnap.exists){
        titleEl.textContent = `Dag ${pad3(dayNum)} (niet gevonden)`;
        storyEl.innerHTML   = '<p style="color:#b5482c">Geen gegevens voor deze dag.</p>';
        todayScoreEl.textContent = '0';
        CURRENT_QUESTIONS = [];
        await refreshKindPunten();
        return;
      }
      const tpl = tplSnap.data();
      CURRENT_QUESTIONS = Array.isArray(tpl.vragen) ? tpl.vragen : [];

      titleEl.textContent    = tpl.titel || `Dag ${pad3(dayNum)}`;
      subtitleEl.textContent = `Document: ${dagId}`;
      renderStory(tpl.tekst || '');
      renderQuiz(CURRENT_QUESTIONS);

      // 2) Kind-dag document (bestScore)
      const kidSnap = await CURRENT_DAGREF.get();
      const best = kidSnap.exists && typeof kidSnap.data().bestScore === 'number'
        ? kidSnap.data().bestScore : 0;
      todayScoreEl.textContent = String(best);

      // evt. bestaande reflectie tonen
      const ref = kidSnap.exists && kidSnap.data().reflectie ? kidSnap.data().reflectie : "";
      document.getElementById('reflectieText').value = ref;

      await refreshKindPunten();
    }

    /* ===================  Nakijken en opslaan  =================== */
    async function gradeNow(){
      if (!CURRENT_DAGREF) return;

      const antwoorden = {};
      let score = 0;

      CURRENT_QUESTIONS.forEach((q, idx)=>{
        const sel = document.querySelector(`input[name="q_${idx}"]:checked`);
        const fb  = document.getElementById(`fb_${idx}`);
        const gekozen = sel ? sel.value : null;
        antwoorden[idx] = gekozen;

        if (!fb) return;
        if (!gekozen){
          fb.textContent = "Kies een antwoord.";
          fb.className = 'feedback nok';
        } else if (gekozen === q.correct){
          score += 10;
          fb.textContent = "Goed zo! (+10)";
          fb.className = 'feedback ok';
        } else {
          fb.textContent = `Niet juist. Het juiste antwoord is: ${q.correct}`;
          fb.className = 'feedback nok';
        }
      });

      todayScoreEl.textContent = String(score);

      // transactie: bestScore + punten-delta
      await db.runTransaction(async (tx)=>{
        const s = await tx.get(CURRENT_DAGREF);
        const cur = s.exists ? s.data() : {};
        const prevBest = typeof cur.bestScore === 'number' ? cur.bestScore : 0;
        const delta = Math.max(0, score - prevBest);

        const payload = {
          bestScore: Math.max(prevBest, score),
          antwoorden,
          nagekekenOp: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (s.exists) tx.update(CURRENT_DAGREF, payload);
        else tx.set(CURRENT_DAGREF, { titel: document.getElementById('title').textContent, ...payload });

        if (delta > 0){
          const childSnap = await tx.get(childRef);
          const curP = childSnap.exists && typeof childSnap.data().punten === 'number' ? childSnap.data().punten : 0;
          tx.update(childRef, { punten: curP + delta });
        }
      });

      await refreshKindPunten();
    }

    /* ===================  Reflectie  =================== */
    async function saveReflectie(){
      const txt = document.getElementById('reflectieText').value.trim();
      if (!txt) { alert("Schrijf eerst je reflectie."); return; }
      if (!CURRENT_DAGREF) return;

      let bonus = false;
      await db.runTransaction(async (tx)=>{
        const s = await tx.get(CURRENT_DAGREF);
        const cur = s.exists ? s.data() : {};
        const al = cur.reflectiePunten === true;

        const payload = {
          reflectie: txt,
          reflectieOp: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (!al) payload.reflectiePunten = true;

        if (s.exists) tx.update(CURRENT_DAGREF, payload);
        else tx.set(CURRENT_DAGREF, { titel: document.getElementById('title').textContent, bestScore:0, antwoorden:{}, ...payload });

        if (!al){
          const childSnap = await tx.get(childRef);
          const curP = childSnap.exists && typeof childSnap.data().punten === 'number' ? childSnap.data().punten : 0;
          tx.update(childRef, { punten: curP + 20 });
          bonus = true;
        }
      });

      await refreshKindPunten();
      alert(bonus ? "Reflectie opgeslagen (+20 punten)." : "Reflectie bijgewerkt.");
    }

    /* ===================  Events  =================== */
    document.getElementById('saveReflectie').addEventListener('click', saveReflectie);
    document.getElementById('checkBtn').addEventListener('click', gradeNow);
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      quizEl.querySelectorAll('input[type="radio"]').forEach(i=> i.checked = false);
      quizEl.querySelectorAll('.feedback').forEach(fb => { fb.textContent = ''; fb.className = 'feedback'; });
      todayScoreEl.textContent = '0';
    });

    document.getElementById('prevBtn').addEventListener('click', ()=>{
      const n = Number(daySelect.value); if (n>1) loadDay(n-1);
    });
    document.getElementById('nextBtn').addEventListener('click', ()=>{
      const n = Number(daySelect.value); if (n<7) loadDay(n+1);
    });
    daySelect.addEventListener('change', ()=> loadDay(Number(daySelect.value)));

    /* ===================  Start  =================== */
    (function init(){
      const qs = new URLSearchParams(location.search);
      const start = Math.max(1, Math.min(7, Number(qs.get('dag') || 1)));
      daySelect.value = String(start);
      loadDay(start);
    })();
  </script>
</body>
</html>
