<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Photeinos Springspel (web)</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png">

  <style>
    :root{
      --primair:#7bb235; --donker:#67510C;
      --pastel1:#fff6e5; --pastel2:#fffde6; --pastel3:#ffe8ec; --pastel4:#e7f8ff;
      --pastel5:#e6ffe5; --pastel6:#fff2fb; --pastel7:#f5ffe5; --pastel8:#f5e8ff;
      --pastel9:#fff6fb; --pastel10:#e7fff9; --pastel11:#f3e6ff; --pastel12:#ffeae6;
      --pastel13:#ecffe9; --pastel14:#f7fff3; --pastel15:#eafffa; --pastel16:#fff4ea;
    }
    html,body{height:100%;margin:0}
    body{
      display:flex; flex-direction:column; align-items:center;
      background:var(--pastel1);
      font-family:'Comic Sans MS', Arial, sans-serif; color:#333;
    }
    /* Header blok (begroeting) */
    .bovenrij{width:100%;max-width:1280px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:0;padding:22px 2vw 8px 2vw;box-sizing:border-box}
    .bovenrij .links{display:flex;align-items:center;gap:18px}
    .photeinos-wave-img{width:120px;height:120px;border-radius:50%;background:#fff;border:2.2px solid #dab97a;box-shadow:0 2px 12px #dab97a2a;object-fit:cover;user-drag:none;-webkit-user-drag:none}
    .begroeting{font-size:2.2em;font-weight:bold;color:var(--primair);text-shadow:0 2px 8px #b3d9ff44;letter-spacing:.01em;line-height:1.04;margin:0;white-space:nowrap}
    .spacer-begroeting-menu{height:10px}

    /* Welkomtekst */
    .welkom-blok{background:#fffce7;border-radius:23px;box-shadow:0 6px 32px #d7cbb144;color:var(--donker);font-size:1.2em;padding:18px 22px;margin:10px auto 10px auto;line-height:1.62;max-width:900px;width:93vw;text-align:center}

    /* Photeinos met vlam en punten */
    .photeinos-vlam-blok{position:relative;display:flex;flex-direction:column;align-items:center;width:330px;max-width:85vw;margin:10px auto 16px auto}
    .photeinos-vlam-img{width:100%;display:block;user-drag:none;-webkit-user-drag:none}
    .punten-teller{
      position:absolute;left:0;right:0;top:70%;text-align:center;
      font-size:2.6em;color:#bf5300;font-weight:bold;
      text-shadow:0 2px 10px #fffef9, 0 1px 0 #ffecb3;pointer-events:none;letter-spacing:.03em;
      transition:transform .14s;
    }

    /* Spel container */
    .wrap{width:min(100vw,1100px);aspect-ratio:16/9;position:relative;border-radius:18px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.12);background:#fff;margin:10px 0 36px}
    canvas{display:block;width:100%;height:100%}

    .hud{position:absolute;left:12px;top:10px;background:rgba(255,255,255,.7);backdrop-filter:blur(4px);padding:8px 10px;border-radius:10px;font-size:14px;color:#1e3a8a}
    .start, .end, .modal{position:absolute;inset:0;display:grid;place-items:center}
    .card{background:#fff;color:#0f172a;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);padding:20px 22px;max-width:min(90%,560px);text-align:center}
    .title{font-weight:700;color:#1e40af;margin:6px 0 6px}
    .btn{appearance:none;border:0;border-radius:10px;background:#0ea5e9;color:#fff;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .ghost{background:#eff6ff;color:#1e40af}
    .answers{display:grid;gap:8px;margin-top:10px}
    .answers.two{grid-template-columns:repeat(2,minmax(0,1fr))}
    .answers .btn{background:#111827;color:#fff;border:1px solid #374151}
    .badge{display:inline-block;background:#ecfeff;color:#0c4a6e;border:1px solid #a5f3fc;border-radius:999px;padding:3px 8px;font-size:12px;margin:6px 0}
    .feedback{position:absolute;left:50%;top:12%;transform:translateX(-50%);background:rgba(255,255,255,.8);padding:8px 12px;border-radius:999px;color:#065f46;font-weight:700}

    @media (max-width:900px){
      .photeinos-wave-img{width:16vw;height:16vw;min-width:44px}
      .begroeting{font-size:1.4em}
      .welkom-blok{font-size:1.05em}
      .photeinos-vlam-blok{width:54vw}
      .punten-teller{font-size:1.6em}
    }
    @media (max-width:550px){
      .photeinos-vlam-blok{width:84vw}
      .punten-teller{font-size:1.2em}
    }
  </style>

  <!-- Firebase compat (zoals je startpagina) -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
</head>
<body>

  <!-- Bovenste rij: ster + begroeting -->
  <div class="bovenrij">
    <div class="links">
      <img src="https://kathy-torfs.github.io/Orthodoxeweg/images/photeinos_wave.gif" alt="Photeinos zwaait" class="photeinos-wave-img" draggable="false">
      <span class="begroeting" id="groet-tekst">Hallo, kind!</span>
    </div>
    <div style="width:120px"></div>
  </div>
  <div class="spacer-begroeting-menu"></div>

  <!-- Welkomtekst -->
  <div class="welkom-blok">
Welkom in jouw Orthodoxe Kinderpagina, <span id="kind-naam-blok"></span>! üéâ

üåü Hier mag je elke dag op avontuur: ontdek mooie verhalen, leer bidden, en speel leuke spelletjes!

Hoe meer jij bidt of leert, hoe meer punten je verdient en hoe meer spelletjes je kan spelen.

Veel plezier vandaag, en vergeet niet: Photeinos is altijd jouw vriendje onderweg! ü§©
  </div>

  <!-- Grote Photeinos met vlam en punten -->
  <div class="photeinos-vlam-blok">
    <img src="https://kathy-torfs.github.io/Orthodoxeweg/images/photeinos_vlam.png" alt="Photeinos met vlam" class="photeinos-vlam-img" draggable="false">
    <div id="punten-teller" class="punten-teller">‚Ä¶</div>
  </div>

  <!-- Spel -->
  <div class="wrap" id="gameRoot">
    <canvas id="game"></canvas>

    <div class="hud" id="hud">Level 1/5 ‚Ä¢ Vleugels 0/0 ‚Ä¢ Score 0 ‚Ä¢ Totaal 0</div>
    <div class="feedback" id="feedback" style="display:none"></div>

    <div class="start" id="start">
      <div class="card">
        <div class="title">Photeinos Springspel</div>
        <div style="color:#334155;margin-bottom:10px">
          Tik/klik of druk <strong>spatie</strong> om te flappen (omhoog). Laat los om te dalen.<br/>
          Vang alle ü™Ω en ontwijk üíÄ. Na een ü™Ω krijg je een korte vraag.
        </div>
        <div class="badge">5 levels ‚Ä¢ van traag naar sneller</div>
        <div style="margin-top:12px;display:flex;gap:10px;justify-content:center">
          <button class="btn" id="startBtn">Start spel (20 lichtjes)</button>
        </div>
      </div>
    </div>

    <div class="modal" id="question" style="display:none">
      <div class="card" id="qCard">
        <div id="qText" class="title" style="margin:0 0 10px"></div>
        <div id="qAnswers" class="answers"></div>
      </div>
    </div>

    <div class="end" id="end" style="display:none">
      <div class="card">
        <div class="title">Goed gespeeld!</div>
        <div id="endText" style="color:#14532d;margin:8px 0 12px"></div>
        <button class="btn" id="again">Speel opnieuw</button>
        <a class="btn ghost" href="spelletjes.html" style="margin-left:8px;text-decoration:none">Terug</a>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== Achtergrondkleur random pastel =====
  (function(){
    const pastel = ['var(--pastel1)','var(--pastel2)','var(--pastel3)','var(--pastel4)','var(--pastel5)','var(--pastel6)','var(--pastel7)','var(--pastel8)','var(--pastel9)','var(--pastel10)','var(--pastel11)','var(--pastel12)','var(--pastel13)','var(--pastel14)','var(--pastel15)','var(--pastel16)'];
    document.body.style.background = pastel[(Math.random()*pastel.length)|0];
  })();

  // ===== Header: naam & begroeting =====
  const kindNaam = localStorage.getItem("ingelogdKindVoornaam") || "Kind";
  document.getElementById('kind-naam-blok').textContent = kindNaam;
  const groet = (()=>{ const h=new Date().getHours(); if(h>=6&&h<=11)return"Goedemorgen"; if(h>=12&&h<=16)return"Goeiemiddag"; if(h>=17&&h<=22)return"Goeieavond"; return"Hallo";})();
  document.getElementById("groet-tekst").textContent = `${groet}, ${kindNaam}!`;

  // ===== Firebase & punten =====
  const firebaseConfig = {
    apiKey: "AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
    authDomain: "orthodoxeweg.firebaseapp.com",
    projectId: "orthodoxeweg",
    storageBucket: "orthodoxeweg.appspot.com",
    messagingSenderId: "408582263618",
    appId: "1:408582263618:web:0a20f4bf0704989d3ceedb"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const parochieId = localStorage.getItem("ingelogdeParochie");
  const ouderLogin = localStorage.getItem("loginKeuze");
  const kindId     = localStorage.getItem("ingelogdKindId");

  const puntenTellerEl = document.getElementById("punten-teller");
  let huidigePunten = 0;

  async function haalPunten(){
    try{
      if(!parochieId || !ouderLogin || !kindId){ puntenTellerEl.textContent = "‚Ä¶"; return 0; }
      const snap = await db.collection("parochies").doc(parochieId).collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId).get();
      const p = snap.exists ? (snap.data().punten || 0) : 0;
      huidigePunten = p;
      puntenTellerEl.textContent = p;
      return p;
    }catch(e){
      console.warn("Punten laden mislukt:", e);
      puntenTellerEl.textContent = "‚Ä¶";
      return 0;
    }
  }
  function bumpTeller(){
    puntenTellerEl.style.transform = 'scale(1.18)';
    setTimeout(()=> puntenTellerEl.style.transform = 'scale(1)', 180);
  }
  async function updatePunten(delta){
    // Optimistisch updaten in UI
    huidigePunten += delta;
    if(huidigePunten < 0) huidigePunten = 0;
    puntenTellerEl.textContent = huidigePunten;
    bumpTeller();
    try{
      if(parochieId && ouderLogin && kindId){
        await db.collection("parochies").doc(parochieId).collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId)
          .update({ punten: firebase.firestore.FieldValue.increment(delta) });
      }
    }catch(e){
      // rollback bij fout
      console.error("Punten updaten mislukt:", e);
      await haalPunten();
    }
  }

  // Init punten bij laden
  haalPunten();

  // ====== Spelconfig & helpers (zoals vorige versie) ======
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  const hud = document.getElementById('hud');
  const startOverlay = document.getElementById('start');
  const endOverlay = document.getElementById('end');
  const endText = document.getElementById('endText');
  const feedback = document.getElementById('feedback');
  const startBtn = document.getElementById('startBtn');
  const againBtn = document.getElementById('again');

  const qModal = document.getElementById('question');
  const qText  = document.getElementById('qText');
  const qAns   = document.getElementById('qAnswers');

  const rand = (a=0,b=1)=> a + Math.random()*(b-a);
  const clamp = (v,a,b)=> Math.max(a, Math.min(b, v));

  const LEVELS = [
    { wings: 10, sky: '#B3E5FC' },
    { wings: 10, sky: '#E6EE9C' },
    { wings: 10, sky: '#F8BBD0' },
    { wings: 10, sky: '#C5CAE9' },
    { wings: 10, sky: '#E1F5FE' },
  ];

// --- CATECHETISCHE VRAGEN (volledige set) ---

const LIGHT_QUESTIONS = [
  // Liefde tot God & gebed
  { q:"Wat doe je als je wakker wordt?", opts:["Een kort gebedje bidden","Je bed uit springen zonder God te groeten"], ok:0 },
  { q:"Wat doe je met het kruisteken?", opts:["Je begint en eindigt je gebed ermee","Alleen doen als anderen kijken"], ok:0 },
  { q:"Wat betekent 'Amen'?", opts:["Ik geloof het/zo is het","Einde, klaar!"], ok:0 },
  { q:"Wat doe je op zondag als je kan?", opts:["Naar de kerk gaan","Thuisblijven omdat uitslapen belangrijker is"], ok:0 },
  { q:"Wat is bidden?", opts:["Praten met God","Alleen iets vragen als je iets wil"], ok:0 },

  // Liefde tot de naaste
  { q:"Een kind zit alleen op de speelplaats. Wat doe je?", opts:["Je nodigt hem/haar uit","Je doet alsof je het niet ziet"], ok:0 },
  { q:"Iemand heeft honger. Wat is goed?", opts:["Delen van je eten","Doen alsof je niets merkt"], ok:0 },
  { q:"Een klasgenoot heeft verdriet. Wat past het meest bij Jezus?", opts:["Troosten en luisteren","Zeggen dat het niet erg is en weglopen"], ok:0 },
  { q:"Iemand maakt een fout. Wat doe je?", opts:["Vergeven en opnieuw proberen","Boos blijven en pesten"], ok:0 },

  // Eerlijkheid & waarheid
  { q:"Je brak per ongeluk iets. Wat is juist?", opts:["Eerlijk zeggen wat er gebeurde","Zwijgen zodat niemand het weet"], ok:0 },
  { q:"De juf stelt een vraag en je weet het niet zeker.", opts:["Eerlijk zijn en je best doen","Afkijken bij de buur"], ok:0 },

  // Gehoorzaamheid & respect
  { q:"Mama vraagt hulp bij de tafel. Wat doe je?", opts:["Je helpt meteen","Je doet alsof je het niet hoorde"], ok:0 },
  { q:"Hoe toon je respect thuis?", opts:["Met dankjewel en alstublieft","Door te roepen als je iets wil"], ok:0 },

  // Delen / eenvoud
  { q:"Je kreeg twee koekjes en je vriend geen.", opts:["Je deelt er √©√©n","Je eet ze snel allebei op"], ok:0 },
  { q:"Iemand heeft een mooier speelgoed.", opts:["Blij zijn met wat je hebt","Jaloers doen en kwaad worden"], ok:0 },

  // Kerk & liturgie
  { q:"Wat doe je in de kerk?", opts:["Stil zijn en meebidden","Rondlopen en praten"], ok:0 },
  { q:"Wat lees je in de Bijbel?", opts:["Gods Woord","Grappige mopjes"], ok:0 },
  { q:"Wat is vasten (simpel)?", opts:["Minder van iets nemen om meer bij God te zijn","Niet eten zodat je sneller bent"], ok:0 },

  // Sacramenten (kinderlijk verwoord)
  { q:"Wat doet het doopsel?", opts:["Maakt je kind van God en lid van de Kerk","Geeft je superkrachten"], ok:0 },
  { q:"Wat is de communie?", opts:["Jezus die bij ons komt in de Eucharistie","Gewoon brood"], ok:0 },

  // Gouden regel / spelcontext
  { q:"Je mag het spel kiezen. Wat is beleefd?", opts:["Om beurten kiezen","Altijd zelf kiezen"], ok:0 },
  { q:"Je krijgt een cadeau dat je al hebt.", opts:["Dankbaar zijn en het mooi bewaren","Meteen doorgeven zonder dankjewel"], ok:0 },

  // Eenvoudige deugden
  { q:"Wat is beter?", opts:["Eerlijk en vriendelijk zijn","Stoer doen en stoer spreken"], ok:0 },
  { q:"Je wordt boos. Wat is goed?", opts:["Eerst rustig worden en dan praten","Meteen schreeuwen"], ok:0 },
  { q:"Wat doe je met je talenten?", opts:["Je gebruikt ze om goed te doen","Alleen om beter te zijn dan anderen"], ok:0 },

  // Geweten vormen
  { q:"Je twijfelt wat juist is.", opts:["Je vraagt raad aan je ouders of catecheet","Je doet maar wat je wil"], ok:0 },
  { q:"Je hebt iemand pijn gedaan.", opts:["Sorry zeggen en goedmaken","Doen alsof er niets is"], ok:0 },

  // Respect voor schepping
  { q:"Wat doe je met afval buiten?", opts:["In de vuilnisbak gooien","Laten liggen, de aarde ruimt het wel op"], ok:0 },
  { q:"Hoe ga je om met dieren?", opts:["Zacht en zorgzaam","Plagen voor de lol"], ok:0 },

  // Kleine geloofskennis
  { q:"Wie leerde ons de 'Onze Vader'?", opts:["Jezus","Petrus"], ok:0 },
  { q:"Wat vieren we met Pasen?", opts:["De verrijzenis van Jezus","Een lenteschoonmaak"], ok:0 },
  { q:"Wat betekent ‚Äònaaste‚Äô?", opts:["Iedereen die God op je weg plaatst","Alleen je beste vriend"], ok:0 },

  // Samenleven
  { q:"Op de beurt wachten is‚Ä¶", opts:["Eerlijk en vriendelijk","Saai en dus niet nodig"], ok:0 },
  { q:"Iemand stelt een domme vraag.", opts:["Respectvol antwoorden","Uitlachen"], ok:0 }
];

const SIN_QUESTIONS = [
  // 1e gebod ‚Äì God liefhebben
  { q:"God helemaal vergeten en nooit bidden is goed.", ok:1 },
  { q:"Grappen maken over God in de kerk is goed.", ok:1 },

  // 2e gebod ‚Äì Gods naam niet ijdel
  { q:"De Naam van God lelijk gebruiken is toegestaan.", ok:1 },

  // 3e gebod ‚Äì Zondag heiligen
  { q:"De zondag is alleen voor spel en nooit voor God.", ok:1 },

  // 4e gebod ‚Äì Vader en moeder eren
  { q:"Je ouders expres negeren is juist.", ok:1 },
  { q:"Met respect praten tegen ouders en juf is niet nodig.", ok:1 },

  // 5e gebod ‚Äì Niet doden (zorg en vrede)
  { q:"Iemand pijn doen voor de grap mag.", ok:1 },
  { q:"Pesten of iemand buitensluiten is goed.", ok:1 },

  // 6e/9e ‚Äì Zuiverheid / respect
  { q:"Over het lichaam van anderen grapjes maken is goed.", ok:1 },

  // 7e/10e ‚Äì Niet stelen / niet hebzuchtig
  { q:"Iets meenemen dat niet van jou is mag.", ok:1 },
  { q:"Jaloers doen en alles voor jezelf willen is goed.", ok:1 },

  // 8e ‚Äì Niet liegen
  { q:"Liegen om uit de problemen te blijven is toegestaan.", ok:1 },
  { q:"Roddelen over iemand is goed.", ok:1 },

  // Kerk & heilig gedrag
  { q:"In de kerk hard roepen en rennen mag.", ok:1 },
  { q:"Tijdens gebed expres grapjes maken is goed.", ok:1 },

  // Barmhartigheid
  { q:"Iemand met honger of verdriet negeren is juist.", ok:1 },
  { q:"Niet willen delen met wie niets heeft is goed.", ok:1 },

  // Respect voor schepping
  { q:"Afval op straat gooien is ok√©.", ok:1 },
  { q:"Dieren plagen mag.", ok:1 },

  // School & eerlijk spel
  { q:"Spieken en valsspelen is toegestaan.", ok:1 },
  { q:"Je beurt afpakken in de rij is goed.", ok:1 },

  // Taalgebruik
  { q:"Schelden en lelijke woorden gebruiken is ok√©.", ok:1 },

  // Vergeving
  { q:"Nooit vergeven en altijd boos blijven is juist.", ok:1 },

  // Dankbaarheid
  { q:"Nooit dankjewel zeggen is goed.", ok:1 },

  // Trots / nederigheid
  { q:"Opscheppen en anderen klein maken is goed.", ok:1 },

  // Media/afleiding
  { q:"Altijd schermtijd kiezen boven gebed of gezin is juist.", ok:1 },

  // Waarheidsliefde
  { q:"Een fout verbergen en een ander de schuld geven is toegestaan.", ok:1 }
];


  function lanesForLevel(level){
    const L = Math.min(level, 4);
    switch(L){
      case 0: return { easy:[0.56,0.50], mix:[0.865] };
      case 1: return { easy:[0.58,0.50,0.44], mix:[0.84,0.78] };
      case 2: return { easy:[0.60,0.52,0.46], mix:[0.86,0.80,0.74,0.38] };
      case 3: return { easy:[0.62,0.54,0.48], mix:[0.88,0.84,0.78,0.72,0.36] };
      default:return { easy:[0.64,0.56,0.50], mix:[0.88,0.84,0.80,0.74,0.70,0.34] };
    }
  }
  const jitter = (base, j=0.016)=> clamp(base + rand(-j,j), 0.14, 0.98);
  const snapNearGrass = y => (y>0.90 ? 0.885 : y);
  function speedForLevel(level){ const base=0.0011, per=0.00038; return base + per*Math.min(level,6); }
  const skySpeed    = lvl => speedForLevel(lvl) * 0.45;
  const groundSpeed = lvl => speedForLevel(lvl) * 0.95;
  const playerXForLevel = lvl => clamp(0.44 + 0.035*lvl, 0.44, 0.58);

  const playerImg = new Image();
  playerImg.src = "https://github.com/kathy-torfs/Orthodoxeweg/raw/main/images/photeinos_walk.png";

  const FLOWERS = ["üå∑","üåπ","üåª","üåº","üå∫","üå∏","üåæ","üåø","üçÄ","üå±"];

  function fit(){
    const dpr = window.devicePixelRatio || 1;
    const rect = cvs.getBoundingClientRect();
    cvs.width  = rect.width * dpr;
    cvs.height = rect.height * dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  new ResizeObserver(fit).observe(cvs); fit();

  // ===== Spel-state =====
  let started = false;
  let level = 0;
  let scoreLevel = 0;
  let scoreTotal = 0;

  let showQuestion = false;
  let awaitLastWing = false;

  let pY = 1.0, prevPY = 1.0, vY = 0;
  const gravity = 0.0092, flapImpulse = -0.10, maxUp=-0.16, maxDown=0.155;

  let clouds = [];
  let flowers = [];
  let obstacles = [];
  let wingsCaught = 0, wingsTarget = 0;

  function regenClouds(){
    const r=[]; for(let i=0;i<6;i++) r.push({x:Math.random(), y:0.06+Math.random()*0.28, s:18+((Math.random()*16)|0)});
    return r;
  }
  function regenFlowers(){
    const out=[]; const minDx=0.07;
    for(let i=0;i<90 && out.length<28;i++){
      const fx=Math.random(), fy=0.81+Math.random()*0.15, fs=12+((Math.random()*9)|0);
      const g=FLOWERS[(Math.random()*FLOWERS.length)|0];
      if(!out.some(o=>Math.abs(o.x-fx)<minDx && Math.abs(o.y-fy)<0.045)) out.push({x:fx,y:fy,s:fs,g});
    }
    return out;
  }

  function updateHud(){
    hud.textContent = `Level ${level+1}/${LEVELS.length} ‚Ä¢ Vleugels ${wingsCaught}/${wingsTarget} ‚Ä¢ Score ${scoreLevel} ‚Ä¢ Totaal ${scoreTotal}`;
  }
  function showFeedback(text, ok=true){
    feedback.textContent = text;
    feedback.style.display = 'block';
    feedback.style.color = ok ? '#065f46' : '#7f1d1d';
    setTimeout(()=> feedback.style.display='none', 900);
  }

  function loadLevel(lvl){
    scoreLevel = 0;
    wingsCaught = 0;
    awaitLastWing = false;
    pY = 1.0; prevPY = 1.0; vY = 0;

    clouds  = regenClouds();
    flowers = regenFlowers();

    const lanes = lanesForLevel(lvl);
    const wingsNeeded = LEVELS[lvl].wings;
    wingsTarget = wingsNeeded;

    const total = wingsNeeded + Math.max(2, Math.floor(wingsNeeded * (0.55 + 0.1 * Math.min(lvl,4))));
    const minDelta = 0.22 - 0.02*Math.min(lvl,4);
    const lanesAll = [...lanes.easy, ...lanes.mix];
    const pLight = (lvl<=0?0.72:lvl===1?0.64:lvl===2?0.56:lvl===3?0.50:0.46);

    obstacles = [];
    let lastX = 1.10;
    let wingsInARow = 0;

    for(let i=0;i<total;i++){
      const forceSkull = wingsInARow>=2;
      const isLight = forceSkull ? false : Math.random()<pLight;
      wingsInARow = isLight? wingsInARow+1 : 0;

      const baseLane = (lvl<2)
        ? (isLight ? lanes.easy[(Math.random()*lanes.easy.length)|0] : lanes.mix[(Math.random()*lanes.mix.length)|0])
        : lanesAll[(Math.random()*lanesAll.length)|0];

      const y = snapNearGrass(jitter(baseLane));
      lastX += minDelta + Math.random()*0.10;

      obstacles.push({ x:lastX, y, type: isLight ? "light" : "skull", active:true });
    }
    // minimaal voldoende vleugels
    let have = obstacles.filter(o=>o.type==="light").length;
    for(let i=0;i<obstacles.length && have<wingsNeeded;i++){
      if(obstacles[i].type!=="light"){ obstacles[i].type="light"; have++; }
    }
    updateHud();
  }

  // ---- PUNTEN: start kost 20, per level +2 ----
  async function tryStartWithCost(){
    // zorg dat punten geladen zijn
    const punten = await haalPunten();
    if(punten < 20){
      alert("Je hebt niet genoeg lichtjes om te starten. (20 nodig)");
      return false;
    }
    // trek 20 af (optimistisch + Firestore)
    await updatePunten(-20);
    return true;
  }
  async function rewardLevel(){
    await updatePunten(+2);
  }

  async function startGame(){
    // check & betaal
    startBtn.disabled = true;
    const ok = await tryStartWithCost();
    startBtn.disabled = false;
    if(!ok) return;

    scoreTotal = 0;
    level = 0;
    started = true;
    endOverlay.style.display = 'none';
    startOverlay.style.display = 'none';
    loadLevel(0);
  }

  function nextLevel(){
    scoreTotal += scoreLevel;
    rewardLevel(); // +2 punten bij elk gehaald level
    if(level + 1 < LEVELS.length){
      level += 1;
      loadLevel(level);
    } else {
      started = false;
      endText.textContent = `Je totale score: ${scoreTotal} lichtjes!`;
      endOverlay.style.display = 'grid';
    }
  }

  // ===== Vragen =====
  function askLight(){
    const item = LIGHT_QUESTIONS[(Math.random()*LIGHT_QUESTIONS.length)|0];
    qText.textContent = item.q;
    qAns.className = 'answers';
    qAns.innerHTML = '';
    item.opts.forEach((o,idx)=>{
      const b = document.createElement('button');
      b.className = 'btn';
      b.textContent = o;
      b.onclick = () => {
        if(idx === item.ok){ scoreLevel++; showFeedback('Goed gedaan! +1', true); }
        else { showFeedback('Jammer! Niet juist.', false); }
        closeQuestion();
      };
      qAns.appendChild(b);
    });
    qModal.style.display = 'grid';
    showQuestion = true;
  }
  function askSin(){
    const item = SIN_QUESTIONS[(Math.random()*SIN_QUESTIONS.length)|0];
    qText.textContent = item.q;
    qAns.className = 'answers two';
    qAns.innerHTML = '';
    ['Ja','Nee'].forEach((o,idx)=>{
      const b = document.createElement('button');
      b.className = 'btn';
      b.textContent = o;
      b.onclick = () => {
        if(idx === item.ok){ // ok=1 (Nee)
          showFeedback('Juist! Dat mag niet.', true);
          closeQuestion();
        } else {
          showFeedback('Helaas, dat was fout! Probeer opnieuw.', false);
          closeQuestion();
          started = false;
          endText.textContent = `Je totale score: ${scoreTotal} lichtjes!`;
          endOverlay.style.display = 'grid';
        }
      };
      qAns.appendChild(b);
    });
    qModal.style.display = 'grid';
    showQuestion = true;
  }
  function closeQuestion(){
    qModal.style.display = 'none';
    showQuestion = false;
    if(!started) return;
    if(!showQuestion && awaitLastWing && wingsCaught >= wingsTarget){
      awaitLastWing = false;
      nextLevel();
    }
    updateHud();
  }

  // ===== Input =====
  function flap(){ if(!started || showQuestion) return; vY = Math.max(maxUp, vY + flapImpulse); }
  window.addEventListener('keydown', e=>{ if(e.code==='Space'){ e.preventDefault(); flap(); } }, {passive:false});
  document.getElementById('gameRoot').addEventListener('mousedown', flap);
  document.getElementById('gameRoot').addEventListener('touchstart', e=>{ e.preventDefault(); flap(); }, {passive:false});

  startBtn.onclick = startGame;
  againBtn.onclick = startGame;

  // ===== Loop =====
  function loop(t){
    const W = cvs.clientWidth, H = cvs.clientHeight;
    ctx.fillStyle = LEVELS[level]?.sky || '#B3E5FC';
    ctx.fillRect(0,0,W,H);

    if(started && !showQuestion){
      prevPY = pY;
      vY *= 0.985; vY += gravity; vY = clamp(vY, maxUp, maxDown);
      pY = clamp(pY + vY, 0.10, 1.00);

      const dx = speedForLevel(level);
      for(const c of clouds){ c.x -= skySpeed(level); if(c.x < -0.10) c.x = 1.10; }
      for(const f of flowers){ f.x -= groundSpeed(level); if(f.x < -0.05) f.x = 1.05; }
      for(const o of obstacles){
        if(!o.active){ o.x = -1; continue; }
        o.x -= dx;
        if(o.x <= -0.10) o.x += 1.40;
      }

      const xCenter = playerXForLevel(level);
      const halfLight = 0.060, halfSkull = 0.038;
      const phY = clamp(pY + 0.032, 0, 1);
      const prevPhY = clamp(prevPY + 0.032, 0, 1);
      const segMin = Math.min(prevPhY, phY), segMax = Math.max(prevPhY, phY);

      for(let i=0;i<obstacles.length;i++){
        const o = obstacles[i]; if(!o.active) continue;
        const xMin = (o.type==='light' ? xCenter-halfLight : xCenter-halfSkull);
        const xMax = (o.type==='light' ? xCenter+halfLight : xCenter+halfSkull);
        const binnenX = o.x >= xMin && o.x <= xMax;
        const wingPad = (o.type==='light' && o.y>=0.84) ? 0.070 : 0.042;
        const skullPad = 0.030;
        const raak = (o.type==='light')
          ? (binnenX && (o.y >= segMin - wingPad && o.y <= segMax + wingPad))
          : (binnenX && (o.y >= segMin - skullPad && o.y <= segMax + skullPad));
        if(raak){
          o.active = false; o.x = -1;
          if(o.type === 'light'){
            wingsCaught++;
            const isLast = wingsCaught >= wingsTarget;
            awaitLastWing = isLast;
            askLight();
          } else {
            askSin();
          }
          break;
        }
      }

      if(!showQuestion && !awaitLastWing && wingsCaught >= wingsTarget){
        nextLevel();
      }
      updateHud();
    }

    // Wolken
    ctx.save();
    for(const c of clouds){ ctx.font = `${c.s}px serif`; ctx.fillText('‚òÅÔ∏è', c.x*W, c.y*H); }
    ctx.restore();

    // Gras
    const grassH = 0.22 * H;
    ctx.fillStyle = '#9CCC65';
    ctx.fillRect(0, H - grassH, W, grassH);

    // Bloemen
    ctx.save();
    for(const f of flowers){ ctx.font = `${f.s}px serif`; ctx.fillText(f.g, f.x*W, f.y*H); }
    ctx.restore();

    // Obstakels
    ctx.save();
    ctx.font = `${H*0.08}px serif`;
    for(const o of obstacles){ const emoji = o.type==='light' ? 'ü™Ω' : 'üíÄ'; ctx.fillText(emoji, o.x*W, o.y*H); }
    ctx.restore();

    // Speler
    const px = playerXForLevel(level)*W, pyPix = (0.10 + 0.70*pY)*H;
    const size = H*0.20;
    if(playerImg.complete){
      ctx.drawImage(playerImg, px - size*0.5, pyPix - size*0.5, size, size);
    } else {
      ctx.save(); ctx.fillStyle = '#1e293b'; ctx.beginPath(); ctx.arc(px, pyPix, size*0.35, 0, Math.PI*2); ctx.fill(); ctx.restore();
    }

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  // Overlays init
  startOverlay.style.display = 'grid';
  endOverlay.style.display = 'none';
  updateHud();
})();
</script>
</body>
</html>
