<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bijbelverhalen – Orthodoxe Kinderpagina</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png" />

  <style>
    :root{
      --primair:#7bb235; --donker:#67510C;
      --pastel1:#fff6e5; --pastel2:#fffde6; --pastel3:#ffe8ec; --pastel4:#e7f8ff;
      --pastel5:#e6ffe5; --pastel6:#fff2fb; --pastel7:#f5ffe5; --pastel8:#f5e8ff;
      --pastel9:#fff6fb; --pastel10:#e7fff9; --pastel11:#f3e6ff; --pastel12:#ffeae6;
      --pastel13:#ecffe9; --pastel14:#f7fff3; --pastel15:#eafffa; --pastel16:#fff4ea;
      --kaart:#fffef9; --rand:#f1e6c8; --tekst:#3b2f12;
    }
    body{
      margin:0; font-family:'Comic Sans MS', Arial, sans-serif; color:var(--tekst);
      min-height:100vh; background:var(--pastel1); transition:background .6s;
    }

    main{ max-width: 980px; margin: 16px auto 60px auto; padding: 0 2vw; }

    .intro{
      background:#fffdf5; border:1.5px solid var(--rand); border-radius:18px;
      box-shadow:0 6px 22px rgba(0,0,0,.06);
      padding:16px 18px; margin:6px auto 18px auto; text-align:center; color:#56461e;
    }
    .intro b{ color:var(--primair); }

    .story{
      background:var(--kaart);
      border:1.5px solid var(--rand);
      border-radius:20px;
      box-shadow:0 8px 26px rgba(0,0,0,.06);
      padding:18px 18px 20px 18px;
      opacity:0; transform:translateY(14px) scale(.98);
      animation: storyIn .6s ease forwards;
    }
    .story h2{
      margin:0 0 8px 0; font-size:1.25rem; color:#684d16;
    }
    .story .tekst{
      white-space:pre-line; line-height:1.55; font-size:1.02rem; color:#3d3218;
    }

    @keyframes storyIn{
      to{ opacity:1; transform:translateY(0) scale(1); }
    }

    .label{
      display:inline-block; background:#fff1c7; border:1px solid #f1d188; color:#7a4d00;
      padding:6px 12px; border-radius:999px; font-weight:bold; font-size:.92rem;
      margin:8px 0 6px 2px;
    }

    .loading{
      text-align:center; color:#7a6b42; padding:22px 8px; font-size:1.05rem;
    }

    #nav{
      text-align:center; margin-top:20px; display:flex; justify-content:center; gap:14px;
    }
    #nav button{
      padding:10px 20px; font-size:1rem; border:none; border-radius:10px;
      background:#7bb235; color:white; cursor:pointer;
      box-shadow:0 3px 6px rgba(0,0,0,.2);
    }
    #nav button[disabled]{
      background:#cccccc; cursor:default; box-shadow:none;
    }

    @media (max-width: 600px){
      .story{ padding:14px; }
      .story h2{ font-size:1.14rem; }
      .story .tekst{ font-size:1rem; }
    }
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <!-- Header + beveiliging -->
  <script defer src="common/layout.js"></script>
</head>
<body>
  <!-- Header wordt hier ingeladen -->
  <div id="kinder-header" data-header-src="common/header.html"></div>

  <main>
    <div class="intro">
      <b>Welkom!</b> Hieronder vind je mooie bijbelverhalen. Je leest ze één voor één —
      gebruik de knoppen om verder of terug te gaan. ✨
    </div>

    <div class="label">Bijbelverhalen</div>
    <div id="stories"></div>
    <div id="loader" class="loading">Laden…</div>

    <!-- Navigatieknoppen -->
    <div id="nav" style="display:none;">
      <button id="prevBtn">⬅ Vorige</button>
      <button id="nextBtn">Volgende ➡</button>
    </div>
  </main>

  <script>
    // Random pastelachtergrond
    (function(){
      const p=['var(--pastel1)','var(--pastel2)','var(--pastel3)','var(--pastel4)','var(--pastel5)','var(--pastel6)','var(--pastel7)','var(--pastel8)','var(--pastel9)','var(--pastel10)','var(--pastel11)','var(--pastel12)','var(--pastel13)','var(--pastel14)','var(--pastel15)','var(--pastel16)'];
      document.body.style.background = p[Math.floor(Math.random()*p.length)];
    })();

    // wachten tot layout.js klaar is
    (function boot(){
      if (!(window.KinderLayout && window.firebase)) return setTimeout(boot, 120);
      const el = document.getElementById('kinder-header');
      window.KinderLayout.mountHeader({
        rootId: 'kinder-header',
        headerSrc: el.dataset.headerSrc,
        active: 'bijbel'
      }).then(loadStories).catch(loadStories);
    })();

    let verhalen = [];
    let huidigeIndex = 0;

    async function loadStories(){
      try{
        if (!firebase.apps.length) {
          firebase.initializeApp({
            apiKey:"AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
            authDomain:"orthodoxeweg.firebaseapp.com",
            projectId:"orthodoxeweg",
            storageBucket:"orthodoxeweg.appspot.com",
            messagingSenderId:"408582263618",
            appId:"1:408582263618:web:0a20f4bf0704989d3ceedb"
          });
        }
        const db = firebase.firestore();

        const snap = await db.collection('VlaamsOrthodoxekinderdagboek')
                             .orderBy(firebase.firestore.FieldPath.documentId())
                             .get();

        snap.forEach(doc => {
          const d = doc.data() || {};
          const titel = d.titel || d.Titel || `Verhaal ${doc.id}`;
          const tekst = d.tekst || d.verhaal || d.content || d.beschrijving || "";
          if (String(tekst).trim().length) {
            verhalen.push({ titel, tekst: String(tekst) });
          }
        });

        document.getElementById('loader').style.display = 'none';

        if (verhalen.length){
          document.getElementById('nav').style.display = 'flex';

          // haal laatst gelezen index uit localStorage
          const savedIndex = parseInt(localStorage.getItem("bijbelverhaalIndex"));
          if (!isNaN(savedIndex) && savedIndex >= 0 && savedIndex < verhalen.length){
            huidigeIndex = savedIndex;
          }
          toonVerhaal(huidigeIndex);
        } else {
          document.getElementById('loader').textContent = "Er zijn nog geen bijbelverhalen toegevoegd.";
        }

      }catch(e){
        console.error(e);
        document.getElementById('loader').textContent = "Kon de verhalen niet laden. Probeer later opnieuw.";
      }
    }

    function toonVerhaal(index){
      const root = document.getElementById('stories');
      root.innerHTML = "";
      if (index < verhalen.length){
        const { titel, tekst } = verhalen[index];
        root.innerHTML = `
          <article class="story">
            <h2>${escapeHtml(titel)}</h2>
            <div class="tekst">${sanitizeTextWithBr(tekst)}</div>
          </article>
        `;
        // onthoud waar het kind gebleven is
        localStorage.setItem("bijbelverhaalIndex", index);
      }

      // knoppen updaten
      document.getElementById('prevBtn').disabled = (index <= 0);
      document.getElementById('nextBtn').disabled = (index >= verhalen.length - 1);
    }

    document.getElementById('prevBtn').addEventListener('click', () => {
      if (huidigeIndex > 0){
        huidigeIndex--;
        toonVerhaal(huidigeIndex);
      }
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (huidigeIndex < verhalen.length - 1){
        huidigeIndex++;
        toonVerhaal(huidigeIndex);
      }
    });

    function sanitizeTextWithBr(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/&lt;br\s*\/?&gt;/gi,'<br>');
    }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;');
    }
  </script>
</body>
</html>
