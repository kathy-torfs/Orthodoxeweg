<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Noach's Ark Memory – Orthodoxe Kinderpagina</title>
  <link rel="icon" href="../images/kruis.png" />

  <style>
    :root{
      --primair:#7bb235; --donker:#67510C;
      --pastel1:#fff6e5; --pastel2:#fffde6; --pastel3:#ffe8ec; --pastel4:#e7f8ff;
      --pastel5:#e6ffe5; --pastel6:#fff2fb; --pastel7:#f5ffe5; --pastel8:#f5e8ff;
      --pastel9:#fff6fb; --pastel10:#e7fff9; --pastel11:#f3e6ff; --pastel12:#ffeae6;
      --pastel13:#ecffe9; --pastel14:#f7fff3; --pastel15:#eafffa; --pastel16:#fff4ea;
    }
    body{
      margin:0; font-family:'Comic Sans MS', Arial, sans-serif; color:#333;
      min-height:100vh; background:var(--pastel1); transition:background .6s;
    }
    main{ max-width:1000px; margin:20px auto; padding:0 16px; text-align:center }

    #gameWrapper{
      position:relative;
      margin:20px auto;
      width:90%; max-width:900px;
      min-height:600px;
      background:url("../images/arkvannoah.png") center top/contain no-repeat;
      background-color:#e0f7fa;
      border-radius:12px;
      box-shadow:0 4px 10px rgba(0,0,0,0.25);
      overflow:hidden;
      padding-top:200px; /* ruimte voor de boot */
      display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
    }

    #gameBoard{
      display:grid; grid-gap:12px; justify-content:center; margin-top:20px;
      z-index:10;
    }

    .card{
      width:80px; height:80px; background:#7bb235; border-radius:8px;
      cursor:pointer; display:flex; align-items:center; justify-content:center;
      font-size:42px; font-weight:bold; color:#fff; transition: transform 0.3s;
    }
    .flipped{ background:#fff; color:#000; cursor:default; }

    #status{ margin:12px 0; font-weight:bold; z-index:20; position:relative; }
    .btn{
      background:var(--primair); color:#fff; border:none; border-radius:8px;
      padding:8px 14px; font-weight:bold; cursor:pointer; margin:4px;
    }

    /* Water */
    #water{
      position:absolute;
      bottom:0; left:0;
      width:100%; height:0;
      background:rgba(0,150,255,0.6);
      z-index:5;
      transition: height 8s linear;
    }
    #water.stijgt{ height:100%; }

    /* Regen */
    #regen{
      position:absolute;
      top:0; left:0; width:100%; height:100%;
      pointer-events:none; overflow:hidden; z-index:8;
    }
    .druppel{
      position:absolute; width:2px; height:12px;
      background:rgba(0,0,255,0.4); border-radius:1px;
      animation: vallen linear infinite;
    }
    @keyframes vallen{
      from{ transform:translateY(-20px); }
      to{ transform:translateY(110%); }
    }
    #regen.hevig .druppel{ background:rgba(0,0,180,0.7); height:16px; }

    /* Game over bericht */
    #gameOverMsg{
      position:absolute;
      top:40%; left:50%; transform:translate(-50%,-50%);
      background:rgba(255,255,255,0.9);
      padding:16px 24px; border-radius:12px;
      font-size:1.4em; font-weight:bold;
      z-index:200; display:none;
    }
  </style>

  <script defer src="common/layout.js"></script>
</head>
<body>
  <div id="kinder-header" data-header-src="common/header.html"></div>

  <main>
    <h1>Noach's Ark Memory 🛶🌈</h1>
    <div>
      <button id="startBtn" class="btn">Spel starten (20 punten)</button>
      <button id="resetBtn" class="btn" style="display:none;">Opnieuw spelen</button>
      <button id="pauseBtn" class="btn" style="display:none;">Pauze</button>
    </div>
    <div id="timer"></div>

    <div id="gameWrapper">
      <div id="gameBoard"></div>
      <div id="status"></div>
      <div id="water"></div>
      <div id="regen"></div>
      <div id="gameOverMsg"></div>
    </div>
  </main>

  <script>
    const animals=["🐶","🐱","🐭","🐰","🦊","🐻","🐼","🐨","🦁","🐯","🐮","🐷","🐸","🐵","🐔"];
    const levels=[
      {pairs:2,time:40},{pairs:4,time:60},{pairs:6,time:90},
      {pairs:8,time:120},{pairs:10,time:150},{pairs:15,time:180}
    ];

    let currentLevel=0, matches=0, totalPairs=0;
    let firstCard=null, lock=false;
    let timerId=null, timeLeft=0, paused=false;

    function startRain(hevig=false){
      const regen=document.getElementById("regen");
      regen.innerHTML=""; regen.className=hevig?"hevig":"";
      const druppels=hevig?100:40;
      for(let i=0;i<druppels;i++){
        const d=document.createElement("div");
        d.className="druppel";
        d.style.left=Math.random()*100+"%";
        d.style.animationDuration=(Math.random()*1+0.5)+"s";
        d.style.animationDelay=(Math.random()*2)+"s";
        regen.appendChild(d);
      }
    }
    function stopRain(){ document.getElementById("regen").innerHTML=""; }

    function gameOver(){
      document.getElementById("water").classList.add("stijgt");
      startRain(true);
      const msg=document.getElementById("gameOverMsg");
      msg.style.display="block";
      msg.textContent="De ark liep vol water… probeer opnieuw! 🌊";
    }

    function startLevel(){
      const {pairs,time}=levels[currentLevel];
      createBoard(pairs);
      timeLeft=time; updateTimer();
      timerId=setInterval(()=>{
        if(!paused){
          timeLeft--; updateTimer();
          if(timeLeft===Math.floor(time/2)) startRain(false);
          if(timeLeft<=0){
            clearInterval(timerId); gameOver(); lock=true;
          }
        }
      },1000);
    }

    function createBoard(pairs){
      const gameBoard=document.getElementById("gameBoard");
      gameBoard.innerHTML="";
      totalPairs=pairs; matches=0; firstCard=null; lock=false;

      // reset water + regen + bericht
      document.getElementById("water").classList.remove("stijgt");
      document.getElementById("water").style.height="0";
      stopRain();
      document.getElementById("gameOverMsg").style.display="none";

      const deck=[...animals.slice(0,pairs),...animals.slice(0,pairs)].sort(()=>Math.random()-0.5);
      const cols=pairs<=4?4:pairs<=8?5:6;
      gameBoard.style.gridTemplateColumns=`repeat(${cols},80px)`;

      deck.forEach(animal=>{
        const card=document.createElement("div");
        card.className="card"; card.dataset.symbol=animal;
        card.addEventListener("click",()=>flipCard(card));
        gameBoard.appendChild(card);
      });
      status(`Level ${currentLevel+1} – Zoek de paren!`);
    }

    function flipCard(card){
      if(lock || paused || card.classList.contains("flipped")) return;
      card.textContent=card.dataset.symbol;
      card.classList.add("flipped");
      if(!firstCard){
        firstCard=card;
      }else{
        if(firstCard.dataset.symbol===card.dataset.symbol){
          firstCard=null; matches++;
          if(matches===totalPairs){
            clearInterval(timerId); stopRain();
            if(currentLevel<levels.length-1){
              currentLevel++; status("Goed gedaan! Op naar level "+(currentLevel+1));
              setTimeout(startLevel,2000);
            }else{ status("Fantastisch! Alle dieren zijn veilig in de Ark 🎉"); }
          }
        }else{
          lock=true;
          setTimeout(()=>{
            firstCard.textContent=""; firstCard.classList.remove("flipped");
            card.textContent=""; card.classList.remove("flipped");
            firstCard=null; lock=false;
          },800);
        }
      }
    }

    function status(msg){ document.getElementById("status").textContent=msg; }
    function updateTimer(){ document.getElementById("timer").textContent="⏳ Tijd: "+timeLeft+"s"; }

    // Firestore punten
    async function getUserPoints(){
      const db=firebase.firestore();
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(!parochieId||!ouderLogin||!kindId)return 0;
      const ref=db.collection("parochies").doc(parochieId).collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId);
      const snap=await ref.get(); return snap.exists?(snap.data().punten||0):0;
    }
    async function deductPoints(amount){
      const db=firebase.firestore();
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(!parochieId||!ouderLogin||!kindId)return;
      const ref=db.collection("parochies").doc(parochieId).collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId);
      await db.runTransaction(async tx=>{
        const snap=await tx.get(ref);
        if(!snap.exists)return;
        const current=snap.data().punten||0;
        if(current>=amount) tx.update(ref,{punten:current-amount});
      });
    }

    // Start & Reset & Pauze
    document.getElementById("startBtn").addEventListener("click",async()=>{
      const points=await getUserPoints();
      if(points<20){ alert("Niet genoeg punten om te spelen!"); return; }
      await deductPoints(20);
      document.getElementById("startBtn").style.display="none";
      document.getElementById("resetBtn").style.display="inline-block";
      document.getElementById("pauseBtn").style.display="inline-block";
      currentLevel=0; startLevel();
    });
    document.getElementById("resetBtn").addEventListener("click",()=>location.reload());
    document.getElementById("pauseBtn").addEventListener("click",()=>{
      paused=!paused;
      document.getElementById("pauseBtn").textContent=paused?"Hervatten":"Pauze";
      status(paused?"Pauze – neem even rust":"Ga verder met spelen!");
    });
  </script>
</body>
</html>
