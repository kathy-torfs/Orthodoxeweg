<!DOCTYPE html> 
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Molenspel â€“ Orthodoxe Kinderpagina</title>
  <link rel="icon" href="images/kruis.png" />

  <style>
    :root{
      --primair:#7bb235; --donker:#67510C;
      --pastel1:#fff6e5; --pastel2:#fffde6; --pastel3:#ffe8ec; --pastel4:#e7f8ff;
      --pastel5:#e6ffe5; --pastel6:#fff2fb; --pastel7:#f5ffe5; --pastel8:#f5e8ff;
      --pastel9:#fff6fb; --pastel10:#e7fff9; --pastel11:#f3e6ff; --pastel12:#ffeae6;
      --pastel13:#ecffe9; --pastel14:#f7fff3; --pastel15:#eafffa; --pastel16:#fff4ea;
    }
    body{
      margin:0; font-family:'Comic Sans MS', Arial, sans-serif; color:#333;
      min-height:100vh; background:var(--pastel1); transition:background .6s;
    }
    main{ max-width:1000px; margin:20px auto; padding:0 16px; text-align:center }

    #boardWrapper{
      display:inline-block;
      margin-top:12px;
      background:#eee;
      padding:10px;
      border-radius:12px;
      box-shadow:0 4px 10px rgba(0,0,0,0.25);
    }
    svg{ width:90vmin; height:90vmin; max-width:600px; max-height:600px }

    .point{
      fill:#fff;
      stroke:#333;
      stroke-width:2;
      cursor:pointer;
    }
    .point.player{ fill:#e53935; }
    .point.computer{ fill:#fbc02d; }
    .point.selected{ stroke:#000; stroke-width:4; }
    .point.highlight{ stroke:#000; stroke-width:4; animation: blink 0.6s linear infinite; }

    @keyframes blink {
      0%, 50%, 100% { filter: brightness(1.2); }
      25%, 75% { filter: brightness(0.6); }
    }

    #status{ margin-top:12px; font-weight:bold }
    .btn{
      background:var(--primair); color:#fff; border:none; border-radius:8px;
      padding:8px 14px; font-weight:bold; cursor:pointer;
      margin:4px;
    }
  </style>

  <script defer src="common/layout.js"></script>
</head>
<body>
  <div id="kinder-header" data-header-src="common/header.html"></div>

  <main>
    <h1>Molenspel</h1>

    <div>
      Moeilijkheid:
      <select id="difficulty">
        <option value="easy">Makkelijk</option>
        <option value="normal" selected>Normaal</option>
        <option value="hard">Moeilijk</option>
      </select>
    </div>

    <div>
      <button id="startBtn" class="btn">Spel starten (20 punten)</button>
      <button id="resetBtn" class="btn" style="display:none;">Opnieuw spelen</button>
    </div>

    <div id="boardWrapper" style="display:none;">
      <svg id="board" viewBox="0 0 600 600">
        <!-- 3 vierkanten -->
        <rect x="50" y="50" width="500" height="500" fill="none" stroke="#000" stroke-width="2"/>
        <rect x="150" y="150" width="300" height="300" fill="none" stroke="#000" stroke-width="2"/>
        <rect x="250" y="250" width="100" height="100" fill="none" stroke="#000" stroke-width="2"/>
        <!-- verbindingslijnen -->
        <line x1="300" y1="50" x2="300" y2="250" stroke="#000" stroke-width="2"/>
        <line x1="300" y1="350" x2="300" y2="550" stroke="#000" stroke-width="2"/>
        <line x1="50" y1="300" x2="250" y2="300" stroke="#000" stroke-width="2"/>
        <line x1="350" y1="300" x2="550" y2="300" stroke="#000" stroke-width="2"/>
      </svg>
    </div>
    <div id="status"></div>
  </main>

  <script>
    // Achtergrond
    (function(){
      const p=['var(--pastel1)','var(--pastel2)','var(--pastel3)','var(--pastel4)','var(--pastel5)',
               'var(--pastel6)','var(--pastel7)','var(--pastel8)','var(--pastel9)','var(--pastel10)',
               'var(--pastel11)','var(--pastel12)','var(--pastel13)','var(--pastel14)','var(--pastel15)','var(--pastel16)'];
      document.body.style.background=p[Math.floor(Math.random()*p.length)];
    })();

    // Header
    (function boot(){
      if (!(window.KinderLayout)) return setTimeout(boot,120);
      const el=document.getElementById('kinder-header');
      window.KinderLayout.mountHeader({ rootId:'kinder-header', headerSrc:el.dataset.headerSrc, active:'spelletjes' });
    })();

    // Bordconfiguratie
    const positions=[[50,50],[300,50],[550,50],[150,150],[300,150],[450,150],[250,250],[300,250],[350,250],
      [50,300],[150,300],[250,300],[350,300],[450,300],[550,300],[250,350],[300,350],[350,350],
      [150,450],[300,450],[450,450],[50,550],[300,550],[550,550]];
    const adj={0:[1,9],1:[0,2,4],2:[1,14],3:[4,10],4:[1,3,5,7],5:[4,13],6:[7,11],7:[4,6,8],8:[7,12],
      9:[0,10,21],10:[3,9,11,18],11:[6,10,15],12:[8,13,17],13:[5,12,14,20],14:[2,13,23],
      15:[11,16],16:[15,17,19],17:[12,16],18:[10,19],19:[16,18,20,22],20:[13,19],
      21:[9,22],22:[19,21,23],23:[14,22]};
    const mills=[[0,1,2],[3,4,5],[6,7,8],[15,16,17],[18,19,20],[21,22,23],
      [0,9,21],[3,10,18],[6,11,15],[1,4,7],[16,19,22],[8,12,17],
      [5,13,20],[2,14,23],[9,10,11],[12,13,14]];

    const boardSvg=document.getElementById('board');
    let stones={}, placed={player:0,computer:0}, current="player", gameOver=false;
    let selected=null, phase="placing"; let mustRemove=null;
    let difficulty="normal"; // default

    document.getElementById("difficulty").addEventListener("change",e=>{
      difficulty=e.target.value;
    });

    function drawPoints(){
      positions.forEach((p,i)=>{
        const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
        c.setAttribute("cx",p[0]); c.setAttribute("cy",p[1]); c.setAttribute("r",14);
        c.classList.add("point"); c.dataset.id=i;
        c.addEventListener("click",()=>onClick(i));
        boardSvg.appendChild(c);
        stones[i]=null;
      });
    }

    function onClick(id){
      if(gameOver||current!=="player")return;
      if(mustRemove==="playerRemove"){
        if(stones[id]!=="computer")return;
        stones[id]=null; mustRemove=null;
        updateBoard(); if(gameOver) return;
        current="computer"; status("Computer is aan zet..."); setTimeout(computerMove,600);
        return;
      }

      if(phase==="placing"){
        if(stones[id])return;
        stones[id]="player"; placed.player++;
        updateBoard(); if(gameOver) return;
        if(checkMill("player",id)){
          if(Object.values(stones).filter(s=>s==="computer").length>0){
            mustRemove="playerRemove";
            status("Je hebt een molen! Neem een gele steen weg");
            return;
          }
        }
        if(placed.player>=9 && placed.computer>=9){ phase="moving"; status("Alle stenen geplaatst, verschuiven!"); }
        current="computer"; status("Computer is aan zet..."); setTimeout(computerMove,600);
      } else if(phase==="moving"){
        if(!selected){
          if(stones[id]!=="player")return;
          selected=id; highlight(id);
        } else {
          if(stones[id]){ unselect(); return; }
          if(!adj[selected].includes(id)){ unselect(); return; }
          stones[id]="player"; stones[selected]=null;
          unselect(); updateBoard(); if(gameOver) return;
          if(checkMill("player",id)){
            if(Object.values(stones).filter(s=>s==="computer").length>0){
              mustRemove="playerRemove";
              status("Je hebt een molen! Neem een gele steen weg");
              return;
            }
          }
          current="computer"; status("Computer is aan zet..."); setTimeout(computerMove,600);
        }
      }
    }

    function findMoveSmart(who){
      const empty=Object.keys(stones).filter(k=>!stones[k]);
      for(const id of empty){
        stones[id]=who;
        if(checkMill(who,id)){ stones[id]=null; return parseInt(id); }
        stones[id]=null;
      }
      return null;
    }

    function findWinningMoveNear(from,who){
      const opts=adj[from].filter(n=>!stones[n]);
      for(const id of opts){
        stones[id]=who;
        if(checkMill(who,id)){ stones[id]=null; return id; }
        stones[id]=null;
      }
      return null;
    }

    function pickBestMove(from,opts){
      let best=null, score=-1;
      for(const id of opts){
        let s=0;
        mills.forEach(m=>{
          if(m.includes(parseInt(id))){
            const count=m.filter(i=>stones[i]==="computer").length;
            const empty=m.filter(i=>!stones[i]).length;
            if(count===2 && empty===1) s+=2;
            if(count===1 && empty===2) s+=1;
          }
        });
        if(s>score){ score=s; best=id; }
      }
      return best;
    }

    function computerMove(){
      if(mustRemove==="computerRemove"){
        const targets=Object.keys(stones).filter(k=>stones[k]==="player");
        if(targets.length){
          const pick=targets[Math.floor(Math.random()*targets.length)];
          stones[pick]=null;
          updateBoard();
          status("De computer heeft een molen en neemt jouw steen weg!");
        }
        mustRemove=null; updateBoard();
        mustRemove=null; if(gameOver) return;
        current="player"; status("Jij bent aan zet"); return;
      }

      if(phase==="placing"){
        let choice;
        if(difficulty==="easy"){
          const empty=Object.keys(stones).filter(k=>!stones[k]);
          choice=empty[Math.floor(Math.random()*empty.length)];
        } else {
          choice=findMoveSmart("computer");
          if(choice===null) choice=findMoveSmart("player");
          if(choice===null){
            const empty=Object.keys(stones).filter(k=>!stones[k]);
            choice=empty[Math.floor(Math.random()*empty.length)];
          }
        }
        stones[choice]="computer"; placed.computer++;
        updateBoard();
        updateBoard(); if(gameOver) return;
        if(checkMill("computer",choice)){
          if(Object.values(stones).filter(s=>s==="player").length>0){
            mustRemove="computerRemove";
            status("De computer heeft een molen!"); return;
          const targets=Object.keys(stones).filter(k=>stones[k]==="player");
          if(targets.length){
            const pick=targets[Math.floor(Math.random()*targets.length)];
            stones[pick]=null;
            updateBoard();
            status("De computer heeft een molen en neemt jouw steen weg!");
          }
        }
        if(placed.player>=9 && placed.computer>=9){ phase="moving"; status("Alle stenen geplaatst, verschuiven!"); }
        current="player"; status("Jij bent aan zet");
      } else if(phase==="moving"){
        const own=Object.keys(stones).filter(k=>stones[k]==="computer");
        if(own.length===0)return;
        let moved=false;
        for(let tries=0;tries<40 && !moved;tries++){
          const from=own[Math.floor(Math.random()*own.length)];
          const opts=adj[from].filter(n=>!stones[n]);
          if(!opts.length) continue;

          let to;
          if(difficulty==="easy"){
            to=opts[Math.floor(Math.random()*opts.length)];
          } else {
            to=findWinningMoveNear(from,"computer");
            if(to===null) to=findWinningMoveNear(from,"player");
            if(to===null) to=opts[Math.floor(Math.random()*opts.length)];
            if(difficulty==="hard"){
              to=pickBestMove(from,opts) || to;
            }
          }

          stones[to]="computer"; stones[from]=null;
          updateBoard();
          updateBoard(); if(gameOver) return;
          if(checkMill("computer",to)){
            if(Object.values(stones).filter(s=>s==="player").length>0){
              mustRemove="computerRemove";
              status("De computer heeft een molen!"); return;
            const targets=Object.keys(stones).filter(k=>stones[k]==="player");
            if(targets.length){
              const pick=targets[Math.floor(Math.random()*targets.length)];
              stones[pick]=null;
              updateBoard();
              status("De computer heeft een molen en neemt jouw steen weg!");
            }
          }
          moved=true;
        }
        current="player"; status("Jij bent aan zet");
      }
    }

    function checkMill(who,lastId){
      return mills.some(set=>{
        if(!set.includes(parseInt(lastId))) return false;
        return set.every(i=>stones[i]===who);
      });
    }

    function updateBoard(){
      document.querySelectorAll(".point").forEach(c=>{
        const id=c.dataset.id;
        c.classList.remove("player","computer","selected","highlight");
        if(stones[id]) c.classList.add(stones[id]);
      });
      checkWin();
      checkWin(); if(gameOver) return;
    }

    function highlight(id){ document.querySelector(`.point[data-id="${id}"]`).classList.add("selected"); }
    function unselect(){ if(selected!==null){ document.querySelector(`.point[data-id="${selected}"]`).classList.remove("selected"); selected=null; } }

    function checkWin(){
      if(phase!=="moving") return;
      const playerCount=Object.values(stones).filter(s=>s==="player").length;
      const compCount=Object.values(stones).filter(s=>s==="computer").length;
      if(playerCount<3){ gameOver=true; status("De computer wint! ðŸ¤–"); }
      if(compCount<3){ gameOver=true; status("Jij wint! ðŸŽ‰"); }
    }

    function status(msg){ document.getElementById("status").textContent=msg; }

    // Firestore punten
    async function getUserPoints(){
      const db=firebase.firestore();
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(!parochieId||!ouderLogin||!kindId)return 0;
      const ref=db.collection("parochies").doc(parochieId).collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId);
      const snap=await ref.get(); return snap.exists?(snap.data().punten||0):0;
    }
    async function deductPoints(amount){
      const db=firebase.firestore();
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(!parochieId||!ouderLogin||!kindId)return;
      const ref=db.collection("parochies").doc(parochieId).collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId);
      await db.runTransaction(async tx=>{
        const snap=await tx.get(ref);
        if(!snap.exists)return;
        const current=snap.data().punten||0;
        if(current>=amount) tx.update(ref,{punten:current-amount});
      });
    }

    // Start & Reset
    document.getElementById("startBtn").addEventListener("click",async()=>{
      const points=await getUserPoints();
      if(points<20){ alert("Niet genoeg punten om te spelen!"); return; }
      await deductPoints(20);
      document.getElementById("startBtn").style.display="none";
      document.getElementById("resetBtn").style.display="inline-block";
      document.getElementById("boardWrapper").style.display="inline-block";
      stones={}; placed={player:0,computer:0}; current="player"; gameOver=false; selected=null; phase="placing"; mustRemove=null;
      boardSvg.querySelectorAll("circle").forEach(c=>c.remove());
      drawPoints(); status("Jij mag beginnen");
    });
    document.getElementById("resetBtn").addEventListener("click",()=>location.reload());

    drawPoints();
  </script>
</body>
</html>
