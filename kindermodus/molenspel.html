<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Springspel ‚Äì Orthodoxe Kinderpagina</title>
  <link rel="icon" href="images/kruis.png" />
  <style>
    :root{
      --primair:#7bb235; --donker:#67510C;
      --pastel1:#fff6e5; --pastel2:#fffde6; --pastel3:#ffe8ec; --pastel4:#e7f8ff;
      --pastel5:#e6ffe5; --pastel6:#fff2fb; --pastel7:#f5ffe5; --pastel8:#f5e8ff;
      --pastel9:#fff6fb; --pastel10:#e7fff9; --pastel11:#f3e6ff; --pastel12:#ffeae6;
      --pastel13:#ecffe9; --pastel14:#f7fff3; --pastel15:#eafffa; --pastel16:#fff4ea;
    }
    body{
      margin:0; font-family:'Comic Sans MS', Arial, sans-serif; color:#333;
      min-height:100vh; background:var(--pastel1); transition:background .6s;
    }
    main{ max-width:1000px; margin:20px auto; padding:0 16px; text-align:center }
    #game-container { position:relative; width:860px; height:340px; background:#fffde6; margin:34px auto 0 auto; border-radius:20px; box-shadow:0 4px 32px #bedbe888; overflow:hidden; }
    #score { font-size:24px; font-weight:bold; background:rgba(255,255,255,0.85); border-radius:10px; padding:4px 22px; position:absolute; left:24px; top:12px; box-shadow:0 2px 8px #dbecc299; }
    #restartBtn { display:none; position:absolute; left:50%; top:54%; transform:translate(-50%,-50%); background:#7bb235; color:white; font-size:21px; border:none; border-radius:12px; padding:12px 36px; box-shadow:0 2px 12px #a9dea670; cursor:pointer; font-family:'Comic Sans MS',Arial,sans-serif; }
    #startBtn {
      display: block;
      margin: 30px auto 0 auto;
      background: var(--primair); color: #fff; border:none; border-radius: 10px;
      padding: 10px 30px; font-size: 22px; font-weight: bold;
      box-shadow: 0 2px 10px #9eceb3a0;
      cursor: pointer;
    }
    #startBtn[disabled]{ opacity:0.5; pointer-events:none;}
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script defer src="common/layout.js"></script>
</head>
<body>
  <div id="kinder-header" data-header-src="common/header.html"></div>
  <main>
    <h1>Springspel ‚≠êÔ∏è</h1>
    <button id="startBtn">Start Springspel (20 punten)</button>
    <div id="game-container" style="display:none;">
      <div id="score">Score: 0</div>
      <button id="restartBtn">Opnieuw</button>
      <!-- Canvas-element wordt dynamisch toegevoegd -->
    </div>
    <div style="margin-top:24px;font-size:17px;color:#888">Druk op spatie of tik/klik om te springen!</div>
  </main>
  <script>
    // Achtergrond wisselen
    (function(){
      const p=[
        'var(--pastel1)','var(--pastel2)','var(--pastel3)','var(--pastel4)',
        'var(--pastel5)','var(--pastel6)','var(--pastel7)','var(--pastel8)',
        'var(--pastel9)','var(--pastel10)','var(--pastel11)','var(--pastel12)',
        'var(--pastel13)','var(--pastel14)','var(--pastel15)','var(--pastel16)'];
      document.body.style.background = p[Math.floor(Math.random()*p.length)];
    })();

    // Header/menubalk laden, active-tab is 'spelletjes'
    (function boot(){
      if (!(window.KinderLayout)) return setTimeout(boot,120);
      const el=document.getElementById('kinder-header');
      window.KinderLayout.mountHeader({ rootId:'kinder-header', headerSrc:el.dataset.headerSrc, active:'spelletjes' });
    })();

    // ===== Firestore puntenlogica (20 punten nodig) =====
    async function getUserPoints(){
      const db=firebase.firestore();
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(!parochieId||!ouderLogin||!kindId)return 0;
      const ref=db.collection("parochies").doc(parochieId)
        .collection("leden").doc(ouderLogin)
        .collection("kinderen").doc(kindId);
      const snap=await ref.get(); 
      return snap.exists?(snap.data().punten||0):0;
    }
    async function updateUserPoints(delta){
      const db=firebase.firestore();
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(!parochieId||!ouderLogin||!kindId)return;
      const ref=db.collection("parochies").doc(parochieId)
        .collection("leden").doc(ouderLogin)
        .collection("kinderen").doc(kindId);
      await db.runTransaction(async tx=>{
        const snap=await tx.get(ref);
        if(!snap.exists)return;
        const current=snap.data().punten||0;
        tx.update(ref,{punten: Math.max(0,current+delta)});
      });
    }

    // ===== Game-code (sterretje) =====
    const EMOJI_OBSTACLES = ["üíÄ","ü™®","üí£","üåµ","‚ö°Ô∏è","üöß"];
    const STAR = "‚≠êÔ∏è";
    let canvas, ctx, W=860, H=340;
    let star = { x:80, y:270, vy:0, size:50, jumping:false };
    let obstacles = [];
    let score = 0, alive = true, gravity=2.25, jumpVel=-30;
    let speed = 8;
    let groundY = 312;
    let bgFrame=0;
    function startGame() {
      // Reset
      obstacles = [];
      score = 0;
      alive = true;
      star.y = 270;
      star.vy = 0;
      star.jumping = false;
      speed = 8;
      document.getElementById("score").textContent = "Score: 0";
      document.getElementById("restartBtn").style.display = "none";
      document.getElementById("game-container").style.display = "";
      if(!canvas){
        canvas = document.createElement("canvas");
        canvas.width = W;
        canvas.height = H;
        canvas.style.display = "block";
        canvas.style.margin = "0 auto";
        canvas.style.background = "#f2faf5";
        document.getElementById("game-container").appendChild(canvas);
        ctx = canvas.getContext("2d");
      }
      loop();
    }
    function addObstacle() {
      const size = 44 + Math.random()*20;
      obstacles.push({
        x: W+10,
        y: groundY,
        size: size,
        emoji: EMOJI_OBSTACLES[Math.floor(Math.random()*EMOJI_OBSTACLES.length)]
      });
    }
    function loop() {
      ctx.clearRect(0,0,W,H);
      // Achtergrond: eenvoudige scrollende lucht/grond
      ctx.fillStyle = ["#cfe8ff","#f2faf5","#ffe8ec","#e0ffe3"][bgFrame%4];
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle = "#c2e3b5";
      ctx.fillRect(0,groundY+star.size/2,W, H-groundY);
      // Sterretje tekenen
      ctx.font = star.size + "px Segoe UI Emoji, Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      ctx.fillText(STAR, star.x, star.y);
      // Obstakels
      for(let obs of obstacles){
        ctx.font = obs.size+"px Segoe UI Emoji, Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "bottom";
        ctx.fillText(obs.emoji, obs.x, obs.y);
      }
      // Bewegen
      if(alive){
        // Star physics
        star.vy += gravity;
        star.y += star.vy;
        if(star.y >= 270){ star.y=270; star.vy=0; star.jumping=false; }
        // Obstakels bewegen
        for(let obs of obstacles){ obs.x -= speed; }
        // Nieuwe obstakel toevoegen? (max 2)
        if(obstacles.length===0 || (obstacles[obstacles.length-1].x < W-220 && obstacles.length<2)){
          if(Math.random()>0.8 || obstacles.length===0) addObstacle();
        }
        // Botsing?
        for(let obs of obstacles){
          if( Math.abs(star.x-obs.x)<obs.size*0.65 && Math.abs(star.y-obs.y)<star.size*0.55 ){
            alive=false;
            document.getElementById("restartBtn").style.display = "block";
          }
        }
        // Score verhogen
        obstacles = obstacles.filter(obs=>obs.x > -60);
        score++;
        document.getElementById("score").textContent = "Score: "+score;
      } else {
        ctx.font = "40px Comic Sans MS, Arial";
        ctx.fillStyle = "#e84040";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("Game Over!", W/2, H/2-22);
      }
      bgFrame++;
      requestAnimationFrame(loop);
    }
    // Springen
    function jump(){
      if(!alive) return;
      if(!star.jumping){
        star.vy = jumpVel;
        star.jumping = true;
      }
    }
    window.addEventListener('keydown', e=>{
      if(e.code==='Space') jump();
    });
    canvas = null; // wordt in startGame aangemaakt
    document.getElementById('game-container').addEventListener('pointerdown', jump);
    document.getElementById('restartBtn').onclick = startGame;

    // === Startknop functionaliteit ===
    document.getElementById("startBtn").onclick = async function(){
      let punten = await getUserPoints();
      if(punten<20){
        alert("Je hebt minstens 20 punten nodig om dit spel te starten.");
        return;
      }
      await updateUserPoints(-20);
      document.getElementById('startBtn').disabled = true;
      document.getElementById('startBtn').style.display='none';
      document.getElementById('game-container').style.display = '';
      startGame();
    };

    // Bij laden alles goedzetten
    window.onload = ()=>{
      document.getElementById('game-container').style.display = "none";
      document.getElementById('startBtn').disabled = false;
      document.getElementById('startBtn').style.display='';
    };
  </script>
</body>
</html>
