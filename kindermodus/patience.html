<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patience ‚Äì Orthodoxe Kinderpagina</title>
  <link rel="icon" href="images/kruis.png" />

  <style>
    :root{
      --primair:#7bb235; --donker:#67510C;
      --pastel1:#fff6e5; --pastel2:#fffde6;
      --pastel3:#ffe8ec; --pastel4:#e7f8ff;
    }
    body{
      margin:0; font-family:'Comic Sans MS', Arial, sans-serif; color:#333;
      min-height:100vh; background:var(--pastel1); transition:background .6s;
    }
    main{ max-width:1200px; margin:20px auto; padding:0 16px; text-align:center }

    #gameArea{
      display:flex; justify-content:space-between; margin-top:20px;
    }

    .foundations, .stock-area{
      display:flex; flex-direction:column; gap:12px; width:15%;
    }

    .foundations .pile, .stock-area .pile, .tableau .pile{
      border:2px dashed #999; border-radius:8px;
      width:100px; height:140px;
      display:flex; align-items:center; justify-content:center;
      background:#fafafa;
      position:relative;
    }

    .tableau{
      display:flex; justify-content:center; gap:12px; flex:1;
    }

    .tableau .pile{
      flex-shrink:0; width:100px;
    }

    .card{
      position:absolute; top:0; left:0;
      width:100px; height:140px;
      border-radius:8px; border:2px solid #555;
      background:#fff; cursor:grab;
      display:flex; align-items:center; justify-content:center;
      font-size:32px; font-weight:bold;
      user-select:none;
    }
    .card .corner{
      position:absolute; font-size:14px; font-weight:bold;
    }
    .card .corner.tl{ top:4px; left:6px; }
    .card .corner.tr{ top:4px; right:6px; }
    .card .corner.bl{ bottom:4px; left:6px; }
    .card .corner.br{ bottom:4px; right:6px; }
    .card .icon{ font-size:40px; }

    .red{ color:#c62828; }
    .black{ color:#000; }

    .btn{
      background:var(--primair); color:#fff; border:none; border-radius:8px;
      padding:8px 14px; font-weight:bold; cursor:pointer; margin:4px;
    }
  </style>

  <script defer src="common/layout.js"></script>
</head>
<body>
  <div id="kinder-header" data-header-src="common/header.html"></div>

  <main>
    <h1>Patience üÉèüôè</h1>
    <button id="startBtn" class="btn">Spel starten (20 punten)</button>
    <button id="resetBtn" class="btn" style="display:none;">Opnieuw spelen</button>

    <div id="gameArea" style="display:none;">
      <!-- Foundations links -->
      <div class="foundations">
        <div class="pile" id="foundation1"></div>
        <div class="pile" id="foundation2"></div>
        <div class="pile" id="foundation3"></div>
        <div class="pile" id="foundation4"></div>
      </div>

      <!-- Tableau midden -->
      <div class="tableau" id="tableau"></div>

      <!-- Stock rechts -->
      <div class="stock-area">
        <div class="pile" id="stock"></div>
        <div class="pile" id="waste"></div>
      </div>
    </div>
  </main>

  <script>
    // Achtergrond wisselen
    (function(){
      const p=['var(--pastel1)','var(--pastel2)','var(--pastel3)','var(--pastel4)'];
      document.body.style.background=p[Math.floor(Math.random()*p.length)];
    })();

    // Header
    (function boot(){
      if (!(window.KinderLayout)) return setTimeout(boot,120);
      const el=document.getElementById('kinder-header');
      window.KinderLayout.mountHeader({ rootId:'kinder-header', headerSrc:el.dataset.headerSrc, active:'spelletjes' });
    })();

    // Kaarten
    const suits = ["‚úùÔ∏è","üìñ","üôè","üëº"];
    const colors = ["red","black","red","black"];
    const pastel = ["var(--pastel1)","var(--pastel2)","var(--pastel3)","var(--pastel4)"];
    const ranks = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];

    let deck = [];

    function createDeck(){
      deck=[];
      for(let s=0;s<suits.length;s++){
        for(let r=0;r<ranks.length;r++){
          deck.push({rank:ranks[r], suit:suits[s], color:colors[s], bg:pastel[s]});
        }
      }
      shuffle(deck);
    }

    function shuffle(array){
      for(let i=array.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [array[i],array[j]]=[array[j],array[i]];
      }
    }

    function createCardElement(card){
      const div=document.createElement("div");
      div.className="card";
      div.style.background=card.bg;
      div.innerHTML=`
        <span class="corner tl ${card.color}">${card.rank}</span>
        <span class="corner tr ${card.color}">${card.rank}</span>
        <span class="icon">${card.suit}</span>
        <span class="corner bl ${card.color}">${card.rank}</span>
        <span class="corner br ${card.color}">${card.rank}</span>
      `;
      div.draggable=true;
      return div;
    }

    function setupGame(){
      createDeck();

      // tableau 7 kolommen
      const tableau=document.getElementById("tableau");
      tableau.innerHTML="";
      for(let i=0;i<7;i++){
        const pile=document.createElement("div");
        pile.className="pile";
        for(let j=0;j<=i;j++){
          const card=deck.pop();
          const el=createCardElement(card);
          el.style.top=(j*20)+"px";
          pile.appendChild(el);
        }
        tableau.appendChild(pile);
      }

      // stock vullen
      const stock=document.getElementById("stock");
      stock.innerHTML="";
      deck.forEach(c=>{
        stock.appendChild(createCardElement(c));
      });
    }

    // Firestore punten
    async function getUserPoints(){
      const db=firebase.firestore();
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(!parochieId||!ouderLogin||!kindId)return 0;
      const ref=db.collection("parochies").doc(parochieId)
        .collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId);
      const snap=await ref.get(); return snap.exists?(snap.data().punten||0):0;
    }
    async function deductPoints(amount){
      const db=firebase.firestore();
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(!parochieId||!ouderLogin||!kindId)return;
      const ref=db.collection("parochies").doc(parochieId)
        .collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId);
      await db.runTransaction(async tx=>{
        const snap=await tx.get(ref);
        if(!snap.exists)return;
        const current=snap.data().punten||0;
        if(current>=amount) tx.update(ref,{punten:current-amount});
      });
    }

    // Start & Reset
    document.getElementById("startBtn").addEventListener("click",async()=>{
      const points=await getUserPoints();
      if(points<20){ alert("Niet genoeg punten om te spelen!"); return; }
      await deductPoints(20);
      document.getElementById("startBtn").style.display="none";
      document.getElementById("resetBtn").style.display="inline-block";
      document.getElementById("gameArea").style.display="flex";
      setupGame();
    });
    document.getElementById("resetBtn").addEventListener("click",()=>location.reload());
  </script>
</body>
</html>
