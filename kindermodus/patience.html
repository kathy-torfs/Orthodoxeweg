<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patience ‚Äì Orthodoxe Kinderpagina</title>
  <link rel="icon" href="images/kruis.png" />
  <style>
    :root{
      --primair:#7bb235; --donker:#67510C;
      --pastel1:#fff6e5; --pastel2:#fffde6; --pastel3:#ffe8ec; --pastel4:#e7f8ff;
      --pastel5:#e6ffe5; --pastel6:#fff2fb; --pastel7:#f5ffe5; --pastel8:#f5e8ff;
      --pastel9:#fff6fb; --pastel10:#e7fff9; --pastel11:#f3e6ff; --pastel12:#ffeae6;
      --pastel13:#ecffe9; --pastel14:#f7fff3; --pastel15:#eafffa; --pastel16:#fff4ea;
    }
    body{ margin:0; font-family:'Comic Sans MS', Arial, sans-serif; color:#333;
      min-height:100vh; background:var(--pastel1); transition:background .6s; }
    main{ max-width:1200px; margin:20px auto; padding:0 16px; text-align:center }

    .controls{ margin-bottom:10px }
    .btn{ background:var(--primair); color:#fff; border:none; border-radius:8px;
      padding:8px 14px; font-weight:bold; cursor:pointer; margin:4px; }
    select.btn{ padding:7px 10px; }

    #board{ margin-top:16px; display:none; flex-direction:column; align-items:center; }
    .topRow{ display:flex; justify-content:space-between; align-items:flex-start;
      width:100%; max-width:1100px; margin-bottom:16px; }
    .leftTop,.rightTop{ display:flex; gap:12px; align-items:center; }
    .labels{ font-size:12px; color:#666; text-align:center; margin-top:4px; }

    .pile{ width:100px; height:140px; position:relative; border:2px dashed #bbb;
      border-radius:10px; background:#fafafa; cursor:pointer; }
    .pile.small{ width:90px; height:126px; }
    .pile.foundation{ background:#fffef8; }

    #tableauRow{ display:flex; gap:12px; justify-content:center; max-width:1100px; width:100%; }
    .tableauPile{ width:100px; min-height:350px; position:relative; border:2px dashed #bbb;
      border-radius:10px; background:#fdfdfd; cursor:pointer; }

    .card{ width:100px; height:140px; border-radius:10px; border:1px solid #ccc;
      position:absolute; left:0; top:0; display:flex; align-items:center; justify-content:center;
      background:#fff; font-size:38px; font-weight:bold; box-shadow:0 2px 6px rgba(0,0,0,.15);
      user-select:none; cursor:pointer; transition:transform .12s ease; }
    .card.red{ color:#c62828; } .card.black{ color:#000; }
    .card.hidden{ background:#7bb235; color:transparent; border:1px solid #699a2f; cursor:default; }
    .card.selected{ outline:3px solid #7bb235; z-index:5; }

    .corner{ position:absolute; font-size:14px; font-weight:bold; }
    .tl{ top:4px; left:6px } .tr{ top:4px; right:6px }
    .bl{ bottom:4px; left:6px } .br{ bottom:4px; right:6px }

    #status{ margin-top:12px; font-weight:bold; }
    #rules{ background:#fffef8; border:2px solid #e2d6b3; border-radius:12px;
      padding:16px; margin-top:24px; text-align:left; max-width:1000px; margin-inline:auto; }
  </style>
  <script defer src="common/layout.js"></script>
</head>
<body>
  <div id="kinder-header" data-header-src="common/header.html"></div>

  <main>
    <h1>Patience (Solitair) ‚úùÔ∏èüìñüôèüëº</h1>
    <div class="controls">
      <select id="levelSelect" class="btn">
        <option value="1">Level 1 ‚Äì 1 kaart draaien</option>
        <option value="2">Level 2 ‚Äì 2 kaarten draaien</option>
        <option value="3">Level 3 ‚Äì 3 kaarten draaien</option>
      </select>
      <button id="startBtn" class="btn">Spel starten (20 punten)</button>
      <button id="resetBtn" class="btn" style="display:none;">Opnieuw spelen</button>
    </div>

    <div id="board">
      <div class="topRow">
        <div class="leftTop">
          <div>
            <div id="stock" class="pile small" aria-label="stock"></div>
            <div class="labels">üì¶ Stock</div>
          </div>
          <div>
            <div id="waste" class="pile small" aria-label="waste"></div>
            <div class="labels">üÉè Waste</div>
          </div>
        </div>
        <div class="rightTop" id="foundationsWrap">
          <div><div id="f0" class="pile foundation small"></div><div class="labels">‚úùÔ∏è Foundation</div></div>
          <div><div id="f1" class="pile foundation small"></div><div class="labels">üìñ Foundation</div></div>
          <div><div id="f2" class="pile foundation small"></div><div class="labels">üôè Foundation</div></div>
          <div><div id="f3" class="pile foundation small"></div><div class="labels">üëº Foundation</div></div>
        </div>
      </div>

      <div id="tableauRow">
        <div id="t0" class="tableauPile"></div>
        <div id="t1" class="tableauPile"></div>
        <div id="t2" class="tableauPile"></div>
        <div id="t3" class="tableauPile"></div>
        <div id="t4" class="tableauPile"></div>
        <div id="t5" class="tableauPile"></div>
        <div id="t6" class="tableauPile"></div>
      </div>
    </div>

    <div id="status"></div>

    <div id="rules">
      <h2>üìñ Spelregels</h2>
      <ul>
        <li><b>Doel:</b> leg alle kaarten in de 4 foundations (‚úùÔ∏è üìñ üôè üëº) van A (Aas) tot K (Koning).</li>
        <li><b>Tableau:</b> aflopend (bijv. 9 op 10) en afwisselend rood/zwart. Lege plek = alleen Koning.</li>
        <li><b>Stock (üì¶):</b> klik om 1/2/3 kaarten (level) naar <b>waste</b> te draaien. Lege stock ‚Üí klik om waste terug te zetten.</li>
        <li><b>Verplaatsen:</b> klik om te <b>selecteren</b> ‚Üí klik op <b>bestemming</b> (foundation of tableau). <b>Dubbelklik</b> op top-kaart = automatisch naar foundation (indien mogelijk).</li>
      </ul>
    </div>
  </main>

  <script>
    // Pastel achtergrond
    (function(){
      const p=['var(--pastel1)','var(--pastel2)','var(--pastel3)','var(--pastel4)',
               'var(--pastel5)','var(--pastel6)','var(--pastel7)','var(--pastel8)',
               'var(--pastel9)','var(--pastel10)','var(--pastel11)','var(--pastel12)',
               'var(--pastel13)','var(--pastel14)','var(--pastel15)','var(--pastel16)'];
      document.body.style.background=p[Math.floor(Math.random()*p.length)];
    })();
    // Header
    (function boot(){
      if (!(window.KinderLayout)) return setTimeout(boot,120);
      const el=document.getElementById('kinder-header');
      window.KinderLayout.mountHeader({ rootId:'kinder-header', headerSrc:el.dataset.headerSrc, active:'spelletjes' });
    })();

    // Suits & ranks
    const SUITS=[ {icon:"‚úùÔ∏è", color:"black"}, {icon:"üìñ", color:"red"}, {icon:"üôè", color:"black"}, {icon:"üëº", color:"red"} ];
    const RANKS=[null,"A","2","3","4","5","6","7","8","9","10","J","Q","K"];
    let drawCount=1, deck=[], stock=[], waste=[], foundations=[[],[],[],[]], tableau=[[],[],[],[],[],[],[]];
    let selected=null; // {from:'waste'|'tableau', pile:idx, index:idxInPile}

    function makeDeck(){
      deck=[];
      for(let s=0;s<4;s++) for(let r=1;r<=13;r++) deck.push({suit:s,rank:r,faceUp:false});
      for(let i=deck.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[deck[i],deck[j]]=[deck[j],deck[i]];}
    }
    function colorOf(c){return SUITS[c.suit].color;}
    function rankName(r){return RANKS[r]}
    function iconOf(s){return SUITS[s].icon}

    function start(){
      drawCount=parseInt(document.getElementById('levelSelect').value,10);
      makeDeck(); stock=[...deck]; waste=[]; foundations=[[],[],[],[]]; tableau=[[],[],[],[],[],[],[]];
      for(let col=0;col<7;col++){
        for(let i=0;i<=col;i++){ const c=stock.pop(); tableau[col].push(c); }
        tableau[col][tableau[col].length-1].faceUp=true;
      }
      render(); status("Spel gestart! Klik kaart ‚Üí klik bestemming.");
    }

    function render(){
      // stock
      const stockEl=document.getElementById('stock'); stockEl.innerHTML="";
      if(stock.length){
        stockEl.appendChild(cardElement({faceUp:false},true));
        stockEl.onclick=()=>drawFromStock();
      }else{
        const back=document.createElement('div'); back.className='card hidden'; back.style.left='0'; back.style.top='0';
        stockEl.appendChild(back); stockEl.onclick=()=>recycleWaste();
      }
      // waste
      const wasteEl=document.getElementById('waste'); wasteEl.innerHTML="";
      const show=Math.min(drawCount,waste.length);
      for(let i=waste.length-show;i<waste.length;i++){
        const c=waste[i]; c.faceUp=true;
        const el=cardElement(c);
        el.style.left=(i-(waste.length-show))*18+'px';
        el.dataset.from='waste'; el.dataset.pile='-1'; el.dataset.index=i;
        el.addEventListener('click',onCardClick);
        el.addEventListener('dblclick',onCardDoubleClick);
        wasteEl.appendChild(el);
      }
      // foundations
      for(let f=0;f<4;f++){
        const fe=document.getElementById('f'+f); fe.innerHTML="";
        if(foundations[f].length){
          const top=foundations[f][foundations[f].length-1];
          fe.appendChild(cardElement(top));
        }else{
          fe.appendChild(emptyCard());
        }
        fe.onclick=()=>attemptDropOnFoundation(f);
      }
      // tableau
      for(let t=0;t<7;t++){
        const te=document.getElementById('t'+t); te.innerHTML="";
        const pile=tableau[t];
        te.onclick=()=>attemptDropOnTableau(t); // <-- ook bij NIET-lege stapel droppen mogelijk
        pile.forEach((c,idx)=>{
          const el=cardElement(c);
          el.style.top=(idx*28)+'px';
          el.dataset.from='tableau'; el.dataset.pile=t; el.dataset.index=idx;
          if(c.faceUp){
            el.addEventListener('click',onCardClick);
            el.addEventListener('dblclick',onCardDoubleClick);
          }
          te.appendChild(el);
        });
      }
      highlightSelected(); checkWin();
    }

    function cardElement(card,forceBack=false){
      const face = card.faceUp && !forceBack && card.rank;
      const el=document.createElement('div');
      el.className='card '+(face?(colorOf(card)==='red'?'red':'black'):'hidden');
      el.innerHTML= face ? `
        <span class="corner tl">${rankName(card.rank)}</span>
        <span class="corner tr">${rankName(card.rank)}</span>
        <div>${iconOf(card.suit)}</div>
        <span class="corner bl">${rankName(card.rank)}</span>
        <span class="corner br">${rankName(card.rank)}</span>
      ` : '';
      return el;
    }
    function emptyCard(){ const d=document.createElement('div'); d.className='card hidden'; d.style.left='0'; d.style.top='0'; return d; }

    // --- regels
    function canMoveToTableau(card, dest){
      if(dest.length===0) return card.rank===13;
      const top=dest[dest.length-1]; if(!top.faceUp) return false;
      return colorOf(card)!==colorOf(top) && card.rank===top.rank-1;
    }
    function canMoveToFoundation(card,f){
      if(card.suit!==f) return false;
      const pile=foundations[f];
      if(pile.length===0) return card.rank===1;
      return card.rank===pile[pile.length-1].rank+1;
    }
    function isValidRun(run){
      if(!run.length) return false;
      for(const c of run) if(!c.faceUp) return false;
      for(let i=0;i<run.length-1;i++){
        if(colorOf(run[i])===colorOf(run[i+1])) return false;
        if(run[i].rank!==run[i+1].rank+1) return false;
      }
      return true;
    }

    // --- interactie
    function onCardClick(e){
      const el=e.currentTarget;
      const from=el.dataset.from;
      if(from==='waste'){
        const i=parseInt(el.dataset.index,10);
        if(i!==waste.length-1){ return; }
        // als er al iets geselecteerd is en je klikt op tableau-top ‚Üí drop
        toggleSelect({from:'waste',pile:-1,index:i});
      }else if(from==='tableau'){
        const p=parseInt(el.dataset.pile,10), i=parseInt(el.dataset.index,10);
        if(!tableau[p][i].faceUp) return;

        // NIEUW: als er al iets geselecteerd is en je klikt op de TOP van een tableau-stapel -> probeer droppen op die stapel
        const isTop = (i===tableau[p].length-1);
        if(selected && isTop && !(selected.from==='tableau' && selected.pile===p && selected.index===i)){
          attemptDropOnTableau(p);
          return;
        }
        // anders: selecteer (vanaf i = hele ketting)
        toggleSelect({from:'tableau',pile:p,index:i});
      }
    }
    function onCardDoubleClick(e){
      const el=e.currentTarget, from=el.dataset.from;
      if(from==='waste'){
        const i=parseInt(el.dataset.index,10); if(i!==waste.length-1) return;
        const card=waste[i];
        for(let f=0;f<4;f++){ if(canMoveToFoundation(card,f)){ waste.pop(); foundations[f].push(card); render(); return; } }
      }else if(from==='tableau'){
        const p=parseInt(el.dataset.pile,10), i=parseInt(el.dataset.index,10);
        if(i!==tableau[p].length-1) return;
        const card=tableau[p][i];
        for(let f=0;f<4;f++){ if(canMoveToFoundation(card,f)){ tableau[p].pop(); foundations[f].push(card); flipTopIfNeeded(p); render(); return; } }
      }
    }
    function toggleSelect(sel){
      if(selected && selected.from===sel.from && selected.pile===sel.pile && selected.index===sel.index){
        selected=null;
      }else{
        selected=sel;
      }
      highlightSelected();
    }
    function highlightSelected(){
      document.querySelectorAll('.card').forEach(c=>c.classList.remove('selected'));
      if(!selected) return;
      if(selected.from==='waste'){
        const wasteEl=document.getElementById('waste');
        if(wasteEl.lastElementChild) wasteEl.lastElementChild.classList.add('selected');
      }else if(selected.from==='tableau'){
        const pileEl=document.getElementById('t'+selected.pile);
        const children=[...pileEl.children];
        for(let i=selected.index;i<children.length;i++) children[i].classList.add('selected');
      }
    }

    // droppen
    function attemptDropOnTableau(dest){
      if(!selected) return;
      if(selected.from==='waste'){
        const card=waste[waste.length-1];
        if(canMoveToTableau(card, tableau[dest])){ tableau[dest].push(waste.pop()); selected=null; render(); }
      }else if(selected.from==='tableau'){
        const src=selected.pile, start=selected.index;
        if(src===dest) return; // geen no-op
        const moving=tableau[src].slice(start);
        if(!isValidRun(moving)) return status('Die rij kan zo niet verplaatst worden.');
        if(canMoveToTableau(moving[0], tableau[dest])){
          tableau[dest].push(...moving);
          tableau[src].length=start;
          flipTopIfNeeded(src); selected=null; render();
        }
      }
    }
    function attemptDropOnFoundation(f){
      if(!selected) return;
      if(selected.from==='waste'){
        const card=waste[waste.length-1];
        if(canMoveToFoundation(card,f)){ foundations[f].push(waste.pop()); selected=null; render(); }
      }else if(selected.from==='tableau'){
        const src=selected.pile;
        if(selected.index!==tableau[src].length-1) return; // alleen top
        const card=tableau[src][selected.index];
        if(canMoveToFoundation(card,f)){ foundations[f].push(tableau[src].pop()); flipTopIfNeeded(src); selected=null; render(); }
      }
    }
    function flipTopIfNeeded(p){
      const pile=tableau[p];
      if(pile.length && !pile[pile.length-1].faceUp) pile[pile.length-1].faceUp=true;
    }

    // stock/waste
    function drawFromStock(){
      if(!stock.length) return;
      const n=Math.min(drawCount,stock.length);
      for(let k=0;k<n;k++){ const c=stock.pop(); c.faceUp=true; waste.push(c); }
      selected=null; render();
    }
    function recycleWaste(){
      if(stock.length) return;
      while(waste.length){ const c=waste.pop(); c.faceUp=false; stock.push(c); }
      selected=null; render();
    }

    // winst
    function checkWin(){
      const total=foundations.reduce((s,f)=>s+f.length,0);
      if(total===52) status('üéâ Proficiat! Je hebt gewonnen!');
    }
    function status(msg){ document.getElementById('status').textContent=msg; }

    // Firestore punten
    async function getUserPoints(){
      try{
        const db=firebase.firestore();
        const parochieId=localStorage.getItem("ingelogdeParochie");
        const ouderLogin=localStorage.getItem("loginKeuze");
        const kindId=localStorage.getItem("ingelogdKindId");
        if(!parochieId||!ouderLogin||!kindId) return 0;
        const ref=db.collection("parochies").doc(parochieId).collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId);
        const snap=await ref.get(); return snap.exists?(snap.data().punten||0):0;
      }catch(e){ console.warn(e); return 0; }
    }
    async function deductPoints(amount){
      try{
        const db=firebase.firestore();
        const parochieId=localStorage.getItem("ingelogdeParochie");
        const ouderLogin=localStorage.getItem("loginKeuze");
        const kindId=localStorage.getItem("ingelogdKindId");
        if(!parochieId||!ouderLogin||!kindId) return;
        const ref=db.collection("parochies").doc(parochieId).collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId);
        await db.runTransaction(async tx=>{
          const snap=await tx.get(ref); if(!snap.exists) return;
          const curr=snap.data().punten||0; if(curr>=amount) tx.update(ref,{punten:curr-amount});
        });
      }catch(e){ console.warn(e); }
    }

    // start/reset
    document.getElementById('startBtn').addEventListener('click', async ()=>{
      const points=await getUserPoints();
      if(points<20){ alert('Niet genoeg punten om te spelen!'); return; }
      await deductPoints(20);
      document.getElementById('board').style.display='flex';
      document.getElementById('startBtn').style.display='none';
      document.getElementById('resetBtn').style.display='inline-block';
      start();
    });
    document.getElementById('resetBtn').addEventListener('click',()=>location.reload());
  </script>
</body>
</html>
