<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patience ‚Äì Orthodoxe Kinderpagina</title>
  <link rel="icon" href="images/kruis.png" />

  <style>
     :root{
      --primair:#7bb235; --donker:#67510C;
      --pastel1:#fff6e5; --pastel2:#fffde6; --pastel3:#ffe8ec; --pastel4:#e7f8ff;
      --pastel5:#e6ffe5; --pastel6:#fff2fb; --pastel7:#f5ffe5; --pastel8:#f5e8ff;
      --pastel9:#fff6fb; --pastel10:#e7fff9; --pastel11:#f3e6ff; --pastel12:#ffeae6;
      --pastel13:#ecffe9; --pastel14:#f7fff3; --pastel15:#eafffa; --pastel16:#fff4ea;
    }
    body{
      margin:0; font-family:'Comic Sans MS', Arial, sans-serif; color:#333;
      min-height:100vh; background:var(--pastel1); transition:background .6s;
    }
    main{ max-width:1200px; margin:20px auto; padding:0 16px; text-align:center }

    #top{
      display:flex; justify-content:space-between; margin-bottom:20px;
    }
    .pile{
      border:2px dashed #999; border-radius:8px;
      width:100px; height:140px;
      position:relative; margin:0 6px;
      display:flex; align-items:center; justify-content:center;
      background:#fafafa;
    }
    #foundations{ display:flex; gap:8px; }
    #stockWaste{ display:flex; gap:8px; }

    #tableau{
      display:flex; justify-content:center; gap:12px;
    }
    #tableau .pile{ width:100px; }

    .card{
      position:absolute; top:0; left:0;
      width:100px; height:140px;
      border-radius:8px; border:2px solid #555;
      background:#fff; cursor:grab;
      display:flex; align-items:center; justify-content:center;
      font-size:32px; font-weight:bold;
      user-select:none;
    }
    .card .corner{
      position:absolute; font-size:14px; font-weight:bold;
    }
    .card .corner.tl{ top:4px; left:6px; }
    .card .corner.tr{ top:4px; right:6px; }
    .card .corner.bl{ bottom:4px; left:6px; }
    .card .corner.br{ bottom:4px; right:6px; }
    .card .icon{ font-size:40px; }

    .red{ color:#c62828; }
    .black{ color:#000; }

    .btn{
      background:var(--primair); color:#fff; border:none; border-radius:8px;
      padding:8px 14px; font-weight:bold; cursor:pointer; margin:4px;
    }
  </style>

  <script defer src="common/layout.js"></script>
</head>
<body>
  <div id="kinder-header" data-header-src="common/header.html"></div>

  <main>
    <h1>Patience üÉèüôè</h1>
    <button id="startBtn" class="btn">Spel starten (20 punten)</button>
    <button id="resetBtn" class="btn" style="display:none;">Opnieuw spelen</button>

    <div id="gameArea" style="display:none;">
      <!-- BOVEN -->
      <div id="top">
        <div id="stockWaste">
          <div class="pile" id="stock"></div>
          <div class="pile" id="waste"></div>
        </div>
        <div id="foundations">
          <div class="pile" id="foundation1"></div>
          <div class="pile" id="foundation2"></div>
          <div class="pile" id="foundation3"></div>
          <div class="pile" id="foundation4"></div>
        </div>
      </div>

      <!-- ONDER -->
      <div id="tableau"></div>
    </div>
  </main>

  <script>
    // Achtergrond wisselen
    (function(){
      const p=['var(--pastel1)','var(--pastel2)','var(--pastel3)','var(--pastel4)'];
      document.body.style.background=p[Math.floor(Math.random()*p.length)];
    })();

    // Header
    (function boot(){
      if (!(window.KinderLayout)) return setTimeout(boot,120);
      const el=document.getElementById('kinder-header');
      window.KinderLayout.mountHeader({ rootId:'kinder-header', headerSrc:el.dataset.headerSrc, active:'spelletjes' });
    })();

    // Kaarten
    const suits = ["‚úùÔ∏è","üìñ","üôè","üëº"];
    const colors = ["red","black","red","black"];
    const pastel = ["var(--pastel1)","var(--pastel2)","var(--pastel3)","var(--pastel4)"];
    const ranks = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];

    let deck = [], waste=[], foundations=[[],[],[],[]], tableau=[[],[],[],[],[],[],[]];

    function createDeck(){
      deck=[];
      for(let s=0;s<suits.length;s++){
        for(let r=0;r<ranks.length;r++){
          deck.push({rank:ranks[r], suit:suits[s], color:colors[s], bg:pastel[s], suitIndex:s, rankIndex:r});
        }
      }
      shuffle(deck);
    }

    function shuffle(array){
      for(let i=array.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [array[i],array[j]]=[array[j],array[i]];
      }
    }

    function createCardElement(card){
      const div=document.createElement("div");
      div.className="card";
      div.style.background=card.bg;
      div.dataset.rankIndex=card.rankIndex;
      div.dataset.suitIndex=card.suitIndex;
      div.dataset.color=card.color;
      div.innerHTML=`
        <span class="corner tl ${card.color}">${card.rank}</span>
        <span class="corner tr ${card.color}">${card.rank}</span>
        <span class="icon">${card.suit}</span>
        <span class="corner bl ${card.color}">${card.rank}</span>
        <span class="corner br ${card.color}">${card.rank}</span>
      `;
      div.draggable=true;
      div.addEventListener("dragstart", dragStart);
      return div;
    }

    function render(){
      // foundations
      for(let i=0;i<4;i++){
        const pile=document.getElementById("foundation"+(i+1));
        pile.innerHTML="";
        if(foundations[i].length){
          const top=foundations[i][foundations[i].length-1];
          pile.appendChild(createCardElement(top));
        }
      }
      // tableau
      const t=document.getElementById("tableau");
      t.innerHTML="";
      for(let i=0;i<7;i++){
        const pile=document.createElement("div");
        pile.className="pile";
        tableau[i].forEach((c,idx)=>{
          const el=createCardElement(c);
          el.style.top=(idx*25)+"px";
          pile.appendChild(el);
        });
        pile.addEventListener("dragover",dragOver);
        pile.addEventListener("drop",e=>dropTableau(e,i));
        t.appendChild(pile);
      }
      // stock
      const stock=document.getElementById("stock");
      stock.innerHTML="";
      if(deck.length){
        stock.appendChild(createCardElement({rank:"",suit:"‚¨ú",color:"black",bg:"#ccc"}));
      }
      // waste
      const wastePile=document.getElementById("waste");
      wastePile.innerHTML="";
      if(waste.length){
        wastePile.appendChild(createCardElement(waste[waste.length-1]));
      }
    }

    function dragStart(e){
      e.dataTransfer.setData("card", JSON.stringify({
        rankIndex:e.target.dataset.rankIndex,
        suitIndex:e.target.dataset.suitIndex,
        color:e.target.dataset.color
      }));
    }
    function dragOver(e){ e.preventDefault(); }

    function dropTableau(e, pileIndex){
      e.preventDefault();
      const data=JSON.parse(e.dataTransfer.getData("card"));
      const card={...data};
      const targetPile=tableau[pileIndex];
      if(!targetPile.length){
        if(ranks[data.rankIndex]==="K"){
          tableau[pileIndex].push(data); render();
        }
      } else {
        const last=targetPile[targetPile.length-1];
        if(last.color!==card.color && parseInt(data.rankIndex)==parseInt(last.rankIndex)-1){
          tableau[pileIndex].push(data); render();
        }
      }
    }

    function setupGame(){
      createDeck();
      tableau=[[],[],[],[],[],[],[]];
      for(let i=0;i<7;i++){
        for(let j=0;j<=i;j++){
          tableau[i].push(deck.pop());
        }
      }
      render();
    }

    // Firestore punten
    async function getUserPoints(){
      const db=firebase.firestore();
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(!parochieId||!ouderLogin||!kindId)return 0;
      const ref=db.collection("parochies").doc(parochieId)
        .collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId);
      const snap=await ref.get(); return snap.exists?(snap.data().punten||0):0;
    }
    async function deductPoints(amount){
      const db=firebase.firestore();
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(!parochieId||!ouderLogin||!kindId)return;
      const ref=db.collection("parochies").doc(parochieId)
        .collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId);
      await db.runTransaction(async tx=>{
        const snap=await tx.get(ref);
        if(!snap.exists)return;
        const current=snap.data().punten||0;
        if(current>=amount) tx.update(ref,{punten:current-amount});
      });
    }

    // Start & Reset
    document.getElementById("startBtn").addEventListener("click",async()=>{
      const points=await getUserPoints();
      if(points<20){ alert("Niet genoeg punten om te spelen!"); return; }
      await deductPoints(20);
      document.getElementById("startBtn").style.display="none";
      document.getElementById("resetBtn").style.display="inline-block";
      document.getElementById("gameArea").style.display="block";
      setupGame();
    });
    document.getElementById("resetBtn").addEventListener("click",()=>location.reload());
  </script>
</body>
</html>
