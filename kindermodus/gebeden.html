<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ik bid – Orthodoxe Kinderpagina</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png">

  <style>
    :root{
      --primair:#7bb235; --donker:#67510C;
      --pastel1:#fff6e5; --pastel2:#fffde6; --pastel3:#ffe8ec; --pastel4:#e7f8ff;
      --pastel5:#e6ffe5; --pastel6:#fff2fb; --pastel7:#f5ffe5; --pastel8:#f5e8ff;
      --pastel9:#fff6fb; --pastel10:#e7fff9; --pastel11:#f3e6ff; --pastel12:#ffeae6;
      --pastel13:#ecffe9; --pastel14:#f7fff3; --pastel15:#eafffa; --pastel16:#fff4ea;
    }
    body{
      margin:0; font-family:'Comic Sans MS', Arial, sans-serif; color:#333;
      min-height:100vh; background:var(--pastel1); transition:background .6s; overflow-x:hidden;
    }

    /* Pagina-inhoud (onder de herbruikbare header) */
    .page-container{ max-width:650px; margin:0 auto; padding:0 12px 44px 12px; }

    /* Gebed-cards */
    .gebed-card{
      background:#fff6e2; border-radius:22px; box-shadow:0 2px 8px #0002;
      margin-bottom:22px; padding:20px 18px; position:relative; opacity:1;
      transition:opacity .4s, max-height .4s, padding .3s, margin .3s;
    }
    .gebed-card.fade{ opacity:0; max-height:0!important; padding:0 18px; margin-bottom:0; overflow:hidden; }

    .gebed-titel{ color:#795020; font-size:1.13em; font-weight:bold; margin-bottom:8px; }
    .gebed-tekst{ color:#46351F; font-size:1em; line-height:1.45; margin-bottom:15px; }

    .gebed-punten{
      display:inline-block; background:#d8ffdf; color:#20641e; border-radius:8px;
      padding:2px 11px; font-size:.95em; margin-right:10px; margin-bottom:7px;
    }

    .gebed-btn{
      background:#7bb235; color:#fff; border:none; border-radius:13px; padding:11px 0;
      width:100%; font-size:1em; font-weight:bold; cursor:pointer; transition:background .2s;
    }
    .gebed-btn:hover{ background:#6aa12c; }
    .gebed-btn:disabled{ background:#d8ffdf; color:#888; cursor:default; }

    /* Klein “duim”-gifje (zoals op je eerdere pagina) */
    .photeinos-gif{
      position:fixed; left:0; bottom:50px; width:110px; height:110px; z-index:1000;
      display:none; pointer-events:none; animation:photeinosInOut 2.2s linear forwards;
    }
    @keyframes photeinosInOut{
      0%{transform:translateX(-120%);} 15%{transform:translateX(12%);}
      80%{transform:translateX(10%);} 100%{transform:translateX(-120%);}
    }
  </style>

  <!-- Firebase compat (zelfde versie als elders) -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <!-- Kinder lay-out (laadt & bewaakt header/menubalk/veiligheid/punten) -->
  <script defer src="common/layout.js"></script>
</head>
<body>
  <!-- Herbruikbare header wordt hier ingeladen door layout.js -->
  <div id="kinder-header" data-header-src="common/header.html"></div>

  <!-- Pagina-inhoud -->
  <main class="page-container">
    <div id="gebedenLijst">
      <div id="loadingMsg" style="font-size:1.2em;color:#888;text-align:center;margin:28px 0;">Laden...</div>
    </div>
  </main>

  <!-- Optioneel: Photeinos duim-gif -->
  <img id="photeinosGif" class="photeinos-gif" src="https://kathy-torfs.github.io/Orthodoxeweg/images/photeinos_kiekeboeduim.gif" alt="Photeinos duim" />

  <script>
    // Pastel achtergrond (zelfde logica als elders)
    (function(){
      const pastel=['var(--pastel1)','var(--pastel2)','var(--pastel3)','var(--pastel4)','var(--pastel5)','var(--pastel6)','var(--pastel7)','var(--pastel8)','var(--pastel9)','var(--pastel10)','var(--pastel11)','var(--pastel12)','var(--pastel13)','var(--pastel14)','var(--pastel15)','var(--pastel16)'];
      document.body.style.background = pastel[Math.floor(Math.random()*pastel.length)];
    })();

    // Firebase init (veilig tegen dubbel-initialisatie)
    const firebaseConfig = {
      apiKey:"AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
      authDomain:"orthodoxeweg.firebaseapp.com",
      projectId:"orthodoxeweg",
      storageBucket:"orthodoxeweg.appspot.com",
      messagingSenderId:"408582263618",
      appId:"1:408582263618:web:0a20f4bf0704989d3ceedb"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Wacht tot de kinder-header klaar staat + beveiliging toegepast is
    // layout.js zou zelf de header injecteren en beveiligen.
    document.addEventListener('DOMContentLoaded', async () => {
      // Vraag aan layout.js om de header te plaatsen & beveiliging te checken
      if (window.KinderLayout && typeof window.KinderLayout.mountHeader === 'function') {
        await window.KinderLayout.mountHeader({
          rootId: 'kinder-header',
          headerSrc: document.getElementById('kinder-header').dataset.headerSrc,
          active: 'gebeden' // active knop in menubalk
        });
      } else {
        // Fallback: header zelf includen (als layout.js nog niet klaar is)
        try {
          const src = document.getElementById('kinder-header').dataset.headerSrc;
          const html = await fetch(src, {cache:'no-cache'}).then(r=>r.text());
          document.getElementById('kinder-header').innerHTML = html;
        } catch(e) {
          console.warn('Header kon niet geladen worden:', e);
        }
      }

      // Beveiliging (als layout.js dit niet al gedaan heeft)
      if (!localStorage.getItem('kindIngelogd') ||
          !localStorage.getItem('ingelogdKindId') ||
          !localStorage.getItem('loginKeuze') ||
          !localStorage.getItem('ingelogdeParochie')) {
        // redirect naar login van volwassenenmodus
        window.location.href = "https://kathy-torfs.github.io/Orthodoxeweg/volwassenmodus/parochie.html";
        return;
      }

      // Gebeden laden
      laadGebeden();
    });

    async function laadGebeden() {
      const lijst = document.getElementById('gebedenLijst');
      lijst.innerHTML = '<div id="loadingMsg" style="font-size:1.2em;color:#888;text-align:center;margin:28px 0;">Laden...</div>';

      let gebeden = [];
      try {
        const doc = await db.collection("gebedenboek").doc("dagschema").get();
        if (doc.exists && Array.isArray(doc.data().blocks)) gebeden = doc.data().blocks;
      } catch(e) {
        lijst.innerHTML = '<div style="color:red;text-align:center;margin:28px 0;">Kan gebeden niet laden: ' + (e.message||e) + '</div>';
        return;
      }

      const parochieId = localStorage.getItem("ingelogdeParochie");
      const ouderLogin = localStorage.getItem("loginKeuze");
      const kindId    = localStorage.getItem("ingelogdKindId");
      const today = new Date().toISOString().slice(0,10);

      let statusData = {};
      try {
        const statDoc = await db
          .collection("parochies").doc(parochieId)
          .collection("leden").doc(ouderLogin)
          .collection("kinderen").doc(kindId)
          .collection("gebeden_status").doc(today)
          .get();
        if (statDoc.exists) statusData = statDoc.data() || {};
      } catch(e) {
        // laat statusData leeg
      }

      lijst.innerHTML = '';
      for (const blok of gebeden) {
        const done = !!statusData[blok.id];
        lijst.appendChild(maakGebedCard(blok, done, {parochieId, ouderLogin, kindId, today}));
      }
    }

    function toonPhoteinosGif() {
      const gif = document.getElementById('photeinosGif');
      if (!gif) return;
      gif.style.display = 'block';
      gif.style.animation = 'none';
      // force reflow
      void gif.offsetWidth;
      gif.style.animation = 'photeinosInOut 2.2s linear forwards';
      setTimeout(() => { gif.style.display = 'none'; }, 2200);
    }

    function maakGebedCard(gebed, checked, ctx) {
      const card = document.createElement('div');
      card.className = 'gebed-card';
      card.id = gebed.id;

      const puntenBadge = document.createElement('span');
      puntenBadge.className = 'gebed-punten';
      puntenBadge.textContent = `+${gebed.punten} punt${gebed.punten > 1 ? 'en' : ''}`;
      card.appendChild(puntenBadge);

      const titel = document.createElement('div');
      titel.className = 'gebed-titel';
      titel.textContent = gebed.titel;
      card.appendChild(titel);

      const tekst = document.createElement('div');
      tekst.className = 'gebed-tekst';
      tekst.textContent = gebed.tekst;
      card.appendChild(tekst);

      const btn = document.createElement('button');
      btn.className = 'gebed-btn';
      btn.textContent = checked ? "✔ Gedaan" : 'Ik heb gebeden!';
      btn.disabled = checked;

      btn.onclick = async function() {
        if (btn.disabled) return;
        btn.disabled = true;
        card.classList.add('fade');

        // Status voor vandaag zetten
        await db.collection("parochies").doc(ctx.parochieId)
          .collection("leden").doc(ctx.ouderLogin)
          .collection("kinderen").doc(ctx.kindId)
          .collection("gebeden_status").doc(ctx.today)
          .set({ [gebed.id]: true }, { merge: true });

        // Punten in Firestore verhogen
        await db.collection("parochies").doc(ctx.parochieId)
          .collection("leden").doc(ctx.ouderLogin)
          .collection("kinderen").doc(ctx.kindId)
          .update({ punten: firebase.firestore.FieldValue.increment(gebed.punten) });

        // Puntenteller in de header bijwerken via layout.js (als aanwezig)
        if (window.KinderLayout && typeof window.KinderLayout.refreshPoints === 'function') {
          window.KinderLayout.refreshPoints();
        }

        toonPhoteinosGif();
        setTimeout(() => card.remove(), 600);
      };

      card.appendChild(btn);

      // Als al gedaan, kaartje zacht verwijderen
      if (checked) {
        setTimeout(() => card.remove(), 1100);
      }

      return card;
    }
  </script>
</body>
</html>
