package be.orthodoxeweg.mijnorthodoxeweg

import android.content.Context
import androidx.compose.animation.AnimatedVisibility
import androidx.compose.animation.fadeOut
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.foundation.rememberScrollState
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.navigation.NavController
import androidx.compose.foundation.layout.WindowInsets
import androidx.compose.foundation.layout.statusBars
import androidx.compose.foundation.layout.asPaddingValues
import coil.compose.AsyncImage
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.firestore.SetOptions
import com.google.firebase.firestore.FieldValue
import kotlinx.coroutines.tasks.await
import java.text.SimpleDateFormat
import java.util.*

data class PrayerBlockKind(
    val id: String = "",
    val titel: String = "",
    val tekst: String = "",
    val punten: Int = 1
)

@Composable
fun IkBidKindScreen(navController: NavController) {
    val context = LocalContext.current
    // GIF loader met Coil (nodig voor animatie)
    val imageLoader = remember {
        coil.ImageLoader.Builder(context)
            .components { add(coil.decode.GifDecoder.Factory()) }
            .build()
    }
    val sharedPrefs = context.getSharedPreferences("prefs", Context.MODE_PRIVATE)
    val kindNaam = sharedPrefs.getString("ingelogdKindVoornaam", "Kind")
    val pastelKleuren = listOf(
        Color(0xFFFFF6E5), Color(0xFFFFFDE6), Color(0xFFFFE8EC), Color(0xFFE7F8FF),
        Color(0xFFE6FFE5), Color(0xFFFFF2FB), Color(0xFFF5FFE5), Color(0xFFF5E8FF)
    )
    val bgColor = remember { pastelKleuren[kotlin.random.Random.nextInt(pastelKleuren.size)] }

    // FIRESTORE: info ophalen
    val parochieId = sharedPrefs.getString("ingelogdeParochie", "") ?: ""
    val ouderLogin = sharedPrefs.getString("loginKeuze", "") ?: ""
    val kindId = sharedPrefs.getString("ingelogdKindId", "") ?: ""
    val db = FirebaseFirestore.getInstance()
    val today = remember { SimpleDateFormat("yyyy-MM-dd", Locale.getDefault()).format(Date()) }

    // ==== PUNTEN OPHALEN UIT FIRESTORE ====
    var punten by remember { mutableStateOf<Int?>(null) }
    LaunchedEffect(parochieId, ouderLogin, kindId) {
        if (parochieId.isNotBlank() && ouderLogin.isNotBlank() && kindId.isNotBlank()) {
            db.collection("parochies")
                .document(parochieId)
                .collection("leden")
                .document(ouderLogin)
                .collection("kinderen")
                .document(kindId)
                .get()
                .addOnSuccessListener { doc ->
                    punten = doc.getLong("punten")?.toInt() ?: 0
                }
                .addOnFailureListener {
                    punten = null
                }
        }
    }

    // ==== GEBEDEN LADEN UIT FIRESTORE ====
    var gebeden by remember { mutableStateOf<List<PrayerBlockKind>>(emptyList()) }
    var gebedenStatus by remember { mutableStateOf<Map<String, Boolean>>(emptyMap()) }
    var loading by remember { mutableStateOf(true) }
    var error by remember { mutableStateOf<String?>(null) }

    // Voor de GIF-animatie:
    var showGif by remember { mutableStateOf(false) }
    var gifTrigger by remember { mutableStateOf(0L) }

    // Trigger de GIF-animatie via één centrale LaunchedEffect:
    LaunchedEffect(gifTrigger) {
        if (gifTrigger != 0L) {
            showGif = true
            kotlinx.coroutines.delay(2500)
            showGif = false
        }
    }

    // Dagschema laden (inclusief puntenveld)
    LaunchedEffect(Unit) {
        loading = true
        try {
            val doc = db.collection("gebedenboek").document("dagschema").get().await()
            val blocks = doc["blocks"] as? List<Map<String, Any>> ?: emptyList()
            gebeden = blocks.map { blok ->
                PrayerBlockKind(
                    id = blok["id"] as? String ?: "",
                    titel = blok["titel"] as? String ?: "",
                    tekst = blok["tekst"] as? String ?: "",
                    punten = when (val p = blok["punten"]) {
                        is String -> p.toIntOrNull() ?: 1
                        is Number -> p.toInt()
                        else -> 1
                    }
                )
            }
        } catch (e: Exception) {
            error = "Kan gebeden niet laden: ${e.message}"
        }
        loading = false
    }

    // Gebedenstatus laden uit Firestore (per kind, per dag)
    val gebedenStatusDocRef = db
        .collection("parochies").document(parochieId)
        .collection("leden").document(ouderLogin)
        .collection("kinderen").document(kindId)
        .collection("gebeden_status").document(today)

    LaunchedEffect(parochieId, ouderLogin, kindId, today) {
        if (parochieId.isNotBlank() && ouderLogin.isNotBlank() && kindId.isNotBlank()) {
            try {
                val snapshot = gebedenStatusDocRef.get().await()
                @Suppress("UNCHECKED_CAST")
                gebedenStatus = snapshot.data as? Map<String, Boolean> ?: emptyMap()
            } catch (e: Exception) {
                gebedenStatus = emptyMap()
            }
        }
    }

    // === ALLES in één scrolbare Column ===
    Box(
        modifier = Modifier
            .fillMaxSize()
            .background(bgColor)
    ) {
        Column(
            modifier = Modifier
                .verticalScroll(rememberScrollState())
                .padding(
                    top = WindowInsets.statusBars.asPaddingValues().calculateTopPadding() + 8.dp,
                    start = 18.dp,
                    end = 18.dp,
                    bottom = 18.dp
                ),
            horizontalAlignment = Alignment.CenterHorizontally,
            verticalArrangement = Arrangement.Top
        ) {
            // Bovenaan: begroeting en menubalk
            KinderAppBegroeting(punten=punten)
            KinderAppMenuBalk(navController = navController)

            // Titel
            Text(
                text = "Vandaag bidden we samen!",
                style = MaterialTheme.typography.titleLarge,
                color = Color(0xFF67510C),
                modifier = Modifier.padding(top = 18.dp, bottom = 4.dp)
            )

            // Laadindicator of foutmelding
            when {
                loading -> {
                    CircularProgressIndicator(modifier = Modifier.padding(32.dp))
                }
                error != null -> {
                    Text(
                        text = error!!,
                        color = MaterialTheme.colorScheme.error,
                        modifier = Modifier.padding(24.dp)
                    )
                }
                else -> {
                    gebeden.forEach { blokje ->
                        val checked = gebedenStatus[blokje.id] == true
                        var visible by remember(blokje.id, checked) { mutableStateOf(!checked) }

                        LaunchedEffect(checked) {
                            if (checked) {
                                kotlinx.coroutines.delay(350)
                                visible = false
                            } else {
                                visible = true
                            }
                        }

                        AnimatedVisibility(
                            visible = visible,
                            exit = fadeOut()
                        ) {
                            Card(
                                modifier = Modifier
                                    .fillMaxWidth()
                                    .padding(vertical = 9.dp, horizontal = 3.dp),
                                shape = RoundedCornerShape(22.dp),
                                colors = CardDefaults.cardColors(
                                    containerColor = if (checked) Color(0xFFD8FFDF) else Color(0xFFFFF6E2)
                                ),
                                elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
                            ) {
                                Column(
                                    modifier = Modifier
                                        .padding(16.dp)
                                        .fillMaxWidth(),
                                    horizontalAlignment = Alignment.CenterHorizontally
                                ) {
                                    Text(
                                        blokje.titel,
                                        fontWeight = androidx.compose.ui.text.font.FontWeight.Bold,
                                        fontSize = 19.sp,
                                        color = Color(0xFF795020)
                                    )
                                    Spacer(Modifier.height(8.dp))
                                    Text(
                                        blokje.tekst,
                                        fontSize = 16.sp,
                                        color = Color(0xFF46351F),
                                        lineHeight = 22.sp
                                    )
                                    Spacer(Modifier.height(15.dp))
                                    Button(
                                        onClick = {
                                            gebedenStatus = gebedenStatus.toMutableMap().apply {
                                                put(blokje.id, true)
                                            }
                                            gebedenStatusDocRef.set(
                                                mapOf(blokje.id to true),
                                                SetOptions.merge()
                                            )

                                            // Punten exact uit blokje pakken
                                            val puntenToevoegen = blokje.punten

                                            // Punten atomair optellen in Firestore
                                            db.collection("parochies")
                                                .document(parochieId)
                                                .collection("leden")
                                                .document(ouderLogin)
                                                .collection("kinderen")
                                                .document(kindId)
                                                .update("punten", FieldValue.increment(puntenToevoegen.toLong()))

                                            // Lokaal ook verhogen voor directe feedback
                                            punten = (punten ?: 0) + puntenToevoegen

                                            // GIF-animatie: update trigger
                                            gifTrigger = System.currentTimeMillis()
                                        },
                                        enabled = !checked,
                                        colors = ButtonDefaults.buttonColors(
                                            containerColor = if (!checked) Color(0xFF7bb235) else Color(0xFFD8FFDF),
                                            contentColor = Color.White
                                        ),
                                        shape = RoundedCornerShape(13.dp),
                                        modifier = Modifier
                                            .fillMaxWidth()
                                            .height(45.dp)
                                    ) {
                                        Text(
                                            if (!checked) "Ik heb gebeden!" else "✔ Gedaan",
                                            fontWeight = androidx.compose.ui.text.font.FontWeight.Bold,
                                            fontSize = 17.sp
                                        )
                                    }
                                }
                            }
                        }
                    }
                }
            }
            Spacer(modifier = Modifier.height(32.dp))
        }

        // ---- GIF: kiekeboeduim springt van LINKS in beeld en verdwijnt vanzelf ----
        AnimatedVisibility(
            visible = showGif,
            modifier = Modifier
                .align(Alignment.CenterStart)
                .padding(bottom = 80.dp, start = 0.dp) // Helemaal links!
        ) {
            AsyncImage(
                model = coil.request.ImageRequest.Builder(context)
                    .data(R.drawable.photeinos_kiekeboeduim)
                    .build(),
                imageLoader = imageLoader,
                contentDescription = "Photeinos kiekeboe",
                modifier = Modifier.size(110.dp)
            )
        }
    }
}
