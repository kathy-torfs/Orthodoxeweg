<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Springspel ‚Äì Orthodoxe Kinderpagina</title>
  <link rel="icon" href="images/kruis.png" />
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
  <script src="vragen.js"></script>
  <script defer src="common/layout.js"></script>
  <style>
    :root{ --primair:#7bb235; --donker:#67510C; }
    body{
      margin:0; font-family:'Comic Sans MS', Arial, sans-serif;
      background:#fff6e5; color:#333;
    }
    main{ max-width:1000px; margin:20px auto; padding:0 16px; text-align:center }
    #spelcontainer{ margin:24px auto; width:900px; height:600px; }
    #infoBar{
      width:900px; max-width:96vw; margin:10px auto 0 auto;
      display:flex; justify-content:space-between;
      font-size:18px; background:#fffde6;
      border-radius:12px; padding:6px 16px; font-weight:bold;
    }
    .vraag-overlay{
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.22); display:flex;
      align-items:center; justify-content:center;
      z-index:9999;
    }
    .vraag-box{
      background:#fffde6; padding:24px;
      border-radius:16px; box-shadow:0 2px 18px rgba(0,0,0,0.2);
      max-width:90vw; width:420px; font-size:18px; color:#333;
    }
    .vraag-antw-btn{
      display:block; width:100%; margin:6px 0;
      padding:8px; border:none; border-radius:8px;
      background:#7bb235; color:white; font-weight:bold; cursor:pointer;
    }
    .vraag-antw-btn:hover{ background:#4c8617 }
    #startBtn{
      background: var(--primair); color: #fff; border:none; border-radius: 10px;
      padding: 8px 18px; font-size: 19px; font-weight: bold; margin: 14px auto 0 auto; display:block;
      box-shadow: 0 2px 10px #9eceb3a0;
    }
    #startBtn[disabled]{ opacity:0.5; pointer-events:none;}
  </style>
</head>
<body>
  <div id="kinder-header" data-header-src="common/header.html"></div>
  <main>
    <h1>Springspel üèÉ‚Äç‚ôÇÔ∏èü™Ω</h1>
    <button id="startBtn">Start Springspel (20 punten)</button>
    <div id="infoBar" style="display:none">
      <span id="levelInfo">Level 1</span>
      <span id="vleugelInfo">Vleugels: 0/10</span>
      <span id="puntenInfo">Punten: ...</span>
    </div>
    <div id="spelcontainer"></div>
    <div id="vraag-overlay" style="display:none"></div>
  </main>
<script>
// Header / menubalk laden, active-tab is 'spelletjes'
(function boot(){
  if (!(window.KinderLayout)) return setTimeout(boot,120);
  const el=document.getElementById('kinder-header');
  window.KinderLayout.mountHeader({ rootId:'kinder-header', headerSrc:el.dataset.headerSrc, active:'spelletjes' });
})();

// ======= Firebase helpers (pas aan op je project) ==========
async function haalPunten() {
  // return (await firebase.firestore().collection("kinderen").doc(window.CurrentChildId).get()).data().punten ?? 0;
  // Vervang bovenste door Firestore-code indien live!
  return parseInt(localStorage.getItem("kinderpunten")||'100',10);
}
async function zetPunten(nieuw) {
  // await firebase.firestore().collection("kinderen").doc(window.CurrentChildId).update({punten: nieuw});
  localStorage.setItem("kinderpunten",nieuw);
}
async function wijzigPunten(delta) {
  let huidig = await haalPunten();
  let nieuw = Math.max(0, huidig + delta);
  await zetPunten(nieuw);
  toonPunten(nieuw);
}
async function toonPunten(nieuw) {
  document.getElementById('puntenInfo').textContent = "Punten: " + nieuw;
}

// ------------ GAME ------------
let speler, cursors, jumpRequested=false, canJump=true;
let obstacles=[], wings=[];
let level=1, vleugels=0, maxLevels=5, speed=1.1, gravityY=1050;
let spelBlokkeren=false, spelGestart=false, gameInstance;

const GAME_WIDTH=900, GAME_HEIGHT=600;
const GROUND_Y=GAME_HEIGHT-14;
const SPELER_SIZE=Math.round(GAME_HEIGHT*0.4);

// Levelkleuren/emoji's
const bgLevels=[
  { kleur:'#b2e5f5', emoji:'üå§Ô∏è' },
  { kleur:'#d7f5b2', emoji:'üåª' },
  { kleur:'#ffeec9', emoji:'‚òÄÔ∏è' },
  { kleur:'#e7ddf7', emoji:'üåà' },
  { kleur:'#f2b2f5', emoji:'üåû' },
];

document.getElementById("startBtn").onclick = async function(){
  let punten = await haalPunten();
  if(punten<20){
    alert("Je hebt minstens 20 punten nodig om dit spel te starten.");
    return;
  }
  await wijzigPunten(-20);
  document.getElementById('startBtn').style.display='none';
  document.getElementById('infoBar').style.display='';
  spelGestart=true;
  startGame();
};

async function startGame(){
  vleugels=0; speed=1.1+(level-1)*.16; spelBlokkeren=false;
  document.getElementById("levelInfo").textContent = "Level "+level;
  document.getElementById("vleugelInfo").textContent = "Vleugels: 0/10";
  toonPunten(await haalPunten());
  if(gameInstance) { gameInstance.destroy(true); }
  gameInstance = new Phaser.Game({
    type: Phaser.AUTO,
    width: GAME_WIDTH,
    height: GAME_HEIGHT,
    parent: 'spelcontainer',
    physics: {
      default: 'arcade',
      arcade: { gravity: { y: gravityY+(level-1)*80 }, debug: false }
    },
    scene: { preload, create, update }
  });
}

function preload() {}
function create() {
  // Achtergrondkleur + emoji
  this.cameras.main.setBackgroundColor(bgLevels[level-1].kleur);
  for(let i=0;i<3;i++) this.add.text(90+Math.random()*700,80+Math.random()*260,bgLevels[level-1].emoji,{fontSize:'56px'}).setAlpha(0.35);

  // Grasveld
  this.add.rectangle(GAME_WIDTH/2,GAME_HEIGHT-22,GAME_WIDTH,70,0xbde5a0);

  // Bloemen (verschuiven langzaam)
  this.flowers=[];
  let bloemIcons=["üå∏","üåª","üåº","üå∫","üå∑","üåπ"];
  for(let i=0;i<8;i++){
    let f=this.add.text(Math.random()*GAME_WIDTH,GAME_HEIGHT-22,bloemIcons[Math.floor(Math.random()*bloemIcons.length)],{fontSize:'34px'});
    f.setOrigin(0.5,1);
    this.flowers.push(f);
  }

  // Speler
  speler = this.add.text(GAME_WIDTH*0.18,GROUND_Y,"üèÉ‚Äç‚ôÇÔ∏è",{
    fontFamily:'Segoe UI Emoji, Arial',
    fontSize: SPELER_SIZE+'px'
  });
  speler.setOrigin(0.5,1);
  speler.setScale(-1,1); // Spiegelen naar rechts!
  this.physics.add.existing(speler);
  speler.body.setCollideWorldBounds(true);
  speler.body.setGravityY(gravityY+(level-1)*80);
  speler.body.setBounce(0.0);

  // Grond
  let ground = this.add.rectangle(GAME_WIDTH/2, GAME_HEIGHT-2, GAME_WIDTH, 8, 0x000, 0);
  this.physics.add.existing(ground,true);
  this.physics.add.collider(speler, ground);

  // Obstakels (schedels en vleugels), max 2 tegelijk!
  obstacles=[]; wings=[];
  cursors = this.input.keyboard.createCursorKeys();
  this.input.keyboard.on('keydown-SPACE',()=>{jumpRequested=true;});
  this.input.keyboard.on('keydown-UP',()=>{jumpRequested=true;});
  this.input.on('pointerdown',()=>{jumpRequested=true;});

  // Start 2 van elk (max 2 on screen)
  for(let i=0;i<2;i++) createObstacle(this,GAME_WIDTH+220*i+60,GROUND_Y,"üíÄ");
  for(let i=0;i<2;i++) createWing(this,GAME_WIDTH+190*i+120,GAME_HEIGHT*0.25,"ü™Ω");

  this.time.addEvent({
    delay:22, loop:true, callback:()=>{
      if(spelBlokkeren) return;
      // Laat alles langzaam bewegen
      moveAll.call(this, -speed);
      // Bloemen/carrousel
      this.flowers.forEach(f=>{
        f.x+=-speed*1.07;
        if(f.x<-24) f.x=GAME_WIDTH+Math.random()*140;
      });
    }
  });
}

function moveAll(dx){
  // Houd altijd max 2 on screen per soort
  let activeSkulls=obstacles.filter(o=>o.x>-60);
  let activeWings=wings.filter(w=>w.x>-60);
  // Obstakels
  obstacles.forEach((o,i)=>{
    o.x+=dx;
    if(o.x<-60){
      // Reset pas als minder dan 2 zichtbaar
      if(activeSkulls.length<2){
        o.x = GAME_WIDTH+200+Math.random()*250;
        o.hit = false;
      }
    }
  });
  // Vleugels
  wings.forEach((w,i)=>{
    w.x+=dx;
    if(w.x<-60){
      if(activeWings.length<2){
        w.x = GAME_WIDTH+170+Math.random()*210;
        w.collected = false;
        w.setVisible(true);
      }
    }
  });
}

function update(){
  if(spelBlokkeren) return;
  // Springen (langzaam naar beneden)
  if(jumpRequested && speler.body.blocked.down && canJump){
    speler.body.setVelocityY(-900-(level-1)*80); // iets lager springen!
    jumpRequested=false; canJump=false;
    setTimeout(()=>canJump=true,600);
  }
  let bounds=speler.getBounds();
  let hoofd={x:bounds.centerX, y:bounds.top+30};
  let voet={x:bounds.centerX+30, y:bounds.bottom-8};

  // Schedelbotsing (alleen als op grond!)
  obstacles.forEach(o=>{
    if(!spelBlokkeren && !o.hit){
      let ox=o.x, oy=o.y-24;
      let opGrond=speler.body.blocked.down;
      let dR=Math.hypot(voet.x-ox, voet.y-oy);
      if(opGrond && dR<62){
        o.hit=true; stelVraag("zonde");
      }
    }
  });
  // Vleugel pakken (in de lucht)
  wings.forEach(w=>{
    if(!spelBlokkeren && !w.collected){
      let wBounds=w.getBounds();
      let dx=hoofd.x-wBounds.centerX, dy=hoofd.y-wBounds.centerY;
      if(Math.sqrt(dx*dx+dy*dy)<60){
        w.collected=true; w.setVisible(false);
        vleugels++; document.getElementById("vleugelInfo").textContent="Vleugels: "+vleugels+"/10";
        stelVraag("licht");
        if(vleugels>=10) volgendLevel();
      }
    }
  });
}

function createObstacle(scene, x, y, emoji){
  let o=scene.add.text(x, y, emoji, {
    fontFamily: 'Segoe UI Emoji, Arial',
    fontSize: '85px'
  });
  o.setOrigin(0.5, 1); o.hit=false; obstacles.push(o); return o;
}
function createWing(scene, x, y, emoji){
  let w=scene.add.text(x, y, emoji, {
    fontFamily: 'Segoe UI Emoji, Arial',
    fontSize: '72px'
  });
  w.setOrigin(0.5, 0.5); w.collected=false; wings.push(w); return w;
}

// ===== Vraaglogica =====
function stelVraag(type){
  let pool;
  if(type==="licht"){
    if(level===1) pool=vragen.filter(q=>q.difficulty===1);
    else if(level===2) pool=vragen.filter(q=>q.difficulty===2);
    else pool=vragen.filter(q=>q.difficulty===3);
  } else if(type==="zonde"){
    pool=vragen.filter(q=>q.difficulty==="zonde");
  }
  if(!pool||!pool.length)return;
  const v=pool[Math.floor(Math.random()*pool.length)];
  const overlay=document.getElementById("vraag-overlay");
  overlay.innerHTML=`
    <div class="vraag-overlay">
      <div class="vraag-box">
        <h3>Vraag:</h3>
        <div style="margin-bottom:14px">${v.q}</div>
        ${v.a.map((ans,i)=>`<button class="vraag-antw-btn" onclick="beantwoordVraag(${i},${v.correct},'${type}')">${ans}</button>`).join("")}
      </div>
    </div>`;
  overlay.style.display=""; spelBlokkeren=true;
}

window.beantwoordVraag=function(given,correct,type){
  const overlay=document.getElementById("vraag-overlay");
  if(given===correct){
    overlay.style.display="none"; spelBlokkeren=false;
  }else{
    if(type==="zonde"){
      alert("Fout! Je bent tegen een zonde gelopen. Game Over.");
      location.reload();
    }else{
      overlay.innerHTML=`<div class="vraag-overlay"><div class="vraag-box">Dat was fout!</div></div>`;
      setTimeout(()=>{ overlay.style.display="none"; spelBlokkeren=false; },500);
    }
  }
};

async function volgendLevel(){
  level++;
  if(level>maxLevels){
    await wijzigPunten(10);
    alert("Gefeliciteerd, je hebt alle levels uitgespeeld!\nJe krijgt 10 punten als beloning!");
    document.getElementById('startBtn').style.display='';
    document.getElementById('infoBar').style.display='none';
    spelGestart=false; vleugels=0; level=1;
    if(gameInstance) gameInstance.destroy(true);
    return;
  }
  vleugels=0;
  document.getElementById("levelInfo").textContent="Level "+level;
  document.getElementById("vleugelInfo").textContent="Vleugels: 0/10";
  if(gameInstance) gameInstance.destroy(true);
  setTimeout(startGame,350);
};
</script>
</body>
</html>
