<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Springspel ‚Äì Orthodoxe Kinderpagina</title>
  <link rel="icon" href="images/kruis.png" />
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
  <script src="vragen.js"></script>
  <script defer src="common/layout.js"></script>
  <style>
    :root{ --primair:#7bb235; --donker:#67510C; }
    body{
      margin:0; font-family:'Comic Sans MS', Arial, sans-serif; 
      background:#fff6e5; color:#333;
    }
    main{ max-width:1000px; margin:20px auto; padding:0 16px; text-align:center }
    #spelcontainer{ margin:20px auto; width:900px; height:600px }
    #infoBar{
      width:900px; max-width:96vw; margin:10px auto;
      display:flex; justify-content:space-between;
      font-size:18px; background:#fffde6;
      border-radius:12px; padding:6px 16px; font-weight:bold;
    }
    .vraag-overlay{
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.2); display:flex;
      align-items:center; justify-content:center;
      z-index:9999;
    }
    .vraag-box{
      background:#fffde6; padding:24px;
      border-radius:16px; box-shadow:0 2px 18px rgba(0,0,0,0.2);
      max-width:90vw; width:420px; font-size:18px; color:#333;
    }
    .vraag-antw-btn{
      display:block; width:100%; margin:6px 0;
      padding:8px; border:none; border-radius:8px;
      background:#7bb235; color:white; font-weight:bold; cursor:pointer;
    }
    .vraag-antw-btn:hover{ background:#4c8617 }
    #startBtn{
      background: var(--primair); color: #fff; border:none; border-radius: 10px;
      padding: 8px 18px; font-size: 19px; font-weight: bold; margin: 14px auto 0 auto; display:block;
      box-shadow: 0 2px 10px #9eceb3a0;
    }
  </style>
</head>
<body>
  <div id="kinder-header" data-header-src="common/header.html"></div>

  <main>
    <h1>Springspel üèÉ‚Äç‚ôÇÔ∏èü™Ω</h1>
    <button id="startBtn">Start Springspel (20 punten)</button>
    <div id="infoBar" style="display:none">
      <span id="levelInfo">Level 1</span>
      <span id="vleugelInfo">Vleugels: 0/10</span>
      <span id="puntenInfo">Punten: ...</span>
    </div>
    <div id="spelcontainer"></div>
    <div id="vraag-overlay" style="display:none"></div>
  </main>

<script>
(function boot(){
  if (!(window.KinderLayout)) return setTimeout(boot,120);
  const el=document.getElementById('kinder-header');
  window.KinderLayout.mountHeader({ rootId:'kinder-header', headerSrc:el.dataset.headerSrc, active:'spelletjes' });
})();

// Firebase puntenlogica
async function getUserPoints(){
  const db=firebase.firestore();
  const parochieId=localStorage.getItem("ingelogdeParochie");
  const ouderLogin=localStorage.getItem("loginKeuze");
  const kindId=localStorage.getItem("ingelogdKindId");
  if(!parochieId||!ouderLogin||!kindId)return 0;
  const ref=db.collection("parochies").doc(parochieId).collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId);
  const snap=await ref.get(); return snap.exists?(snap.data().punten||0):0;
}
async function updateUserPoints(delta){
  const db=firebase.firestore();
  const parochieId=localStorage.getItem("ingelogdeParochie");
  const ouderLogin=localStorage.getItem("loginKeuze");
  const kindId=localStorage.getItem("ingelogdKindId");
  if(!parochieId||!ouderLogin||!kindId)return;
  const ref=db.collection("parochies").doc(parochieId).collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId);
  await db.runTransaction(async tx=>{
    const snap=await tx.get(ref);
    if(!snap.exists)return;
    const current=snap.data().punten||0;
    tx.update(ref,{punten: Math.max(0,current+delta)});
  });
  document.getElementById("puntenInfo").textContent="Punten: "+await getUserPoints();
}

// ---- Game ----
let game, speler, cursors, jumpRequested=false, canJump=true;
let obstacles=[], wings=[];
let level=1, vleugels=0, maxLevels=5, speed=1.2;
let spelBlokkeren=false;

const GAME_WIDTH=900, GAME_HEIGHT=600, LUCHT_H=GAME_HEIGHT*0.5;

document.getElementById("startBtn").onclick=async()=>{
  const punten=await getUserPoints();
  if(punten<20){ alert("Niet genoeg punten!"); return; }
  await updateUserPoints(-20);
  document.getElementById("startBtn").style.display="none";
  document.getElementById("infoBar").style.display="";
  startGame();
};

function startGame(){
  vleugels=0; level=1; speed=1.2;
  document.getElementById("levelInfo").textContent="Level 1";
  document.getElementById("vleugelInfo").textContent="Vleugels: 0/10";
  if(game) game.destroy(true);
  game=new Phaser.Game({
    type:Phaser.AUTO, width:GAME_WIDTH, height:GAME_HEIGHT, parent:"spelcontainer",
    physics:{ default:"arcade", arcade:{ gravity:{y:1700}, debug:false }},
    scene:{ preload, create, update }
  });
}

function preload(){}

function create(){
  // achtergrond
  this.bg=this.add.tileSprite(0,0,GAME_WIDTH,GAME_HEIGHT,"").setOrigin(0);
  this.add.rectangle(GAME_WIDTH/2,LUCHT_H/2,GAME_WIDTH,LUCHT_H,0xaee7ff);
  this.add.rectangle(GAME_WIDTH/2,LUCHT_H+(GAME_HEIGHT-LUCHT_H)/2,GAME_WIDTH,GAME_HEIGHT-LUCHT_H,0x8bc34a);

  // zon & wolkjes
  this.add.text(100,100,"‚òÄÔ∏è",{fontSize:"80px"});
  this.add.text(300,80,"‚òÅÔ∏è",{fontSize:"60px"});
  this.add.text(600,120,"‚òÅÔ∏è",{fontSize:"50px"});

  // speler
  speler=this.add.text(130,GAME_HEIGHT-15,"üèÉ‚Äç‚ôÇÔ∏è",{fontSize:"240px"});
  speler.setOrigin(0.5,1);
  this.physics.add.existing(speler);
  speler.body.setCollideWorldBounds(true);

  let ground=this.add.rectangle(GAME_WIDTH/2,GAME_HEIGHT-2,GAME_WIDTH,8,0x000,0);
  this.physics.add.existing(ground,true);
  this.physics.add.collider(speler,ground);

  cursors=this.input.keyboard.createCursorKeys();
  this.input.keyboard.on("keydown-SPACE",()=>jumpRequested=true);
  this.input.keyboard.on("keydown-UP",()=>jumpRequested=true);
  this.input.on("pointerdown",()=>jumpRequested=true);

  for(let i=0;i<2;i++) createObstacle(this,GAME_WIDTH+200*i,GAME_HEIGHT-14,"üíÄ");
  for(let i=0;i<2;i++) createWing(this,GAME_WIDTH+180*i+120,LUCHT_H/2+40,"ü™Ω");

  this.time.addEvent({ delay:15, loop:true, callback:()=>{ if(!spelBlokkeren) moveAll(-speed);} });
}

function update(){
  if(spelBlokkeren) return;
  if(jumpRequested && speler.body.blocked.down && canJump){
    speler.body.setVelocityY(-1500);
    jumpRequested=false; canJump=false; setTimeout(()=>canJump=true,500);
  }

  let bounds=speler.getBounds();
  let hoofd={x:bounds.centerX,y:bounds.top+34};
  let voet={x:bounds.centerX+28,y:bounds.bottom-8};

  // üíÄ skulls: enkel hit als speler op de grond staat
  obstacles.forEach(o=>{
    if(!o.hit && Math.hypot(voet.x-o.x,voet.y-o.y)<60){
      if(speler.body.blocked.down){
        o.hit=true; stelVraag("zonde");
      }
    }
  });

  // ü™Ω vleugels
  wings.forEach(w=>{
    if(!w.collected && Math.hypot(hoofd.x-w.x,hoofd.y-w.y)<70){
      w.collected=true; w.setVisible(false);
      vleugels++;
      document.getElementById("vleugelInfo").textContent="Vleugels: "+vleugels+"/10";
      stelVraag("licht");
      if(vleugels>=10) volgendLevel();
    }
  });
}

function createObstacle(scene,x,y,emoji){
  let o=scene.add.text(x,y,emoji,{fontSize:"80px"}); o.setOrigin(0.5,1); o.hit=false; obstacles.push(o); return o;
}
function createWing(scene,x,y,emoji){
  let w=scene.add.text(x,y,emoji,{fontSize:"70px"}); w.setOrigin(0.5,0.5); w.collected=false; wings.push(w); return w;
}
function moveAll(dx){
  obstacles.forEach(o=>{
    o.x+=dx; 
    if(o.x<-60){o.x=GAME_WIDTH+200+Math.random()*300;o.hit=false;}
  });
  wings.forEach(w=>{
    w.x+=dx; 
    if(w.x<-60){w.x=GAME_WIDTH+200+Math.random()*300;w.setVisible(true);w.collected=false;}
  });
}

// ===== Volgend level =====
async function volgendLevel(){
  level++; vleugels=0; speed+=0.2;
  if(level>maxLevels){ 
    await updateUserPoints(+10); 
    alert("Gefeliciteerd! Alle levels gehaald, je krijgt 10 punten terug."); 
    location.reload(); return; 
  }
  document.getElementById("levelInfo").textContent="Level "+level;
  document.getElementById("vleugelInfo").textContent="Vleugels: 0/10";
  if(game) game.destroy(true);
  setTimeout(startGame,300);
}

// ===== Vraaglogica =====
function stelVraag(type){
  let pool;
  if(type==="licht"){
    if(level===1) pool=vragen.filter(q=>q.difficulty===1);
    else if(level===2) pool=vragen.filter(q=>q.difficulty===2);
    else pool=vragen.filter(q=>q.difficulty===3);
  } else if(type==="zonde"){
    pool=vragen.filter(q=>q.difficulty==="zonde");
  }
  if(!pool||!pool.length)return;
  const v=pool[Math.floor(Math.random()*pool.length)];

  const overlay=document.getElementById("vraag-overlay");
  overlay.innerHTML=`
    <div class="vraag-overlay">
      <div class="vraag-box">
        <h3>Vraag:</h3>
        <div style="margin-bottom:14px">${v.q}</div>
        ${v.a.map((ans,i)=>`<button class="vraag-antw-btn" onclick="beantwoordVraag(${i},${v.correct},'${type}')">${ans}</button>`).join("")}
      </div>
    </div>`;
  overlay.style.display=""; spelBlokkeren=true;
}

window.beantwoordVraag=function(given,correct,type){
  const overlay=document.getElementById("vraag-overlay");
  if(given===correct){
    overlay.style.display="none"; spelBlokkeren=false;
  }else{
    if(type==="zonde"){ 
      alert("Fout! Je bent tegen een zonde gelopen. Game Over.");
      location.reload();
    }else{
      overlay.innerHTML=`<div class="vraag-overlay"><div class="vraag-box">Dat was fout!</div></div>`;
      setTimeout(()=>{ overlay.style.display="none"; spelBlokkeren=false; },500);
    }
  }
};
</script>
</body>
</html>
