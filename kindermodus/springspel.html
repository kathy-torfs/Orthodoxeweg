<!DOCTYPE html> 
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Springspel ‚Äì Orthodoxe Kinderpagina</title>
  <link rel="icon" href="images/kruis.png" />

  <style>
    :root{
      --primair:#7bb235; --donker:#67510C;
      --pastel1:#fff6e5; --pastel2:#fffde6; --pastel3:#ffe8ec; --pastel4:#e7f8ff;
      --pastel5:#e6ffe5; --pastel6:#fff2fb; --pastel7:#f5ffe5; --pastel8:#f5e8ff;
      --pastel9:#fff6fb; --pastel10:#e7fff9; --pastel11:#f3e6ff; --pastel12:#ffeae6;
      --pastel13:#ecffe9; --pastel14:#f7fff3; --pastel15:#eafffa; --pastel16:#fff4ea;
    }
    body{
      margin:0; font-family:'Comic Sans MS', Arial, sans-serif; color:#333;
      min-height:100vh; background:var(--pastel1); transition:background .6s;
    }
    main{ max-width:1000px; margin:20px auto; padding:0 16px; text-align:center }

    #spelcontainer{ margin:20px auto; width:900px; height:600px; }

    #infoBar {
      width:900px; max-width:96vw; margin:20px auto; display:flex; justify-content:space-between;
      font-size:20px; background:#fffde6; border-radius:12px; padding:8px 20px; box-shadow:0 2px 12px #bedbe880;
      font-weight:bold;
    }
    .btn{
      background:var(--primair); color:#fff; border:none; border-radius:8px;
      padding:8px 14px; font-weight:bold; cursor:pointer;
      margin:4px;
    }
    .vraag-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.18); z-index: 9999; display: flex;
      align-items: center; justify-content: center;
    }
    .vraag-box {
      background: #fffde6; padding: 32px 28px 20px 28px;
      border-radius: 18px; box-shadow: 0 2px 24px #8bc34ab0;
      max-width: 96vw; width: 420px; font-family: 'Comic Sans MS', Arial, sans-serif;
      color: #2276b9; font-size: 20px;
    }
    .vraag-box h3 { margin: 0 0 16px 0; font-size: 1.1em; font-weight: bold; color: #67510C;}
    .vraag-antw-btn {
      margin: 10px 0; background: #7bb235; color: white;
      border: none; border-radius: 8px; font-size: 17px;
      padding: 8px 14px; width: 96%; cursor: pointer; display: block;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
  <script src="vragen.js"></script>
  <script defer src="common/layout.js"></script>
</head>
<body>
  <div id="kinder-header" data-header-src="common/header.html"></div>

  <main>
    <h1>Springspel üèÉ‚Äç‚ôÇÔ∏èü™Ω</h1>

    <div>
      <button id="startBtn" class="btn">Spel starten (20 punten)</button>
      <button id="resetBtn" class="btn" style="display:none;">Opnieuw spelen</button>
    </div>

    <div id="infoBar" style="display:none">
      <span id="levelInfo">Level 1</span>
      <span id="vleugelInfo">Vleugels: 0/10</span>
      <span id="puntenInfo">Punten: ...</span>
    </div>

    <div id="spelcontainer"></div>
    <div id="vraag-overlay" style="display:none"></div>
  </main>

  <script>
    // Achtergrond
    (function(){
      const p=['var(--pastel1)','var(--pastel2)','var(--pastel3)','var(--pastel4)','var(--pastel5)',
               'var(--pastel6)','var(--pastel7)','var(--pastel8)','var(--pastel9)','var(--pastel10)',
               'var(--pastel11)','var(--pastel12)','var(--pastel13)','var(--pastel14)','var(--pastel15)','var(--pastel16)'];
      document.body.style.background=p[Math.floor(Math.random()*p.length)];
    })();

    // Header
    (function boot(){
      if (!(window.KinderLayout)) return setTimeout(boot,120);
      const el=document.getElementById('kinder-header');
      window.KinderLayout.mountHeader({ rootId:'kinder-header', headerSrc:el.dataset.headerSrc, active:'spelletjes' });
    })();

    // Firestore helpers
    async function getUserPoints(){
      const db=firebase.firestore();
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(!parochieId||!ouderLogin||!kindId)return 0;
      const ref=db.collection("parochies").doc(parochieId).collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId);
      const snap=await ref.get(); return snap.exists?(snap.data().punten||0):0;
    }
    async function updatePoints(delta){
      const db=firebase.firestore();
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(!parochieId||!ouderLogin||!kindId)return;
      const ref=db.collection("parochies").doc(parochieId).collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId);
      await db.runTransaction(async tx=>{
        const snap=await tx.get(ref);
        if(!snap.exists)return;
        const current=snap.data().punten||0;
        tx.update(ref,{punten:Math.max(0,current+delta)});
      });
    }

    // Springspel variabelen
    let speler, cursors, jumpRequested=false, canJump=true;
    let obstacles=[], wings=[], clouds=[], flowers=[];
    let speed=1.2, level=1, vleugels=0, levelsMax=5;
    let spelBlokkeren=false;
    let gameInstance;

    const GAME_WIDTH=900, GAME_HEIGHT=600, LUCHT_H=GAME_HEIGHT*0.5;
    const FOOT_RADIUS=28, HEAD_RADIUS=30;

    document.getElementById("startBtn").addEventListener("click",async()=>{
      const points=await getUserPoints();
      if(points<20){ alert("Niet genoeg punten om te spelen!"); return; }
      await updatePoints(-20);
      document.getElementById("startBtn").style.display="none";
      document.getElementById("resetBtn").style.display="inline-block";
      document.getElementById("infoBar").style.display="";
      startGame();
    });
    document.getElementById("resetBtn").addEventListener("click",()=>location.reload());

    async function startGame(){
      level=1; vleugels=0; speed=1.2;
      document.getElementById("levelInfo").textContent="Level 1";
      document.getElementById("vleugelInfo").textContent="Vleugels: 0/10";
      document.getElementById("puntenInfo").textContent="Punten: "+await getUserPoints();
      if(gameInstance) gameInstance.destroy(true);

      gameInstance=new Phaser.Game({
        type: Phaser.AUTO,
        width: GAME_WIDTH,
        height: GAME_HEIGHT,
        parent:'spelcontainer',
        physics:{ default:'arcade', arcade:{gravity:{y:1700},debug:false}},
        scene:{preload,create,update}
      });
    }

    function preload(){}
    function create(){
      for(let i=0;i<6;i++) addCloud(this,Math.random()*GAME_WIDTH,60+Math.random()*140);
      for(let i=0;i<8;i++) addFlower(this,Math.random()*GAME_WIDTH,GAME_HEIGHT-24);

      this.add.rectangle(GAME_WIDTH/2,LUCHT_H/2,GAME_WIDTH,LUCHT_H,0xaee7ff);
      this.add.rectangle(GAME_WIDTH/2,LUCHT_H+(GAME_HEIGHT-LUCHT_H)/2,GAME_WIDTH,GAME_HEIGHT-LUCHT_H,0x8bc34a);

      const spelerGrootte=GAME_HEIGHT*0.4;
      const grondNiveau=GAME_HEIGHT-15;
      speler=this.add.text(130,grondNiveau,"üèÉ‚Äç‚ôÇÔ∏è",{fontFamily:'Segoe UI Emoji, Arial',fontSize:Math.round(spelerGrootte)+'px'});
      speler.setOrigin(0.5,1); speler.setScale(-1,1);

      this.physics.add.existing(speler);
      speler.body.setCollideWorldBounds(true);
      speler.body.setGravityY(1700);

      let ground=this.add.rectangle(GAME_WIDTH/2,GAME_HEIGHT-2,GAME_WIDTH,8,0x000000,0);
      this.physics.add.existing(ground,true);
      this.physics.add.collider(speler,ground);

      cursors=this.input.keyboard.createCursorKeys();
      this.input.keyboard.on('keydown-SPACE',()=>{jumpRequested=true;});
      this.input.on('pointerdown',()=>{jumpRequested=true;});

      createObstacle(this,GAME_WIDTH+120,GAME_HEIGHT-14,"üíÄ",1.2);
      createWing(this,GAME_WIDTH+260,LUCHT_H/2+40,"ü™Ω",1.1);

      this.time.addEvent({delay:13,loop:true,callback:()=>{ if(!spelBlokkeren) moveAll(-speed); }});
    }

    function moveAll(dx){
      obstacles.forEach(o=>{ o.x+=dx; if(o.x<-60) resetObstacle(o); });
      wings.forEach(w=>{ w.x+=dx; if(w.x<-60) resetWing(w); });
      clouds.forEach(cl=>{ cl.x+=dx*0.5; if(cl.x<-60) cl.x=GAME_WIDTH+100; });
      flowers.forEach(f=>{ f.x+=dx*1.1; if(f.x<-28) f.x=GAME_WIDTH+150; });
    }

    function update(){
      if(spelBlokkeren) return;
      if(jumpRequested&&speler.body.blocked.down&&canJump){
        speler.body.setVelocityY(-1500);
        jumpRequested=false; canJump=false;
        setTimeout(()=>canJump=true,500);
      }
      let b=speler.getBounds();
      let hoofd={x:b.centerX,y:b.top+34};
      let voetR={x:b.centerX+28,y:b.bottom-8};

      obstacles.forEach(o=>{
        if(!o.hit){
          let dR=Math.hypot(voetR.x-o.x,voetR.y-(o.y-32));
          if(speler.body.blocked.down && dR<FOOT_RADIUS+24){
            o.hit=true; stelVraag("zonde");
          }
        }
      });
      wings.forEach(w=>{
        if(!w.collected){
          let wb=w.getBounds();
          let dx=hoofd.x-wb.centerX, dy=hoofd.y-wb.centerY;
          if(Math.sqrt(dx*dx+dy*dy)<58){
            w.collected=true; w.setVisible(false);
            vleugels++; document.getElementById("vleugelInfo").textContent=`Vleugels: ${vleugels}/10`;
            if(vleugels>=10) volgendLevel();
            stelVraag("licht");
          }
        }
      });
    }

    function createObstacle(scene,x,y,emoji,scale=1){
      let obst=scene.add.text(x,y,emoji,{fontFamily:'Segoe UI Emoji, Arial',fontSize:Math.round(56*scale)+'px'});
      obst.setOrigin(0.5,1); obst.hit=false; obstacles.push(obst); return obst;
    }
    function createWing(scene,x,y,emoji,scale=1){
      let wing=scene.add.text(x,y,emoji,{fontFamily:'Segoe UI Emoji, Arial',fontSize:Math.round(54*scale)+'px'});
      wing.setOrigin(0.5,0.5); wing.collected=false; wings.push(wing); return wing;
    }
    function addCloud(scene,x,y){ let c=scene.add.text(x,y,"‚òÅÔ∏è",{fontSize:'62px'}); c.setOrigin(0.5); clouds.push(c);}
    function addFlower(scene,x,y){ let icons=["üå∏","üåª","üåº","üå∫","üå∑","üåπ"]; let f=scene.add.text(x,y,icons[Math.floor(Math.random()*icons.length)],{fontSize:'38px'}); f.setOrigin(0.5,1); flowers.push(f); }

    function resetObstacle(o){ o.x=GAME_WIDTH+150+Math.random()*250; o.hit=false; }
    function resetWing(w){ w.x=GAME_WIDTH+220+Math.random()*350; w.collected=false; w.setVisible(true); }

    async function volgendLevel(){
      level++;
      if(level>levelsMax){
        await updatePoints(+10);
        alert("Fantastisch! Alle levels uitgespeeld, je krijgt 10 punten terug!");
        document.getElementById("startBtn").style.display="";
        document.getElementById("resetBtn").style.display="none";
        document.getElementById("infoBar").style.display="none";
        vleugels=0; level=1;
        if(gameInstance) gameInstance.destroy(true);
        return;
      }
      vleugels=0; speed+=0.18;
      document.getElementById("levelInfo").textContent="Level "+level;
      document.getElementById("vleugelInfo").textContent="Vleugels: 0/10";
      if(gameInstance) gameInstance.destroy(true);
      setTimeout(startGame,300);
    }

    function stelVraag(type=""){
      let v;
      if(type==="licht"){ v=vragen.filter(q=>q.difficulty!=="zonde")[Math.floor(Math.random()*vragen.length)]; }
      else if(type==="zonde"){ v=vragen.filter(q=>q.difficulty==="zonde")[Math.floor(Math.random()*vragen.length)]; }
      else { v=vragen[Math.floor(Math.random()*vragen.length)]; }
      const overlay=document.getElementById('vraag-overlay');
      overlay.innerHTML=`
        <div class="vraag-overlay">
          <div class="vraag-box">
            <h3>Vraag:</h3>
            <div style="margin-bottom:14px">${v.q}</div>
            ${v.a.map((ans,i)=>`<button class="vraag-antw-btn" onclick="beantwoordVraag(${i},${v.correct})">${ans}</button>`).join("")}
          </div>
        </div>`;
      overlay.style.display=''; spelBlokkeren=true;
    }
    window.beantwoordVraag=function(g,c){
      document.getElementById('vraag-overlay').style.display='none';
      spelBlokkeren=false;
    };
  </script>
</body>
</html>
