<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Springspel ‚Äì Orthodoxe Kinderpagina</title>
  <link rel="icon" href="images/kruis.png" />
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
  <script src="vragen.js"></script>
  <script defer src="common/layout.js"></script>
  <style>
    :root{
      --primair:#7bb235; --donker:#67510C;
      --pastel1:#fff6e5; --pastel2:#fffde6; --pastel3:#ffe8ec; --pastel4:#e7f8ff;
      --pastel5:#e6ffe5; --pastel6:#fff2fb; --pastel7:#f5ffe5; --pastel8:#f5e8ff;
      --pastel9:#fff6fb; --pastel10:#e7fff9; --pastel11:#f3e6ff; --pastel12:#ffeae6;
      --pastel13:#ecffe9; --pastel14:#f7fff3; --pastel15:#eafffa; --pastel16:#fff4ea;
    }
    body{
      margin:0; font-family:'Comic Sans MS', Arial, sans-serif; color:#333;
      min-height:100vh; background:var(--pastel1); transition:background .6s;
    }
    main{ max-width:1200px; margin:20px auto; padding:0 16px; text-align:center }
    #spelcontainer { margin: 32px auto 0 auto; width: 900px; }
    #infoBar {
      width:900px; max-width:96vw; margin:30px auto 0 auto; display:flex; justify-content:space-between;
      font-size:20px; background:#fffde6; border-radius:12px; padding:8px 20px; box-shadow:0 2px 12px #bedbe880;
      font-weight:bold; letter-spacing:0.5px;
    }
    .vraag-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.18); z-index: 9999; display: flex;
      align-items: center; justify-content: center;
    }
    .vraag-box {
      background: #fffde6; padding: 32px 28px 20px 28px;
      border-radius: 18px; box-shadow: 0 2px 24px #8bc34ab0;
      max-width: 96vw; width: 420px; font-family: 'Comic Sans MS', Arial, sans-serif;
      color: #2276b9; font-size: 20px;
    }
    .vraag-box h3 { margin: 0 0 16px 0; font-size: 1.1em; font-weight: bold; color: #67510C;}
    .vraag-antw-btn {
      margin: 10px 0; background: #7bb235; color: white;
      border: none; border-radius: 8px; font-size: 17px;
      padding: 8px 14px; width: 96%; cursor: pointer; display: block;
    }
    .vraag-antw-btn:hover { background: #488f12; }
    #startBtn{
      background: var(--primair); color: #fff; border:none; border-radius: 10px;
      padding: 8px 18px; font-size: 19px; font-weight: bold; margin: 14px auto 0 auto; display:block;
      box-shadow: 0 2px 10px #9eceb3a0;
    }
    #startBtn[disabled]{ opacity:0.5; pointer-events:none;}
  </style>
</head>
<body>
  <div id="kinder-header" data-header-src="common/header.html"></div>
  <main>
    <h1>Springspel üèÉ‚Äç‚ôÇÔ∏èü™Ω</h1>
    <button id="startBtn">Start Springspel (20 punten)</button>
    <div id="infoBar" style="display:none">
      <span id="levelInfo">Level 1</span>
      <span id="vleugelInfo">Vleugels: 0/10</span>
      <span id="puntenInfo">Punten: ...</span>
    </div>
    <div id="spelcontainer"></div>
    <div id="vraag-overlay" style="display:none"></div>
  </main>
  <script>
    // Achtergrond wisselen
    (function(){
      const p=['var(--pastel1)','var(--pastel2)','var(--pastel3)','var(--pastel4)',
               'var(--pastel5)','var(--pastel6)','var(--pastel7)','var(--pastel8)',
               'var(--pastel9)','var(--pastel10)','var(--pastel11)','var(--pastel12)',
               'var(--pastel13)','var(--pastel14)','var(--pastel15)','var(--pastel16)'];
      document.body.style.background=p[Math.floor(Math.random()*p.length)];
    })();

    // Header/menubalk laden, active-tab is 'spelletjes'
    (function boot(){
      if (!(window.KinderLayout)) return setTimeout(boot,120);
      const el=document.getElementById('kinder-header');
      window.KinderLayout.mountHeader({ rootId:'kinder-header', headerSrc:el.dataset.headerSrc, active:'spelletjes' });
    })();

    // ======= Firestore puntenlogica =======
    async function getUserPoints(){
      const db=firebase.firestore();
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(!parochieId||!ouderLogin||!kindId)return 0;
      const ref=db.collection("parochies").doc(parochieId)
        .collection("leden").doc(ouderLogin)
        .collection("kinderen").doc(kindId);
      const snap=await ref.get(); 
      return snap.exists?(snap.data().punten||0):0;
    }
    async function updateUserPoints(delta){
      const db=firebase.firestore();
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(!parochieId||!ouderLogin||!kindId)return;
      const ref=db.collection("parochies").doc(parochieId)
        .collection("leden").doc(ouderLogin)
        .collection("kinderen").doc(kindId);
      await db.runTransaction(async tx=>{
        const snap=await tx.get(ref);
        if(!snap.exists)return;
        const current=snap.data().punten||0;
        tx.update(ref,{punten: Math.max(0,current+delta)});
      });
      document.getElementById("puntenInfo").textContent="Punten: "+await getUserPoints();
    }

    // ------------- GAME ----------------
    let speler, cursors, jumpRequested = false, canJump = true;
    let obstacles = [], wings = [], flowers = [], clouds = [];
    let speed = 1.0, level = 1, vleugels = 0, levelsMax = 5;
    let spelBlokkeren = false, spelGestart = false;
    const GAME_WIDTH = 900, GAME_HEIGHT = 600, LUCHT_H = GAME_HEIGHT * 0.5;

    let gameInstance;

    // INIT POINTS UI
    getUserPoints().then(p=>{document.getElementById("puntenInfo").textContent="Punten: "+p;});

    document.getElementById("startBtn").onclick = async function(){
      let punten = await getUserPoints();
      if(punten<20){
        alert("Je hebt minstens 20 punten nodig om dit spel te starten.");
        return;
      }
      await updateUserPoints(-20);
      document.getElementById('startBtn').disabled = true;
      document.getElementById('startBtn').style.display='none';
      document.getElementById('infoBar').style.display = '';
      spelGestart=true;
      startGame();
    };

    async function startGame(){
      level=1; vleugels=0; speed=1.0;
      document.getElementById("levelInfo").textContent = "Level 1";
      document.getElementById("vleugelInfo").textContent = "Vleugels: 0/10";
      if(gameInstance) { gameInstance.destroy(true); }
      gameInstance = new Phaser.Game({
        type: Phaser.AUTO,
        width: GAME_WIDTH,
        height: GAME_HEIGHT,
        parent: 'spelcontainer',
        physics: {
          default: 'arcade',
          arcade: { gravity: { y: 950 }, debug: false }
        },
        scene: { preload, create, update }
      });
    }

    function preload() {}

    function create() {
      // Clouds & Flowers (parallax)
      for (let i = 0; i < 7; i++) addCloud(this, Math.random()*GAME_WIDTH, 60+Math.random()*140);
      for (let i = 0; i < 12; i++) addFlower(this, Math.random()*GAME_WIDTH, GAME_HEIGHT-22);

      this.add.rectangle(GAME_WIDTH/2, LUCHT_H/2, GAME_WIDTH, LUCHT_H, 0xaee7ff);
      this.add.rectangle(GAME_WIDTH/2, LUCHT_H + (GAME_HEIGHT-LUCHT_H)/2, GAME_WIDTH, GAME_HEIGHT-LUCHT_H, 0x8bc34a);

      // Speler
      const spelerGrootte = GAME_HEIGHT * 0.4;
      const grondNiveau = GAME_HEIGHT - 15;
      speler = this.add.text(120, grondNiveau, "üèÉ‚Äç‚ôÇÔ∏è", {
        fontFamily: 'Segoe UI Emoji, Arial',
        fontSize: Math.round(spelerGrootte) + 'px'
      });
      speler.setOrigin(0.5, 1);
      speler.setScale(-1, 1); // gespiegeld

      this.physics.add.existing(speler);
      speler.body.setCollideWorldBounds(true);
      speler.body.setGravityY(900); // trager terugvallen
      speler.body.setBounce(0);

      let ground = this.add.rectangle(GAME_WIDTH/2, GAME_HEIGHT - 2, GAME_WIDTH, 8, 0x000000, 0);
      this.physics.add.existing(ground, true);
      this.physics.add.collider(speler, ground);

      cursors = this.input.keyboard.createCursorKeys();
      this.input.keyboard.on('keydown-SPACE', () => { jumpRequested = true; });
      this.input.keyboard.on('keydown-UP', () => { jumpRequested = true; });
      this.input.on('pointerdown', () => { jumpRequested = true; });

      // Maak precies 2 van elk (schedel, vleugel)
      for(let i=0; i<2; i++)
        createObstacle(this, GAME_WIDTH + 280*i, GAME_HEIGHT - 14, "üíÄ", 1.17);
      for(let i=0; i<2; i++)
        createWing(this, GAME_WIDTH + 180*i + 200, LUCHT_H/2 + 48, "ü™Ω", 1.1);

      this.time.addEvent({
        delay: 16, loop: true, callback: () => {
          if (spelBlokkeren) return;
          moveAll(-speed);
        }
      });
    }

    function moveAll(dx) {
      // Obstakels (schedels) - max 2 tegelijk zichtbaar
      let schedelsInBeeld = 0;
      obstacles.forEach(o => {
        o.x += dx;
        if (o.x > -60 && o.x < GAME_WIDTH+60) {
          schedelsInBeeld++;
        }
      });
      obstacles.forEach(o => {
        if (o.x < -60 && schedelsInBeeld < 2) {
          o.x = GAME_WIDTH + 140 + Math.random() * 290;
          o.hit = false;
          schedelsInBeeld++;
        }
      });
      // Wings
      wings.forEach(w => {
        w.x += dx;
        if (w.x < -60) resetWing(w);
      });
      // Flowers
      flowers.forEach(f => {
        f.x += dx * 1.2;
        if (f.x < -28) { f.x = GAME_WIDTH + Math.random()*140; }
      });
      // Clouds
      clouds.forEach(cl => {
        cl.x += dx * 0.6;
        if (cl.x < -60) { cl.x = GAME_WIDTH + Math.random()*100; }
      });
    }

    function update() {
      if (spelBlokkeren) return;
      if (jumpRequested && speler.body.blocked.down && canJump) {
        speler.body.setVelocityY(-1300); // Hoger/trager springen
        jumpRequested = false;
        canJump = false;
        setTimeout(() => canJump = true, 490); // Niet te snel na elkaar
      }
      let bounds = speler.getBounds();
      let hoofd = {x: bounds.centerX, y: bounds.top + 34};
      let voetR = {x: bounds.centerX + 30, y: bounds.bottom - 8};
      let isSpringend = !speler.body.blocked.down;

      // Schedels: Raken mag ENKEL als je op de grond bent (niet springend!)
      obstacles.forEach(o => {
        if (!spelBlokkeren && !o.hit) {
          let ox = o.x, oy = o.y - 38;
          let opGrond = speler.body.blocked.down;
          let dR = Math.hypot(voetR.x-ox, voetR.y-oy);
          if (dR < 44 && opGrond) {
            o.hit = true;
            stelVraag("zonde");
          }
        }
      });
      // Vleugeltjes: Raken mag ENKEL als je springt (in de lucht!)
      wings.forEach(w => {
        if (!spelBlokkeren && !w.collected) {
          let wBounds = w.getBounds();
          let dx = hoofd.x - wBounds.centerX;
          let dy = hoofd.y - wBounds.centerY;
          if (Math.sqrt(dx*dx + dy*dy) < 60 && isSpringend) {
            w.collected = true;
            w.setVisible(false);
            vleugels++;
            document.getElementById("vleugelInfo").textContent = `Vleugels: ${vleugels}/10`;
            stelVraag("licht");
            if(vleugels >= 10) volgendLevel();
          }
        }
      });
    }

    function createObstacle(scene, x, y, emoji, scale=1) {
      let obst = scene.add.text(x, y, emoji, {
        fontFamily: 'Segoe UI Emoji, Arial',
        fontSize: Math.round(54*scale)+'px'
      });
      obst.setOrigin(0.5, 1);
      obst.hit = false;
      obstacles.push(obst);
      return obst;
    }
    function createWing(scene, x, y, emoji, scale=1) {
      let wing = scene.add.text(x, y, emoji, {
        fontFamily: 'Segoe UI Emoji, Arial',
        fontSize: Math.round(48*scale)+'px'
      });
      wing.setOrigin(0.5, 0.5);
      wing.collected = false;
      wings.push(wing);
      return wing;
    }
    function addCloud(scene, x, y) {
      let cloud = scene.add.text(x, y, "‚òÅÔ∏è", {
        fontFamily: 'Segoe UI Emoji, Arial',
        fontSize: '62px'
      });
      cloud.setOrigin(0.5, 0.5);
      clouds.push(cloud);
      return cloud;
    }
    function addFlower(scene, x, y) {
      let bloemIcons = ["üå∏","üåª","üåº","üå∫","üå∑","üåπ"];
      let bloem = scene.add.text(x, y, bloemIcons[Math.floor(Math.random()*bloemIcons.length)], {
        fontFamily: 'Segoe UI Emoji, Arial',
        fontSize: '38px'
      });
      bloem.setOrigin(0.5, 1);
      flowers.push(bloem);
      return bloem;
    }
    function resetObstacle(obst) {
      obst.x = GAME_WIDTH + 140 + Math.random() * 290;
      obst.hit = false;
    }
    function resetWing(wing) {
      wing.x = GAME_WIDTH + 140 + Math.random()*390;
      wing.collected = false;
      wing.setVisible(true);
    }

    async function volgendLevel(){
      level++;
      if(level>levelsMax){
        await updateUserPoints(10);
        alert("Gefeliciteerd, je hebt alle levels uitgespeeld!\nJe krijgt 10 punten als beloning!");
        document.getElementById('startBtn').disabled=false;
        document.getElementById('startBtn').style.display='';
        document.getElementById('infoBar').style.display='none';
        spelGestart=false;
        vleugels=0;
        level=1;
        if(gameInstance) gameInstance.destroy(true);
        return;
      }
      vleugels = 0;
      speed += 0.13;
      document.getElementById("levelInfo").textContent = "Level "+level;
      document.getElementById("vleugelInfo").textContent = `Vleugels: 0/10`;
      if(gameInstance) gameInstance.destroy(true);
      setTimeout(startGame,350);
    }

    // Vraag tonen in overlay
    function stelVraag(type = "") {
      let v;
      if (type === "licht") {
        let lichtvragen = vragen.filter(q=>(
          (level===1&&q.difficulty===1)||
          (level===2&&q.difficulty===2)||
          (level>=3&&q.difficulty===3)
        ));
        v = lichtvragen[Math.floor(Math.random()*lichtvragen.length)];
      } else if (type === "zonde") {
        let zondevragen = vragen.filter(q => q.difficulty === "zonde");
        v = zondevragen[Math.floor(Math.random()*zondevragen.length)];
      } else {
        v = vragen[Math.floor(Math.random()*vragen.length)];
      }
      const overlay = document.getElementById('vraag-overlay');
      overlay.innerHTML = `
        <div class="vraag-overlay">
          <div class="vraag-box">
            <h3>Vraag:</h3>
            <div style="margin-bottom:14px">${v.q}</div>
            ${v.a.map((ans, i) => `<button class="vraag-antw-btn" onclick="beantwoordVraag(${i},${v.correct},'${type}')">${ans}</button>`).join("")}
          </div>
        </div>
      `;
      overlay.style.display = '';
      spelBlokkeren = true;
    }
    window.beantwoordVraag = function(given, correct, type) {
      const overlay = document.getElementById('vraag-overlay');
      if(given===correct){
        overlay.style.display = 'none';
        spelBlokkeren = false;
      } else {
        if(type==="zonde"){
          alert("Fout! Je bent tegen een zonde gelopen. Game Over.");
          location.reload();
        } else {
          overlay.innerHTML = `<div class="vraag-overlay"><div class="vraag-box">Dat was fout!</div></div>`;
          setTimeout(() => { overlay.style.display = 'none'; spelBlokkeren = false; }, 500);
        }
      }
    };
  </script>
</body>
</html>
