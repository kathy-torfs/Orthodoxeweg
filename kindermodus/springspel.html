<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Springspel ‚Äì Orthodoxe Kinderpagina</title>
  <link rel="icon" href="images/kruis.png" />
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
  <script src="vragen.js"></script>
  <script defer src="common/layout.js"></script>
  <!-- Firebase SDKs (zet jouw versie en config erin!) -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
  <script>
    // Zet je Firebase config hieronder!
    const firebaseConfig = {
      apiKey: "YOUR-API-KEY",
      authDomain: "YOUR-DOMAIN",
      projectId: "YOUR-PROJECT-ID",
      // ... (rest van config)
    };
    firebase.initializeApp(firebaseConfig);
  </script>
  <style>
    :root{
      --primair:#7bb235; --donker:#67510C;
      --pastel1:#fff6e5; --pastel2:#fffde6; --pastel3:#ffe8ec; --pastel4:#e7f8ff;
      --pastel5:#e6ffe5; --pastel6:#fff2fb; --pastel7:#f5ffe5; --pastel8:#f5e8ff;
      --pastel9:#fff6fb; --pastel10:#e7fff9; --pastel11:#f3e6ff; --pastel12:#ffeae6;
      --pastel13:#ecffe9; --pastel14:#f7fff3; --pastel15:#eafffa; --pastel16:#fff4ea;
    }
    body{
      margin:0; font-family:'Comic Sans MS', Arial, sans-serif; color:#333;
      min-height:100vh; background:var(--pastel1); transition:background .6s;
    }
    main{ max-width:1000px; margin:20px auto; padding:0 16px; text-align:center }

    #infoBar {
      width:700px; max-width:98vw; margin:30px auto 0 auto; display:flex; justify-content:space-between;
      font-size:22px; background:#fffde6; border-radius:12px; padding:8px 32px; box-shadow:0 2px 12px #bedbe880;
      font-weight:bold; letter-spacing:0.5px;
    }
    #spelcontainer { margin: 26px auto 0 auto; width: 640px; }

    .vraag-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.18); z-index: 9999; display: flex;
      align-items: center; justify-content: center;
    }
    .vraag-box {
      background: #fffde6; padding: 32px 28px 20px 28px;
      border-radius: 18px; box-shadow: 0 2px 24px #8bc34ab0;
      max-width: 96vw; width: 420px; font-family: 'Comic Sans MS', Arial, sans-serif;
      color: #2276b9; font-size: 21px;
    }
    .vraag-box h3 { margin: 0 0 16px 0; font-size: 1.2em; font-weight: bold; color: #67510C;}
    .vraag-antw-btn {
      margin: 10px 0; background: #7bb235; color: white;
      border: none; border-radius: 8px; font-size: 18px;
      padding: 8px 14px; width: 96%; cursor: pointer; display: block;
    }
    .vraag-antw-btn:hover { background: #488f12; }
    #startBtn{
      background: var(--primair); color: #fff; border:none; border-radius: 10px;
      padding: 8px 18px; font-size: 20px; font-weight: bold; margin: 14px auto 0 auto; display:block;
      box-shadow: 0 2px 10px #9eceb3a0;
    }
    #startBtn[disabled]{ opacity:0.5; pointer-events:none;}
  </style>
</head>
<body>
  <div id="kinder-header" data-header-src="common/header.html"></div>
  <main>
    <h1>Springspel üèÉ‚Äç‚ôÇÔ∏èü™Ω</h1>
    <div id="infoBar" style="display:flex;">
      <span id="levelInfo">Level 1</span>
      <span id="vleugelInfo">Vleugels: 0/10</span>
      <span id="puntenInfo">Punten: ...</span>
    </div>
    <button id="startBtn">Start Springspel (20 punten)</button>
    <div id="spelcontainer"></div>
    <div id="vraag-overlay" style="display:none"></div>
  </main>
  <script>
    // Pastel achtergrond
    (function(){
      const p=['var(--pastel1)','var(--pastel2)','var(--pastel3)','var(--pastel4)','var(--pastel5)','var(--pastel6)','var(--pastel7)','var(--pastel8)','var(--pastel9)','var(--pastel10)','var(--pastel11)','var(--pastel12)','var(--pastel13)','var(--pastel14)','var(--pastel15)','var(--pastel16)'];
      document.body.style.background=p[Math.floor(Math.random()*p.length)];
    })();

    // Header laden, active-tab = spelletjes
    (function boot(){
      if (!(window.KinderLayout)) return setTimeout(boot,120);
      const el=document.getElementById('kinder-header');
      window.KinderLayout.mountHeader({ rootId:'kinder-header', headerSrc:el.dataset.headerSrc, active:'spelletjes' });
    })();

    // Firebase punten
    async function getUserPoints(){
      const db=firebase.firestore();
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(!parochieId||!ouderLogin||!kindId)return 0;
      const ref=db.collection("parochies").doc(parochieId).collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId);
      const snap=await ref.get(); return snap.exists?(snap.data().punten||0):0;
    }
    async function setUserPoints(nieuw){
      const db=firebase.firestore();
      const parochieId=localStorage.getItem("ingelogdeParochie");
      const ouderLogin=localStorage.getItem("loginKeuze");
      const kindId=localStorage.getItem("ingelogdKindId");
      if(!parochieId||!ouderLogin||!kindId)return;
      const ref=db.collection("parochies").doc(parochieId).collection("leden").doc(ouderLogin).collection("kinderen").doc(kindId);
      await ref.update({punten:nieuw});
    }
    async function addUserPoints(delta){
      let huidig = await getUserPoints();
      let nieuw = Math.max(0, huidig + delta);
      await setUserPoints(nieuw);
      toonPunten(nieuw);
    }
    async function toonPunten(nieuw){
      document.getElementById('puntenInfo').textContent = "Punten: " + nieuw;
    }

    // ---------------- GAME LOGICA ---------------
    let speler, cursors, jumpRequested=false, canJump=true;
    let obstacles=[], wings=[], speed=1.05, level=1, vleugels=0, levelsMax=5;
    let spelGestart=false, spelBlokkeren=false, gameInstance;
    const GAME_WIDTH=640, GAME_HEIGHT=420, LUCHT_H=GAME_HEIGHT*0.55;
    const FOOT_RADIUS=24, HEAD_RADIUS=28;

    // Start knop
    document.getElementById("startBtn").onclick = async function(){
      const points=await getUserPoints();
      if(points<20){ alert("Niet genoeg punten om te spelen!"); return; }
      await addUserPoints(-20);
      document.getElementById('startBtn').style.display='none';
      spelGestart=true; vleugels=0; level=1; speed=1.05;
      document.getElementById("levelInfo").textContent="Level 1";
      document.getElementById("vleugelInfo").textContent="Vleugels: 0/10";
      toonPunten(await getUserPoints());
      startGame();
    };

    async function startGame(){
      if(gameInstance) { gameInstance.destroy(true); }
      obstacles=[]; wings=[];
      gameInstance=new Phaser.Game({
        type: Phaser.AUTO, width: GAME_WIDTH, height: GAME_HEIGHT,
        parent: 'spelcontainer',
        physics: { default: 'arcade', arcade: { gravity: { y: 1250 }, debug: false } },
        scene: { preload, create, update }
      });
    }

    function preload() {}

    function create() {
      // lucht + gras
      this.add.rectangle(GAME_WIDTH/2, LUCHT_H/2, GAME_WIDTH, LUCHT_H, 0xaee7ff);
      this.add.rectangle(GAME_WIDTH/2, LUCHT_H + (GAME_HEIGHT-LUCHT_H)/2, GAME_WIDTH, GAME_HEIGHT-LUCHT_H, 0x8bc34a);

      // Obstakels (max 2 in beeld)
      for(let i=0;i<2;i++) createObstacle(this, GAME_WIDTH+120*i+180, GAME_HEIGHT-4, "üíÄ");
      // Vleugels (per level 10 nodig, in het begin 3 zichtbaar)
      for(let i=0;i<3;i++) createWing(this, GAME_WIDTH+200*i+160, LUCHT_H/3, "ü™Ω");

      // Speler
      const spelerGrootte=GAME_HEIGHT*0.42, grondNiveau=GAME_HEIGHT-7;
      speler=this.add.text(100, grondNiveau, "üèÉ‚Äç‚ôÇÔ∏è", { fontFamily:'Segoe UI Emoji,Arial', fontSize:Math.round(spelerGrootte)+'px' });
      speler.setOrigin(0.5,1);
      speler.setScale(-1,1); // gespiegeld!
      this.physics.add.existing(speler);
      speler.body.setCollideWorldBounds(true);
      speler.body.setGravityY(1250);
      speler.body.setBounce(0.0);

      // Grond
      let ground=this.add.rectangle(GAME_WIDTH/2, GAME_HEIGHT, GAME_WIDTH, 12, 0x000000, 0);
      this.physics.add.existing(ground, true);
      this.physics.add.collider(speler, ground);

      // Controls
      cursors=this.input.keyboard.createCursorKeys();
      this.input.keyboard.on('keydown-SPACE',()=>{ jumpRequested=true; });
      this.input.keyboard.on('keydown-UP',()=>{ jumpRequested=true; });
      this.input.on('pointerdown',()=>{ jumpRequested=true; });

      // Main loop (alles beweegt)
      this.time.addEvent({
        delay:15, loop:true, callback:()=>{ if(!spelBlokkeren) moveAll(-speed); }
      });
    }

    function createObstacle(scene, x, y, emoji) {
      let o=scene.add.text(x, y-22, emoji, { fontFamily:'Segoe UI Emoji,Arial', fontSize:'65px' });
      o.setOrigin(0.5,1); o.hit=false;
      obstacles.push(o); return o;
    }
    function createWing(scene, x, y, emoji) {
      let w=scene.add.text(x, y, emoji, { fontFamily:'Segoe UI Emoji,Arial', fontSize:'53px' });
      w.setOrigin(0.5,0.5); w.collected=false;
      wings.push(w); return w;
    }

    function moveAll(dx) {
      // Beweeg obstakels (max 2 on screen)
      let activeObstacles=obstacles.filter(o=>o.x>0 && o.x<GAME_WIDTH);
      obstacles.forEach(o=>{
        o.x+=dx;
        if(o.x<-60) resetObstacle(o,activeObstacles);
      });
      // Vleugels
      wings.forEach(w=>{
        w.x+=dx;
        if(w.x<-60) resetWing(w);
      });
    }
    function resetObstacle(o,activeObstacles) {
      // nooit meer dan 2 tegelijk on screen
      let count=obstacles.filter(ob=>ob!==o && ob.x>0 && ob.x<GAME_WIDTH).length;
      if(count>=1) o.x = GAME_WIDTH + 250 + Math.random()*150;
      else o.x = GAME_WIDTH + 100 + Math.random()*150;
      o.hit=false;
    }
    function resetWing(w) {
      w.x = GAME_WIDTH + 240 + Math.random()*250;
      w.collected = false; w.setVisible(true);
    }

    function update() {
      if(spelBlokkeren) return;
      // springen
      if(jumpRequested && speler.body.blocked.down && canJump){
        speler.body.setVelocityY(-1220); // zachtere sprong
        jumpRequested=false; canJump=false;
        setTimeout(()=>canJump=true,470);
      }
      let bounds=speler.getBounds();
      let hoofd={x:bounds.centerX, y:bounds.top+34};
      let voet={x:bounds.centerX, y:bounds.bottom-6};

      // Obstakels: alleen hitten als NIET springen (dus op grond)
      obstacles.forEach(o=>{
        if(!spelBlokkeren && !o.hit && speler.body.blocked.down && Math.abs(voet.x-o.x)<46 && Math.abs(voet.y-o.y)<46){
          o.hit=true;
          stelVraag("zonde");
        }
      });

      // Vleugels: alleen verzamelen als niet al collected
      wings.forEach(w=>{
        if(!spelBlokkeren && !w.collected){
          let dx=hoofd.x-w.x, dy=hoofd.y-w.y;
          if(Math.sqrt(dx*dx+dy*dy)<49){
            w.collected=true; w.setVisible(false);
            vleugels++;
            document.getElementById("vleugelInfo").textContent = `Vleugels: ${vleugels}/10`;
            if(vleugels>=10) volgendLevel();
            else stelVraag("licht");
          }
        }
      });
    }

    async function volgendLevel(){
      level++;
      if(level>levelsMax){
        await addUserPoints(10);
        alert("Gefeliciteerd, je hebt ALLE levels uitgespeeld!\nJe krijgt 10 punten als beloning!");
        document.getElementById('startBtn').style.display='';
        spelGestart=false;
        vleugels=0; level=1;
        if(gameInstance) gameInstance.destroy(true);
        return;
      }
      vleugels=0; speed+=0.17;
      document.getElementById("levelInfo").textContent = "Level "+level;
      document.getElementById("vleugelInfo").textContent = "Vleugels: 0/10";
      if(gameInstance) gameInstance.destroy(true);
      setTimeout(startGame,350);
    }

    // VRAAG LOGICA
    function stelVraag(type="") {
      let v;
      if(type==="licht"){
        let diff=level<3?level:3;
        let lichtvragen = vragen.filter(q=>q.difficulty==diff);
        v = lichtvragen[Math.floor(Math.random()*lichtvragen.length)];
      } else if(type==="zonde"){
        let zondevragen = vragen.filter(q=>q.difficulty==="zonde");
        v = zondevragen[Math.floor(Math.random()*zondevragen.length)];
      } else {
        v = vragen[Math.floor(Math.random()*vragen.length)];
      }
      const overlay=document.getElementById('vraag-overlay');
      overlay.innerHTML=`
        <div class="vraag-overlay">
          <div class="vraag-box">
            <h3>Vraag:</h3>
            <div style="margin-bottom:14px">${v.q}</div>
            ${v.a.map((ans,i)=>`<button class="vraag-antw-btn" onclick="beantwoordVraag(${i},${v.correct},'${type}')">${ans}</button>`).join("")}
          </div>
        </div>
      `;
      overlay.style.display='';
      spelBlokkeren=true;
    }
    window.beantwoordVraag=function(given, correct, type){
      const overlay=document.getElementById('vraag-overlay');
      overlay.style.display='none';
      if(type==="zonde" && given!=correct){
        alert("Oei, dat was fout! Je gaf een zondig antwoord... Probeer nog eens!");
        document.getElementById('startBtn').style.display='';
        spelGestart=false; vleugels=0; level=1;
        if(gameInstance) gameInstance.destroy(true);
        return;
      }
      if(type==="licht" && given!=correct){
        // feedback maar geen gameover
        overlay.innerHTML = `<div class="vraag-overlay"><div class="vraag-box" style="font-size:24px;color:#e53935">Dat was fout!</div></div>`;
        overlay.style.display = '';
        setTimeout(()=>{ overlay.style.display='none'; spelBlokkeren=false; }, 700);
        return;
      }
      spelBlokkeren=false;
    };

    // INIT: punten tonen
    getUserPoints().then(toonPunten);
  </script>
</body>
</html>
