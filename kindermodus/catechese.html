<script>
  if (!firebase.apps.length) {
    firebase.initializeApp({
      apiKey: "AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
      authDomain: "orthodoxeweg.firebaseapp.com",
      projectId: "orthodoxeweg"
    });
  }
  const db = firebase.firestore();

  // Gebruik de waarden die layout.js al zet
  const parochieId = localStorage.getItem("ingelogdeParochie");
  const ouderId    = localStorage.getItem("loginKeuze");
  const kindId     = localStorage.getItem("ingelogdKindId");

  const grid   = document.getElementById("lessenGrid");
  const modal  = document.getElementById("lesModal");
  const detail = document.getElementById("lesDetail");

  async function laadLessen(){
    if (!parochieId) {
      grid.innerHTML = "‚ö†Ô∏è Geen parochie gevonden.";
      return;
    }
    const snap = await db.collection("parochies").doc(parochieId)
      .collection("catecheselessen")
      .where("zichtbaar","==",true)
      .orderBy("aangemaaktOp","desc").get();

    grid.innerHTML = "";
    if (snap.empty) {
      grid.innerHTML = "<p>Geen lessen beschikbaar.</p>";
      return;
    }
    snap.forEach(doc=>{
      const d = doc.data();
      const kaart = document.createElement("div");
      kaart.className = "card";
      kaart.innerHTML = `
        ${d.mediaURL ? `<img src="${d.mediaURL}">` : ""}
        <h3>${d.titel}</h3>
        <p>${(d.inhoud||"").substring(0,60)}...</p>
      `;
      kaart.onclick = ()=>openLes(doc.id,d);
      grid.appendChild(kaart);
    });
  }

  function openLes(id,d){
    modal.style.display="flex";
    let html=`<h2>${d.titel}</h2>`;
    if(d.mediaURL) html+=`<img src="${d.mediaURL}" style="max-width:100%;border-radius:10px">`;
    html+=`<p>${d.inhoud}</p>`;

    if(d.vragen && d.vragen.length){
      html+="<h3>Quiz</h3>";
      d.vragen.forEach((v,i)=>{
        html+=`<div class="quiz-vraag"><h4>${v.vraag}</h4>`;
        v.antwoorden.forEach((a,ai)=>{
          html+=`<label><input type="radio" name="q${i}" value="${ai}"> ${a}</label>`;
        });
        html+="</div>";
      });
      html+=`<button class="btn" onclick="indienenQuiz('${id}',${d.vragen.length})">Indienen</button>`;
    }
    detail.innerHTML=html;
  }

  function sluitLes(){
    modal.style.display="none";
    detail.innerHTML="";
  }

  async function indienenQuiz(lesId,aantal){
    if (!parochieId || !ouderId || !kindId) {
      alert("Niet ingelogd.");
      return;
    }
    const antwoorden=[];
    for(let i=0;i<aantal;i++){
      const sel=document.querySelector(`input[name="q${i}"]:checked`);
      antwoorden.push(sel?parseInt(sel.value):-1);
    }
    if(antwoorden.includes(-1)){alert("Beantwoord alle vragen!");return;}

    const doc=await db.collection("parochies").doc(parochieId)
      .collection("catecheselessen").doc(lesId).get();
    const les=doc.data();
    let score=0;
    antwoorden.forEach((a,i)=>{if(a===les.vragen[i].correct) score++;});

    // ‚úÖ resultaat opslaan bij dit kind
    await db.collection("parochies").doc(parochieId)
      .collection("leden").doc(ouderId)
      .collection("kinderen").doc(kindId)
      .collection("lessen").doc(lesId)
      .set({antwoorden,score,totaal:aantal,datum:new Date()});

    alert(`üéâ Je scoorde ${score} van de ${aantal}!`);
    sluitLes();
  }

  laadLessen();
</script>
