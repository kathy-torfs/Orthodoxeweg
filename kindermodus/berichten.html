<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Berichten ‚Äì Orthodoxe Kinderpagina</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png">
  <style>
    body { margin:0; font-family:'Comic Sans MS', Arial, sans-serif; background:#fff6e5; color:#333; }
    main { max-width:900px; margin:24px auto; padding:0 2vw; }
    h1 { color:#7bb235; }

    .tabs { display:flex; gap:12px; margin-bottom:20px; }
    .tabs button {
      flex:1; padding:10px; border:none; border-radius:8px; cursor:pointer;
      font-weight:bold; background:#eee; transition:background .2s;
    }
    .tabs button.active { background:#7bb235; color:#fff; }

    .pane { display:none; }
    .pane.active { display:block; }

    .bericht { border:1px solid #dab97a; background:#fff; border-radius:10px; padding:12px; margin-bottom:10px; }
    .bericht small { color:#666; display:block; margin-top:6px; }

    form label { display:block; margin:8px 0 4px; }
    form select, form textarea {
      width:100%; padding:8px; border:1px solid #dab97a; border-radius:6px;
      font-family:inherit; resize:vertical;
    }
    form button {
      margin-top:10px; padding:10px 16px; border:none; border-radius:8px;
      background:#7bb235; color:#fff; font-weight:bold; cursor:pointer;
    }
    form button:hover { background:#5e8f1c; }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script defer src="common/layout.js"></script>
</head>
<body>
  <div id="kinder-header" data-header-src="common/header.html"></div>

  <main>
    <h1>üíå Berichten</h1>

    <div class="tabs">
      <button onclick="toonPane('inbox')" class="active">üì• Ontvangen</button>
      <button onclick="toonPane('sent')">üì§ Verzonden</button>
      <button onclick="toonPane('new')">‚úçÔ∏è Nieuw</button>
    </div>

    <!-- Ontvangen -->
    <div id="pane-inbox" class="pane active">
      <div id="inboxLijst">Laden‚Ä¶</div>
    </div>

    <!-- Verzonden -->
    <div id="pane-sent" class="pane">
      <div id="sentLijst">Laden‚Ä¶</div>
    </div>

    <!-- Nieuw bericht -->
    <div id="pane-new" class="pane">
      <form id="nieuwBerichtForm">
        <label for="naarCatecheet">Aan:</label>
        <select id="naarCatecheet" required>
          <option value="">Laden‚Ä¶</option>
        </select>

        <label for="berichtTekst">Bericht:</label>
        <textarea id="berichtTekst" required></textarea>

        <button type="submit">üì® Verstuur</button>
      </form>
    </div>
  </main>

  <script>
    if (!firebase.apps.length) {
      firebase.initializeApp({
        apiKey:"AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
        authDomain:"orthodoxeweg.firebaseapp.com",
        projectId:"orthodoxeweg",
      });
    }
    const db=firebase.firestore();

    // Context
    const parochieId = localStorage.getItem("ingelogdeParochie");
    const ouderId    = localStorage.getItem("loginKeuze");
    const kindId     = localStorage.getItem("ingelogdKindId");

    const inboxDiv=document.getElementById("inboxLijst");
    const sentDiv=document.getElementById("sentLijst");
    const select=document.getElementById("naarCatecheet");
    const form=document.getElementById("nieuwBerichtForm");

    // Tabs wisselen
    function toonPane(pane){
      document.querySelectorAll(".tabs button").forEach(btn=>btn.classList.remove("active"));
      document.querySelectorAll(".pane").forEach(p=>p.classList.remove("active"));
      document.querySelector(`.tabs button[onclick*="${pane}"]`).classList.add("active");
      document.getElementById("pane-"+pane).classList.add("active");
    }

    // Catecheten laden
    async function laadCatecheten(){
      if(!parochieId) return;
      const snap=await db.collection("parochies").doc(parochieId).collection("leden")
        .where("rol","==","catecheet").get();

      select.innerHTML='<option value="">Kies catecheet...</option>';
      snap.forEach(doc=>{
        const d=doc.data();
        const optie=document.createElement("option");
        optie.value=doc.id;
        optie.textContent=d.naam||d.email||("Catecheet "+doc.id);
        select.appendChild(optie);
      });
    }

    // Inbox laden
    async function laadInbox(){
      if(!parochieId||!ouderId||!kindId) return;
      const snap=await db.collection("parochies").doc(parochieId)
        .collection("leden").doc(ouderId)
        .collection("kinderen").doc(kindId)
        .collection("berichtenOntvangen").orderBy("datum","desc").get();

      inboxDiv.innerHTML="";
      if(snap.empty){inboxDiv.innerHTML="<p>Geen ontvangen berichten.</p>";return;}
      snap.forEach(doc=>{
        const d=doc.data();
        inboxDiv.innerHTML+=`<div class="bericht"><b>Van: ${d.vanNaam||"?"}</b><p>${d.tekst}</p><small>${d.datum?.toDate().toLocaleString()}</small></div>`;
      });
    }

    // Verzonden laden
    async function laadSent(){
      if(!parochieId||!ouderId||!kindId) return;
      const snap=await db.collection("parochies").doc(parochieId)
        .collection("leden").doc(ouderId)
        .collection("kinderen").doc(kindId)
        .collection("berichtenVerzonden").orderBy("datum","desc").get();

      sentDiv.innerHTML="";
      if(snap.empty){sentDiv.innerHTML="<p>Geen verzonden berichten.</p>";return;}
      snap.forEach(doc=>{
        const d=doc.data();
        sentDiv.innerHTML+=`<div class="bericht"><b>Aan: ${d.naarNaam||"?"}</b><p>${d.tekst}</p><small>${d.datum?.toDate().toLocaleString()}</small></div>`;
      });
    }

    // Versturen
    form.addEventListener("submit",async e=>{
      e.preventDefault();
      const catecheetId=select.value;
      const tekst=document.getElementById("berichtTekst").value.trim();
      if(!catecheetId||!tekst){alert("Vul alles in!");return;}

      const kindRef=db.collection("parochies").doc(parochieId)
        .collection("leden").doc(ouderId)
        .collection("kinderen").doc(kindId);

      const catechRef=db.collection("parochies").doc(parochieId).collection("leden").doc(catecheetId);

      const catechDoc=await catechRef.get();
      const catechNaam=catechDoc.data()?.naam||"Catecheet";

      // opslaan bij kind (verzonden)
      await kindRef.collection("berichtenVerzonden").add({
        naarId:catecheetId,
        naarNaam:catechNaam,
        tekst, datum:new Date()
      });

      // opslaan bij catecheet (ontvangen)
      await catechRef.collection("berichtenOntvangen").add({
        vanKindId:kindId,
        vanNaam:localStorage.getItem("ingelogdKindNaam")||"Kind",
        tekst, datum:new Date()
      });

      alert("‚úÖ Bericht verstuurd!");
      form.reset();
      laadSent();
      toonPane("sent");
    });

    laadCatecheten();
    laadInbox();
    laadSent();
  </script>
</body>
</html>
