<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Berichten â€“ Orthodoxe Kinderpagina</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png" />

  <style>
    body{margin:0;font-family:'Comic Sans MS', Arial, sans-serif;background:#fff6e5;color:#333;}
    main{max-width:800px;margin:20px auto;padding:0 15px;}

    h1{color:#7bb235;text-align:center;}

    form{background:#fffef9;border:1px solid #e3d7b5;border-radius:12px;
         padding:15px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
    label{display:block;margin-top:10px;font-weight:bold;}
    select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #dab97a;font-family:inherit;}
    textarea{min-height:100px;}
    button{margin-top:12px;background:#7bb235;color:#fff;border:none;
           padding:8px 16px;border-radius:8px;font-weight:bold;cursor:pointer;}
    button:hover{background:#5e8f1c;}

    .bericht-lijst{display:flex;flex-direction:column;gap:12px;}
    .bericht{background:#fff;border:1px solid #dab97a;border-radius:10px;
             padding:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);}
    .bericht small{color:#777;display:block;margin-top:6px;}
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script defer src="common/layout.js"></script>
</head>
<body>
  <!-- Header kindermodus -->
  <div id="kinder-header" data-header-src="common/header.html"></div>

  <main>
    <h1>ðŸ’¬ Berichten met je catecheet</h1>

    <form id="berichtForm">
      <label for="ontvanger">Aan:</label>
      <select id="ontvanger" required>
        <option value="">Kies catecheetâ€¦</option>
      </select>

      <label for="inhoud">Bericht:</label>
      <textarea id="inhoud" required></textarea>

      <button type="submit">ðŸ“¨ Versturen</button>
    </form>

    <h2>ðŸ“© Mijn verstuurde berichten</h2>
    <div id="mijnBerichten" class="bericht-lijst">Ladenâ€¦</div>
  </main>

  <script>
    // Firebase config
    if (!firebase.apps.length) {
      firebase.initializeApp({
        apiKey:"AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
        authDomain:"orthodoxeweg.firebaseapp.com",
        projectId:"orthodoxeweg",
      });
    }
    const db=firebase.firestore();

    // Context ophalen
    const parochieId = localStorage.getItem("ingelogdeParochie");
    const ouderId    = localStorage.getItem("loginKeuze");
    const kindId     = localStorage.getItem("ingelogdKindId");

    const form=document.getElementById("berichtForm");
    const ontvangerSelect=document.getElementById("ontvanger");
    const mijnBerichten=document.getElementById("mijnBerichten");

    // Catecheten ophalen voor de keuzelijst
    async function laadCatecheten(){
      ontvangerSelect.innerHTML='<option value="">Kies catecheetâ€¦</option>';
      try{
        const snap=await db.collection("parochies").doc(parochieId)
          .collection("leden").where("rol","==","catecheet").get();
        snap.forEach(doc=>{
          const d=doc.data();
          ontvangerSelect.innerHTML+=`<option value="${doc.id}">${d.naam||"Catecheet"}</option>`;
        });
      }catch(e){console.error("Fout catecheten laden",e);}
    }

    // Bericht versturen
    form.addEventListener("submit",async(e)=>{
      e.preventDefault();
      const ontvanger=ontvangerSelect.value;
      const inhoud=document.getElementById("inhoud").value.trim();
      if(!ontvanger||!inhoud){alert("Kies catecheet en schrijf bericht.");return;}

      try{
        await db.collection("parochies").doc(parochieId)
          .collection("berichten").add({
            vanKind:kindId,
            vanOuder:ouderId,
            naar:ontvanger,
            inhoud,
            datum:new Date()
          });
        form.reset();
        laadMijnBerichten();
      }catch(err){console.error("Fout bij versturen",err);}
    });

    // Mijn berichten ophalen
    async function laadMijnBerichten(){
      mijnBerichten.innerHTML="Ladenâ€¦";
      try{
        const snap=await db.collection("parochies").doc(parochieId)
          .collection("berichten")
          .where("vanKind","==",kindId)
          .orderBy("datum","desc").get();

        mijnBerichten.innerHTML="";
        if(snap.empty){mijnBerichten.innerHTML="<p>Geen berichten verstuurd.</p>";return;}
        snap.forEach(doc=>{
          const d=doc.data();
          const tijd=d.datum?.toDate?d.datum.toDate().toLocaleString():"";
          const div=document.createElement("div");
          div.className="bericht";
          div.innerHTML=`
            <p>${d.inhoud}</p>
            <small>ðŸ“¤ naar catecheet (${d.naar}) â€“ ${tijd}</small>
          `;
          mijnBerichten.appendChild(div);
        });
      }catch(e){console.error("Fout bij ophalen berichten",e);}
    }

    laadCatecheten();
    laadMijnBerichten();
  </script>
</body>
</html>
