<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vier op een Rij – Orthodoxe Kinderpagina</title>
  <link rel="icon" href="images/kruis.png" />

  <style>
    :root{
      --primair:#7bb235; --donker:#67510C;
      --pastel1:#fff6e5; --pastel2:#fffde6; --pastel3:#ffe8ec; --pastel4:#e7f8ff;
      --pastel5:#e6ffe5; --pastel6:#fff2fb; --pastel7:#f5ffe5; --pastel8:#f5e8ff;
      --pastel9:#fff6fb; --pastel10:#e7fff9; --pastel11:#f3e6ff; --pastel12:#ffeae6;
      --pastel13:#ecffe9; --pastel14:#f7fff3; --pastel15:#eafffa; --pastel16:#fff4ea;
    }
    body{
      margin:0; font-family:'Comic Sans MS', Arial, sans-serif; color:#333;
      min-height:100vh; background:var(--pastel1); transition:background .6s;
    }
    main{ max-width:1000px; margin:20px auto; padding:0 16px; text-align:center }

    #boardWrapper {
      display: inline-block;
      background: #005bbb;
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    #board {
      display:grid;
      grid-template-columns:repeat(7, min(12vw,60px));
      grid-template-rows:repeat(6, min(12vw,60px));
      gap:8px;
    }
    .cell {
      width:min(12vw,60px);
      height:min(12vw,60px);
      border-radius:50%;
      background:#fff;
      border:2px solid #003f7d;
      cursor:pointer;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
    }
    .player {
      background: radial-gradient(circle at 30% 30%, #ff6666, #e53935);
    }
    .computer {
      background: radial-gradient(circle at 30% 30%, #fff176, #fbc02d);
    }
    /* Highlight voor winnaars */
    .player.win, .computer.win {
      animation: blink 0.6s linear infinite;
    }
    @keyframes blink {
      0%, 50%, 100% { filter: brightness(1.2); }
      25%, 75% { filter: brightness(0.6); }
    }

    #status{ margin-top:10px; font-weight:bold }
    .actions{ margin:14px 0 6px }
    .btn{
      background:var(--primair); color:#fff; border:none; border-radius:8px;
      padding:8px 14px; font-weight:bold; cursor:pointer;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
  </style>

  <!-- Header + menubalk + beveiliging -->
  <script defer src="common/layout.js"></script>
</head>
<body>
  <div id="kinder-header" data-header-src="common/header.html"></div>

  <main>
    <h1>Vier op een Rij</h1>
    <div class="actions">
      <button id="startBtn" class="btn" type="button">Spel starten (20 punten)</button>
      <button id="resetBtn" class="btn" type="button" style="display:none;">Opnieuw spelen</button>
    </div>
    <div id="boardWrapper" style="display:none;">
      <div id="board" aria-label="Vier op een rij speelbord"></div>
    </div>
    <div id="status"></div>
  </main>

  <script>
    // Pastelachtergrond
    (function(){
      const p=['var(--pastel1)','var(--pastel2)','var(--pastel3)','var(--pastel4)','var(--pastel5)',
               'var(--pastel6)','var(--pastel7)','var(--pastel8)','var(--pastel9)','var(--pastel10)',
               'var(--pastel11)','var(--pastel12)','var(--pastel13)','var(--pastel14)',
               'var(--pastel15)','var(--pastel16)'];
      document.body.style.background = p[Math.floor(Math.random()*p.length)];
    })();

    // Header laden
    (function boot(){
      if (!(window.KinderLayout)) return setTimeout(boot, 120);
      const el = document.getElementById('kinder-header');
      window.KinderLayout.mountHeader({
        rootId: 'kinder-header',
        headerSrc: el.dataset.headerSrc,
        active: 'spelletjes'
      });
    })();

    // ===== Vier op een Rij =====
    const rows = 6, cols = 7;
    let board, gameOver, busy;
    const boardDiv = document.getElementById('board');
    const boardWrapper = document.getElementById('boardWrapper');
    const statusDiv = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');

    function init(){
      board = Array.from({length:rows}, () => Array(cols).fill(null));
      gameOver = false; busy = false;
      drawBoard();
      statusDiv.textContent = 'Jij (rood) bent aan de beurt';
    }

    function drawBoard(){
      boardDiv.innerHTML = '';
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.row = r;
          cell.dataset.col = c;
          cell.addEventListener('click', onCellClick, {passive:true});
          boardDiv.appendChild(cell);
        }
      }
      renderChips();
    }

    function renderChips(){
      boardDiv.querySelectorAll('.cell').forEach(cell=>{
        cell.classList.remove('player','computer','win');
        const r = +cell.dataset.row, c = +cell.dataset.col;
        if (board[r][c]==='player') cell.classList.add('player');
        if (board[r][c]==='computer') cell.classList.add('computer');
      });
    }

    function onCellClick(e){
      if (gameOver || busy) return;
      const col = +e.currentTarget.dataset.col;
      if (!drop(col,'player')) return;
      renderChips();
      const winCoords = checkWin('player');
      if (winCoords) return endGame('Jij wint! 🎉', winCoords);
      if (isDraw()) return endGame('Gelijkspel 🤝');
      busy = true;
      setTimeout(()=>{ computerMove(); busy=false; }, 400);
    }

    function drop(col, who){
      for(let r=rows-1;r>=0;r--){
        if(!board[r][col]){ board[r][col]=who; return true; }
      }
      return false;
    }

    function getNextOpenRow(col){
      for(let r=rows-1;r>=0;r--) if(!board[r][col]) return r;
      return -1;
    }

    function isDraw(){ return board.every(row => row.every(cell => cell)); }

    // ✅ Verbeterde checkWin
    function checkWin(who, grid=board){
      const dirs = [[0,1],[1,0],[1,1],[1,-1]];
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          if(grid[r][c]!==who) continue;
          for(const [dr,dc] of dirs){
            let coords = [[r,c]];
            for (let k=1;k<4;k++){
              const rr = r + dr*k, cc = c + dc*k;
              if (rr<0||rr>=rows||cc<0||cc>=cols) break;
              if (grid[rr][cc]===who){
                coords.push([rr,cc]);
              } else break;
            }
            if(coords.length===4){
              return coords; // exact 4 gevonden
            }
          }
        }
      }
      return null;
    }

    function endGame(msg, winCoords){
      statusDiv.textContent = msg;
      if (winCoords){
        winCoords.forEach(([r,c])=>{
          const sel = `.cell[data-row="${r}"][data-col="${c}"]`;
          const cell = boardDiv.querySelector(sel);
          if(cell) cell.classList.add("win");
        });
      }
      gameOver = true;
    }

    // ===== Kindvriendelijke AI =====
    function computerMove(){
      if (gameOver) return;

      // 1. Win pakken
      for (let c=0;c<cols;c++){
        const r = getNextOpenRow(c);
        if (r!==-1){
          const tmp = board.map(row=>row.slice());
          tmp[r][c]='computer';
          if (checkWin('computer', tmp)){
            drop(c,'computer'); renderChips();
            const winCoords = checkWin('computer');
            return endGame('De computer wint! 🤖', winCoords);
          }
        }
      }

      // 2. Blokkeren
      for (let c=0;c<cols;c++){
        const r = getNextOpenRow(c);
        if (r!==-1){
          const tmp = board.map(row=>row.slice());
          tmp[r][c]='player';
          if (checkWin('player', tmp)){
            drop(c,'computer'); renderChips();
            const winCoords = checkWin('computer');
            if (winCoords) return endGame('De computer wint! 🤖', winCoords);
            statusDiv.textContent = 'Jij (rood) bent aan de beurt';
            return;
          }
        }
      }

      // 3. Willekeurig
      const options = [];
      for (let c=0;c<cols;c++) if (getNextOpenRow(c)!==-1) options.push(c);
      const choice = options[Math.floor(Math.random()*options.length)];
      drop(choice,'computer'); renderChips();
      const winCoords = checkWin('computer');
      if (winCoords) return endGame('De computer wint! 🤖', winCoords);
      if (isDraw()) return endGame('Gelijkspel 🤝');
      statusDiv.textContent = 'Jij (rood) bent aan de beurt';
    }

    // ===== Firestore puntenlogica =====
    async function getUserPoints(){
      const parochieId = localStorage.getItem("ingelogdeParochie");
      const ouderLogin = localStorage.getItem("loginKeuze");
      const kindId     = localStorage.getItem("ingelogdKindId");
      if (!parochieId || !ouderLogin || !kindId) return 0;

      const ref = firebase.firestore()
        .collection("parochies").doc(parochieId)
        .collection("leden").doc(ouderLogin)
        .collection("kinderen").doc(kindId);

      const snap = await ref.get();
      return snap.exists ? (snap.data().punten || 0) : 0;
    }

    async function deductPoints(amount){
      const parochieId = localStorage.getItem("ingelogdeParochie");
      const ouderLogin = localStorage.getItem("loginKeuze");
      const kindId     = localStorage.getItem("ingelogdKindId");
      if (!parochieId || !ouderLogin || !kindId) return;

      const ref = firebase.firestore()
        .collection("parochies").doc(parochieId)
        .collection("leden").doc(ouderLogin)
        .collection("kinderen").doc(kindId);

      await firebase.firestore().runTransaction(async (tx) => {
        const snap = await tx.get(ref);
        if (!snap.exists) return;
        const current = snap.data().punten || 0;
        if (current >= amount){
          tx.update(ref, { punten: current - amount });
        }
      });
    }

    // ===== Start & Reset =====
    startBtn.addEventListener('click', async () => {
      const points = await getUserPoints();
      if (points < 20){
        alert("Niet genoeg punten om te spelen!");
        return;
      }
      await deductPoints(20);

      startBtn.style.display = 'none';
      resetBtn.style.display = 'inline-block';
      boardWrapper.style.display = 'inline-block';
      init();
    });

    resetBtn.addEventListener('click', init);
  </script>
</body>
</html>
