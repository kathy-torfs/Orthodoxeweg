<!-- ==== SCRIPT DAGKALENDER ==== -->
<script>
  const pad = n => (n<10 ? '0'+n : ''+n);
  const heiligeEl = document.getElementById('heilige-inhoud');
  const dagEl     = document.getElementById('dagkalender-inhoud');
  const tipEl     = document.getElementById('dagkalender-tip');
  const btnPrev   = document.getElementById('vorigeDag');
  const btnNext   = document.getElementById('volgendeDag');

  function ids(d){
    const y=d.getFullYear(), m=pad(d.getMonth()+1), dd=pad(d.getDate());
    return { kalenderId:`${y}${m}${dd}`, feestdag:`${dd}-${m}`, datumTekst:`${dd}-${m}-${y}` };
  }
  function toggleButtons(disabled){
    [btnPrev, btnNext].forEach(b=>{
      b.disabled = disabled;
      b.classList.toggle('hoek-btn-disabled', disabled);
    });
  }
  function fadeOutAll(){
    heiligeEl.classList.add('is-fading');
    dagEl.classList.add('is-fading');
    tipEl.classList.add('is-fading');
  }
  function fadeInAll(){
    heiligeEl.classList.remove('is-fading');
    dagEl.classList.remove('is-fading');
    tipEl.classList.remove('is-fading');
  }

  // ===== LEZINGEN OPHALEN UIT 'bijbel' (NT) =====
  function normaliseerBoek(raw){
    const s = (raw||'').toLowerCase();

    // NL + EN varianten → Firestore doc-prefix
    const map = [
      ['mattheüs','mattheus'], ['mattheus','mattheus'], ['matthew','mattheus'],
      ['markus','markus'], ['marcus','markus'], ['mark','markus'],
      ['lukas','lukas'], ['lucas','lukas'], ['luke','lukas'],
      ['johannes','johannes'], ['john','johannes'],
      ['handelingen','handelingen'], ['acts','handelingen'],
      ['romeinen','romeinen'], ['romans','romeinen'],
      ['galaten','galaten'], ['galatians','galaten'],
      ['efeze','efeze'], ['ephesians','efeze'],
      ['filippenzen','filippenzen'], ['philippians','filippenzen'],
      ['kolossenzen','kolossenzen'], ['colossians','kolossenzen'],
      ['titus','titus'],
      ['filemon','filemon'], ['philemon','filemon'],
      ['hebreeën','hebreeen'], ['hebreeen','hebreeen'], ['hebreen','hebreeen'], ['hebrews','hebreeen'],
      ['jakobus','jakobus'], ['james','jakobus'],
      ['judas','judas'], ['jude','judas'],
      ['openbaring','openbaring'], ['revelation','openbaring'], ['apocalypse','openbaring']
    ];
    for (const [needle, doc] of map){
      if (s.includes(needle)) return doc;
    }
    return ''; // onbekend boek
  }

  function parseRefToQuery(ref){
    if(!ref) return null;

    // Zoek hoofdstuk:verzen
    const m = ref.match(/(\d+)\s*:\s*(\d+)(?:\s*[-–]\s*(\d+))?/);
    if(!m) return null;
    const h = parseInt(m[1],10);
    const v1 = parseInt(m[2],10);
    const v2 = m[3] ? parseInt(m[3],10) : v1;

    // Boeknaam zit vóór de match
    const idx = ref.indexOf(m[0]);
    const boekRuw = ref.slice(0, idx).trim();

    // Strip eventuele inleidingen zoals "Brief van Paulus aan de ..."
    const boekKandidaat = boekRuw
      .replace(/^brief van paulus aan de\s+/i,'')
      .replace(/^st\.\s*paul'?s letter to\s+/i,'')
      .replace(/^the gospel according to\s+/i,'')
      .replace(/^evangelie volgens\s+/i,'')
      .replace(/[,.;]+$/,'');

    const boek = normaliseerBoek(boekKandidaat);
    if(!boek) return null;

    return { docId: `${boek}_h${h}`, vStart: v1, vEnd: v2 };
  }

  async function haalLezingUitBijbel(ref){
    const q = parseRefToQuery(ref);
    if(!q) return '';
    const snap = await db.collection('bijbel').doc(q.docId).get();
    if(!snap.exists) return '';
    const verzen = snap.data()?.verzen || {};
    let html = '';
    for(let v=q.vStart; v<=q.vEnd; v++){
      if(verzen[v]) html += `<p><strong>${v}</strong> ${verzen[v]}</p>`;
    }
    return html;
  }

  async function bouwHTMLVoorDatum(datum, taal){
    const { kalenderId, feestdag, datumTekst } = ids(datum);
    let leftHTML = `<div style="color:#a6a5a4;text-align:center;">Bezig met laden...</div>`;
    let rightMain = `<div style="color:#a6a5a4;text-align:center;">Bezig met laden...</div>`;
    let rightTip  = ``;

    // LINKS: heilige van de dag
    const pHeilige = db.collection("heiligen").where("feestdag","==",feestdag).get().then(snap=>{
      if (snap.empty){
        leftHTML = `<div style="color:#b8b7b4;text-align:center;margin-top:22px;font-size:1.15em"><br>Geen heilige van de dag gevonden.<br><div style="font-size:4em;text-align:center;margin-top:16px;">✝️</div></div>`;
        return;
      }
      const data = snap.docs[Math.floor(Math.random()*snap.docs.length)].data();
      const fotoUrl = data.icoon || data.foto_url || "https://upload.wikimedia.org/wikipedia/commons/1/12/Orthodox_Cross.svg";
      let naam="", levensverhaal="";
      if (taal==="engels"){ naam=data.naam_en||""; levensverhaal=data.levensverhaal_en||""; }
      else if (taal==="grieks"){ naam=data.naam_el||""; levensverhaal=data.levensverhaal_el||""; }
      else { naam=data.naam_nl||data.naam||data.id||"Heilige"; levensverhaal=data.levensverhaal_nl||data.levensverhaal_volwassenen||""; }
      if (!naam) naam = "Nog geen vertaling beschikbaar.";
      if (!levensverhaal) levensverhaal = "Nog geen vertaling beschikbaar.";
      leftHTML = `<div class="heilige-naam">${naam}</div><img src="${fotoUrl}" class="heilige-foto" alt="Heilige icoon"><div class="heilige-levensverhaal">${levensverhaal}</div>`;
    });

    // RECHTS: datum, vasten, LEZINGEN (volledig), tip — GEEN heiligenlijst rechts
    const pKal = db.collection("kalender2025").doc(kalenderId).get().then(async doc=>{
      if (!doc.exists){
        rightMain = `<div style="color:#b8b7b4;text-align:center;margin-top:60px;font-size:1.1em">Geen kalenderinfo gevonden.</div>`;
        rightTip = "";
        return;
      }
      const data = doc.data();

      let vasten = data[`Vastenregel NL (netjes NL)`] || data[`Vastenregel NL`] || "";
      if (taal==="engels") vasten = data[`Vastenregel EN`] || (vasten ? "Fasting Free" : "");
      if (taal==="grieks") vasten = data[`Vastenregel EL`] || (vasten ? "Νηστεία ελεύθερη" : "");
      if (!vasten){
        if (taal==="vlaams") vasten="Vastenvrij";
        else if (taal==="engels") vasten="Fasting Free";
        else vasten="Νηστεία ελεύθερη";
      }
      const symb = data["Symbool"] || "";
      let vastenRegelBlok = `<span>${vasten}</span>`;
      if (symb) vastenRegelBlok += `<span class="vastenregel-symbool">${symb}</span>`;

      // Referenties per taal
      let epRef="", evRef="";
      if (taal==="vlaams"){
        epRef = data[`Epistel Ref NL (netjes NL)`] || data[`Epistel Ref NL`] || "";
        evRef = data[`Evangelie Ref NL (netjes NL)`] || data[`Evangelie Ref NL`] || "";
      } else if (taal==="engels"){
        epRef = data[`Epistel Ref EN`] || "";
        evRef = data[`Evangelie Ref EN`] || "";
      } else {
        epRef = data[`Epistel Ref EL`] || "";
        evRef = data[`Evangelie Ref EL`] || "";
      }

      // Volledige tekst van de lezingen uit 'bijbel'
      const [epTekst, evTekst] = await Promise.all([
        haalLezingUitBijbel(epRef),
        haalLezingUitBijbel(evRef)
      ]);

      let epL="Apostellezing", evL="Evangelielezing";
      if (taal==="engels"){ epL="Epistle Reading"; evL="Gospel Reading"; }
      if (taal==="grieks"){ epL="Απόστολος"; evL="Ευαγγέλιο"; }

      const tip = (taal==="vlaams") ? (data[`Tip/Wens NL (netjes NL)`] || data[`Tip/Wens NL`] || "")
               : (taal==="engels") ? (data[`Tip/Wens EN`] || "")
               : (data[`Tip/Wens EL`] || "");

      rightMain =
        `<div class="dagkalender-datum">${datumTekst}</div>
         <div class="vastenregel-regel">${vastenRegelBlok}</div>
         <div class="lezingblok"><b>${epL}:</b> ${epRef}${epTekst ? `<br>${epTekst}` : ''}</div>
         <div class="lezingblok"><b>${evL}:</b> ${evRef}${evTekst ? `<br>${evTekst}` : ''}</div>`;
      rightTip = tip || "";
    });

    await Promise.all([pHeilige, pKal]);
    return { leftHTML, rightMain, rightTip };
  }

  let huidigeTaal = "vlaams";
  let actieveDatum = new Date();
  let isBusy = false;

  document.getElementById("btn-vlaams").onclick = () => { huidigeTaal="vlaams"; setTaal(); };
  document.getElementById("btn-engels").onclick = () => { huidigeTaal="engels"; setTaal(); };
  document.getElementById("btn-grieks").onclick = () => { huidigeTaal="grieks"; setTaal(); };

  function setTaal(){
    laadDag(actieveDatum);
    document.querySelectorAll(".taalkeuze button").forEach(btn=>btn.classList.remove("selected"));
    document.getElementById("btn-"+huidigeTaal).classList.add("selected");
  }

  async function laadDag(datum){
    if (isBusy) return;
    isBusy = true;
    fadeOutAll();
    toggleButtons(true);
    const html = await bouwHTMLVoorDatum(datum, huidigeTaal);
    if (html){
      heiligeEl.innerHTML = html.leftHTML;
      dagEl.innerHTML     = html.rightMain;
      tipEl.innerHTML     = html.rightTip;
    }
    fadeInAll();
    toggleButtons(false);
    isBusy = false;
  }

  laadDag(actieveDatum);
  btnPrev.onclick = ()=>{ actieveDatum.setDate(actieveDatum.getDate()-1); laadDag(actieveDatum); };
  btnNext.onclick = ()=>{ actieveDatum.setDate(actieveDatum.getDate()+1); laadDag(actieveDatum); };
</script>
<!-- ==== EINDE SCRIPT DAGKALENDER ==== -->
