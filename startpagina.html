<!-- ==== SCRIPT DAGKALENDER ==== -->
<script>
  const pad = n => (n<10 ? '0'+n : ''+n);
  const heiligeEl = document.getElementById('heilige-inhoud');
  const dagEl     = document.getElementById('dagkalender-inhoud');
  const tipEl     = document.getElementById('dagkalender-tip');
  const btnPrev   = document.getElementById('vorigeDag');
  const btnNext   = document.getElementById('volgendeDag');

  function ids(d){
    const y=d.getFullYear(), m=pad(d.getMonth()+1), dd=pad(d.getDate());
    return { kalenderId:`${y}${m}${dd}`, feestdag:`${dd}-${m}`, datumTekst:`${dd}-${m}-${y}` };
  }
  function toggleButtons(disabled){
    [btnPrev, btnNext].forEach(b=>{
      b.disabled = disabled;
      b.classList.toggle('hoek-btn-disabled', disabled);
    });
  }
  function fadeOutAll(){
    heiligeEl.classList.add('is-fading');
    dagEl.classList.add('is-fading');
    tipEl.classList.add('is-fading');
  }
  function fadeInAll(){
    heiligeEl.classList.remove('is-fading');
    dagEl.classList.remove('is-fading');
    tipEl.classList.remove('is-fading');
  }

  // kleine helper om de juiste lezing uit 'bijbel' te halen
  async function haalLezingUitBijbel(ref) {
    if (!ref) return "";
    const match = ref.match(/([\wÃ«Ã©Ã¨ÃªÃ¯Ã¶Ã¤Ã¼]+)\s+(\d+):(\d+)-(\d+)/i);
    if (!match) return "";
    let boek = match[1].toLowerCase().replace(/[Ã«Ã©Ã¨Ãª]/g,"e").replace(/[Ã¯]/g,"i");
    const hoofdstuk = parseInt(match[2]), v1 = parseInt(match[3]), v2 = parseInt(match[4]);
    const map = {
      mattheÃ¼s:"mattheus", mattheus:"mattheus", matthew:"mattheus",
      markus:"markus", mark:"markus",
      lukas:"lukas", luke:"lukas",
      johannes:"johannes", john:"johannes",
      handelingen:"handelingen", acts:"handelingen",
      romeinen:"romeinen", romans:"romeinen",
      galaten:"galaten", galatians:"galaten",
      efeze:"efeze", ephesians:"efeze",
      filippenzen:"filippenzen", philippians:"filippenzen",
      kolossenzen:"kolossenzen", colossians:"kolossenzen",
      titus:"titus",
      filemon:"filemon", philemon:"filemon",
      hebreeen:"hebreeen", hebrews:"hebreeen",
      jakobus:"jakobus", james:"jakobus",
      judas:"judas", jude:"judas",
      openbaring:"openbaring", revelation:"openbaring"
    };
    boek = map[boek] || boek;
    const docId = `${boek}_h${hoofdstuk}`;
    const snap = await db.collection("bijbel").doc(docId).get();
    if (!snap.exists) return "";
    const verzen = snap.data().verzen || {};
    let tekst = "";
    for (let i = v1; i <= v2; i++) {
      if (verzen[i]) tekst += `<p><strong>${i}</strong> ${verzen[i]}</p>`;
    }
    return tekst;
  }

  async function bouwHTMLVoorDatum(datum, taal){
    const { kalenderId, feestdag, datumTekst } = ids(datum);
    let leftHTML = `<div style="color:#a6a5a4;text-align:center;">Bezig met laden...</div>`;
    let rightMain = `<div style="color:#a6a5a4;text-align:center;">Bezig met laden...</div>`;
    let rightTip  = ``;

    // LINKS: heilige van de dag
    const pHeilige = db.collection("heiligen").where("feestdag","==",feestdag).get().then(snap=>{
      if (snap.empty){
        leftHTML = `<div style="color:#b8b7b4;text-align:center;margin-top:22px;font-size:1.15em"><br>Geen heilige van de dag gevonden.<br><div style="font-size:4em;text-align:center;margin-top:16px;">âœï¸</div></div>`;
        return;
      }
      const data = snap.docs[Math.floor(Math.random()*snap.docs.length)].data();
      const fotoUrl = data.icoon || data.foto_url || "https://upload.wikimedia.org/wikipedia/commons/1/12/Orthodox_Cross.svg";
      let naam="", levensverhaal="";
      if (taal==="engels"){ naam=data.naam_en||""; levensverhaal=data.levensverhaal_en||""; }
      else if (taal==="grieks"){ naam=data.naam_el||""; levensverhaal=data.levensverhaal_el||""; }
      else { naam=data.naam_nl||data.naam||data.id||"Heilige"; levensverhaal=data.levensverhaal_nl||data.levensverhaal_volwassenen||""; }
      if (!naam) naam = "Nog geen vertaling beschikbaar.";
      if (!levensverhaal) levensverhaal = "Nog geen vertaling beschikbaar.";
      leftHTML = `<div class="heilige-naam">${naam}</div><img src="${fotoUrl}" class="heilige-foto" alt="Heilige icoon"><div class="heilige-levensverhaal">${levensverhaal}</div>`;
    });

    // RECHTS: datum, vasten, lezingen, tip (ZONDER heiligen-lijst rechts)
    const pKal = db.collection("kalender2025").doc(kalenderId).get().then(async doc=>{
      if (!doc.exists){
        rightMain = `<div style="color:#b8b7b4;text-align:center;margin-top:60px;font-size:1.1em">Geen kalenderinfo gevonden.</div>`;
        rightTip = "";
        return;
      }
      const data = doc.data();

      let vasten = data[`Vastenregel NL (netjes NL)`] || data[`Vastenregel NL`] || "";
      if (taal==="engels") vasten = data[`Vastenregel EN`] || (vasten ? "Fasting Free" : "");
      if (taal==="grieks") vasten = data[`Vastenregel EL`] || (vasten ? "ÎÎ·ÏƒÏ„ÎµÎ¯Î± ÎµÎ»ÎµÏÎ¸ÎµÏÎ·" : "");
      if (!vasten){
        if (taal==="vlaams") vasten="Vastenvrij";
        else if (taal==="engels") vasten="Fasting Free";
        else vasten="ÎÎ·ÏƒÏ„ÎµÎ¯Î± ÎµÎ»ÎµÏÎ¸ÎµÏÎ·";
      }
      const symb = data["Symbool"] || "";
      let vastenRegelBlok = `<span>${vasten}</span>`;
      if (symb) vastenRegelBlok += `<span class="vastenregel-symbool">${symb}</span>`;

      let ep="", ev="";
      if (taal==="vlaams"){
        ep = data[`Epistel Ref NL (netjes NL)`] || data[`Epistel Ref NL`] || "Nog geen vertaling beschikbaar.";
        ev = data[`Evangelie Ref NL (netjes NL)`] || data[`Evangelie Ref NL`] || "Nog geen vertaling beschikbaar.";
      } else if (taal==="engels"){
        ep = data[`Epistel Ref EN`] || "No translation available yet.";
        ev = data[`Evangelie Ref EN`] || "No translation available yet.";
      } else {
        ep = data[`Epistel Ref EL`] || "Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î±ÎºÏŒÎ¼Î· Î¼ÎµÏ„Î¬Ï†ÏÎ±ÏƒÎ·.";
        ev = data[`Evangelie Ref EL`] || "Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î±ÎºÏŒÎ¼Î· Î¼ÎµÏ„Î¬Ï†ÏÎ±ÏƒÎ·.";
      }

      // ğŸ”¹ toevoeging: lezingen volledig ophalen uit 'bijbel'
      const epLezing = await haalLezingUitBijbel(ep);
      const evLezing = await haalLezingUitBijbel(ev);

      let epL="Apostellezing", evL="Evangelielezing";
      if (taal==="engels"){ epL="Epistle Reading"; evL="Gospel Reading"; }
      if (taal==="grieks"){ epL="Î‘Ï€ÏŒÏƒÏ„Î¿Î»Î¿Ï‚"; evL="Î•Ï…Î±Î³Î³Î­Î»Î¹Î¿"; }

      const tip = (taal==="vlaams") ? (data[`Tip/Wens NL (netjes NL)`] || data[`Tip/Wens NL`] || "")
               : (taal==="engels") ? (data[`Tip/Wens EN`] || "")
               : (data[`Tip/Wens EL`] || "");

      rightMain =
        `<div class="dagkalender-datum">${datumTekst}</div>
         <div class="vastenregel-regel">${vastenRegelBlok}</div>
         <div class="lezingblok"><b>${epL}:</b> ${ep}<br>${epLezing}</div>
         <div class="lezingblok"><b>${evL}:</b> ${ev}<br>${evLezing}</div>`;
      rightTip = tip || "";
    });

    await Promise.all([pHeilige, pKal]);
    return { leftHTML, rightMain, rightTip };
  }

  let huidigeTaal = "vlaams";
  let actieveDatum = new Date();
  let isBusy = false;

  document.getElementById("btn-vlaams").onclick = () => { huidigeTaal="vlaams"; setTaal(); };
  document.getElementById("btn-engels").onclick = () => { huidigeTaal="engels"; setTaal(); };
  document.getElementById("btn-grieks").onclick = () => { huidigeTaal="grieks"; setTaal(); };

  function setTaal(){
    laadDag(actieveDatum);
    document.querySelectorAll(".taalkeuze button").forEach(btn=>btn.classList.remove("selected"));
    document.getElementById("btn-"+huidigeTaal).classList.add("selected");
  }

  async function laadDag(datum){
    if (isBusy) return;
    isBusy = true;
    fadeOutAll();
    toggleButtons(true);
    const html = await bouwHTMLVoorDatum(datum, huidigeTaal);
    if (html){
      heiligeEl.innerHTML = html.leftHTML;
      dagEl.innerHTML     = html.rightMain;
      tipEl.innerHTML     = html.rightTip;
    }
    fadeInAll();
    toggleButtons(false);
    isBusy = false;
  }

  laadDag(actieveDatum);
  btnPrev.onclick = ()=>{ actieveDatum.setDate(actieveDatum.getDate()-1); laadDag(actieveDatum); };
  btnNext.onclick = ()=>{ actieveDatum.setDate(actieveDatum.getDate()+1); laadDag(actieveDatum); };
</script>
<!-- ==== EINDE SCRIPT DAGKALENDER ==== -->
