<!-- ==== SCRIPT DAGKALENDER ==== -->
<script>
  // Hulpjes
  const pad = n => (n<10 ? '0'+n : ''+n);
  const heiligeEl = document.getElementById('heilige-inhoud');
  const dagEl     = document.getElementById('dagkalender-inhoud');
  const tipEl     = document.getElementById('dagkalender-tip');
  const btnPrev   = document.getElementById('vorigeDag');
  const btnNext   = document.getElementById('volgendeDag');

  // Datum → ids
  function ids(d){
    const y=d.getFullYear(), m=pad(d.getMonth()+1), dd=pad(d.getDate());
    return { kalenderId:`${y}${m}${dd}`, feestdag:`${dd}-${m}`, datumTekst:`${dd}-${m}-${y}` };
  }

  function toggleButtons(disabled){
    [btnPrev, btnNext].forEach(b=>{
      b.disabled = disabled;
      b.classList.toggle('hoek-btn-disabled', disabled);
    });
  }
  function fadeOutAll(){ heiligeEl.classList.add('is-fading'); dagEl.classList.add('is-fading'); tipEl.classList.add('is-fading'); }
  function fadeInAll(){  heiligeEl.classList.remove('is-fading'); dagEl.classList.remove('is-fading'); tipEl.classList.remove('is-fading'); }

  // ===== Boeknaam → Firestore-ID (NT) =====
  // (Alleen NT nodig voor epistel/evangelie; we hebben deze boeken in 'bijbel' staan als <id>_h<nr>)
  const NT_ID = {
    "Mattheus":"mattheus", "Matthéüs":"mattheus", "Matteus":"mattheus",
    "Markus":"markus", "Marcus":"markus",
    "Lukas":"lukas", "Lucas":"lukas",
    "Johannes":"johannes",
    "Handelingen":"handelingen",
    "Romeinen":"romeinen",
    "Galaten":"galaten",
    "Efeze":"efeze", "Efeziers":"efeze", "Efeziërs":"efeze",
    "Filippenzen":"filippenzen", "Filippenzen":"filippenzen",
    "Kolossenzen":"kolossenzen",
    "Titus":"titus",
    "Filemon":"filemon", "Filemón":"filemon",
    "Hebreeen":"hebreeen", "Hebreeën":"hebreeen",
    "Jakobus":"jakobus",
    "Judas":"judas",
    "Openbaring":"openbaring", "Apokalyps":"openbaring", "Openbaring van Johannes":"openbaring"
  };

  // Ref parser: neemt b.v. "Efeze 1:1-10", "Johannes 3", "Handelingen 2:4"
  // Retourneert {boek, hoofdstuk, vStart, vEnd}
  function parseRef(refText){
    if(!refText || typeof refText!=='string') return null;
    let t = refText.trim();
    // Verwijder eventuele extra’s binnen haakjes
    t = t.replace(/\(.*?\)/g,'').trim();

    // Boeknaam (met spaties/diacritics) + hoofdstuk + optioneel :verzen
    const m = t.match(/^([A-Za-zÀ-ÿ\. \-]+?)\s+(\d+)(?::\s*(\d+)(?:\s*\-\s*(\d+))?)?$/);
    if(!m) return null;

    let boek = m[1].replace(/\s+/g,' ').trim();
    // Normaliseer bekende varianten
    if(NT_ID[boek] === undefined){
      // Probeer hoofdletterfix
      const key = boek.charAt(0).toUpperCase()+boek.slice(1).toLowerCase();
      if(NT_ID[key] !== undefined) boek = key;
    }
    const hoofdstuk = Number(m[2]);
    const vStart = m[3] ? Number(m[3]) : null;
    const vEnd   = m[4] ? Number(m[4]) : vStart;

    const boekId = NT_ID[boek];
    if(!boekId || !hoofdstuk || isNaN(hoofdstuk)) return null;

    return { boek, boekId, hoofdstuk, vStart, vEnd };
  }

  // Laad 1 passage (volledige of deel van hoofdstuk) uit 'bijbel/<boekId>_h<hoofdstuk>'
  async function fetchPassageHTML(refText, label){
    const parsed = parseRef(refText);
    if(!parsed){
      return `<div class="lezingblok"><b>${label}:</b> <em>Onleesbare referentie</em> — <code>${refText||''}</code></div>`;
    }
    const { boek, boekId, hoofdstuk, vStart, vEnd } = parsed;
    const docId = `${boekId}_h${hoofdstuk}`;
    try{
      const snap = await db.collection('bijbel').doc(docId).get();
      if(!snap.exists){
        return `<div class="lezingblok"><b>${label}:</b> <em>Niet gevonden</em> — <code>${docId}</code></div>`;
      }
      const data = snap.data();
      const verzen = data?.verzen || {};
      // Bepaal welke verzen we tonen
      let nums = Object.keys(verzen).map(n=>Number(n)).filter(n=>!isNaN(n)).sort((a,b)=>a-b);
      if(vStart){ 
        const from = vStart, to = vEnd || vStart;
        nums = nums.filter(n => n>=from && n<=to);
      }
      if(nums.length===0){
        return `<div class="lezingblok"><b>${label}:</b> <em>Geen verzen in dit bereik</em> — ${boek} ${hoofdstuk}${vStart?':'+vStart+(vEnd?'-'+vEnd:''):''}</div>`;
      }
      const tekstHTML = nums.map(n=>`<p class="vers"><strong>${n}</strong> ${verzen[n]}</p>`).join('');
      return `<div class="lezingblok"><b>${label}:</b> <u>${boek} ${hoofdstuk}${vStart?':'+vStart+(vEnd?'-'+vEnd:''):''}</u>${tekstHTML}</div>`;
    }catch(e){
      return `<div class="lezingblok"><b>${label}:</b> <em>Fout bij laden</em> — ${e}</div>`;
    }
  }

  // Bouw HTML voor beide pagina's
  async function bouwHTMLVoorDatum(datum, taal){
    const { kalenderId, feestdag, datumTekst } = ids(datum);

    // Links (heilige van de dag) blijft zoals bij jou
    let leftHTML = `<div style="color:#a6a5a4;text-align:center;">Bezig met laden...</div>`;
    const pHeilige = db.collection("heiligen")
      .where("feestdag","==",feestdag)
      .get()
      .then(snap=>{
        if (snap.empty){
          leftHTML = `<div style="color:#b8b7b4;text-align:center;margin-top:22px;font-size:1.15em">
            <br>Geen heilige van de dag gevonden.<br>
            <div style="font-size:4em;text-align:center;margin-top:16px;">✝️</div>
          </div>`;
          return;
        }
        const data = snap.docs[Math.floor(Math.random()*snap.docs.length)].data();
        const fotoUrl = data.icoon || data.foto_url || "https://upload.wikimedia.org/wikipedia/commons/1/12/Orthodox_Cross.svg";
        let naam="", levensverhaal="";
        if (taal==="engels"){ naam=data.naam_en||""; levensverhaal=data.levensverhaal_en||""; }
        else if (taal==="grieks"){ naam=data.naam_el||""; levensverhaal=data.levensverhaal_el||""; }
        else { naam=data.naam_nl||data.naam||data.id||"Heilige"; levensverhaal=data.levensverhaal_nl||data.levensverhaal_volwassenen||""; }
        if (!naam) naam = "Nog geen vertaling beschikbaar.";
        if (!levensverhaal) levensverhaal = "Nog geen vertaling beschikbaar.";
        leftHTML = `
          <div class="heilige-naam">${naam}</div>
          <img src="${fotoUrl}" class="heilige-foto" alt="Heilige icoon">
          <div class="heilige-levensverhaal">${levensverhaal}</div>
        `;
      });

    // Rechts: datum + vastenregel + VOLLEDIGE lezingen (geen “heiligenlijst” hier)
    let rightMain = `<div style="color:#a6a5a4;text-align:center;">Bezig met laden...</div>`;
    let rightTip  = ``;

    const pKal = db.collection("kalender2025").doc(kalenderId).get().then(async doc=>{
      if (!doc.exists){
        rightMain = `<div class="dagkalender-datum">${datumTekst}</div>
          <div style="color:#b8b7b4;text-align:center;margin-top:60px;font-size:1.1em">Geen kalenderinfo gevonden.</div>`;
        rightTip = "";
        return;
      }
      const data = doc.data();

      // Vastenregel
      let vasten = data[`Vastenregel NL (netjes NL)`] || data[`Vastenregel NL`] || "";
      if (taal==="engels") vasten = data[`Vastenregel EN`] || (vasten ? "Fasting Free" : "");
      if (taal==="grieks") vasten = data[`Vastenregel EL`] || (vasten ? "Νηστεία ελεύθερη" : "");
      if (!vasten){
        if (taal==="vlaams") vasten="Vastenvrij";
        else if (taal==="engels") vasten="Fasting Free";
        else vasten="Νηστεία ελεύθερη";
      }
      const symb = data["Symbool"] || "";
      let vastenRegelBlok = `<span>${vasten}</span>`;
      if (symb) vastenRegelBlok += ` <span class="vastenregel-symbool">${symb}</span>`;

      // Lezingen: neem refs uit gekozen taal, maar tekst komt uit onze NT (Vlaams)
      let epRef = "", evRef = "";
      if (taal==="vlaams"){
        epRef = data[`Epistel Ref NL (netjes NL)`] || data[`Epistel Ref NL`] || "";
        evRef = data[`Evangelie Ref NL (netjes NL)`] || data[`Evangelie Ref NL`] || "";
      } else if (taal==="engels"){
        epRef = data[`Epistel Ref EN`] || data[`Epistel Ref NL (netjes NL)`] || data[`Epistel Ref NL`] || "";
        evRef = data[`Evangelie Ref EN`] || data[`Evangelie Ref NL (netjes NL)`] || data[`Evangelie Ref NL`] || "";
      } else {
        epRef = data[`Epistel Ref EL`] || data[`Epistel Ref NL (netjes NL)`] || data[`Epistel Ref NL`] || "";
        evRef = data[`Evangelie Ref EL`] || data[`Evangelie Ref NL (netjes NL)`] || data[`Evangelie Ref NL`] || "";
      }

      const epLabel = (taal==="engels") ? "Epistle Reading" : (taal==="grieks" ? "Απόστολος" : "Apostellezing");
      const evLabel = (taal==="engels") ? "Gospel Reading"  : (taal==="grieks" ? "Ευαγγέλιο"  : "Evangelielezing");

      // Volledige tekst ophalen uit 'bijbel'
      const epHTML = await fetchPassageHTML(epRef, epLabel);
      const evHTML = await fetchPassageHTML(evRef, evLabel);

      const datumHTML = `<div class="dagkalender-datum">${datumTekst}</div>`;
      rightMain = `
        ${datumHTML}
        <div class="vastenregel-regel">${vastenRegelBlok}</div>
        ${epHTML}
        ${evHTML}
      `;

      // Tip
      rightTip = (taal==="vlaams") ? (data[`Tip/Wens NL (netjes NL)`] || data[`Tip/Wens NL`] || "")
               : (taal==="engels") ? (data[`Tip/Wens EN`] || "")
               : (data[`Tip/Wens EL`] || "");
    });

    await Promise.all([pHeilige, pKal]);
    return { leftHTML, rightMain, rightTip };
  }

  // Taalkeuze en navigatie
  let huidigeTaal = "vlaams";
  let actieveDatum = new Date();
  let isBusy = false;

  document.getElementById("btn-vlaams").onclick = () => { huidigeTaal="vlaams"; setTaal(); };
  document.getElementById("btn-engels").onclick = () => { huidigeTaal="engels"; setTaal(); };
  document.getElementById("btn-grieks").onclick = () => { huidigeTaal="grieks"; setTaal(); };

  function setTaal(){
    laadDag(actieveDatum);
    document.querySelectorAll(".taalkeuze button").forEach(btn=>btn.classList.remove("selected"));
    document.getElementById("btn-"+huidigeTaal).classList.add("selected");
  }

  async function laadDag(datum){
    if (isBusy) return;
    isBusy = true;
    fadeOutAll();
    toggleButtons(true);
    const html = await bouwHTMLVoorDatum(datum, huidigeTaal);
    if (html){
      heiligeEl.innerHTML = html.leftHTML;
      dagEl.innerHTML     = html.rightMain;
      tipEl.innerHTML     = html.rightTip;
    }
    fadeInAll();
    toggleButtons(false);
    isBusy = false;
  }

  // start
  laadDag(actieveDatum);
  btnPrev.onclick = ()=>{ actieveDatum.setDate(actieveDatum.getDate()-1); laadDag(actieveDatum); };
  btnNext.onclick = ()=>{ actieveDatum.setDate(actieveDatum.getDate()+1); laadDag(actieveDatum); };
</script>
<!-- ==== EINDE SCRIPT DAGKALENDER ==== -->
