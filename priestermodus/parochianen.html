<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Parochianen - Priestermodus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial, sans-serif; background: #f8f5e9; margin: 0; }
    h1 { text-align: center; color: #5d4c2f; margin-top: 32px; }
    table { width: 90%; margin: 40px auto; background: #fffef9; border-radius: 18px; box-shadow: 0 6px 32px #d7cbb142; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #f0e4c8; vertical-align: top; }
    th { background: #7bb235; color: #fff; }
    .opslaan { background: #45a745; color: #fff; border: none; border-radius: 5px; padding: 6px 12px; cursor: pointer;}
    .opslaan:hover { background: #358135; }
    .kindlijst { margin: 5px 0 15px 30px; font-size: 0.97em; color: #50402a;}
    .kindlabel { font-weight: bold; color: #88865a;}
    label { display: block; margin-bottom: 4px; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
</head>
<body>

  <!-- ==== HEADER (via layout.js) ==== -->
  <div id="priester-header"></div>
  <script src="https://kathy-torfs.github.io/Orthodoxeweg/priestermodus/common/layout.js" defer></script>
  <!-- ==== EINDE HEADER ==== -->

  <h1>Ledenlijst</h1>

  <table>
    <thead>
      <tr>
        <th>Naam</th>
        <th>E-mail</th>
        <th>Rol(len)</th>
        <th>Kinderen</th>
        <th>Actie</th>
      </tr>
    </thead>
    <tbody id="ledenTabel">
      <tr><td colspan="5">Bezig met laden...</td></tr>
    </tbody>
  </table>

  <script>
    // FIREBASE INIT
    const firebaseConfig = {
      apiKey: "AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
      authDomain: "orthodoxeweg.firebaseapp.com",
      projectId: "orthodoxeweg",
      storageBucket: "orthodoxeweg.appspot.com",
      messagingSenderId: "408582263618",
      appId: "1:408582263618:web:0a20f4bf0704989d3ceedb"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const parochieId = localStorage.getItem("ingelogdeParochie");
    if (!parochieId) {
      alert("Geen parochie gevonden in je sessie. Log opnieuw in.");
      window.location.href = "https://kathy-torfs.github.io/Orthodoxeweg/index.html";
    }

    async function laadLeden() {
      const tbody = document.getElementById("ledenTabel");

      db.collection("parochies").doc(parochieId).collection("leden")
        .get().then(async snapshot => {
          if (snapshot.empty) {
            tbody.innerHTML = "<tr><td colspan='5'>Geen leden gevonden.</td></tr>";
            return;
          }
          let html = "";
          const promises = [];

          snapshot.forEach(doc => {
            const d = doc.data();
            const lidId = doc.id;

            // === Migratie: rol omzetten naar array als nodig ===
            let rollen = d.rol;
            if (typeof rollen === "string") {
              rollen = [rollen];
              db.collection("parochies").doc(parochieId).collection("leden").doc(lidId).update({
                rol: rollen
              });
            }

            const kindPromise = db.collection("parochies").doc(parochieId)
              .collection("leden").doc(lidId).collection("kinderen").get()
              .then(kindSnap => {
                let kindList = "";
                if (kindSnap.empty) {
                  kindList = "<span class='kindlabel'>Geen</span>";
                } else {
                  kindList = "<ul class='kindlijst'>";
                  kindSnap.forEach(kindDoc => {
                    const k = kindDoc.data();
                    kindList += `<li>${k.voornaam} ${k.achternaam} (${k.geboortedatum || ""})</li>`;
                  });
                  kindList += "</ul>";
                }

                html += `
                  <tr>
                    <td>${d.voornaam} ${d.achternaam}</td>
                    <td>${d.email}</td>
                    <td>
                      <label>
                        <input type="checkbox" id="rol-${lidId}-parochiaan" ${rollen && rollen.includes("parochiaan") ? "checked" : ""}>
                        Parochiaan
                      </label>
                      <label>
                        <input type="checkbox" id="rol-${lidId}-catecheet" ${rollen && rollen.includes("catecheet") ? "checked" : ""}>
                        Catecheet
                      </label>
                    </td>
                    <td>${kindList}</td>
                    <td><button class="opslaan" onclick="rolOpslaan('${lidId}')">Opslaan</button></td>
                  </tr>
                `;
              });
            promises.push(kindPromise);
          });

          await Promise.all(promises);
          tbody.innerHTML = html;
        });
    }

    laadLeden();

    async function rolOpslaan(id) {
      const rollen = [];
      if (document.getElementById(`rol-${id}-parochiaan`).checked) rollen.push("parochiaan");
      if (document.getElementById(`rol-${id}-catecheet`).checked) rollen.push("catecheet");

      if (rollen.length === 0) rollen.push("parochiaan"); // altijd minimaal parochiaan

      await db.collection("parochies").doc(parochieId).collection("leden").doc(id)
        .update({ rol: rollen });
      alert("Rol bijgewerkt!");
      laadLeden();
    }
  </script>
</body>
</html>
