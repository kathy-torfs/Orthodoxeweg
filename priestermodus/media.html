<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Media â€“ Priester</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png">
  <style>
    main { max-width: 800px; margin: 40px auto; padding: 0 16px; }
    h1 { text-align: center; color: #5d4c2f; margin-bottom: 26px; }
    form {
      background: #fdfaf2; border: 2px solid #dab97a; border-radius: 12px;
      padding: 18px; margin-bottom: 30px; box-shadow: 0 2px 8px #0001;
      display: flex; flex-direction: column; gap: 14px;
    }
    form input, form textarea, form button {
      font-family: inherit; font-size: 1em;
    }
    form input, form textarea {
      padding: 8px 10px; border: 1px solid #ccb47a; border-radius: 6px;
    }
    form textarea { resize: vertical; min-height: 70px; }
    form button {
      background: #7a5f35; color: #fff; border: none; border-radius: 6px;
      padding: 10px 14px; font-weight: bold; cursor: pointer; align-self: flex-end;
    }
    form button:hover { background: #b09765; }
    .feedback { color: #9a2617; font-size: 0.95em; }
    .media-lijst { display: flex; flex-direction: column; gap: 1rem; }
    .media-item {
      background: #fffef9; border: 1.5px solid #e1d6b0; border-radius: 10px;
      padding: 14px 16px; box-shadow: 0 2px 6px #0001;
    }
    .media-item h3 { margin: 0 0 6px 0; color: #5d4c2f; }
    .media-item p { margin: 0 0 8px 0; color: #6a5835; font-size: 0.95em; }
    .media-item audio, .media-item iframe { width: 100%; margin-bottom: 8px; }
    .delete-btn {
      background: #b6322c; color: #fff; border: none; border-radius: 6px;
      padding: 6px 12px; cursor: pointer; font-size: 0.9em; font-weight: bold;
    }
    .delete-btn:hover { background: #ef1616; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
</head>
<body>
  <!-- Header & layout -->
  <div id="header-container"></div>
  <script src="https://kathy-torfs.github.io/Orthodoxeweg/layout.js"></script>

  <main>
    <h1>ðŸŽµ Media Uploaden</h1>
    <form id="mediaForm">
      <input type="text" id="titel" placeholder="Titel" required>
      <textarea id="omschrijving" placeholder="Korte omschrijving..."></textarea>
      <label>Upload bestand (mp3/mp4): <input type="file" id="bestand"></label>
      <input type="url" id="link" placeholder="of plak een link (YouTube, mp3...)">
      <button type="submit">Opslaan</button>
      <div class="feedback" id="feedback"></div>
    </form>

    <div class="media-lijst" id="mediaLijst"></div>
  </main>

  <script>
    // Toegangscontrole
    if (!localStorage.getItem("ingelogdeParochie") || localStorage.getItem("modus") !== "priester") {
      window.location.href = "https://kathy-torfs.github.io/Orthodoxeweg/index.html";
    }
    const parochieId = localStorage.getItem("ingelogdeParochie");

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
      authDomain: "orthodoxeweg.firebaseapp.com",
      projectId: "orthodoxeweg",
      storageBucket: "orthodoxeweg.appspot.com",
      messagingSenderId: "408582263618",
      appId: "1:408582263618:web:0a20f4bf0704989d3ceedb"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const form = document.getElementById("mediaForm");
    const feedback = document.getElementById("feedback");
    const lijst = document.getElementById("mediaLijst");

    form.onsubmit = async (e) => {
      e.preventDefault();
      feedback.textContent = "";

      const titel = document.getElementById("titel").value.trim();
      const omschrijving = document.getElementById("omschrijving").value.trim();
      const bestand = document.getElementById("bestand").files[0];
      const link = document.getElementById("link").value.trim();

      if (!titel) {
        feedback.textContent = "Titel is verplicht.";
        return;
      }

      let url = link;
      if (bestand) {
        const opslagPad = `uploads/${parochieId}/${Date.now()}_${bestand.name}`;
        const ref = storage.ref(opslagPad);
        await ref.put(bestand);
        url = await ref.getDownloadURL();
      }
      if (!url) {
        feedback.textContent = "Geen bestand of link opgegeven.";
        return;
      }

      await db.collection("parochies").doc(parochieId).collection("uploads").add({
        titel, omschrijving, url,
        tijd: firebase.firestore.Timestamp.now()
      });
      feedback.textContent = "Opgeslagen!";
      form.reset();
      laadMedia();
      setTimeout(() => feedback.textContent = "", 1800);
    };

    async function laadMedia() {
      lijst.innerHTML = "<em>Laden...</em>";
      const snap = await db.collection("parochies").doc(parochieId).collection("uploads")
        .orderBy("tijd", "desc").get();
      lijst.innerHTML = "";
      if (snap.empty) {
        lijst.innerHTML = "<em>Nog geen media toegevoegd.</em>";
        return;
      }
      snap.forEach(doc => {
        const d = doc.data();
        const div = document.createElement("div");
        div.className = "media-item";
        div.innerHTML = `
          <h3>${d.titel || "Zonder titel"}</h3>
          <p>${d.omschrijving || ""}</p>
          ${d.url.endsWith(".mp3") ? `<audio controls src="${d.url}"></audio>` : ""}
          ${d.url.includes("youtube.com") || d.url.includes("youtu.be")
            ? `<iframe src="${d.url.replace("watch?v=", "embed/")}" frameborder="0" allowfullscreen></iframe>` : ""}
          <a href="${d.url}" target="_blank">Openen</a><br>
          <button class="delete-btn">Verwijderen</button>
        `;
        div.querySelector(".delete-btn").onclick = async () => {
          await db.collection("parochies").doc(parochieId).collection("uploads").doc(doc.id).delete();
          laadMedia();
        };
        lijst.appendChild(div);
      });
    }

    window.onload = laadMedia;
  </script>
</body>
</html>
