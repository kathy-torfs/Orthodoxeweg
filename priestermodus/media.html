<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>📡 Media – Priester</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#f5e9b8; color:#4e3a15; }
    header { background:#7a5f35; color:#fff; padding:14px; text-align:center; font-size:1.3em; font-weight:bold; }
    nav.menu {
      background:#7a5f35; padding:12px 20px;
      display:flex; flex-wrap:wrap; gap:14px; justify-content:center;
    }
    nav.menu a {
      color:#f8f5e9; text-decoration:none; font-weight:bold; font-size:16px;
      padding:6px 14px; border-radius:8px; transition:background-color 0.3s;
    }
    nav.menu a:hover { background-color:#5e4724; }
    main { max-width:900px; margin:30px auto; padding:0 2vw; }
    h1 { color:#7a5f35; text-align:center; margin-bottom:20px; }
    form {
      background:#fffef9; border:2px dashed #c9b067; border-radius:12px;
      padding:18px; margin-bottom:30px; text-align:center;
    }
    input,button { margin:10px 0; padding:8px 12px; font-size:1em; }
    button {
      background:#7bb235; border:none; border-radius:8px; cursor:pointer;
      color:#fff; font-weight:bold;
    }
    button:hover { background:#5a8d27; }
    .media-lijst { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px; }
    .media-item {
      background:#fffdf2; border:1.5px solid #e3c87a; border-radius:10px; padding:12px;
      display:flex; flex-direction:column; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.08);
    }
    .media-item img { max-width:100%; border-radius:8px; }
    .media-item audio, .media-item video { width:100%; margin-top:8px; }
    .delete-btn {
      margin-top:10px; background:#b6322c; border:none; border-radius:8px;
      color:#fff; padding:6px 12px; cursor:pointer; font-weight:bold;
    }
    .delete-btn:hover { background:#941f1a; }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
</head>
<body>
  <header>📡 Media Beheer – Priester</header>
  <nav class="menu">
    <a href="startpagina.html">🏠 Start</a>
    <a href="parochie.html">🛐 Parochie</a>
    <a href="catechese/catechese.html">📖 Catechese</a>
    <a href="gebeden/gebeden.html">🙏 Gebeden</a>
    <a href="psalmen/psalmen.html">📜 Psalmen</a>
    <a href="heiligen/heiligen.html">👼 Heiligen</a>
    <a href="bijbeldagboek.html">📔 Dagboek</a>
    <a href="verjaardagskalender.html">🎂 Verjaardagen</a>
    <a href="layout.html">⛪ Beheer</a>
  </nav>

  <main>
    <h1>Media uploaden</h1>
    <form id="uploadForm">
      <input type="file" id="bestand" accept="image/*,audio/*,video/*">
      <button type="submit">⬆️ Upload bestand</button>
    </form>

    <h2>📂 Geüploade media</h2>
    <div id="mediaLijst" class="media-lijst"></div>
  </main>

  <script>
    // 🔒 Toegang enkel voor priesters
    if (!localStorage.getItem("ingelogdeParochie") || localStorage.getItem("modus") !== "priester") {
      window.location.href = "https://kathy-torfs.github.io/Orthodoxeweg/index.html";
    }

    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
      authDomain: "orthodoxeweg.firebaseapp.com",
      projectId: "orthodoxeweg",
      storageBucket: "orthodoxeweg.appspot.com",
      messagingSenderId: "408582263618",
      appId: "1:408582263618:web:0a20f4bf0704989d3ceedb"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();
    const db = firebase.firestore();

    const parochieId = localStorage.getItem("ingelogdeParochie");

    // Upload bestand
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const bestand = document.getElementById("bestand").files[0];
      if (!bestand) return alert("Kies eerst een bestand!");

      const opslagPad = `uploads/${parochieId}/${Date.now()}_${bestand.name}`;
      const ref = storage.ref(oslagPad);
      await ref.put(bestand);

      // DownloadURL ophalen
      const url = await ref.getDownloadURL();

      // Metadata bepalen
      let type = "anders";
      if (bestand.type.startsWith("image")) type = "afbeelding";
      else if (bestand.type.startsWith("audio")) type = "audio";
      else if (bestand.type.startsWith("video")) type = "video";

      // In Firestore loggen
      await db.collection("parochies").doc(parochieId).collection("uploads").add({
        naam: bestand.name,
        pad: opslagPad,
        url: url,
        type: type,
        uploader: localStorage.getItem("loginKeuze") || "priester",
        datum: firebase.firestore.Timestamp.now()
      });

      alert("✅ Bestand geüpload!");
      document.getElementById("bestand").value = "";
      laadMedia();
    });

    // Media tonen
    async function laadMedia(){
      const lijst = document.getElementById("mediaLijst");
      lijst.innerHTML = "<em>Laden...</em>";
      try {
        const snap = await db.collection("parochies").doc(parochieId).collection("uploads")
          .orderBy("datum","desc").get();

        lijst.innerHTML = "";
        snap.forEach(doc => {
          const d = doc.data();
          const div = document.createElement("div");
          div.className = "media-item";

          if (d.type === "afbeelding") {
            div.innerHTML = `<img src="${d.url}" alt="${d.naam}">`;
          } else if (d.type === "audio") {
            div.innerHTML = `<audio controls src="${d.url}"></audio>`;
          } else if (d.type === "video") {
            div.innerHTML = `<video controls src="${d.url}"></video>`;
          } else {
            div.innerHTML = `<a href="${d.url}" target="_blank">${d.naam}</a>`;
          }

          // Verwijderknop
          const btn = document.createElement("button");
          btn.className = "delete-btn";
          btn.textContent = "🗑 Verwijder";
          btn.onclick = async () => {
            if (confirm("Weet je zeker dat je dit wilt verwijderen?")) {
              // Bestand verwijderen in Storage
              await storage.ref(d.pad).delete();
              // Document verwijderen in Firestore
              await doc.ref.delete();
              laadMedia();
            }
          };
          div.appendChild(btn);
          lijst.appendChild(div);
        });

        if (snap.empty) lijst.innerHTML = "<em>Geen media gevonden.</em>";
      } catch (err) {
        lijst.innerHTML = "<em>Fout bij laden.</em>";
        console.error(err);
      }
    }

    window.onload = laadMedia;
  </script>
</body>
</html>
