<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Priestermodus – Bijbeldagboek</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png">
  <style>
    body { background:#f5e9b8; font-family: Arial, sans-serif; color:#6f4e1a; margin:0; padding:0; }
    .page{max-width:1100px;margin:28px auto 40px;padding:0 14px}
    .headerline{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .dag-titel{font-size:1.3em;color:#7a5f35;font-weight:bold;margin:0}
    .chip{background:#eef6ff;color:#214b77;border:1px solid #cddcf4;border-radius:22px;padding:6px 10px;font-size:.92em}
    .intro-wrap{background:#fffbe7;border:1.5px solid #decaa1;border-radius:14px;padding:14px 16px;margin:8px 0 16px;color:#6f4e1a}
    .intro-wrap blockquote{margin:0;font-style:italic}
    .book{display:grid;grid-template-columns:1.05fr .95fr;gap:18px;
      background:linear-gradient(90deg,#ede4ca 48%,#fff9e1 52%);
      border:2.5px solid #ceb27d;border-radius:22px;box-shadow:0 8px 38px #a88b5480;
      padding:22px 18px;}
    @media (max-width:900px){ .book{grid-template-columns:1fr; } }
    .pane{background:#fffdfa;border:1px solid #eadbb2;border-radius:14px;padding:14px 16px;min-height:320px;
      box-shadow: inset 0 0 0 2px #00000006;}
    .pane h3{margin:0 0 10px 0;color:#7a5f35;font-size:1.04em}
    .bijbeltekst{color:#4a3a1c;line-height:1.72;letter-spacing:.15px}
    .bijbeltekst p{margin:0 0 10px 0;text-indent:1.1em}
    .notes-area{width:100%;min-height:320px;border:1.3px solid #dbc592;border-radius:10px;background:#faf5e1;padding:10px;resize:vertical;font-family:inherit}
    .save-row{display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:10px}
    .btn{background:#7a5f35;color:#fff;border:none;border-radius:10px;padding:9px 16px;cursor:pointer;font-family:inherit}
    .btn.secondary{background:#b09765}
    .hint{font-size:.9em;color:#8f7437}
    .under{margin-top:18px;display:grid;grid-template-columns:1fr;gap:14px}
    .vragen-blok{background:#f3ece1;border:1.2px solid #dfc789;border-radius:12px;padding:14px 16px}
    .vragen-blok h4{margin:0 0 8px 0;color:#7a5f35}
    .vragen-blok ol{margin:0;padding-left:20px}
    .reflectie-blok{background:#fffef6;border:1.2px solid #dbc592;border-radius:12px;padding:14px 16px}
    .reflectie-text{width:100%;min-height:110px;border:1.3px solid #dbc592;border-radius:10px;background:#faf5e1;padding:10px;resize:vertical;font-family:inherit}
    .navrow{display:flex;gap:10px;justify-content:space-between;align-items:center;margin-top:16px}
    .badge{font-size:.92em;color:#8f7437}
    .linkback{background:#b09765}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal{width:min(92vw,420px);background:#fffef6;border:1.6px solid #dbc592;border-radius:14px;
      box-shadow:0 18px 60px rgba(0,0,0,.25);padding:18px 18px 14px}
    .modal h3{margin:0 0 10px;color:#7a5f35}
    .modal label{font-weight:bold;color:#8a641f}
    .modal input{width:100%;margin:.3em 0 1em;border:1.2px solid #dbc592;border-radius:8px;padding:9px;background:#faf5e1}
    .modal .row{display:flex;gap:8px;justify-content:flex-end;align-items:center}
    .modal .err{color:#b9311e;min-height:22px;font-size:.95em}
    .small{font-size:.92em;color:#8f7437;margin-top:6px}
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script defer src="common/layout.js"></script>
</head>
<body>
  <!-- Priester header -->
  <div id="priester-header" data-header-src="common/header.html"></div>

  <div class="page">
    <div class="headerline">
      <h2 class="dag-titel" id="dagTitel">Dag</h2>
      <div class="chip" id="lezingChip" style="display:none;"></div>
    </div>
    <div class="intro-wrap" id="introWrap" style="display:none;">
      <blockquote id="introText"></blockquote>
      <div class="small" id="saveHint" style="display:none;">Je notities en reflectie worden privé opgeslagen bij jouw lidprofiel.</div>
    </div>
    <div class="book">
      <div class="pane">
        <h3>Bijbeltekst</h3>
        <div class="bijbeltekst" id="bijbelTekst"></div>
      </div>
      <div class="pane">
        <h3>Mijn notities</h3>
        <textarea class="notes-area" id="notesArea" placeholder="Schrijf hier je persoonlijke notities…"></textarea>
        <div class="save-row">
          <span class="hint" id="notesFeedback"></span>
          <button class="btn secondary" id="saveNotesBtn">Bewaren</button>
        </div>
      </div>
    </div>

    <div class="under">
      <div class="vragen-blok" id="vragenBlok" style="display:none;">
        <h4>Vragen voor vandaag</h4>
        <ol id="vragenLijst"></ol>
      </div>
      <div class="reflectie-blok">
        <h4>Mijn reflectie</h4>
        <textarea class="reflectie-text" id="reflectieTekst" placeholder="Wat raakte je? Wat wil je bidden of doen?"></textarea>
        <div class="save-row">
          <span class="hint" id="reflectieFeedback"></span>
          <button class="btn" id="saveReflectieBtn">Bewaren</button>
        </div>
      </div>
      <div class="navrow">
        <button class="btn secondary" id="btnBackIndex">← Terug naar index</button>
        <span class="badge" id="dagBadge"></span>
        <div>
          <button class="btn secondary" id="prevBtn">« Vorige</button>
          <button class="btn" id="nextBtn">Volgende »</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Login overlay -->
  <div class="overlay" id="loginOverlay" aria-modal="true" role="dialog">
    <div class="modal">
      <h3>Bijbeldagboek openen</h3>
      <div class="err" id="loginErr"></div>
      <label for="loginEmail">E-mailadres</label>
      <input type="email" id="loginEmail" autocomplete="username" />
      <label for="loginWw">Wachtwoord</label>
      <input type="password" id="loginWw" autocomplete="current-password" />
      <div class="row">
        <button class="btn secondary" id="loginCancel">Annuleren</button>
        <button class="btn" id="loginOk">Inloggen</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
      authDomain: "orthodoxeweg.firebaseapp.com",
      projectId: "orthodoxeweg",
      storageBucket: "orthodoxeweg.appspot.com",
      messagingSenderId: "408582263618",
      appId: "1:408582263618:web:0a20f4bf0704989d3ceedb"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let userId = sessionStorage.getItem("dagboek_userId") || null;
    let parochieId = sessionStorage.getItem("dagboek_parochieId") || null;
    let memberRef = null;
    let opdrachten = []; let index = 0;
    let openId = localStorage.getItem("dagboekOpenId") || null;

    const qs = id => document.getElementById(id);
    const esc = (s='') => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    function renderParagraphs(txt=''){ const blocks = String(txt).trim().split(/\n\s*\n/); return blocks.map(b=>`<p>${esc(b).replace(/\n/g,'<br>')}</p>`).join(''); }
    function showLogin(show){ qs("loginOverlay").style.display = show ? "flex" : "none"; if(show) qs("loginEmail").focus(); }

    async function getTemplateSnapshot(){
      const snap = await db.collection("dagboek").orderBy(firebase.firestore.FieldPath.documentId(),"asc").get().catch(()=>({empty:true,docs:[]}));
      return snap;
    }

    async function syncTemplatesToUser(){
      const coll = db.collection("parochies").doc(parochieId).collection("leden").doc(userId).collection("dagboek");
      const [tplSnap, userSnap] = await Promise.all([getTemplateSnapshot(), coll.get()]);
      const heeft = new Set(userSnap.docs.map(d=>d.id));
      const batch = db.batch(); let toWrite=0;
      tplSnap.docs.forEach(doc=>{
        if(!heeft.has(doc.id)){
          const d = doc.data()||{};
          batch.set(coll.doc(doc.id),{
            templateId:doc.id, titel:d.titel||("Dag "+doc.id), intro:d.intro||"",
            lezing:d.lezing||"", tekst:d.tekst||"", vragen:Array.isArray(d.vragen)?d.vragen:[],
            vragenAntwoorden:{}, notitiesAlgemeen:"", reflectie:"", voltooid:false,
            gestartOp: firebase.firestore.FieldValue.serverTimestamp(), voltooidOp:null, lastEdit:null
          },{merge:true});
          toWrite++;
        }
      });
      if(toWrite>0) await batch.commit();
    }

    async function ensureProgressStart(){
      const first = await db.collection("parochies").doc(parochieId).collection("leden").doc(userId)
        .collection("dagboek").orderBy(firebase.firestore.FieldPath.documentId(),"asc").limit(1).get();
      const firstId = first.empty?null:first.docs[0].id;
      if (!firstId) return;
      const m = await memberRef.get(); const data = m.exists?m.data():{};
      if (!data.dagboekCurrentId) await memberRef.set({dagboekCurrentId:firstId},{merge:true});
    }
    async function updateProgressCurrent(currentId){ if(memberRef) await memberRef.set({dagboekCurrentId: currentId},{merge:true}); }

    async function laadOpdrachten(){
      const coll = memberRef.collection("dagboek");
      const [snap, memberSnap] = await Promise.all([coll.orderBy(firebase.firestore.FieldPath.documentId(),"asc").get(), memberRef.get()]);
      opdrachten = snap.docs.map(d=>({id:d.id, ...d.data()}));
      if (!opdrachten.length){ qs("dagTitel").textContent="Geen dagboek-items."; return; }
      let targetIndex=0;
      if(openId){ const pos = opdrachten.findIndex(o=>o.id===openId); targetIndex=(pos>=0?pos:0); }
      else{ const currentId = memberSnap.exists?memberSnap.data().dagboekCurrentId:null; const pos=currentId?opdrachten.findIndex(o=>o.id===currentId):-1; targetIndex=pos>=0?pos:0; }
      index=targetIndex; toonOpdracht(index);
    }

    function toonOpdracht(i){
      const op = opdrachten[i];
      qs("dagTitel").textContent = op.titel || ("Dag "+(i+1));
      if(op.lezing){ qs("lezingChip").style.display="inline-block"; qs("lezingChip").textContent="Lezing: "+op.lezing; }
      else{ qs("lezingChip").style.display="none"; }
      if(op.intro){ qs("introWrap").style.display="block"; qs("introText").textContent=op.intro; qs("saveHint").style.display="block"; }
      else{ qs("introWrap").style.display="none"; }
      qs("bijbelTekst").innerHTML = renderParagraphs(op.tekst||"");
      qs("notesArea").value = op.notitiesAlgemeen||"";
      const vragen = Array.isArray(op.vragen)?op.vragen:[]; const vragenLijst=qs("vragenLijst"); vragenLijst.innerHTML="";
      if(vragen.length){ vragen.forEach(v=>{ const li=document.createElement("li"); li.textContent=v; vragenLijst.appendChild(li); }); qs("vragenBlok").style.display="block"; }
      else{ qs("vragenBlok").style.display="none"; }
      qs("reflectieTekst").value=op.reflectie||"";
      qs("prevBtn").disabled=(i===0); qs("nextBtn").disabled=(i===opdrachten.length-1);
      qs("dagBadge").textContent=`Dag ${i+1} van ${opdrachten.length}`;
      localStorage.setItem("dagboekOpenId", op.id); updateProgressCurrent(op.id);
    }

    qs("saveNotesBtn").onclick=async()=>{ if(!opdrachten.length) return; const op=opdrachten[index];
      const docRef=memberRef.collection("dagboek").doc(op.id);
      const val=qs("notesArea").value.trim(); await docRef.set({notitiesAlgemeen:val,lastEdit:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
      opdrachten[index].notitiesAlgemeen=val; qs("notesFeedback").textContent="Opgeslagen!"; setTimeout(()=>qs("notesFeedback").textContent="",1200);
    };

    qs("saveReflectieBtn").onclick=async()=>{ if(!opdrachten.length) return; const op=opdrachten[index];
      const docRef=memberRef.collection("dagboek").doc(op.id);
      const val=qs("reflectieTekst").value.trim(); await docRef.set({reflectie:val,lastEdit:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
      opdrachten[index].reflectie=val; qs("reflectieFeedback").textContent="Opgeslagen!"; setTimeout(()=>qs("reflectieFeedback").textContent="",1200);
    };

    qs("prevBtn").onclick=()=>{ if(index>0){ index--; toonOpdracht(index);} };
    qs("nextBtn").onclick=()=>{ if(index<opdrachten.length-1){ index++; toonOpdracht(index);} };
    qs("btnBackIndex").onclick=()=>{ window.location.href="bijbeldagboek_index.html"; };

    qs("loginCancel").onclick=()=>showLogin(false);
    qs("loginOk").onclick=doLogin;
    function onEnter(e){ if(e.key==="Enter"){ doLogin(); } }
    qs("loginEmail").addEventListener("keydown",onEnter); qs("loginWw").addEventListener("keydown",onEnter);

    function doLogin(){
      const email=(qs("loginEmail").value||"").trim().toLowerCase(); const ww=(qs("loginWw").value||"").trim();
      qs("loginErr").textContent=""; if(!email||!ww){ qs("loginErr").textContent="Vul e-mail en wachtwoord in."; return; }
      db.collection("parochies").get().then(snapshot=>{
        if(snapshot.empty){ qs("loginErr").textContent="Geen parochies gevonden."; return; }
        const lookups=[]; let ok=false,lidDoc=null,pId=null;
        snapshot.forEach(p=>{ const leden=db.collection("parochies").doc(p.id).collection("leden");
          lookups.push(leden.where("email","==",email).limit(1).get().then(s=>{ if(!s.empty){ const d=s.docs[0].data(); if((d.wachtwoord||"")===ww){ ok=true; lidDoc=s.docs[0]; pId=p.id; } } })); 
        });
        Promise.all(lookups).then(async()=>{ if(ok&&lidDoc){ userId=lidDoc.id; parochieId=pId;
          sessionStorage.setItem("dagboek_userId",userId); sessionStorage.setItem("dagboek_parochieId",parochieId); sessionStorage.setItem("dagboek_authed","1");
          showLogin(false); memberRef=db.collection("parochies").doc(parochieId).collection("leden").doc(userId);
          await syncTemplatesToUser(); await ensureProgressStart(); await laadOpdrachten();
        } else{ qs("loginErr").textContent="Geen lid gevonden of fout wachtwoord."; } });
      });
    }

    window.addEventListener("load", async()=>{ const authed=sessionStorage.getItem("dagboek_authed")==="1";
      if(!authed){ showLogin(true); } else { userId=sessionStorage.getItem("dagboek_userId"); parochieId=sessionStorage.getItem("dagboek_parochieId");
        memberRef=db.collection("parochies").doc(parochieId).collection("leden").doc(userId);
        await syncTemplatesToUser(); await ensureProgressStart(); await laadOpdrachten(); }
    });
  </script>
</body>
</html>
