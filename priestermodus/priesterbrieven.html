<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Priesterbrieven ‚Äì Priestermodus</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png" />

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #fff6e5;
      color: #4e2710;
    }
    main {
      max-width: 1000px;
      margin: 30px auto;
      padding: 0 20px 50px;
    }
    h1 {
      text-align: center;
      color: #6f4e1a;
    }
    form {
      background: #fff8eb;
      border: 2px solid #dab97a;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      margin-top: 20px;
    }
    form h2 { margin-top: 0; color: #7a5f35; }
    label { display: block; margin: 10px 0 4px; }
    input[type=text], textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #dab97a;
      border-radius: 6px;
      background: #fffdf6;
    }
    textarea { min-height: 120px; resize: vertical; }
    button {
      background: #7bb235;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 4px 4px 0 0;
    }
    button:hover { background: #5e8e29; }
    .blok {
      background: #fff;
      border: 1px solid #dab97a;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
    }
    .blok h4 { margin: 0 0 6px; color: #7a5f35; }
    .brief-lijst {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }
    .brief-kaart {
      background: #fff;
      border: 2px solid #dab97a;
      border-radius: 10px;
      padding: 10px;
      cursor: pointer;
    }
    .brief-kaart h3 { margin: 0; color: #7a5f35; }
    .brief-kaart small { color: #8f7437; }
    img.klein { max-height: 3cm; border-radius: 6px; margin: 6px 0; }
  </style>
</head>

<body>
  <!-- Header priestermodus -->
  <div id="priester-header"></div>
  <script src="https://kathy-torfs.github.io/Orthodoxeweg/priestermodus/common/layout.js" defer></script>

  <main>
    <h1>üìú Priesterbrieven</h1>
    <p style="text-align:center;">Hier kan u catechetische brieven voor volwassenen schrijven en illustreren met afbeeldingen.</p>

    <!-- Overzicht -->
    <div id="brievenOverzicht" class="brief-lijst">Laden‚Ä¶</div>

    <!-- Nieuw / bewerken -->
    <form id="briefForm">
      <h2>Nieuwe brief toevoegen / bewerken</h2>

      <label>Titel</label>
      <input type="text" id="briefTitel" required>

      <label>Inhoud</label>
      <textarea id="briefInhoud"></textarea>

      <h3>Afbeeldingen</h3>
      <div id="imgContainer"></div>
      <button type="button" onclick="voegAfbeeldingToe()">‚ûï Afbeelding toevoegen</button>

      <div style="margin-top:10px;">
        <button type="submit">üìå Opslaan</button>
        <button type="button" onclick="annuleer()">‚ùå Annuleren</button>
      </div>
    </form>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <script>
    // üî• Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBKEakRzmnPZ3DY8NUkZrZr_YtqBbNVHL4",
      authDomain: "orthodoxeweg.firebaseapp.com",
      projectId: "orthodoxeweg",
      storageBucket: "orthodoxeweg.firebasestorage.app"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const parochieId = localStorage.getItem("ingelogdeParochie") || "onbekend";
    const overzicht = document.getElementById("brievenOverzicht");
    const form = document.getElementById("briefForm");
    const imgContainer = document.getElementById("imgContainer");
    let editId = null;
    let origineel = null;

    // ‚ûï Afbeelding toevoegen
    function voegAfbeeldingToe(a={}) {
      const div = document.createElement("div");
      div.className = "blok";
      div.innerHTML = `
        <h4>Afbeelding</h4>
        <input type="file" class="imgFile" accept="image/*"><br>
        <input type="hidden" class="bestaandeUrl" value="${a.url||""}">
        <label>Bijschrift:</label>
        <textarea class="imgTekst">${(a.tekst||"").replace(/<br>/g,"\n")}</textarea>
        ${a.url ? `<img src="${a.url}" class="klein">` : ""}
      `;
      imgContainer.appendChild(div);
    }

    // üì© Opslaan
    form.addEventListener("submit", async(e)=>{
      e.preventDefault();
      const titel = form.briefTitel.value.trim();
      if(!titel) return alert("Titel verplicht!");
      const docId = titel.toLowerCase().replace(/\s+/g,"-");
      const data = {
        titel,
        inhoud: form.briefInhoud.value.trim().replace(/\n/g,"<br>"),
        afbeeldingen: [],
        aangemaaktOp: new Date()
      };

      for(let blok of imgContainer.querySelectorAll(".blok")){
        const file = blok.querySelector(".imgFile").files[0];
        const tekst = blok.querySelector(".imgTekst").value.trim().replace(/\n/g,"<br>");
        const bestaand = blok.querySelector(".bestaandeUrl").value;
        if(file){
          const pad = `priesterbrieven/${parochieId}/${docId}/${Date.now()}_${file.name}`;
          const snap = await storage.ref(pad).put(file);
          const url = await snap.ref.getDownloadURL();
          data.afbeeldingen.push({url,tekst});
        } else if(bestaand){
          data.afbeeldingen.push({url:bestaand,tekst});
        }
      }

      await db.collection("parochies").doc(parochieId).collection("priesterbrieven").doc(docId).set(data);
      form.reset(); imgContainer.innerHTML=""; editId=null; origineel=null;
      laadBrieven();
    });

    // ‚ùå Annuleren
    function annuleer(){
      if(!editId){
        form.reset(); imgContainer.innerHTML="";
      } else if(origineel){
        const d = origineel;
        form.briefTitel.value = d.titel;
        form.briefInhoud.value = (d.inhoud||"").replace(/<br>/g,"\n");
        imgContainer.innerHTML="";
        d.afbeeldingen?.forEach(a=>voegAfbeeldingToe(a));
      }
    }

    // üìö Laden
    async function laadBrieven(){
      overzicht.innerHTML = "Laden‚Ä¶";
      const snap = await db.collection("parochies").doc(parochieId).collection("priesterbrieven").get();
      overzicht.innerHTML = "";
      if(snap.empty){ overzicht.innerHTML = "<p>Geen brieven gevonden.</p>"; return; }
      snap.forEach(doc=>{
        const d = doc.data();
        const kaart = document.createElement("div");
        kaart.className = "brief-kaart";
        kaart.innerHTML = `
          <h3 onclick="bewerkBrief('${doc.id}')">${d.titel}</h3>
          <small>${(d.inhoud||"").replace(/<br>/g," ").substring(0,70)}</small>
          <div><button onclick="verwijderBrief('${doc.id}')">üóë Verwijderen</button></div>
        `;
        overzicht.appendChild(kaart);
      });
    }

    // ‚úèÔ∏è Bewerken
    async function bewerkBrief(id){
      const docRef = await db.collection("parochies").doc(parochieId).collection("priesterbrieven").doc(id).get();
      if(!docRef.exists) return;
      const d = docRef.data();
      origineel = {id,...d};
      form.briefTitel.value = d.titel;
      form.briefInhoud.value = (d.inhoud||"").replace(/<br>/g,"\n");
      imgContainer.innerHTML="";
      d.afbeeldingen?.forEach(a=>voegAfbeeldingToe(a));
      editId = id;
      window.scrollTo({top:0,behavior:"smooth"});
    }

    // üóë Verwijderen
    async function verwijderBrief(id){
      if(!confirm("Weet u zeker dat u deze brief wil verwijderen?")) return;
      await db.collection("parochies").doc(parochieId).collection("priesterbrieven").doc(id).delete();
      laadBrieven();
    }

    laadBrieven();
  </script>
</body>
</html>
