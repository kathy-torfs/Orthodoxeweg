<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tradities – Priestermodus</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png" />

  <!-- Priester layout -->
  <script defer src="common/layout.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBKEakRzmnPZ3DY8NUkZrZr_YtqBbNVHL4",
      authDomain: "orthodoxeweg.firebaseapp.com",
      projectId: "orthodoxeweg",
      storageBucket: "orthodoxeweg.appspot.com",
      messagingSenderId: "408582263618",
      appId: "1:408582263618:web:2e02833fa0d4d8903ceedb"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <style>
    :root{
      --bg:#fff6e5; --ink:#5b3a00; --brand:#7bb235; --accent:#67510C;
      --card:#ffffff; --line:#ead9b4; --muted:#8d7a57;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    main{display:flex;max-width:1200px;margin:20px auto;padding:0 14px 40px;gap:20px}

    /* Index */
    aside{flex:1;max-width:320px}
    .rowhead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .title{font-size:1.2rem;color:var(--accent);font-weight:700}
    .btn-add{background:#ddd;border:1px solid #c8bb9a;border-radius:8px;padding:8px 10px;cursor:pointer}
    .panel{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px}
    details.group{border:1px solid var(--line);border-radius:8px;margin:8px 0;background:#fff}
    details.group>summary{list-style:none;cursor:pointer;padding:8px 10px;font-weight:600;color:#31560b}
    details.group[open]>summary{background:#f3f8ea;border-bottom:1px solid var(--line);border-radius:8px 8px 0 0}
    ul.items{margin:0;padding:8px;list-style:none;display:flex;flex-direction:column;gap:6px}
    .item{border:1px solid var(--line);border-radius:8px;padding:8px 10px;background:#fff;cursor:pointer}
    .item:hover{background:#fffaf0}
    .item.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .muted{color:var(--muted);font-size:.92em}

    /* Detail */
    section#detail{flex:3}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 6px 18px rgba(0,0,0,.05)}
    h1{margin:0 0 6px;color:var(--accent)}
    .badge{display:inline-block;background:#e8f4d9;border:1px solid #cfe0ad;color:#325602;border-radius:999px;padding:4px 8px;font-size:.85em;margin-left:6px}
    .tabs{display:flex;gap:8px;margin:10px 0}
    .tabs button{flex:1;border:1px solid var(--line);border-radius:8px;padding:8px;cursor:pointer;background:#fff}
    .tabs button.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .tab-pane{display:none}
    .tab-pane.active{display:block}
    textarea{width:100%;min-height:150px;border:1px solid var(--line);border-radius:8px;padding:10px;font-family:inherit}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{background:var(--brand);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.ghost{background:#fff;color:#333;border:1px solid var(--line)}
    .info{font-size:.9em;color:var(--muted)}
  </style>
</head>
<body>

  <!-- Priester-header -->
  <div id="priester-header" data-header-src="common/header.html"></div>

  <main>
    <!-- INDEX -->
    <aside>
      <div class="rowhead">
        <div class="title">Tradities</div>
        <button class="btn-add" id="btnNew">+ Nieuwe traditie</button>
      </div>

      <div class="panel">
        <div class="muted">Algemeen</div>
        <div id="listAlgemeen"></div>
        <div class="muted" style="margin-top:10px">Mijn parochie</div>
        <ul id="listParochie" class="items"></ul>
      </div>
    </aside>

    <!-- DETAIL -->
    <section id="detail">
      <h1>Kies een traditie</h1>
      <div id="detailCard" class="card">
        <p class="info">Kies links een item. Voor categorieën (Heiligen, Kerkelijke feesten, Sacramenten) klapt het menu open en klik je het concrete item (bv. “Verkondiging” of “Heilige Demetrios”).</p>
      </div>
    </section>
  </main>

  <script>
    const parochieId = localStorage.getItem("ingelogdeParochie") || "demo";
    const listAlgemeen = document.getElementById("listAlgemeen");
    const listParochie = document.getElementById("listParochie");
    const detailCard  = document.getElementById("detailCard");

    let current = { cat:null, itemId:null, single:false, source:"algemeen", titel:null };

    const arrToText = (a)=> (Array.isArray(a)?a:[]).join("\n");
    const textToArr = (t)=> String(t||"").split("\n").map(s=>s.trim()).filter(Boolean);

    async function loadIndex(){
      // Algemeen
      const catSnap = await db.collection("tradities").get();
      listAlgemeen.innerHTML = '';
      const catIds = catSnap.docs.map(d=>d.id);

      for (const catId of catIds){
        const subSnap = await db.collection("tradities").doc(catId).collection(catId).get();
        if (!subSnap.empty){
          const det = document.createElement("details");
          det.className = "group";
          const sum = document.createElement("summary");
          sum.textContent = catId.replace(/_/g," ");
          det.appendChild(sum);

          const ul = document.createElement("ul");
          ul.className = "items";

          subSnap.docs
            .sort((a,b)=> (a.id > b.id ? 1 : -1))
            .forEach(doc=>{
              const li = document.createElement("li");
              li.className = "item";
              li.textContent = (doc.data().naam || doc.data().titel || doc.id).replace(/_/g," ");
              li.onclick = ()=> openItem({cat:catId, itemId:doc.id, single:false, source:"algemeen", titel: li.textContent, liEl: li});
              ul.appendChild(li);
            });

          det.appendChild(ul);
          listAlgemeen.appendChild(det);
        } else {
          const li = document.createElement("div");
          li.className = "item";
          li.textContent = catId.replace(/_/g," ");
          li.onclick = ()=> openItem({cat:catId, itemId:null, single:true, source:"algemeen", titel: li.textContent, liEl: li});
          listAlgemeen.appendChild(li);
        }
      }

      // Parochie
      listParochie.innerHTML = '';
      const parochieSnap = await db.collection("parochies").doc(parochieId).collection("tradities").get();

      for (const doc of parochieSnap.docs) {
        const catId = doc.id;
        const data = doc.data();

        // single traditie
        if (Object.keys(data).length > 0) {
          const li = document.createElement("li");
          li.className = "item";
          li.textContent = (data.titel || catId).replace(/_/g," ") + " (parochie)";
          li.onclick = ()=> openItem({cat:catId, itemId:null, single:true, source:"parochie", titel: li.textContent, liEl:li});
          listParochie.appendChild(li);
        }

        // subitems
        const subSnap = await db.collection("parochies").doc(parochieId).collection("tradities").doc(catId).collection(catId).get().catch(()=>null);
        if (subSnap && !subSnap.empty) {
          subSnap.docs.forEach(sub=>{
            const li = document.createElement("li");
            li.className = "item";
            li.textContent = ((sub.data().titel||sub.data().naam||sub.id)+" (parochie)").replace(/_/g," ");
            li.onclick = ()=> openItem({cat:catId, itemId:sub.id, single:false, source:"parochie", titel: li.textContent, liEl:li});
            listParochie.appendChild(li);
          });
        }
      }
    }

    async function openItem(sel){
      document.querySelectorAll(".item").forEach(el=>el.classList.remove("active"));
      sel.liEl && sel.liEl.classList.add("active");
      current = sel;

      let docRef, docSnap;
      if (sel.single){
        docRef = db.collection("parochies").doc(parochieId).collection("tradities").doc(sel.cat);
        docSnap = await docRef.get();
        if (!docSnap.exists && sel.source==="algemeen"){
          docRef = db.collection("tradities").doc(sel.cat);
          docSnap = await docRef.get();
        }
      } else {
        docRef = db.collection("parochies").doc(parochieId).collection("tradities").doc(sel.cat).collection(sel.cat).doc(sel.itemId);
        docSnap = await docRef.get();
        if (!docSnap.exists && sel.source==="algemeen"){
          docRef = db.collection("tradities").doc(sel.cat).collection(sel.cat).doc(sel.itemId);
          docSnap = await docRef.get();
        }
      }

      if (!docSnap || !docSnap.exists){
        renderEditor({
          titel: sel.titel || "(zonder titel)",
          voorbereiding: [], tijdens: [], na: [],
          note: "Geen inhoud gevonden. Je kan rechts invullen en opslaan in eigen parochie."
        });
        return;
      }

      const d = docSnap.data() || {};
      const titel = d.titel || d.naam || sel.titel || (sel.itemId || sel.cat).replace(/_/g," ");
      renderEditor({
        titel,
        voorbereiding: d.voorbereiding || [],
        tijdens: d.tijdens || [],
        na: d.na || [],
        origin: (docRef.path.startsWith("parochies/") ? "parochie" : "algemeen")
      });
    }

    function renderEditor({titel, voorbereiding, tijdens, na, origin, note}){
      const originBadge = origin ? `<span class="badge">${origin==="parochie"?"Parochieversie":"Algemene bron"}</span>` : "";
      const noteHtml = note ? `<p class="info">${note}</p>` : "";

      detailCard.innerHTML = `
        <h1>${titel}${originBadge}</h1>
        ${noteHtml}
        <div class="tabs">
          <button class="tabBtn active" data-tab="voor">Voorbereiding</button>
          <button class="tabBtn" data-tab="tijdens">Tijdens</button>
          <button class="tabBtn" data-tab="na">Na</button>
        </div>

        <div id="pane-voor" class="tab-pane active">
          <textarea id="txt-voor">${arrToText(voorbereiding)}</textarea>
        </div>
        <div id="pane-tijdens" class="tab-pane">
          <textarea id="txt-tijdens">${arrToText(tijdens)}</textarea>
        </div>
        <div id="pane-na" class="tab-pane">
          <textarea id="txt-na">${arrToText(na)}</textarea>
        </div>

        <div class="actions">
          <button class="btn" id="btnSave">Opslaan in eigen parochie</button>
          <button class="btn ghost" id="btnPrint">Print</button>
        </div>
      `;

      detailCard.querySelectorAll(".tabBtn").forEach(b=>{
        b.onclick = ()=>{
          detailCard.querySelectorAll(".tabBtn").forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          const key = b.dataset.tab;
          detailCard.querySelectorAll(".tab-pane").forEach(p=>p.classList.remove("active"));
          detailCard.querySelector("#pane-"+key).classList.add("active");
        };
      });

      detailCard.querySelector("#btnSave").onclick = saveToParochie;
      detailCard.querySelector("#btnPrint").onclick = ()=>window.print();
    }

    async function saveToParochie(){
      if (!current || !current.cat){
        alert("Geen item geselecteerd.");
        return;
      }
      const titel = document.querySelector("#detail h1").childNodes[0].nodeValue.trim();
      const voorbereiding = textToArr(document.getElementById("txt-voor").value);
      const tijdens       = textToArr(document.getElementById("txt-tijdens").value);
      const na            = textToArr(document.getElementById("txt-na").value);

      let ref;
      if (current.single){
        ref = db.collection("parochies").doc(parochieId).collection("tradities").doc(current.cat);
      } else {
        ref = db.collection("parochies").doc(parochieId).collection("tradities").doc(current.cat).collection(current.cat).doc(current.itemId);
      }

      await ref.set({ titel, voorbereiding, tijdens, na }, { merge:true });
      alert("Opgeslagen in eigen parochie.");
      await loadIndex();
    }

    document.getElementById("btnNew").onclick = async ()=>{
      const cat = prompt("Categorie? (heiligen / kerkelijke_feesten / sacramenten / zondagsliturgie)").trim();
      if (!cat) return;
      const lowCat = cat.toLowerCase().replace(/\s+/g,"_");

      let itemId = null;
      if (lowCat === "heiligen" || lowCat === "kerkelijke_feesten" || lowCat === "sacramenten"){
        const titel = prompt("Titel / naam van het item (bv. Heilige X of Verkondiging)").trim();
        if (!titel) return;
        itemId = titel.toLowerCase().replace(/\s+/g,"_");
        await db.collection("parochies").doc(parochieId).collection("tradities").doc(lowCat)
          .collection(lowCat).doc(itemId).set({ titel, voorbereiding:[], tijdens:[], na:[] });
        await loadIndex();
        openItem({cat:lowCat, itemId, single:false, source:"parochie", titel});
      } else {
        const titel = prompt("Titel (bv. Zondagsliturgie)").trim();
        if (!titel) return;
        await db.collection("parochies").doc(parochieId).collection("tradities").doc(lowCat)
          .set({ titel, voorbereiding:[], tijdens:[], na:[] }, {merge:true});
        await loadIndex();
        openItem({cat:lowCat, itemId:null, single:true, source:"parochie", titel});
      }
    };

    loadIndex();
  </script>
</body>
</html>
