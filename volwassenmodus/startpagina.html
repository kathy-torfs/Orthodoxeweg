<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Orthodoxeweg - Dagkalender (Bladerboek)</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png">

  <!-- ==== FIREBASE ==== -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script>
    // Volwassenenbescherming — blijft ingelogd tot handmatig uitloggen via header
    if (!localStorage.getItem("ingelogdeParochie") || localStorage.getItem("modus") !== "volwassene") {
      window.location.href = "https://kathy-torfs.github.io/Orthodoxeweg/index.html";
    }
    const firebaseConfig = {
      apiKey: "AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
      authDomain: "orthodoxeweg.firebaseapp.com",
      projectId: "orthodoxeweg",
      storageBucket: "orthodoxeweg.appspot.com",
      messagingSenderId: "408582263618",
      appId: "1:408582263618:web:0a20f4bf0704989d3ceedb",
      measurementId: "G-C942F2NYQV"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <style>
    /* ==== ALGEMEEN ==== */
    :root{
      --boek-bg-left:  linear-gradient(110deg, #ede4ca 90%, #fff7e2 100%);
      --boek-bg-right: linear-gradient(-110deg, #fff9e1 90%, #ede4ca 100%);
      --boek-line: #c6b187;
      --boek-edge: #ceb27d;
      --boek-shadow: #a88b5488;
      --text-main:#6f4e1a;
    }
    *{box-sizing:border-box}
    body { background:#f5e9b8; color:var(--text-main); font-family:Arial,sans-serif; margin:0; }

    /* ==== TAALKNOPPEN ==== */
    .taalkeuze { text-align:center; margin: 18px 0 8px; }
    .taalkeuze button{
      background:#eee3c6; color:#6f4e1a; border:1.5px solid #b29467; border-radius:6px;
      padding:7px 20px; font-size:1em; font-weight:bold; cursor:pointer; margin:0 6px; transition:background .2s, transform .05s;
    }
    .taalkeuze button:active{ transform: translateY(1px) }
    .taalkeuze button.selected{ background:#d3b87c; color:#3a2c17; border:2px solid #85652a; }

    /* ==== BOEK CONTAINER ==== */
    .boek-wrapper {
      width: 960px; max-width: 99vw; margin: 0 auto 32px; padding: 0 1vw;
      perspective: 2000px; /* 3D-perspectief voor flip */
    }
    .boek {
      position: relative;
      width: 940px; max-width: 100%; min-height: 590px;
      margin: 0 auto;
      border: 3px solid var(--boek-edge);
      border-radius: 24px;
      box-shadow: 0 8px 40px var(--boek-shadow);
      background: linear-gradient(90deg, #ede4ca 48%, #fff9e1 52%);
      overflow: visible;
      transform-style: preserve-3d;

      /* Flex zodat paginas niet verspringen */
      display: flex;
      align-items: stretch;
    }

    /* Pagina's */
    .pagina {
      position: relative;
      flex: 0 0 50%;
      min-height: 510px;
      padding: 44px 28px 38px 28px;
      font-size: 1.15em;
    }
    .links {
      border-right: 2px dashed var(--boek-line);
      background: var(--boek-bg-left);
      box-shadow: 2px 0 12px #d2bc908a inset;
    }
    .rechts {
      background: var(--boek-bg-right);
      box-shadow: -2px 0 12px #e5dab58a inset;
    }

    /* Hoekknoppen */
    .hoek-linksonder, .hoek-rechtsonder {
      width: 52px; height: 44px; position: absolute; bottom: 2px; z-index: 9;
      opacity: .34; cursor: pointer; transition: opacity .2s, color .2s; font-size: 2.7em; color: #9c834a;
      background: none; border: none; display: flex; align-items: flex-end; justify-content: flex-start; user-select: none; font-family: Georgia, serif;
    }
    .hoek-linksonder { left: 2px; }
    .hoek-rechtsonder { right: 2px; }
    .hoek-linksonder:hover, .hoek-rechtsonder:hover { opacity: .8; color: #caa146; }
    .hoek-btn-disabled{ opacity:.25 !important; cursor:not-allowed !important; }

    /* Typografie blokken */
    .boek h2 { font-family: Georgia, serif; font-size: 2em; margin: 0 0 10px; color: #745d35; text-align: center; letter-spacing: 2px; }
    .heilige-foto {
      width: 120px; height: 140px; object-fit: contain; display:block; margin: 0 auto 18px;
      background:#f4e8d5; border-radius:12px; box-shadow:0 1px 8px #d3be9e63; border:1.5px solid #d8caad;
    }
    .heilige-naam { font-weight:bold; color:#664b1c; text-align:center; margin-bottom:8px; font-size:1.18em; letter-spacing:1px; }
    .heilige-levensverhaal { font-size:.97em; line-height:1.36; color:#3a2c17; max-height:240px; overflow-y:auto; margin-top:10px; padding-right:5px; text-align:left; }

    .dagkalender-datum { font-family: Georgia, serif; font-size: 2em; margin-bottom: 16px; color: #85652a; text-align: left; letter-spacing: 1px; }
    .vastenregel-regel { margin: 0 0 15px; font-weight: 600; font-size: 1.11em; display:flex; align-items:center; gap:12px; }
    .vastenregel-symbool { font-size: 1.65em; margin-left:7px; vertical-align: middle; }
    .heiligenrij { margin-bottom: 15px; color: #725721; font-size: 1.08em; font-weight: 600; }
    .lezingblok { margin-bottom: 13px; color:#444; background:#f7f1de; border-radius: 8px; padding:9px 16px; box-shadow: 0 2px 7px #e1d5ae29 inset; font-size:1.04em; }
    .lezingblok:last-of-type { margin-bottom: 22px; }
    .tip-blok {
      position:absolute; left:30px; right:30px; bottom:30px; background:#f7ecd1; border-radius:10px; padding:13px 22px;
      font-size: 1.11em; color:#a78225; text-align:center; font-style: italic; box-shadow: 0 2px 10px #d8c48c22;
    }

    /* ==== BLADZIJDE-OMSLA EFFECT ==== */
    .turn-overlay{
      position: absolute;
      top: 0; left: 50%; /* start bij de boekruggengraat */
      width: 50%; height: 100%;
      transform-origin: left center;
      transform-style: preserve-3d;
      pointer-events: none;
      z-index: 8;
      perspective: 2000px;
    }
    .turn-overlay.prev{ left: 0; transform-origin: right center; }

    .leaf{
      position: absolute; inset: 0;
      background: var(--boek-bg-right);
      border-left: 2px dashed var(--boek-line);
      box-shadow: -2px 0 12px #e5dab58a inset, 0 0 20px rgba(0,0,0,.15);
      transform: rotateY(0deg);
      backface-visibility: hidden;
      overflow: hidden;
    }
    .leaf .leaf-content{ padding: 44px 28px 38px 28px; font-size: 1.08em; color:#3a2c17; }

    .leaf-back{
      position: absolute; inset: 0;
      background: var(--boek-bg-left);
      border-right: 2px dashed var(--boek-line);
      box-shadow: 2px 0 12px #d2bc908a inset, 0 0 20px rgba(0,0,0,.12);
      transform: rotateY(180deg);
      backface-visibility: hidden;
      overflow: hidden;
      display:block;
    }
    .leaf-back .leaf-content{ padding: 44px 28px 38px 28px; font-size: 1.08em; color:#3a2c17; }

    /* Animatie rustiger en synchroon */
    .turn-overlay.anim-next .leaf,
    .turn-overlay.anim-prev .leaf{
      transition: transform 1.5s cubic-bezier(.22,.61,.36,1);
    }

    /* Responsief */
    @media (max-width:1024px){
      .boek-wrapper, .boek { width: 99vw; max-width: 100vw; }
    }
    @media (max-width:900px){
      .boek { flex-direction: column; }
      .pagina{ flex: 1 1 auto; min-height: 240px; padding: 24px 7vw 32px; }
      .tip-blok{ left:12vw; right:12vw; bottom:16px; }
      .turn-overlay{ display:none; } /* animatie uit op smal voor stabiliteit */
      .hoek-linksonder, .hoek-rechtsonder{ font-size: 2.2em; }
    }
    @media (max-width:650px){
      .pagina{ font-size: .93em; padding: 10px 2vw 14px; }
      .tip-blok{ left:4vw; right:4vw; font-size: .98em; }
    }
  </style>
</head>
<body>
  <!-- Topbar + menubalk komen automatisch via layout.js -->

  <!-- ==== TAALKEUZE ==== -->
  <div class="taalkeuze">
    <button id="btn-vlaams" class="selected">🇧🇪 Vlaams</button>
    <button id="btn-engels">🇬🇧 English</button>
    <button id="btn-grieks">🇬🇷 Ελληνικά</button>
  </div>

  <!-- ==== BOEK ==== -->
  <div class="boek-wrapper">
    <div class="boek" id="boek">
      <!-- Hoekknoppen -->
      <button class="hoek-linksonder" id="vorigeDag" title="Vorige dag" aria-label="Vorige dag">&lt;</button>
      <button class="hoek-rechtsonder" id="volgendeDag" title="Volgende dag" aria-label="Volgende dag">&gt;</button>

      <!-- Linkerpagina: Heilige van de dag -->
      <div class="pagina links">
        <div id="heilige-inhoud">
          <div style="color:#a6a5a4;text-align:center;">Bezig met laden...</div>
        </div>
      </div>

      <!-- Rechterpagina: Dagkalender -->
      <div class="pagina rechts" id="boek-rechts">
        <div id="dagkalender-inhoud">
          <div style="color:#a6a5a4;text-align:center;">Bezig met laden...</div>
        </div>
        <div class="tip-blok" id="dagkalender-tip"></div>
      </div>
    </div>
  </div>

  <script>
    /* ==== Hulpfuncties ==== */
    const pad = n => (n<10 ? '0'+n : ''+n);

    function formatIds(datum){
      const jaar = datum.getFullYear();
      const maand = pad(datum.getMonth()+1);
      const dag = pad(datum.getDate());
      return {
        kalenderId: `${jaar}${maand}${dag}`,
        feestdag: `${dag}-${maand}`,
        datumTekst: `${dag}-${maand}-${jaar}`
      };
    }

    /* Bouw HTML voor een datum (links & rechts) — gebruikt Firestore */
    async function bouwHTMLVoorDatum(datum, taal){
      const { kalenderId, feestdag, datumTekst } = formatIds(datum);

      // Default placeholders
      let leftHTML = `
        <div style="color:#a6a5a4;text-align:center;">Bezig met laden...</div>`;
      let rightMain = `<div style="color:#a6a5a4;text-align:center;">Bezig met laden...</div>`;
      let rightTip = ``;

      // Promise: heilige (links)
      const pHeilige = db.collection("heiligen").where("feestdag","==",feestdag).get()
      .then(snapshot=>{
        if (snapshot.empty){
          leftHTML = `
            <div style="color:#b8b7b4;text-align:center;margin-top:22px;font-size:1.15em">
              <br>Geen heilige van de dag gevonden.<br>
              <div style="font-size:4em;text-align:center;margin-top:16px;">✝️</div>
            </div>`;
          return;
        }
        const docs = snapshot.docs;
        const data = docs[Math.floor(Math.random()*docs.length)].data();
        const fotoUrl = data.icoon || data.foto_url || "https://upload.wikimedia.org/wikipedia/commons/1/12/Orthodox_Cross.svg";
        let naam="", levensverhaal="";
        if (taal==="engels"){ naam=data.naam_en||""; levensverhaal=data.levensverhaal_en||""; }
        else if (taal==="grieks"){ naam=data.naam_el||""; levensverhaal=data.levensverhaal_el||""; }
        else { naam=data.naam_nl||data.naam||data.id||"Heilige"; levensverhaal=data.levensverhaal_nl||data.levensverhaal_volwassenen||""; }
        if (!naam) naam = "Nog geen vertaling beschikbaar.";
        if (!levensverhaal) levensverhaal = "Nog geen vertaling beschikbaar.";
        leftHTML = `
          <div class="heilige-naam">${naam}</div>
          <img src="${fotoUrl}" class="heilige-foto" alt="Heilige icoon">
          <div class="heilige-levensverhaal">${levensverhaal}</div>`;
      }).catch(()=>{});

      // Promise: kalender (rechts)
      const pKal = db.collection("kalender2025").doc(kalenderId).get()
      .then(doc=>{
        if (!doc.exists){
          rightMain = `<div style="color:#b8b7b4;text-align:center;margin-top:60px;font-size:1.1em">Geen kalenderinfo gevonden.</div>`;
          rightTip = "";
          return;
        }
        const data = doc.data();

        let vasten = data[`Vastenregel NL`] || "";
        if (taal==="engels") vasten = data[`Vastenregel EN`] || (vasten ? "Fasting Free" : "");
        if (taal==="grieks") vasten = data[`Vastenregel EL`] || (vasten ? "Νηστεία ελεύθερη" : "");
        if (!vasten){
          if (taal==="vlaams") vasten="Vastenvrij";
          else if (taal==="engels") vasten="Fasting Free";
          else vasten="Νηστεία ελεύθερη";
        }
        const vastenSymb = data["Symbool"] || "";
        let vastenRegelBlok = `<span>${vasten}</span>`;
        if (vastenSymb) vastenRegelBlok += `<span class="vastenregel-symbool">${vastenSymb}</span>`;

        let heiligen = "";
        if (taal==="vlaams") heiligen = data[`Heiligen NL`] || "";
        else if (taal==="engels") heiligen = data[`Heiligen EN`] || "No translation available yet.";
        else heiligen = data[`Heiligen EL`] || "Δεν υπάρχει ακόμη μετάφραση.";

        let epistel="", evangelie="";
        if (taal==="vlaams"){
          epistel = data[`Epistel Ref NL`] || "Nog geen vertaling beschikbaar.";
          evangelie = data[`Evangelie Ref NL`] || "Nog geen vertaling beschikbaar.";
        } else if (taal==="engels"){
          epistel = data[`Epistel Ref EN`] || "No translation available yet.";
          evangelie = data[`Evangelie Ref EN`] || "No translation available yet.";
        } else {
          epistel = data[`Epistel Ref EL`] || "Δεν υπάρχει ακόμη μετάφραση.";
          evangelie = data[`Evangelie Ref EL`] || "Δεν υπάρχει ακόμη μετάφραση.";
        }

        let epistelLabel="Apostellezing", evangelieLabel="Evangelielezing";
        if (taal==="engels"){ epistelLabel="Epistle Reading"; evangelieLabel="Gospel Reading"; }
        if (taal==="grieks"){ epistelLabel="Απόστολος"; evangelieLabel="Ευαγγέλιο"; }

        let tip="";
        if (taal==="vlaams") tip = data[`Tip/Wens NL`] || "";
        else if (taal==="engels") tip = data[`Tip/Wens EN`] || "";
        else tip = data[`Tip/Wens EL`] || "";

        rightMain = `
          <div class="dagkalender-datum">${datumTekst}</div>
          <div class="vastenregel-regel">${vastenRegelBlok}</div>
          <div class="heiligenrij">${heiligen}</div>
          <div class="lezingblok"><b>${epistelLabel}:</b> ${epistel}</div>
          <div class="lezingblok"><b>${evangelieLabel}:</b> ${evangelie}</div>
        `;
        rightTip = tip || "";
      }).catch(()=>{});

      await Promise.all([pHeilige, pKal]);
      return { leftHTML, rightMain, rightTip };
    }

    /* ==== STATE ==== */
    let huidigeTaal = "vlaams";
    let actieveDatum = new Date();
    const boek = document.getElementById('boek');
    const btnPrev = document.getElementById('vorigeDag');
    const btnNext = document.getElementById('volgendeDag');
    let isTurning = false; // anti-dubbelklik

    // Taal click
    document.getElementById("btn-vlaams").onclick = () => { huidigeTaal = "vlaams"; setTaal(); };
    document.getElementById("btn-engels").onclick = () => { huidigeTaal = "engels"; setTaal(); };
    document.getElementById("btn-grieks").onclick = () => { huidigeTaal = "grieks"; setTaal(); };
    function setTaal(){
      document.querySelectorAll('.taalkeuze button').forEach(b=>b.classList.remove('selected'));
      document.getElementById("btn-vlaams").classList.toggle('selected', huidigeTaal === "vlaams");
      document.getElementById("btn-engels").classList.toggle('selected', huidigeTaal === "engels");
      document.getElementById("btn-grieks").classList.toggle('selected', huidigeTaal === "grieks");
      laadAlles(); // taalwissel zonder animatie
    }

    // Initieel laden
    laadAlles();

    async function laadAlles(){
      const { leftHTML, rightMain, rightTip } = await bouwHTMLVoorDatum(actieveDatum, huidigeTaal);
      document.getElementById('heilige-inhoud').innerHTML = leftHTML;
      document.getElementById('dagkalender-inhoud').innerHTML = rightMain;
      document.getElementById('dagkalender-tip').innerHTML = rightTip;
    }

    // Navigatie knoppen
    btnNext.addEventListener('click', async () => {
      if (isTurning) return;
      const target = new Date(actieveDatum); target.setDate(target.getDate()+1);
      await pageTurn('next', target);
    });
    btnPrev.addEventListener('click', async () => {
      if (isTurning) return;
      const target = new Date(actieveDatum); target.setDate(target.getDate()-1);
      await pageTurn('prev', target);
    });

    function setButtons(disabled){
      [btnPrev, btnNext].forEach(b=>{
        b.disabled = disabled;
        b.classList.toggle('hoek-btn-disabled', disabled);
      });
    }

    // Omslaan met preloading van nieuwe content in de draaiende pagina
    async function pageTurn(direction, targetDate){
      isTurning = true;
      setButtons(true);

      // 1) Bouw ALVAST de HTML voor de doel-datum
      const nextHTML = await bouwHTMLVoorDatum(targetDate, huidigeTaal);

      // 2) Maak overlay-blad
      const overlay = document.createElement('div');
      overlay.className = 'turn-overlay ' + (direction==='next' ? 'anim-next' : 'prev anim-prev');

      const leaf = document.createElement('div');
      leaf.className = 'leaf';

      // Voorzijde = huidige rechterpagina (zodat tekst zichtbaar blijft aan begin)
      const front = document.createElement('div');
      front.className = 'leaf-content';
      const rightNow = document.getElementById('boek-rechts');
      const cloneNow = rightNow.cloneNode(true);
      const frontWrap = document.createElement('div');
      frontWrap.innerHTML = cloneNow.innerHTML;
      front.appendChild(frontWrap);

      // Achterzijde = NIEUWE rechterpagina (zodat tijdens draaien de nieuwe tekst al te zien is)
      const back = document.createElement('div');
      back.className = 'leaf-back';
      const backContent = document.createElement('div');
      backContent.className = 'leaf-content';
      backContent.innerHTML = `
        <div id="leaf-next-right">
          <div>${nextHTML.rightMain}</div>
          <div class="tip-blok">${nextHTML.rightTip||''}</div>
        </div>`;
      back.appendChild(backContent);

      leaf.appendChild(front);
      leaf.appendChild(back);
      overlay.appendChild(leaf);

      if (direction==='prev'){
        overlay.classList.add('prev');
        leaf.style.transformOrigin = 'right center';
      } else {
        leaf.style.transformOrigin = 'left center';
      }

      boek.appendChild(overlay);

      // 3) Start animatie (rustig 1.5s)
      void leaf.offsetWidth; // reflow
      requestAnimationFrame(()=>{
        leaf.style.transform = (direction==='next') ? 'rotateY(-180deg)' : 'rotateY(180deg)';
      });

      // 4) Als animatie klaar is, zet de "echte" pagina's om
      leaf.addEventListener('transitionend', () => {
        overlay.remove();
        actieveDatum = targetDate;

        // vervang échte inhoud
        document.getElementById('heilige-inhoud').innerHTML = nextHTML.leftHTML;
        document.getElementById('dagkalender-inhoud').innerHTML = nextHTML.rightMain;
        document.getElementById('dagkalender-tip').innerHTML = nextHTML.rightTip || '';

        // kleine cooldown
        setTimeout(()=>{ isTurning = false; setButtons(false); }, 60);
      }, { once:true });
    }
  </script>

  <!-- Gedeelde topbar/menubalk/uitloggen -->
  <script src="https://kathy-torfs.github.io/Orthodoxeweg/volwassenmodus/common/layout.js"></script>
</body>
</html>
