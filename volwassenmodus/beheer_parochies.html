<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Beheer Parochie-aanvragen - Orthodoxeweg</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #faf0c8;
      color: #5b4320;
    }
    h1 {
      text-align: center;
      margin: 30px 0;
      color: #5d4c2f;
    }
    .lijst {
      max-width: 900px;
      margin: 0 auto;
      background: #fffef9;
      border-radius: 18px;
      box-shadow: 0 6px 32px #d7cbb142;
      padding: 30px 24px;
    }
    .aanvraag {
      border-bottom: 1.5px dashed #e5d3ad;
      padding: 18px 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-start;
      justify-content: space-between;
    }
    .aanvraag:last-child { border-bottom: none; }
    .info { flex: 1 1 300px; }
    .naam { font-weight: bold; font-size: 1.18em; }
    .veld { color: #725721; margin: 2px 0; }
    .actie {
      display: flex; flex-direction: column;
      gap: 8px; min-width: 180px;
    }
    input[type="text"] {
      padding: 6px; border: 1px solid #bbb; border-radius: 6px;
      font-size: 1em;
    }
    button {
      padding: 8px 15px;
      border-radius: 7px;
      border: none;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    .goedkeur { background: #45a745; color: #fff; }
    .goedkeur:hover { background: #358135; }
    .weiger { background: #b42c25; color: #fff; }
    .weiger:hover { background: #a32018; }
    .geen { color: #aa8e4a; text-align: center; font-size: 1.15em; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script>
    // Alleen beheerders
    const modus = localStorage.getItem("modus");
    const rol = JSON.parse(localStorage.getItem("rol") || "[]");
    const email = localStorage.getItem("email");
    const superUser = "kathy.torfs@telenet.be";

    if ((modus !== "volwassene" || !rol.includes("beheerder")) && email !== superUser) {
      window.location.href = "https://kathy-torfs.github.io/Orthodoxeweg/index.html";
    }
  </script>
</head>
<body>
  <!-- Header -->
  <div id="volwassen-header"></div>
  <script src="common/layout.js" defer></script>

  <h1>Parochie-aanvragen</h1>
  <div class="lijst" id="aanvragenContainer">
    <div class="geen">Bezig met laden...</div>
  </div>

  <script>
    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBKEakRzmnPZ3DY8NUkZrZr_YtqBbNVHL4",
      authDomain: "orthodoxeweg.firebaseapp.com",
      projectId: "orthodoxeweg",
      storageBucket: "orthodoxeweg.appspot.com",
      messagingSenderId: "408582263618",
      appId: "1:408582263618:web:0a20f4bf0704989d3ceedb"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Aanvragen laden
    async function laadAanvragen() {
      const container = document.getElementById("aanvragenContainer");
      container.innerHTML = '<div class="geen">Bezig met laden...</div>';

      const snap = await db.collection("parochie_aanvragen").where("status", "==", "nieuw").get();

      if (snap.empty) {
        container.innerHTML = '<div class="geen">Geen nieuwe aanvragen.</div>';
        return;
      }

      let html = "";
      snap.forEach(doc => {
        const d = doc.data();
        html += `
          <div class="aanvraag" data-id="${doc.id}">
            <div class="info">
              <div class="naam">${d.naam}</div>
              <div class="veld">Priesters: ${d.priesters.join(", ")}</div>
              <div class="veld">Email: ${d.email}</div>
              <div class="veld">Website: ${d.website || "-"}</div>
            </div>
            <div class="actie">
              <input type="text" id="ww-${doc.id}" placeholder="Wachtwoord" />
              <button class="goedkeur" onclick="goedkeurAanvraag('${doc.id}')">Goedkeuren</button>
              <button class="weiger" onclick="weigerAanvraag('${doc.id}')">Weigeren</button>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }
    laadAanvragen();

    // Goedkeuren
    async function goedkeurAanvraag(id) {
      const ref = db.collection("parochie_aanvragen").doc(id);
      const snap = await ref.get();
      if (!snap.exists) return alert("Aanvraag niet gevonden!");
      const data = snap.data();

      const wachtwoord = document.getElementById("ww-" + id).value.trim();
      if (!wachtwoord) return alert("Geef een wachtwoord in!");

      // Verplaats naar parochies
      await db.collection("parochies").doc(id).set({
        naam: data.naam,
        adres: data.adres,
        postcode: data.postcode,
        gemeente: data.gemeente,
        provincie: data.provincie,
        email: data.email,
        telefoon: data.telefoon,
        website: data.website,
        priesters: data.priesters,
        wachtwoord: wachtwoord,
        status: "actief",
        datumAangemaakt: data.datumAangemaakt || firebase.firestore.FieldValue.serverTimestamp()
      });

      // Mail sturen
      try {
        await fetch("https://us-central1-orthodoxeweg.cloudfunctions.net/sendTestMail", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            to: data.email,
            subject: "Orthodoxeweg – Uw parochie is goedgekeurd",
            text: `Beste Vader(s),

Uw parochie-aanvraag werd goedgekeurd en toegevoegd aan Orthodoxeweg.
U kan nu inloggen via de priesterknop op de website.

🌍 Inloggegevens:
Parochie: ${data.naam}
Login: ${data.email}
Wachtwoord: ${wachtwoord}

🇳🇱 Nederlands
Uw parochie is met succes geregistreerd. U kan vanaf nu gebruik maken van alle priesterfuncties op Orthodoxeweg.  
Moge de Heer uw werk in de wijngaard van Christus zegenen.

🇫🇷 Français
Votre paroisse a été enregistrée avec succès. Vous pouvez désormais utiliser toutes les fonctions sacerdotales d’Orthodoxeweg.  
Que le Seigneur bénisse votre travail dans la vigne du Christ.

🇬🇧 English
Your parish has been successfully registered. You can now access all priest functions on Orthodoxeweg.  
May the Lord bless your work in the vineyard of Christ.

🇷🇺 Русский
Ваша приходская заявка успешно одобрена. Теперь вы можете пользоваться всеми функциями священника на Orthodoxeweg.  
Да благословит Господь ваш труд на винограднике Христовом.

🇬🇷 Ελληνικά
Η ενορία σας εγκρίθηκε με επιτυχία. Μπορείτε τώρα να χρησιμοποιείτε όλες τις λειτουργίες ιερέων στο Orthodoxeweg.  
Είθε ο Κύριος να ευλογεί το έργο σας στον αμπελώνα του Χριστού.

🇸🇦 العربية
تمت الموافقة على طلب رعيتكم بنجاح. يمكنكم الآن استخدام جميع وظائف الكاهن في موقع Orthodoxeweg.  
ليبارك الرب عملكم في كرم المسيح.

---

Met broederlijke groet,  
Orthodoxeweg`
          })
        });
        alert("Parochie goedgekeurd en mail verzonden!");
      } catch (e) {
        alert("Parochie goedgekeurd, maar mail NIET verzonden!");
      }

      // Verwijder uit aanvragen
      await ref.delete();
      laadAanvragen();
    }

    // Weigeren
    async function weigerAanvraag(id) {
      await db.collection("parochie_aanvragen").doc(id).delete();
      alert("Parochie-aanvraag geweigerd en verwijderd.");
      laadAanvragen();
    }

    window.goedkeurAanvraag = goedkeurAanvraag;
    window.weigerAanvraag = weigerAanvraag;
  </script>
</body>
</html>
