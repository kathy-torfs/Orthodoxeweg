<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Beheer Parochie-aanvragen - Orthodoxeweg</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #faf0c8;
      color: #5b4320;
    }
    h1 {
      text-align: center;
      margin: 30px 0;
      color: #5d4c2f;
    }
    .lijst {
      max-width: 900px;
      margin: 0 auto;
      background: #fffef9;
      border-radius: 18px;
      box-shadow: 0 6px 32px #d7cbb142;
      padding: 30px 24px;
    }
    .aanvraag {
      border-bottom: 1.5px dashed #e5d3ad;
      padding: 18px 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-start;
      justify-content: space-between;
    }
    .aanvraag:last-child { border-bottom: none; }
    .info { flex: 1 1 300px; }
    .naam { font-weight: bold; font-size: 1.18em; }
    .veld { color: #725721; margin: 2px 0; }
    .actie {
      display: flex; flex-direction: column;
      gap: 8px; min-width: 180px;
    }
    input[type="text"] {
      padding: 6px; border: 1px solid #bbb; border-radius: 6px;
      font-size: 1em;
    }
    button {
      padding: 8px 15px;
      border-radius: 7px;
      border: none;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    .goedkeur { background: #45a745; color: #fff; }
    .goedkeur:hover { background: #358135; }
    .weiger { background: #b42c25; color: #fff; }
    .weiger:hover { background: #a32018; }
    .geen { color: #aa8e4a; text-align: center; font-size: 1.15em; }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script>
    // Alleen beheerders
    const modus = localStorage.getItem("modus");
    const rol = JSON.parse(localStorage.getItem("rol") || "[]");
    const email = localStorage.getItem("email");
    const superUser = "kathy.torfs@telenet.be";

    if ((modus !== "volwassene" || !rol.includes("beheerder")) && email !== superUser) {
      window.location.href = "https://kathy-torfs.github.io/Orthodoxeweg/index.html";
    }
  </script>
</head>
<body>
  <!-- Header -->
  <div id="volwassen-header"></div>
  <script src="common/layout.js" defer></script>

  <h1>Parochie-aanvragen</h1>
  <div class="lijst" id="aanvragenContainer">
    <div class="geen">Bezig met laden...</div>
  </div>

  <script>
    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBKEakRzmnPZ3DY8NUkZrZr_YtqBbNVHL4",
      authDomain: "orthodoxeweg.firebaseapp.com",
      projectId: "orthodoxeweg",
      storageBucket: "orthodoxeweg.appspot.com",
      messagingSenderId: "408582263618",
      appId: "1:408582263618:web:0a20f4bf0704989d3ceedb"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Aanvragen laden
    async function laadAanvragen() {
      const container = document.getElementById("aanvragenContainer");
      container.innerHTML = '<div class="geen">Bezig met laden...</div>';

      const snap = await db.collection("parochie_aanvragen").where("status", "==", "nieuw").get();

      if (snap.empty) {
        container.innerHTML = '<div class="geen">Geen nieuwe aanvragen.</div>';
        return;
      }

      let html = "";
      snap.forEach(doc => {
        const d = doc.data();
        html += `
          <div class="aanvraag" data-id="${doc.id}">
            <div class="info">
              <div class="naam">${d.naam}</div>
              <div class="veld">Priesters: ${d.priesters.join(", ")}</div>
              <div class="veld">Email: ${d.email}</div>
              <div class="veld">Website: ${d.website || "-"}</div>
            </div>
            <div class="actie">
              <input type="text" id="ww-${doc.id}" placeholder="Wachtwoord" />
              <button class="goedkeur" onclick="goedkeurAanvraag('${doc.id}')">Goedkeuren</button>
              <button class="weiger" onclick="weigerAanvraag('${doc.id}')">Weigeren</button>
            </div>
          </div>
        `;
      });
      container.innerHTML = html;
    }
    laadAanvragen();

    // Goedkeuren
    async function goedkeurAanvraag(id) {
      const ref = db.collection("parochie_aanvragen").doc(id);
      const snap = await ref.get();
      if (!snap.exists) return alert("Aanvraag niet gevonden!");
      const data = snap.data();

      const wachtwoord = document.getElementById("ww-" + id).value.trim();
      if (!wachtwoord) return alert("Geef een wachtwoord in!");

      // Verplaats naar parochies
      await db.collection("parochies").doc(id).set({
        naam: data.naam,
        adres: data.adres,
        postcode: data.postcode,
        gemeente: data.gemeente,
        provincie: data.provincie,
        email: data.email,
        telefoon: data.telefoon,
        website: data.website,
        priesters: data.priesters,
        wachtwoord: wachtwoord,
        status: "actief",
        datumAangemaakt: data.datumAangemaakt || firebase.firestore.FieldValue.serverTimestamp()
      });

      // Mail sturen
      try {
        await fetch("https://us-central1-orthodoxeweg.cloudfunctions.net/sendTestMail", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            to: data.email,
            subject: "Orthodoxeweg â€“ Uw parochie is goedgekeurd",
            text: `Beste Vader(s),

Uw parochie-aanvraag werd goedgekeurd en toegevoegd aan Orthodoxeweg.
U kan nu inloggen via de priesterknop op de website.

ğŸŒ Inloggegevens:
Parochie: ${data.naam}
Login: ${data.email}
Wachtwoord: ${wachtwoord}

ğŸ‡³ğŸ‡± Nederlands
Uw parochie is met succes geregistreerd. U kan vanaf nu gebruik maken van alle priesterfuncties op Orthodoxeweg.  
Moge de Heer uw werk in de wijngaard van Christus zegenen.

ğŸ‡«ğŸ‡· FranÃ§ais
Votre paroisse a Ã©tÃ© enregistrÃ©e avec succÃ¨s. Vous pouvez dÃ©sormais utiliser toutes les fonctions sacerdotales dâ€™Orthodoxeweg.  
Que le Seigneur bÃ©nisse votre travail dans la vigne du Christ.

ğŸ‡¬ğŸ‡§ English
Your parish has been successfully registered. You can now access all priest functions on Orthodoxeweg.  
May the Lord bless your work in the vineyard of Christ.

ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹
Ğ’Ğ°ÑˆĞ° Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´ÑĞºĞ°Ñ Ğ·Ğ°ÑĞ²ĞºĞ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ°. Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ğ²ÑĞµĞ¼Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸ÑĞ¼Ğ¸ ÑĞ²ÑÑ‰ĞµĞ½Ğ½Ğ¸ĞºĞ° Ğ½Ğ° Orthodoxeweg.  
Ğ”Ğ° Ğ±Ğ»Ğ°Ğ³Ğ¾ÑĞ»Ğ¾Ğ²Ğ¸Ñ‚ Ğ“Ğ¾ÑĞ¿Ğ¾Ğ´ÑŒ Ğ²Ğ°Ñˆ Ñ‚Ñ€ÑƒĞ´ Ğ½Ğ° Ğ²Ğ¸Ğ½Ğ¾Ğ³Ñ€Ğ°Ğ´Ğ½Ğ¸ĞºĞµ Ğ¥Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²Ğ¾Ğ¼.

ğŸ‡¬ğŸ‡· Î•Î»Î»Î·Î½Î¹ÎºÎ¬
Î— ÎµÎ½Î¿ÏÎ¯Î± ÏƒÎ±Ï‚ ÎµÎ³ÎºÏÎ¯Î¸Î·ÎºÎµ Î¼Îµ ÎµÏ€Î¹Ï„Ï…Ï‡Î¯Î±. ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Ï„ÏÏÎ± Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Îµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯ÎµÏ‚ Î¹ÎµÏÎ­Ï‰Î½ ÏƒÏ„Î¿ Orthodoxeweg.  
Î•Î¯Î¸Îµ Î¿ ÎšÏÏÎ¹Î¿Ï‚ Î½Î± ÎµÏ…Î»Î¿Î³ÎµÎ¯ Ï„Î¿ Î­ÏÎ³Î¿ ÏƒÎ±Ï‚ ÏƒÏ„Î¿Î½ Î±Î¼Ï€ÎµÎ»ÏÎ½Î± Ï„Î¿Ï… Î§ÏÎ¹ÏƒÏ„Î¿Ï.

ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø±Ø¹ÙŠØªÙƒÙ… Ø¨Ù†Ø¬Ø§Ø­. ÙŠÙ…ÙƒÙ†ÙƒÙ… Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙƒØ§Ù‡Ù† ÙÙŠ Ù…ÙˆÙ‚Ø¹ Orthodoxeweg.  
Ù„ÙŠØ¨Ø§Ø±Ùƒ Ø§Ù„Ø±Ø¨ Ø¹Ù…Ù„ÙƒÙ… ÙÙŠ ÙƒØ±Ù… Ø§Ù„Ù…Ø³ÙŠØ­.

---

Met broederlijke groet,  
Orthodoxeweg`
          })
        });
        alert("Parochie goedgekeurd en mail verzonden!");
      } catch (e) {
        alert("Parochie goedgekeurd, maar mail NIET verzonden!");
      }

      // Verwijder uit aanvragen
      await ref.delete();
      laadAanvragen();
    }

    // Weigeren
    async function weigerAanvraag(id) {
      await db.collection("parochie_aanvragen").doc(id).delete();
      alert("Parochie-aanvraag geweigerd en verwijderd.");
      laadAanvragen();
    }

    window.goedkeurAanvraag = goedkeurAanvraag;
    window.weigerAanvraag = weigerAanvraag;
  </script>
</body>
</html>
