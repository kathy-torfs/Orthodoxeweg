<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bijbeldagboek ‚Äì Volwassenmodus</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png">
  <style>
    body { background:#f5e9b8; font-family: Arial, sans-serif; color:#6f4e1a; margin:0; padding:0; }
    /* Topbar */
    .topbar{background:#6f4e1a;color:#fff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;font-weight:bold}
    #welkom-tekst{font-size:1.07em;font-weight:normal}
    .uitlog-link{background:#8722aa;color:#fff;border:none;padding:8px 18px;border-radius:18px;cursor:pointer;font-weight:bold;margin-left:12px}

    /* Menu */
    nav.menu{background:#7a5f35;padding:10px 15px;display:flex;flex-wrap:wrap;gap:12px;justify-content:center;align-items:center}
    nav.menu a,nav.menu button{color:#f5e9b8;text-decoration:none;font-weight:600;font-size:16px;padding:6px 12px;border-radius:8px;transition:.3s;background:none;border:none;display:flex;align-items:center;cursor:pointer}
    nav.menu a:hover,nav.menu button:hover{background:#5d4726;text-decoration:underline}
    .menu-avatar{padding:0!important;background:none!important;border:none!important;margin-left:2px}
    .menu-avatar img{height:2.1em;width:2.1em;border-radius:50%;border:2.2px solid #dab97a;background:#fff8eb;transition:.2s;box-shadow:0 1px 4px rgba(160,140,80,.13)}
    .menu-avatar img:hover{border:2.2px solid #a06a19;box-shadow:0 2px 8px rgba(160,140,80,.23)}
    @media (max-width:650px){nav.menu{gap:8px}nav.menu a,nav.menu button{font-size:1em;padding:6px 6px}.menu-avatar img{height:1.75em;width:1.75em}}

    /* Login */
    .loginblok{max-width:370px;margin:70px auto 30px;background:#fffef6;padding:2.5em 2.2em 1.4em;border-radius:13px;box-shadow:0 2px 14px #dccfa725}
    .loginblok label{font-weight:bold;color:#8a641f}
    .loginblok input{width:98%;font-size:1em;margin-bottom:1.2em;border-radius:8px;border:1.2px solid #dbc592;padding:9px;background:#faf5e1}
    .loginblok button{background:#7a5f35;color:#fff;padding:10px 28px;border-radius:10px;border:none;font-size:1.1em;cursor:pointer}
    .loginblok button:hover{background:#b09765}
    #loginFeedback{color:#b9311e;margin-top:7px;min-height:26px}

    /* Pagina container */
    .boek-container{display:none;max-width:1000px;margin:30px auto 40px;background:#fffef9;border-radius:18px;box-shadow:0 8px 48px #ccb65b25;padding:18px 18px 26px;position:relative}
    h1{text-align:center;color:#7a5f35;font-size:2em;margin:0.3em 0 0.6em}

    /* Intro boven het boek */
    .intro-top{max-width:940px;margin:0 auto 16px}
    .intro-top blockquote{background:#fffbe7;border-left:4px solid #decaa1;border-radius:10px;padding:12px 14px;margin:0;color:#6f4e1a;font-style:italic}

    /* Boek lay-out (twee kolommen) */
    .boek-flex{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;align-items:start;max-width:940px;margin:0 auto}
    @media (max-width:900px){.boek-flex{grid-template-columns:1fr;gap:12px}}

    .pane{background:linear-gradient(110deg,#ede4ca 90%,#fff7e2 100%);border:2px solid #ceb27d;border-radius:16px;padding:16px;box-shadow:0 6px 24px #a88b5425}
    .pane.right{background:linear-gradient(-110deg,#fff9e1 90%,#ede4ca 100%)}

    .hoofdstuk-kop{font-weight:bold;color:#7a5f35;font-size:1.12em;margin:0 0 6px}
    .subtle{color:#936d2b;margin:0 0 10px}

    /* Bijbeltekst (genummerd) */
    .lezing-tekst{background:#fffef9;border:1.3px solid #e6d49f;border-radius:12px;padding:12px}
    .lezing-tekst .ln{display:flex;gap:8px;align-items:flex-start;margin:6px 0}
    .lezing-tekst .nr{min-width:2.2em;color:#9a7a33;font-weight:bold;text-align:right}
    .lezing-tekst .tx{white-space:pre-wrap}

    /* Notities naast tekst */
    .notities-box label{display:block;font-weight:bold;color:#6a4f1f;margin-bottom:6px}
    .notities-box textarea{width:100%;min-height:420px;border:1.2px solid #dbc592;border-radius:10px;background:#faf5e1;padding:10px;resize:vertical}

    /* Onder het boek: vragen & reflectie */
    .onderdelen{max-width:940px;margin:18px auto 0;display:flex;flex-direction:column;gap:16px}
    .vragen-blok{background:#f3ece1;border:1.2px solid #dfc789;border-radius:12px;padding:14px 16px}
    .vragen-blok .vraag{background:#fffef9;border:1.2px solid #e6d49f;border-radius:12px;padding:10px 12px;margin:8px 0}
    .vragen-blok .vraag label{display:block;font-weight:bold;color:#6a4f1f;margin-bottom:6px}
    .vragen-blok .vraag textarea{width:100%;min-height:72px;border:1.2px solid #dbc592;border-radius:8px;background:#faf5e1;padding:8px}

    .reflectieblok{background:#fffdf8;border:1.2px solid #e6d49f;border-radius:12px;padding:14px 16px}
    .reflectieblok label{display:block;font-weight:bold;color:#6a4f1f;margin-bottom:6px}
    .reflectieblok textarea{width:100%;min-height:100px;border:1.2px solid #dbc592;border-radius:8px;background:#faf5e1;padding:8px}

    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .actions button{background:#7a5f35;color:#fff;padding:9px 16px;border-radius:10px;border:none;cursor:pointer}
    .actions button:disabled{opacity:.7;background:#ccb58d}
    .opslaan-feedback{color:#a68415}
    .boeknr{text-align:center;font-size:.97em;color:#b29444;margin-top:8px}
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div id="welkom-tekst"></div>
    <button class="uitlog-link" id="uitlogKnop">üö™ Uitloggen</button>
  </div>

  <!-- Menu -->
  <nav class="menu">
    <a href="https://kathy-torfs.github.io/Orthodoxeweg/volwassenmodus/startpagina.html" title="Home">üè†</a>
    <a href="https://kathy-torfs.github.io/Orthodoxeweg/volwassenmodus/parochie.html">üõê Mijn parochie</a>
    <a href="https://kathy-torfs.github.io/Orthodoxeweg/volwassenmodus/catechese/catechese.html">üìñ Catechese</a>
    <a href="https://kathy-torfs.github.io/Orthodoxeweg/volwassenmodus/gebeden/gebeden.html">üôè Gebeden</a>
    <a href="https://kathy-torfs.github.io/Orthodoxeweg/volwassenmodus/gebeden/geloofsbelijdenis.html">‚úù Geloofsbelijdenis</a>
    <a href="https://kathy-torfs.github.io/Orthodoxeweg/volwassenmodus/psalmen/psalmen.html">üìú Psalmen</a>
    <a href="https://kathy-torfs.github.io/Orthodoxeweg/volwassenmodus/heiligen.html">üëº Heiligen</a>
    <a href="https://kathy-torfs.github.io/Orthodoxeweg/volwassenmodus/bijbeldagboek.html">üìî Bijbeldagboek</a>
    <a href="https://kathy-torfs.github.io/Orthodoxeweg/volwassenmodus/verjaardagskalender.html">üéÇ Verjaardagskalender</a>
    <a href="https://kathy-torfs.github.io/Orthodoxeweg/volwassenmodus/profiel.html" class="menu-avatar" title="Mijn profiel">
      <img id="menu-avatar-img" src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" alt="Mijn profiel">
    </a>
  </nav>

  <!-- Login -->
  <div class="loginblok" id="loginblok">
    <form id="dagboekLoginForm">
      <label for="dagboekEmail">E-mailadres</label><br>
      <input type="email" id="dagboekEmail" required autocomplete="username"><br>
      <label for="dagboekWachtwoord">Wachtwoord</label><br>
      <input type="password" id="dagboekWachtwoord" required autocomplete="current-password"><br>
      <button type="submit">Dagboek openen</button>
      <div id="loginFeedback"></div>
    </form>
  </div>

  <!-- Dagboek -->
  <div class="boek-container" id="boekContainer">
    <h1>üìñ Mijn bijbeldagboek</h1>

    <!-- Intro boven het boek -->
    <div class="intro-top">
      <blockquote id="introQuoteTop"></blockquote>
    </div>

    <!-- Boek (links tekst, rechts notities) -->
    <div class="boek-flex">
      <div class="pane">
        <div class="hoofdstuk-kop" id="hoofdstukTitel">Titel</div>
        <div class="subtle" id="lezingKop"></div>
        <div class="lezing-tekst" id="lezingTekstNumeriek"></div>
      </div>
      <div class="pane right">
        <div class="notities-box">
          <label for="notitiesAlgemeen">Notities</label>
          <textarea id="notitiesAlgemeen" placeholder="Schrijf hier je notities naast de tekst‚Ä¶"></textarea>
        </div>
      </div>
    </div>

    <!-- Onder het boek: vragen & reflectie -->
    <div class="onderdelen">
      <div class="vragen-blok" id="vragenBlok" style="display:none">
        <div class="hoofdstuk-kop">Vragen voor vandaag</div>
        <div id="vragenLijst"></div>
      </div>

      <div class="reflectieblok">
        <label for="reflectieTekst">Mijn reflectie</label>
        <textarea id="reflectieTekst" maxlength="1000" placeholder="Wat raakte je? Wat neem je mee?"></textarea>
        <div class="actions">
          <button id="saveBtn" type="button">Alles bewaren</button>
          <button id="vorigeBtn" type="button">&laquo; Vorige</button>
          <button id="volgendeBtn" type="button">Volgende &raquo;</button>
          <span class="opslaan-feedback" id="opslaanFeedback"></span>
        </div>
        <div class="boeknr" id="boeknr"></div>
      </div>
    </div>
  </div>

  <script>
    // Begroeting / avatar
    const welkomTekst = document.getElementById("welkom-tekst");
    const loginNaam = localStorage.getItem("loginKeuze") || "gebruiker";
    const parochieMooieNaam = localStorage.getItem("ingelogdeParochieNaam") || localStorage.getItem("ingelogdeParochie") || "(onbekend)";
    welkomTekst.textContent = `Welkom, ${loginNaam}! U bent ingelogd in de ${parochieMooieNaam}.`;
    const avatarImg = document.getElementById("menu-avatar-img");
    const opgeslagenAvatar = localStorage.getItem("avatarURL");
    if (opgeslagenAvatar) avatarImg.src = opgeslagenAvatar;
    document.getElementById("uitlogKnop").onclick = ()=>{ localStorage.clear(); window.location.href="https://kathy-torfs.github.io/Orthodoxeweg/index.html"; };

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
      authDomain: "orthodoxeweg.firebaseapp.com",
      projectId: "orthodoxeweg",
      storageBucket: "orthodoxeweg.appspot.com",
      messagingSenderId: "408582263618",
      appId: "1:408582263618:web:0a20f4bf0704989d3ceedb"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // State
    let userId=null, parochieId=null, memberRef=null;
    let opdrachten=[]; let index=0;

    // Helpers
    const esc = (s='') => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                                   .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    const splitRegels = (t='') => String(t).replace(/\r\n/g,'\n').split('\n').map(r=>r.trim()).filter(Boolean);

    function vraagItem(i, vraag, antwoord){
      const wrap = document.createElement('div'); wrap.className='vraag';
      const id = `vraag_${i}`;
      wrap.innerHTML = `<label for="${id}">${esc(vraag)}</label>
                        <textarea id="${id}" data-index="${i}" placeholder="Antwoord..."></textarea>`;
      if (antwoord) wrap.querySelector('textarea').value = antwoord;
      return wrap;
    }

    async function getTemplateSnapshot(){
      const primary = await db.collection("vlaamseOrthodoxeBijbelstudie")
        .orderBy(firebase.firestore.FieldPath.documentId(),"asc").get().catch(()=>({empty:true,docs:[]}));
      if (!primary.empty) return primary;
      const fallback = await db.collection("vlaamseOrthodoxeBijbelstudie_Genesis")
        .orderBy(firebase.firestore.FieldPath.documentId(),"asc").get().catch(()=>({empty:true,docs:[]}));
      return fallback;
    }

    async function syncTemplatesToUser(){
      if (!parochieId || !userId) return;
      const userDagColl = db.collection("parochies").doc(parochieId).collection("leden").doc(userId).collection("dagboek");
      const [tplSnap, userSnap] = await Promise.all([getTemplateSnapshot(), userDagColl.get()]);
      const heeft = new Set(userSnap.docs.map(d=>d.id));
      const batch = db.batch(); let toWrite=0;
      tplSnap.docs.forEach(doc=>{
        if(!heeft.has(doc.id)){
          const d = doc.data()||{};
          batch.set(userDagColl.doc(doc.id),{
            templateId:doc.id,
            titel:d.titel||d.titelNL||("Dag "+doc.id),
            intro:d.intro||d.inleiding||"",
            lezing:d.lezing||d.lezen||"",
            tekst:d.tekst||"",
            vragen:Array.isArray(d.vragen)?d.vragen:[],
            vragenAntwoorden:{},
            notitiesAlgemeen:"",
            reflectie:"",
            voltooid:false,
            gestartOp: firebase.firestore.FieldValue.serverTimestamp(),
            voltooidOp:null,
            lastEdit:null
          },{merge:true});
          toWrite++;
        }
      });
      if (toWrite>0) await batch.commit();
    }

    async function getEersteDagId(){
      const snap = await db.collection("parochies").doc(parochieId).collection("leden").doc(userId)
        .collection("dagboek").orderBy(firebase.firestore.FieldPath.documentId(),"asc").limit(1).get();
      return snap.empty ? null : snap.docs[0].id;
    }
    async function ensureProgressStart(){
      if(!memberRef) return;
      const m = await memberRef.get(); const data = m.exists?m.data():{};
      if (data && data.dagboekCurrentId) return;
      const firstId = await getEersteDagId();
      if (firstId) await memberRef.set({dagboekCurrentId:firstId},{merge:true});
    }
    async function updateProgressCurrent(id){
      if(!memberRef) return; await memberRef.set({dagboekCurrentId:id},{merge:true});
    }

    async function laadOpdrachten(){
      const userDagColl = db.collection("parochies").doc(parochieId).collection("leden").doc(userId).collection("dagboek");
      const [snap, memberSnap] = await Promise.all([
        userDagColl.orderBy(firebase.firestore.FieldPath.documentId(),"asc").get(),
        memberRef.get()
      ]);
      opdrachten = snap.docs.map(d=>({id:d.id, ...d.data()}));
      if(!opdrachten.length){
        document.getElementById("hoofdstukTitel").textContent="Nog geen dagboek-items.";
        return;
      }
      const currentId = (memberSnap.exists && memberSnap.data().dagboekCurrentId) ? memberSnap.data().dagboekCurrentId : null;
      const pos = currentId ? opdrachten.findIndex(o=>o.id===currentId) : -1;
      index = pos>=0 ? pos : 0;
      toonOpdracht(index);
    }

    function renderLezing(tekst){
      const cont = document.getElementById("lezingTekstNumeriek");
      cont.innerHTML = "";
      splitRegels(tekst).forEach((r,i)=>{
        const el=document.createElement('div');
        el.className='ln';
        el.innerHTML=`<div class="nr">${i+1}</div><div class="tx">${esc(r)}</div>`;
        cont.appendChild(el);
      });
    }

    function renderVragen(vragenArr, antwoordenMap){
      const blok = document.getElementById("vragenBlok");
      const lijst = document.getElementById("vragenLijst");
      lijst.innerHTML = "";
      if(!Array.isArray(vragenArr) || !vragenArr.length){ blok.style.display="none"; return; }
      vragenArr.forEach((v,i)=> lijst.appendChild( vraagItem(i,v, antwoordenMap && antwoordenMap[i] ? antwoordenMap[i] : "") ));
      blok.style.display="block";
    }

    function toonOpdracht(i){
      const op = opdrachten[i];
      document.getElementById("hoofdstukTitel").textContent = op.titel || ("Dag "+(i+1));
      document.getElementById("lezingKop").textContent = op.lezing ? `Lezing: ${op.lezing}` : "";
      document.getElementById("introQuoteTop").textContent = op.intro || "";
      renderLezing(op.tekst || "");
      renderVragen(op.vragen || [], op.vragenAntwoorden || {});
      document.getElementById("notitiesAlgemeen").value = op.notitiesAlgemeen || "";
      document.getElementById("reflectieTekst").value = op.reflectie || "";
      document.getElementById("boeknr").textContent = `Dag ${i+1} van ${opdrachten.length}`;
      document.getElementById("vorigeBtn").disabled = (i===0);
      document.getElementById("volgendeBtn").disabled = (i===opdrachten.length-1);
      document.getElementById("opslaanFeedback").textContent="";
    }

    async function saveAlles(){
      if(!opdrachten.length) return;
      const opId = opdrachten[index].id;
      const docRef = db.collection("parochies").doc(parochieId).collection("leden").doc(userId).collection("dagboek").doc(opId);

      const antwoorden = {};
      document.querySelectorAll('#vragenLijst textarea[data-index]').forEach(t=>{
        const k=t.getAttribute('data-index'); antwoorden[k]=(t.value||"").trim();
      });

      const payload = {
        vragenAntwoorden: antwoorden,
        notitiesAlgemeen: (document.getElementById("notitiesAlgemeen").value||"").trim(),
        reflectie: (document.getElementById("reflectieTekst").value||"").trim(),
        lastEdit: firebase.firestore.FieldValue.serverTimestamp()
      };
      await docRef.set(payload,{merge:true});
      Object.assign(opdrachten[index], payload);
      const fb = document.getElementById("opslaanFeedback");
      fb.textContent="Opgeslagen!";
      setTimeout(()=>fb.textContent="",1300);
    }

    document.getElementById("saveBtn").onclick = saveAlles;
    document.getElementById("vorigeBtn").onclick = async ()=>{ if(index>0){ index--; await updateProgressCurrent(opdrachten[index].id); toonOpdracht(index);} };
    document.getElementById("volgendeBtn").onclick = async ()=>{ if(index<opdrachten.length-1){ index++; await updateProgressCurrent(opdrachten[index].id); toonOpdracht(index);} };

    // Login
    document.getElementById("dagboekLoginForm").onsubmit = function(e){
      e.preventDefault();
      document.getElementById("loginFeedback").textContent="";
      const email=(document.getElementById("dagboekEmail").value||"").trim().toLowerCase();
      const wachtwoord=(document.getElementById("dagboekWachtwoord").value||"").trim();

      db.collection("parochies").get().then(snapshot=>{
        if(snapshot.empty){ document.getElementById("loginFeedback").textContent="Geen parochies gevonden."; return; }
        const lookups=[]; let ok=false, lidDoc=null, pId=null;
        snapshot.forEach(p=>{
          const leden=db.collection("parochies").doc(p.id).collection("leden");
          lookups.push( leden.where("email","==",email).limit(1).get().then(s=>{
            if(!s.empty){ const d=s.docs[0].data(); if((d.wachtwoord||"")===wachtwoord){ ok=true; lidDoc=s.docs[0]; pId=p.id; } }
          }));
        });
        Promise.all(lookups).then(async ()=>{
          if(ok && lidDoc){
            userId=lidDoc.id; parochieId=pId;
            memberRef=db.collection("parochies").doc(parochieId).collection("leden").doc(userId);
            await syncTemplatesToUser();
            await ensureProgressStart();
            document.getElementById("loginblok").style.display="none";
            document.getElementById("boekContainer").style.display="block";
            laadOpdrachten();
          }else{
            document.getElementById("loginFeedback").textContent="Geen lid gevonden met dit e-mailadres of fout wachtwoord.";
          }
        });
      });
    };
  </script>
</body>
</html>
