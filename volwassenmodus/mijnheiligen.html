<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üìñ Mijn Heiligen ‚Äì Orthodoxeweg</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png">

  <style>
    body {
      margin:0; font-family:Arial,sans-serif;
      background:#f5e9b8; color:#6f4e1a;
    }
    main { max-width:1000px; margin:30px auto; padding:0 20px; }

    h1 { text-align:center; color:#4e2710; margin-bottom:20px; }

    .heilige-kaart {
      background:#fffef9; border:2px solid #dab97a;
      border-radius:10px; padding:10px; margin-bottom:8px;
    }
    .heilige-kaart label { font-weight:bold; }

    form {
      background:#fff8eb; border:2px dashed #dab97a;
      border-radius:12px; padding:16px; margin-bottom:20px;
    }
    label { display:block; margin:10px 0 4px; font-weight:bold; }
    input, textarea {
      width:100%; padding:8px; border:1px solid #dab97a; border-radius:6px;
      background:#fffdf6; font-family:inherit;
    }
    textarea { min-height:120px; }
    .btn { background:#7bb235; color:#fff; border:none; border-radius:8px; padding:8px 16px; font-weight:bold; cursor:pointer; }
    .btn:hover { background:#5e8e29; }

    h2 { margin-top:40px; color:#4e2710; }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script defer src="common/layout.js"></script>
</head>
<body>
  <div id="volwassen-header" data-header-src="common/header.html"></div>

  <main>
    <h1>üìñ Mijn Heiligen</h1>

    <!-- Nieuwe heilige -->
    <form id="nieuweHeiligeForm">
      <h2>Nieuwe heilige toevoegen</h2>
      <label>Titel</label>
      <input type="text" id="titel" required>
      <label>Icoon-URL</label>
      <input type="text" id="icoonurl" placeholder="https://...">
      <label>Verhaal</label>
      <textarea id="verhaal" required></textarea>
      <button type="submit" class="btn">Opslaan</button>
    </form>

    <!-- Standaardheiligen -->
    <h2>üìú Standaardheiligen</h2>
    <div id="standaardLijst"></div>

    <!-- Heiligen in parochie -->
    <h2>üìö Mijn parochieheiligen</h2>
    <div id="parochieLijst"></div>
  </main>

  <script>
    // Firebase init
    const firebaseConfig = {
      apiKey: "AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
      authDomain: "orthodoxeweg.firebaseapp.com",
      projectId: "orthodoxeweg"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();

    const parochieId = localStorage.getItem("ingelogdeParochie");

    const standaardDiv=document.getElementById("standaardLijst");
    const parochieDiv=document.getElementById("parochieLijst");
    const form=document.getElementById("nieuweHeiligeForm");

    // Nieuwe heilige opslaan
    form.addEventListener("submit", async e=>{
      e.preventDefault();
      const titel=document.getElementById("titel").value.trim();
      const icoonurl=document.getElementById("icoonurl").value.trim();
      const verhaal=document.getElementById("verhaal").value.trim();
      if(!titel||!verhaal) return alert("Titel en verhaal zijn verplicht!");

      await db.collection("parochies").doc(parochieId).collection("heiligen")
        .doc(titel).set({titel, icoonurl, verhaal, zichtbaar:true, datum:new Date()});
      form.reset();
      laadParochieHeiligen();
    });

    // Standaardheiligen laden
    async function laadStandaardHeiligen(){
      standaardDiv.innerHTML="Laden‚Ä¶";
      const snap=await db.collection("heiligen_kinderen").get();

      // eerst ophalen welke parochieheiligen al bestaan
      const parochieSnap = await db.collection("parochies").doc(parochieId).collection("heiligen").get();
      const parochieIds = parochieSnap.docs.map(d=>d.id);

      standaardDiv.innerHTML="";
      snap.forEach(doc=>{
        const naam=doc.id;
        const verhaal=doc.data().verhaal||"";
        const alAanwezig=parochieIds.includes(naam);

        const div=document.createElement("div");
        div.className="heilige-kaart";
        div.innerHTML=`
          <label>
            <input type="checkbox" onchange="toggleHeilige('${naam}','${verhaal.replace(/'/g,"&#39;")}',this.checked)" ${alAanwezig?"checked":""}>
            ${naam}
          </label>
        `;
        standaardDiv.appendChild(div);
      });
    }

    // Checkbox handler
    async function toggleHeilige(naam, verhaal, checked){
      const ref=db.collection("parochies").doc(parochieId).collection("heiligen").doc(naam);
      if(checked){
        const snap=await ref.get();
        if(!snap.exists){
          await ref.set({titel:naam, icoonurl:"", verhaal:verhaal, zichtbaar:true, datum:new Date()});
        } else {
          await ref.update({zichtbaar:true});
        }
      }else{
        await ref.update({zichtbaar:false});
      }
      laadParochieHeiligen();
    }

    // Parochieheiligen laden
    async function laadParochieHeiligen(){
      parochieDiv.innerHTML="Laden‚Ä¶";
      const snap=await db.collection("parochies").doc(parochieId).collection("heiligen").get();
      parochieDiv.innerHTML="";
      if(snap.empty){parochieDiv.innerHTML="<p>Geen heiligen in parochie.</p>"; return;}
      snap.forEach(doc=>{
        const d=doc.data();
        const div=document.createElement("div");
        div.className="heilige-kaart";
        div.innerHTML=`
          <h3>${d.icoonurl?`<img src="${d.icoonurl}" style="height:24px;vertical-align:middle"> `:""}${d.titel}</h3>
          <p>${(d.verhaal||"").substring(0,150)}...</p>
          <small>${d.zichtbaar?"‚úÖ zichtbaar":"‚ùå verborgen"}</small>
        `;
        parochieDiv.appendChild(div);
      });
    }

    laadStandaardHeiligen();
    laadParochieHeiligen();
  </script>
</body>
</html>
