<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Catecheselessen ‚Äì Orthodoxeweg</title>
  <link rel="icon" href="images/kruis.png">
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#f5e9b8; color:#6f4e1a; }
    .container { max-width:1000px; margin:30px auto; padding:0 20px; }
    h1 { text-align:center; color:#4e2710; margin-bottom:20px; }
    form { background:#fff8eb; border:2px solid #dab97a; border-radius:12px;
      padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.12); margin-bottom:30px }
    form h2 { margin-top:0; color:#7a5f35 }
    label { display:block; margin:10px 0 4px }
    input[type=text], select, textarea {
      width:100%; padding:8px; border:1px solid #dab97a; border-radius:6px;
      background:#fffdf6; font-family:inherit
    }
    textarea { min-height:80px; resize:vertical }
    button {
      background:#7bb235; color:#fff; border:none; padding:8px 14px;
      border-radius:8px; cursor:pointer; font-weight:bold; margin-top:8px
    }
    button:hover { background:#5e8e29 }
    .blok { background:#fff; border:1px solid #dab97a; border-radius:8px;
      padding:10px; margin-top:10px }
    .blok h4 { margin:0 0 6px; color:#7a5f35 }
    .les-lijst { display:flex; flex-direction:column; gap:14px }
    .les-kaart { background:#fff; border:2px solid #dab97a; border-radius:10px;
      padding:14px; box-shadow:0 2px 6px rgba(0,0,0,0.1) }
    .les-kaart h3 { margin:0; color:#7a5f35; cursor:pointer }
    .les-kaart small { color:#8f7437 }
    .les-kaart img { max-height:6cm; border-radius:6px; margin:6px 0; }
    .les-kaart .acties { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap }
    .groepkeuze { text-align:center; margin-bottom:20px; }
    .groepkeuze button { margin:0 6px; }
  </style>
</head>
<body>
  <!-- Header -->
  <div id="volwassen-header" data-header-src="common/header.html"></div>
  <script src="common/layout.js" defer></script>

  <div class="container">
    <h1 id="paginaTitel">üìñ Catecheselessen</h1>

    <!-- Groepkeuze -->
    <div class="groepkeuze">
      <button onclick="setGroep('kleuters')">üë∂ Kleuters</button>
      <button onclick="setGroep('lagere')">üìö Lagere school</button>
    </div>

    <!-- Formulier -->
    <form id="lesForm">
      <h2>Nieuwe les toevoegen / bewerken</h2>
      <label for="lesTitel">Titel</label>
      <input type="text" id="lesTitel" required>

      <label for="lesInhoud">Lesinhoud (algemeen)</label>
      <textarea id="lesInhoud"></textarea>

      <!-- Vertelplaten -->
      <h3>Vertelplaten</h3>
      <div id="platenContainer"></div>
      <button type="button" onclick="voegPlaatToe()">‚ûï Vertelplaat toevoegen</button>

      <!-- Quizvragen -->
      <h3>Quizvragen</h3>
      <div id="quizContainer"></div>
      <button type="button" onclick="voegVraagToe()">‚ûï Vraag toevoegen</button>

      <button type="submit">üìå Opslaan</button>
    </form>

    <!-- Index van lessen -->
    <div id="lessenOverzicht" class="les-lijst">Laden‚Ä¶</div>
  </div>

  <!-- Firebase SDK's -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <script>
    // Firebase init
    if (!firebase.apps.length) {
      firebase.initializeApp({
        apiKey:"AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
        authDomain:"orthodoxeweg.firebaseapp.com",
        projectId:"orthodoxeweg",
        storageBucket:"orthodoxeweg.appspot.com"
      });
    }
    const db = firebase.firestore();
    const storage = firebase.storage();

    const parochieId = sessionStorage.getItem("dagboek_parochieId");
    const overzicht = document.getElementById("lessenOverzicht");
    const form = document.getElementById("lesForm");
    const platenContainer = document.getElementById("platenContainer");
    const quizContainer = document.getElementById("quizContainer");

    let groep = "kleuters"; // standaard
    let editId = null;

    function setGroep(g) {
      groep = g;
      document.querySelectorAll(".groepkeuze button").forEach(b=>b.style.background="");
      event.target.style.background="#5e8e29";
      laadLessen();
    }

    function slugify(t) {
      return t.toLowerCase().trim().replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"");
    }

    // ‚ûï Vertelplaat
    function voegPlaatToe(p = {}) {
      const idx = platenContainer.children.length+1;
      const div = document.createElement("div");
      div.className="blok";
      div.innerHTML=`
        <h4>Vertelplaat ${idx}</h4>
        <input type="file" class="plaatFile" accept="image/*"><br>
        ${p.url?`<img src="${p.url}" style="max-width:100%">`:""}
        <textarea class="plaatTekst" placeholder="Tekst bij deze plaat...">${p.tekst||""}</textarea>
        <button type="button" onclick="this.parentNode.remove()">üóë Verwijder plaat</button>
      `;
      platenContainer.appendChild(div);
    }

    // ‚ûï Quizvraag
    function voegVraagToe(q = {}) {
      const idx = quizContainer.children.length+1;
      const div = document.createElement("div");
      div.className="blok";
      div.innerHTML=`
        <h4>Vraag ${idx}</h4>
        <label>Vraag:</label>
        <input type="text" class="vraag" value="${q.vraag||""}">
        <label>Antwoorden:</label>
        ${[0,1,2,3].map(i=>`<input type="text" class="antw" value="${q.antwoorden?q.antwoorden[i]||"":""}"><br>`).join("")}
        <label>Correct antwoord (1-4):</label>
        <input type="number" min="1" max="4" class="correct" value="${(q.correct||0)+1}">
        <button type="button" onclick="this.parentNode.remove()">üóë Verwijder vraag</button>
      `;
      quizContainer.appendChild(div);
    }

    // Opslaan
    form.addEventListener("submit", async e=>{
      e.preventDefault();
      if(!parochieId) return alert("Geen parochie gevonden.");

      const titel=document.getElementById("lesTitel").value.trim();
      const inhoud=document.getElementById("lesInhoud").value.trim();
      if(!titel) return alert("Titel ontbreekt.");

      const docId = slugify(titel+"-"+groep);
      const data={ titel, groep, inhoud, platen:[], vragen:[], aangemaaktOp:new Date(), zichtbaar:true };

      // Platen
      for(let blok of platenContainer.querySelectorAll(".blok")){
        const file=blok.querySelector(".plaatFile").files[0];
        const tekst=blok.querySelector(".plaatTekst").value.trim();
        if(file){
          const pad="catecheselessen/"+Date.now()+"_"+file.name;
          const snap=await storage.ref(pad).put(file,{contentType:file.type});
          const url=await snap.ref.getDownloadURL();
          data.platen.push({url,tekst});
        } else {
          const img=blok.querySelector("img");
          if(img) data.platen.push({url:img.src,tekst});
          else if(tekst) data.platen.push({url:"",tekst});
        }
      }

      // Vragen
      for(let blok of quizContainer.querySelectorAll(".blok")){
        const vraag=blok.querySelector(".vraag").value.trim();
        const antwoorden=[...blok.querySelectorAll(".antw")].map(i=>i.value.trim());
        const correct=parseInt(blok.querySelector(".correct").value)-1;
        if(vraag && antwoorden.filter(a=>a).length===4){
          data.vragen.push({vraag,antwoorden,correct});
        }
      }

      await db.collection("parochies").doc(parochieId)
        .collection("catecheselessen").doc(docId).set(data);

      form.reset(); platenContainer.innerHTML=""; quizContainer.innerHTML=""; editId=null;
      laadLessen();
    });

    // Lessen laden
    async function laadLessen() {
      overzicht.innerHTML="Laden‚Ä¶";
      const snap=await db.collection("parochies").doc(parochieId)
        .collection("catecheselessen").where("groep","==",groep)
        .orderBy("aangemaaktOp","desc").get();
      overzicht.innerHTML="";
      if(snap.empty){ overzicht.innerHTML="<p>Geen lessen.</p>"; return; }
      snap.forEach(doc=>{
        const d=doc.data();
        const kaart=document.createElement("div");
        kaart.className="les-kaart";
        kaart.innerHTML=`
          <h3 onclick="bewerkLes('${doc.id}')">${d.titel}</h3>
          <small>${d.groep} ‚Äì ${d.aangemaaktOp?.toDate().toLocaleString()}</small><br>
          <b>Status:</b> ${d.zichtbaar?"‚úÖ zichtbaar":"üö´ verborgen"}<br>
          <p>${d.inhoud}</p>
          ${(d.platen||[]).map(p=>`<div><img src="${p.url}"><p>${p.tekst}</p></div>`).join("")}
          ${d.vragen?.length?`<p><em>Quizvragen: ${d.vragen.length}</em></p>`:""}
          <div class="acties">
            <button onclick="toggleZichtbaarheid('${doc.id}',${d.zichtbaar})">${d.zichtbaar?"üö´ Verbergen":"üëÅÔ∏è Tonen"}</button>
            <button onclick="bewerkLes('${doc.id}')">‚úèÔ∏è Bewerken</button>
            <button onclick="verwijderLes('${doc.id}')">üóë Verwijderen</button>
            <button onclick='printLes(${JSON.stringify(d)})'>üìÑ Printen</button>
          </div>
        `;
        overzicht.appendChild(kaart);
      });
    }

    // Printfunctie
    function printLes(d){
      const w=window.open("","_blank");
      w.document.write("<html><head><title>"+d.titel+"</title></head><body>");
      w.document.write("<h1>"+d.titel+"</h1>");
      if(d.inhoud) w.document.write("<p>"+d.inhoud+"</p>");
      (d.platen||[]).forEach(p=>{
        if(p.url) w.document.write('<img src="'+p.url+'" style="max-width:100%;margin:10px 0"><br>');
        if(p.tekst) w.document.write("<p>"+p.tekst+"</p>");
      });
      w.document.write("</body></html>");
      w.document.close(); w.print();
    }

    // Bewerken
    async function bewerkLes(id){
      const docRef=await db.collection("parochies").doc(parochieId).collection("catecheselessen").doc(id).get();
      if(!docRef.exists) return;
      const d=docRef.data();
      document.getElementById("lesTitel").value=d.titel;
      document.getElementById("lesInhoud").value=d.inhoud||"";
      platenContainer.innerHTML=""; quizContainer.innerHTML="";
      (d.platen||[]).forEach(p=>voegPlaatToe(p));
      (d.vragen||[]).forEach(q=>voegVraagToe(q));
      editId=id;
      window.scrollTo({top:0,behavior:"smooth"});
    }

    async function toggleZichtbaarheid(id,huidig){
      await db.collection("parochies").doc(parochieId).collection("catecheselessen").doc(id).update({zichtbaar:!huidig});
      laadLessen();
    }

    async function verwijderLes(id){
      if(!confirm("Verwijderen?")) return;
      await db.collection("parochies").doc(parochieId).collection("catecheselessen").doc(id).delete();
      laadLessen();
    }

    laadLessen();
  </script>
</body>
</html>
