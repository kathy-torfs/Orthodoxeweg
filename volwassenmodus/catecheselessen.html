<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Catecheselessen ‚Äì Orthodoxeweg</title>
  <link rel="icon" href="https://www.orthodoxeweg.be/images/kruis.png">
  <style>
    body{margin:0;font-family:Arial,sans-serif;background:#f5e9b8;color:#6f4e1a}
    .container{max-width:1000px;margin:30px auto;padding:0 20px}
    h1{text-align:center;color:#4e2710;margin-bottom:30px}
    form{background:#fff8eb;border:2px solid #dab97a;border-radius:12px;
      padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.12);margin-bottom:30px}
    form h2{margin-top:0;color:#7a5f35}
    label{display:block;margin:10px 0 4px}
    input[type=text], textarea, select{
      width:100%;padding:8px;border:1px solid #dab97a;border-radius:6px;
      background:#fffdf6;font-family:inherit
    }
    textarea{min-height:100px;resize:vertical}
    .form-row{margin-top:12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    button{background:#7bb235;color:#fff;border:none;padding:8px 16px;
      border-radius:8px;cursor:pointer;font-weight:bold}
    button:hover{background:#5e8e29}
    .quiz-vraag,.plaat-blok{background:#fff;border:1px solid #dab97a;border-radius:8px;padding:10px;margin-top:10px}
    .quiz-vraag h4,.plaat-blok h4{margin:0 0 6px;color:#7a5f35}
    .les-lijst{display:flex;flex-direction:column;gap:14px}
    .les-kaart{background:#fff;border:2px solid #dab97a;border-radius:10px;
      padding:14px;box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:left}
    .les-kaart h3{margin:0;color:#7a5f35}
    .les-kaart small{color:#8f7437}
    .les-kaart .acties{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .les-kaart button{padding:6px 10px;font-size:0.9em}
  </style>
</head>
<body>
  <!-- ==== HEADER ==== -->
  <div id="volwassen-header" data-header-src="https://www.orthodoxeweg.be/volwassenmodus/common/header.html"></div>

  <div class="container">
    <h1 id="paginaTitel">üìñ Catecheselessen</h1>

    <form id="nieuweLesForm">
      <h2>Nieuwe les toevoegen</h2>
      <label for="lesTitel">Titel</label>
      <input type="text" id="lesTitel" required>

      <label for="lesDoelgroep">Doelgroep</label>
      <select id="lesDoelgroep" required>
        <option value="kleuters">üë∂ Kleuters</option>
        <option value="lagere school">üìò Lagere school</option>
      </select>

      <label for="lesInhoud">Lesinhoud</label>
      <textarea id="lesInhoud" placeholder="Schrijf hier je verhaal of uitleg..."></textarea>

      <!-- Platen -->
      <h3>Vertelplaten</h3>
      <div id="platenContainer"></div>
      <button type="button" onclick="voegPlaatToe()">‚ûï Plaat toevoegen</button>

      <!-- Quiz -->
      <h3>Quizvragen</h3>
      <div id="quizContainer"></div>
      <button type="button" onclick="voegVraagToe()">‚ûï Vraag toevoegen</button>

      <div class="form-row">
        <label><input type="checkbox" id="lesZichtbaar"> Zichtbaar voor klasje</label>
        <button type="submit">üìå Opslaan</button>
      </div>
    </form>

    <div id="lessenOverzicht" class="les-lijst">Laden‚Ä¶</div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
      authDomain: "orthodoxeweg.firebaseapp.com",
      projectId: "orthodoxeweg",
      storageBucket: "orthodoxeweg.appspot.com",
      messagingSenderId: "408582263618",
      appId: "1:408582263618:web:0a20f4bf0704989d3ceedb"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const parochieId = sessionStorage.getItem("dagboek_parochieId");
    const titel = document.getElementById("paginaTitel");

    let lessenRef = null;
    if (parochieId) {
      titel.textContent = "üìñ Catecheselessen van de parochie " + parochieId;
      lessenRef = db.collection("parochies").doc(parochieId).collection("catecheselessen");
    } else {
      titel.textContent = "üìñ Catecheselessen (geen parochie gevonden)";
    }

    const form = document.getElementById("nieuweLesForm");
    const overzicht = document.getElementById("lessenOverzicht");
    const quizContainer = document.getElementById("quizContainer");
    const platenContainer = document.getElementById("platenContainer");

    function voegPlaatToe(){
      const idx=platenContainer.children.length+1;
      const div=document.createElement("div");
      div.className="plaat-blok";
      div.innerHTML=`
        <h4>Plaat ${idx}</h4>
        <label>Afbeelding:</label>
        <input type="file" class="plaatFile" accept="image/*"><br>
        <label>Tekst:</label>
        <textarea class="plaatTekst"></textarea>
      `;
      platenContainer.appendChild(div);
    }

    function voegVraagToe(){
      const idx=quizContainer.children.length+1;
      const div=document.createElement("div");
      div.className="quiz-vraag";
      div.innerHTML=`
        <h4>Vraag ${idx}</h4>
        <label>Vraag:</label>
        <input type="text" class="vraag">
        <label>Antwoorden (4 stuks):</label>
        <input type="text" class="antw"><br>
        <input type="text" class="antw"><br>
        <input type="text" class="antw"><br>
        <input type="text" class="antw"><br>
        <label>Correct antwoord (1-4):</label>
        <input type="number" min="1" max="4" class="correct" value="1">
      `;
      quizContainer.appendChild(div);
    }

    // Opslaan
    form.addEventListener("submit", async(e)=>{
      e.preventDefault();
      if (!lessenRef) {
        alert("‚ùå Geen parochie geselecteerd.");
        return;
      }
      const titel=document.getElementById("lesTitel").value.trim();
      const doelgroep=document.getElementById("lesDoelgroep").value;
      const inhoud=document.getElementById("lesInhoud").value.trim();
      const zichtbaar=document.getElementById("lesZichtbaar").checked;
      if(!titel){alert("Vul titel in.");return;}

      const platen=[];
      for(let blok of platenContainer.querySelectorAll(".plaat-blok")){
        const file=blok.querySelector(".plaatFile").files[0];
        const tekst=blok.querySelector(".plaatTekst").value.trim();
        if(file){
          const pad="catecheselessen/"+Date.now()+"_"+file.name;
          const snap=await storage.ref(pad).put(file,{contentType:file.type});
          const url=await snap.ref.getDownloadURL();
          platen.push({url,tekst});
        }
      }

      const vragen=[];
      quizContainer.querySelectorAll(".quiz-vraag").forEach(div=>{
        const vraag=div.querySelector(".vraag").value.trim();
        const antwoorden=[...div.querySelectorAll(".antw")].map(i=>i.value.trim());
        const correct=parseInt(div.querySelector(".correct").value)-1;
        if(vraag&&antwoorden.filter(a=>a).length===4){
          vragen.push({vraag,antwoorden,correct});
        }
      });

      try{
        await lessenRef.add({
          titel, doelgroep, inhoud, zichtbaar, platen, vragen,
          aangemaaktOp:new Date()
        });
        form.reset();platenContainer.innerHTML="";quizContainer.innerHTML="";
        laadLessen();
      }catch(err){console.error(err);alert("‚ùå Fout: "+err.message);}
    });

    async function laadLessen(){
      if (!lessenRef) {
        overzicht.innerHTML = "‚ùå Geen parochie gevonden.";
        return;
      }
      overzicht.innerHTML="Laden‚Ä¶";
      try{
        const snap=await lessenRef.orderBy("aangemaaktOp","desc").get();
        overzicht.innerHTML="";
        if(snap.empty){overzicht.innerHTML="<p>Geen lessen toegevoegd.</p>";return;}
        snap.forEach(doc=>{
          const d=doc.data();
          const when=d.aangemaaktOp?.toDate?d.aangemaaktOp.toDate().toLocaleString():"";
          const kaart=document.createElement("div");
          kaart.className="les-kaart";
          let platenHTML="";
          if(d.platen){d.platen.forEach(p=>{
            platenHTML+=`<div><img src="${p.url}" style="max-width:100%;border-radius:8px;margin:10px 0"><p>${p.tekst}</p></div>`;
          });}
          kaart.innerHTML=`
            <h3>${d.titel}</h3>
            <small>${when} ‚Äî Doelgroep: ${d.doelgroep||"?"}</small>
            <p>${d.inhoud||"(geen inhoud ingegeven)"}</p>
            ${platenHTML}
            ${d.vragen?.length?`<p><em>Quizvragen: ${d.vragen.length}</em></p>`:""}
            <div class="acties">
              <button onclick="toggleZichtbaar('${doc.id}',${d.zichtbaar})">${d.zichtbaar?"üîí Verbergen":"üëÅ Zichtbaar maken"}</button>
              <button onclick="verwijderLes('${doc.id}')">üóë Verwijderen</button>
            </div>
          `;
          overzicht.appendChild(kaart);
        });
      }catch(e){console.error(e);overzicht.innerHTML="‚ùå Fout bij laden lessen.";}
    }

    async function toggleZichtbaar(id,huidig){
      await lessenRef.doc(id).update({zichtbaar:!huidig});
      laadLessen();
    }
    async function verwijderLes(id){
      if(!confirm("Weet je zeker dat je deze les wil verwijderen?")) return;
      await lessenRef.doc(id).delete();
      laadLessen();
    }

    laadLessen();
  </script>

  <!-- Gemeenschappelijke layout -->
  <script src="https://www.orthodoxeweg.be/volwassenmodus/common/layout.js" defer></script>
</body>
</html>
