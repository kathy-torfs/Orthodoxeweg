<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Catecheselessen ‚Äì Orthodoxeweg</title>
  <link rel="icon" href="images/kruis.png">
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#f5e9b8; color:#6f4e1a; }
    .container { max-width:1000px; margin:30px auto; padding:0 20px; }
    h1 { text-align:center; color:#4e2710; margin-bottom:20px; }

    /* Tabs */
    .tabs { display:flex; justify-content:center; gap:20px; margin-bottom:20px; }
    .tabs button {
      padding:10px 20px; border:none; border-radius:8px; cursor:pointer;
      background:#dab97a; color:#4e2710; font-weight:bold;
    }
    .tabs button.active { background:#7bb235; color:white; }

    /* Index */
    .index { margin-bottom:30px; }
    .index h2 { margin-bottom:10px; }
    .index ul { list-style:none; padding:0; }
    .index li { margin:5px 0; }
    .index a { cursor:pointer; color:#7a5f35; font-weight:bold; text-decoration:underline; }

    /* Formulier */
    form { background:#fff8eb; border:2px solid #dab97a; border-radius:12px;
      padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.12); margin-bottom:30px }
    form h2 { margin-top:0; color:#7a5f35 }
    label { display:block; margin:10px 0 4px }
    input[type=text], select, textarea {
      width:100%; padding:8px; border:1px solid #dab97a; border-radius:6px;
      background:#fffdf6; font-family:inherit
    }
    textarea { min-height:100px; resize:vertical }
    button {
      background:#7bb235; color:#fff; border:none; padding:8px 16px;
      border-radius:8px; cursor:pointer; font-weight:bold; margin-top:12px
    }
    button:hover { background:#5e8e29 }
    .blok { background:#fff; border:1px solid #dab97a; border-radius:8px;
      padding:10px; margin-top:10px }
    .blok h4 { margin:0 0 6px; color:#7a5f35 }
    .blok img { max-height:10cm; border-radius:6px; margin-top:8px; }
  </style>
</head>
<body>
  <!-- Gemeenschappelijke header -->
  <div id="volwassen-header" data-header-src="common/header.html"></div>
  <script src="common/layout.js" defer></script>

  <div class="container">
    <h1 id="paginaTitel">üìñ Catecheselessen</h1>

    <!-- Tabs -->
    <div class="tabs">
      <button id="tabKleuters" class="active" onclick="setDoelgroep('kleuters')">üë∂ Kleuters</button>
      <button id="tabLagere" onclick="setDoelgroep('lagere')">üìö Lagere school</button>
    </div>

    <!-- Index -->
    <div class="index">
      <h2>üìë Lessenoverzicht</h2>
      <ul id="lessenIndex"><li>Laden‚Ä¶</li></ul>
    </div>

    <!-- Formulier -->
    <form id="lesForm">
      <h2 id="formTitel">Nieuwe les toevoegen</h2>
      <label for="lesTitel">Titel</label>
      <input type="text" id="lesTitel" required>

      <label for="lesInhoud">Lesinhoud</label>
      <textarea id="lesInhoud"></textarea>

      <h3>Vertelplaten</h3>
      <div id="platenContainer"></div>
      <button type="button" onclick="voegPlaatToe()">‚ûï Plaat toevoegen</button>

      <h3>Quizvragen</h3>
      <div id="quizContainer"></div>
      <button type="button" onclick="voegVraagToe()">‚ûï Vraag toevoegen</button>

      <div>
        <label><input type="checkbox" id="lesZichtbaar" checked> Zichtbaar voor klasje</label>
      </div>

      <button type="submit">üìå Opslaan</button>
    </form>
  </div>

  <!-- Firebase SDK's -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

  <script>
    // Firebase init
    if (!firebase.apps.length) {
      firebase.initializeApp({
        apiKey:"AIzaSyBKEakRzmnPZ3DY8NUkZrZr_YtqBbNVHL4",
        authDomain:"orthodoxeweg.firebaseapp.com",
        projectId:"orthodoxeweg",
        storageBucket:"orthodoxeweg.appspot.com"
      });
    }
    const db = firebase.firestore();
    const storage = firebase.storage();

    const parochieId = localStorage.getItem("ingelogdeParochie");
    const parochieNaam = localStorage.getItem("ingelogdeParochieNaam");

    const titel = document.getElementById("paginaTitel");
    const indexUL = document.getElementById("lessenIndex");
    const form = document.getElementById("lesForm");
    const platenContainer = document.getElementById("platenContainer");
    const quizContainer = document.getElementById("quizContainer");

    let huidigDoelgroep = "kleuters";
    let editId = null;

    if (parochieId) {
      titel.textContent = "üìñ Catecheselessen van " + parochieNaam;
      laadIndex();
    } else {
      titel.textContent = "üìñ Catecheselessen (geen parochie gevonden)";
      indexUL.innerHTML = "<li style='color:#a33'>‚ùå Geen parochie gevonden. Log eerst in.</li>";
    }

    function setDoelgroep(dg) {
      huidigDoelgroep = dg;
      document.getElementById("tabKleuters").classList.toggle("active", dg==="kleuters");
      document.getElementById("tabLagere").classList.toggle("active", dg==="lagere");
      laadIndex();
    }

    function slugify(t) {
      return t.toLowerCase().trim().replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"");
    }

    // ‚ûï Plaat toevoegen
    function voegPlaatToe(p={}) {
      const idx = platenContainer.children.length+1;
      const div = document.createElement("div");
      div.className="blok";
      div.innerHTML=`
        <h4>Plaat ${idx}</h4>
        <label>Afbeelding:</label>
        <input type="file" class="plaatFile" accept="image/*"><br>
        <label>Tekst:</label>
        <textarea class="plaatTekst">${p.tekst||""}</textarea>
        ${p.url?`<img src="${p.url}">`:""}
      `;
      platenContainer.appendChild(div);
    }

    // ‚ûï Vraag toevoegen
    function voegVraagToe(q={}) {
      const idx = quizContainer.children.length+1;
      const div = document.createElement("div");
      div.className="blok";
      div.innerHTML=`
        <h4>Vraag ${idx}</h4>
        <label>Vraag:</label>
        <input type="text" class="vraag" value="${q.vraag||""}">
        <label>Antwoorden (4):</label>
        ${[0,1,2,3].map(i=>`<input type="text" class="antw" value="${q.antwoorden?q.antwoorden[i]:""}"><br>`).join("")}
        <label>Correct (1-4):</label>
        <input type="number" min="1" max="4" class="correct" value="${(q.correct||0)+1}">
      `;
      quizContainer.appendChild(div);
    }

    // Opslaan
    form.addEventListener("submit", async(e)=>{
      e.preventDefault();
      if(!parochieId) return;

      const data = {
        titel: document.getElementById("lesTitel").value.trim(),
        inhoud: document.getElementById("lesInhoud").value.trim(),
        doelgroep: huidigDoelgroep,
        zichtbaar: document.getElementById("lesZichtbaar").checked,
        platen: [], vragen: [], aangemaaktOp:new Date()
      };

      const docId = slugify(data.titel)+"_"+huidigDoelgroep;

      // Platen (fix: behoud bestaande url)
      for (let blok of platenContainer.querySelectorAll(".blok")) {
        const file = blok.querySelector(".plaatFile").files[0];
        const tekst = blok.querySelector(".plaatTekst").value.trim();
        const bestaandeImg = blok.querySelector("img");

        if (file) {
          const pad = "catecheselessen/"+Date.now()+"_"+file.name;
          const snap = await storage.ref(pad).put(file,{contentType:file.type});
          const url = await snap.ref.getDownloadURL();
          data.platen.push({url,tekst});
        } else if (bestaandeImg) {
          data.platen.push({url:bestaandeImg.src,tekst});
        }
      }

      // Quizvragen
      quizContainer.querySelectorAll(".blok").forEach(div=>{
        const vraag=div.querySelector(".vraag").value.trim();
        const antwoorden=[...div.querySelectorAll(".antw")].map(i=>i.value.trim());
        const correct=parseInt(div.querySelector(".correct").value)-1;
        if(vraag && antwoorden.filter(a=>a).length===4){
          data.vragen.push({vraag,antwoorden,correct});
        }
      });

      await db.collection("parochies").doc(parochieId)
        .collection("catecheselessen").doc(docId).set(data);

      editId=null;
      form.reset(); platenContainer.innerHTML=""; quizContainer.innerHTML="";
      laadIndex();
    });

    // Index laden
    async function laadIndex(){
      indexUL.innerHTML="Laden‚Ä¶";
      const snap = await db.collection("parochies").doc(parochieId)
        .collection("catecheselessen")
        .where("doelgroep","==",huidigDoelgroep)
        .orderBy("aangemaaktOp","desc").get();
      indexUL.innerHTML="";
      if(snap.empty){ indexUL.innerHTML="<li>Geen lessen gevonden.</li>"; return; }
      snap.forEach(doc=>{
        const d=doc.data();
        const li=document.createElement("li");
        li.innerHTML=`<a onclick="bewerkLes('${doc.id}')">${d.titel}</a> ${d.zichtbaar?"‚úÖ":"üö´"}`;
        indexUL.appendChild(li);
      });
    }

    // Bewerken
    async function bewerkLes(id){
      const docRef=await db.collection("parochies").doc(parochieId)
        .collection("catecheselessen").doc(id).get();
      if(!docRef.exists) return;
      const d=docRef.data();

      document.getElementById("formTitel").textContent="Les bewerken";
      document.getElementById("lesTitel").value=d.titel;
      document.getElementById("lesInhoud").value=d.inhoud;
      document.getElementById("lesZichtbaar").checked=d.zichtbaar;
      platenContainer.innerHTML=""; quizContainer.innerHTML="";
      if(d.platen) d.platen.forEach(p=>voegPlaatToe(p));
      if(d.vragen) d.vragen.forEach(q=>voegVraagToe(q));
      editId=id;
      window.scrollTo({top:0,behavior:"smooth"});
    }
  </script>
</body>
</html>
