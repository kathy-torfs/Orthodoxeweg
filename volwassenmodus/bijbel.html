<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orthodoxeweg â€“ Bijbel (LXX â†’ Vlaams)</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png" />
  <style>
    :root{
      --bg:#f5e9b8; --text:#6f4e1a; --card:#fffdf4; --border:#ceb27d;
      --chip:#eee3c6; --chip-border:#b29467; --chip-active:#d3b87c;
      --accent:#8722aa;
    }
    *{box-sizing:border-box}
    body{ background:var(--bg); color:var(--text); font-family:Arial, sans-serif; margin:0; }

    .container{ display:grid; grid-template-columns: 280px 1fr; gap:16px;
                max-width:1200px; margin:16px auto 28px; padding:0 16px; }
    @media (max-width:900px){ .container{ grid-template-columns:1fr; } }

    /* Sidebar (boekenlijst) */
    .panel{
      background:var(--card); border:2px solid var(--border); border-radius:12px;
      box-shadow:0 6px 22px rgba(168,139,84,.18); padding:12px;
    }
    .panel h2{ margin:4px 0 10px; font-size:18px; }
    .booklist{ max-height:70vh; overflow:auto; padding-right:6px; }
    .book{ display:flex; justify-content:space-between; align-items:center;
           gap:8px; padding:8px 10px; margin:4px 0; border:1.5px solid var(--chip-border);
           background:var(--chip); border-radius:8px; cursor:pointer; }
    .book:hover{ background:var(--chip-active); }
    .book .name{ font-weight:700; }
    .chapters{ display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .chap{ padding:6px 8px; border:1.5px solid var(--chip-border); border-radius:6px;
           background:#fffef8; cursor:pointer; font-weight:700; }
    .chap.active{ background:var(--chip-active); border-color:#8c6a2b; }

    /* Content */
    .content{ display:flex; flex-direction:column; gap:12px; }
    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:space-between;
      background:var(--card); border:2px solid var(--border); border-radius:12px; padding:10px 12px;
    }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .btn{
      background:var(--chip); border:1.5px solid var(--chip-border); border-radius:8px;
      padding:9px 12px; font-weight:700; cursor:pointer;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .title{ font-weight:800; font-size:18px; }
    .status{ font-size:14px; opacity:.8; }

    .reader{
      position:relative; min-height:60vh; background:#fffef8;
      border:2px solid var(--border); border-radius:12px; overflow:hidden;
      box-shadow:0 6px 22px rgba(168,139,84,.25);
    }
    .text{
      padding:18px 18px 90px; line-height:1.55; font-size:18px; white-space:pre-wrap;
    }
    .muted{ opacity:.65; font-style:italic; }

    /* Loader overlay */
    .loader{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg, rgba(245,233,184,.6), rgba(245,233,184,.2));
      backdrop-filter: blur(2px);
      opacity:0; pointer-events:none; transition:opacity .2s ease;
    }
    .loader.show{ opacity:1; pointer-events:auto; }
    .spinner{
      width:42px; height:42px; border-radius:50%;
      border:4px solid rgba(111,78,26,.25); border-top-color:var(--accent);
      animation:spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    .footnote{
      text-align:center; font-size:.92em; opacity:.85; margin-top:-6px;
    }
    .footnote a{ color:inherit; }
  </style>
</head>
<body>
  <!-- Jouw gedeelde topbar/menubalk/uitloggen -->
  <script src="https://kathy-torfs.github.io/Orthodoxeweg/volwassenmodus/common/layout.js"></script>

  <div class="container">
    <!-- Sidebar: boeken + hoofdstukken -->
    <aside class="panel">
      <h2>ðŸ“š LXXâ€‘Boeken</h2>
      <div id="bookList" class="booklist">
        <div class="muted">Bezig met laden van boekenâ€¦</div>
      </div>
    </aside>

    <!-- Content -->
    <main class="content">
      <div class="toolbar">
        <div class="row">
          <button id="prevBtn" class="btn" disabled>âŸµ Vorige hoofdstuk</button>
          <button id="nextBtn" class="btn" disabled>Volgende hoofdstuk âŸ¶</button>
        </div>
        <div class="row">
          <div id="title" class="title">Bijbel (LXX â†’ Vlaams)</div>
          <div id="status" class="status"></div>
        </div>
      </div>

      <section class="reader">
        <div id="loader" class="loader"><div class="spinner" aria-label="Bezig met ladenâ€¦"></div></div>
        <article id="text" class="text">
          <p class="muted">Kies links een boek en hoofdstuk. De Griekse tekst wordt opgehaald en live vertaald naar Vlaams (NL).</p>
        </article>
      </section>

      <div class="footnote">
        Bron (Grieks): Sacredâ€‘Texts LXX. Automatische vertaling via LibreTranslate (openâ€‘source).  
        Als vertalen faalt, kun je <a id="gtLink" href="#" target="_blank" rel="noopener">dit hoofdstuk in Google Translate</a> openen.
      </div>
    </main>
  </div>

  <script>
    // ====== Config ======
    const LXX_INDEX = "https://sacred-texts.com/bib/sep/index.htm"; // boekenlijst
    const LIBRE_ENDPOINTS = [
      "https://libretranslate.de/translate",
      "https://translate.argosopentech.com/translate"
      // Je kan hier later eigen/self-hosted endpoints toevoegen
    ];
    const TARGET_LANG = "nl"; // Vlaams/Nederlands
    const SOURCE_LANG = "el"; // Grieks

    // ====== UI refs ======
    const bookListEl = document.getElementById("bookList");
    const titleEl = document.getElementById("title");
    const statusEl = document.getElementById("status");
    const textEl = document.getElementById("text");
    const loaderEl = document.getElementById("loader");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const gtLink = document.getElementById("gtLink");

    // ====== State ======
    let books = [];          // [{name, href}]
    let chapters = [];       // [{label, href}] voor huidig boek
    let currentBook = null;  // {name, href}
    let currentChapIdx = -1; // index in chapters[]

    // ====== Helpers ======
    const showLoader = (on) => loaderEl.classList.toggle("show", !!on);
    const setStatus = (msg) => statusEl.textContent = msg || "";

    // Sanitize/simple HTML â†’ plain text (bewaar verzen-regels)
    function htmlToPlainGreek(html){
      // pak alleen hoofdinhoud (de verzen staan als tekst in body)
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      // vaak staat de hoofdstuktitel in h1/h3; verzen zijn losse tekstregels met nummers
      const main = tmp.querySelector("body") || tmp;
      // verwijder navigatie-links
      main.querySelectorAll("a, nav").forEach(a=>{ a.replaceWith(document.createTextNode("")); });
      // pak tekst
      let txt = main.innerText || main.textContent || "";
      // trim en normaliseer multiple blank lines
      txt = txt.replace(/\u00A0/g, " ").replace(/\r/g, "").replace(/\n{3,}/g, "\n\n").trim();
      // verwijder kop "Septuagint: Genesis Chapter 1" e.d. (optioneel)
      txt = txt.replace(/^Septuagint:.*?\n+/i, "");
      return txt;
    }

    // Google Translate fallback link
    function buildGoogleTranslateLink(url){
      const enc = encodeURIComponent(url);
      return `https://translate.google.com/translate?hl=${TARGET_LANG}&sl=${SOURCE_LANG}&tl=${TARGET_LANG}&u=${enc}`;
    }

    // Try multiple LibreTranslate endpoints
    async function libreTranslate(text){
      const payload = { q: text, source: SOURCE_LANG, target: TARGET_LANG, format: "text" };
      for (const ep of LIBRE_ENDPOINTS){
        try{
          const ctrl = new AbortController();
          const timer = setTimeout(()=>ctrl.abort(), 15000); // 15s timeout
          const res = await fetch(ep, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
            signal: ctrl.signal
          });
          clearTimeout(timer);
          if (!res.ok) continue;
          const data = await res.json();
          if (data && data.translatedText) return data.translatedText;
        }catch(e){ /* probeer volgende endpoint */ }
      }
      throw new Error("Geen vertaalendpoint bereikbaar.");
    }

    // Fetch HTML helper
    async function fetchText(url){
      const ctrl = new AbortController();
      const timer = setTimeout(()=>ctrl.abort(), 15000);
      const res = await fetch(url, { signal: ctrl.signal, headers: { "Accept": "text/html;charset=UTF-8" }});
      clearTimeout(timer);
      if (!res.ok) throw new Error("HTTP "+res.status);
      return await res.text();
    }

    // Parse lijst van boeken uit LXX_INDEX
    async function loadBooks(){
      showLoader(true);
      setStatus("Boeken ladenâ€¦");
      try{
        const html = await fetchText(LXX_INDEX);
        const div = document.createElement("div");
        div.innerHTML = html;
        // Links naar boeken staan in de lijst (we nemen alle anchors in de content)
        const anchors = Array.from(div.querySelectorAll("a")).filter(a => /sep\/.+\.htm$/i.test(a.getAttribute("href") || ""));
        const unique = new Map();
        anchors.forEach(a=>{
          const href = new URL(a.getAttribute("href"), LXX_INDEX).href;
          const name = (a.textContent || "").trim();
          if (name && !unique.has(href)) unique.set(href, name);
        });
        books = Array.from(unique, ([href, name]) => ({ name, href }));
        renderBookList();
        setStatus("");
      }catch(e){
        bookListEl.innerHTML = '<div class="muted">Kon de boekenlijst niet laden. Controleer je internetverbinding.</div>';
        setStatus("Boeken laden mislukt");
      }finally{
        showLoader(false);
      }
    }

    function renderBookList(){
      if (!books.length){
        bookListEl.innerHTML = '<div class="muted">Geen boeken gevonden.</div>';
        return;
      }
      const frag = document.createDocumentFragment();
      books.forEach(b=>{
        const item = document.createElement("div");
        item.className = "book";
        item.innerHTML = `<span class="name">${b.name}</span><span>â–¾</span>`;
        item.addEventListener("click", ()=> selectBook(b, item));
        frag.appendChild(item);
      });
      bookListEl.innerHTML = "";
      bookListEl.appendChild(frag);
    }

    // Boek selecteren â†’ hoofdstukken halen vanaf boek-index (bv. gen.htm)
    async function selectBook(b, bookEl){
      currentBook = b;
      chapters = [];
      currentChapIdx = -1;
      // UI reset
      document.querySelectorAll(".chap").forEach(c => c.classList.remove("active"));
      prevBtn.disabled = true; nextBtn.disabled = true;
      titleEl.textContent = `${b.name}`;
      textEl.innerHTML = '<p class="muted">Hoofdstukken ladenâ€¦</p>';
      setStatus("Hoofdstukken ladenâ€¦");
      showLoader(true);
      try{
        const html = await fetchText(b.href);
        const div = document.createElement("div");
        div.innerHTML = html;
        // hoofdstuklinks lijken op gen001.htm, gen002.htm, â€¦ in dezelfde map
        const base = new URL(b.href);
        const aList = Array.from(div.querySelectorAll("a")).filter(a => /\.htm$/i.test(a.getAttribute("href")||""));
        const chapLinks = [];
        aList.forEach(a=>{
          const href = a.getAttribute("href");
          const text = (a.textContent || "").trim();
          // heuristiek: "Genesis Chapter N" of losse nummers
          if (/Chapter\s*\d+/i.test(text) || /^\d+$/.test(text)){
            chapLinks.push({ label: text, href: new URL(href, base).href });
          }
        });
        // dedupe + sort by href
        const seen = new Set();
        chapters = chapLinks.filter(c=>{
          if (seen.has(c.href)) return false; seen.add(c.href); return true;
        }).sort((a,b)=> a.href.localeCompare(b.href));
        renderChapters(bookEl);
        setStatus("");
      }catch(e){
        textEl.innerHTML = '<p class="muted">Kon de hoofdstukken niet laden.</p>';
        setStatus("Hoofdstukken laden mislukt");
      }finally{
        showLoader(false);
      }
    }

    function renderChapters(bookEl){
      // container voor hoofdstukken onder het aangeklikte boek
      let box = bookEl.nextElementSibling;
      if (!box || !box.classList || !box.classList.contains("chapters")){
        box = document.createElement("div");
        box.className = "chapters";
        bookEl.insertAdjacentElement("afterend", box);
      }
      box.innerHTML = "";
      if (!chapters.length){
        box.innerHTML = '<span class="muted">Geen hoofdstukken gevonden.</span>';
        return;
      }
      chapters.forEach((c, idx)=>{
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "chap";
        chip.textContent = c.label.replace(/.*?(\d+)\s*$/, "Hfst. $1");
        chip.addEventListener("click", ()=>{
          document.querySelectorAll(".chap").forEach(x=>x.classList.remove("active"));
          chip.classList.add("active");
          loadChapter(idx);
        });
        box.appendChild(chip);
      });
      // auto-open eerste hoofdstuk
      loadChapter(0);
      box.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }

    async function loadChapter(idx){
      if (!chapters.length) return;
      currentChapIdx = idx;
      prevBtn.disabled = (idx<=0);
      nextBtn.disabled = (idx>=chapters.length-1);

      const chap = chapters[idx];
      const chapUrl = chap.href;
      titleEl.textContent = `${currentBook?.name || ""} â€“ ${chap.label}`;
      setStatus("Hoofdstuk ophalenâ€¦");
      showLoader(true);
      textEl.innerHTML = "";

      // Zet ook de Google Translate fallback link voor dit hoofdstuk
      gtLink.href = buildGoogleTranslateLink(chapUrl);

      try{
        const html = await fetchText(chapUrl);
        const greek = htmlToPlainGreek(html);
        setStatus("Vertalen naar Vlaamsâ€¦");
        let dutch = "";
        try{
          dutch = await libreTranslate(greek);
        }catch(e){
          // Vertalen mislukt â†’ toon Grieks met uitleg en fallbacklink
          dutch = "";
        }

        if (dutch){
          textEl.textContent = dutch;
          setStatus("Klaar");
        }else{
          // Toon Grieks + melding
          textEl.innerHTML = `<p class="muted">Automatische vertaling is momenteel niet beschikbaar. Hieronder zie je de Griekse tekst. Je kunt ook via de link onderaan in Google Translate openen.</p>\n\n` + greek;
          setStatus("Vertalen mislukt â€” Griekse tekst getoond");
        }
        // Onthoud laatste keuze
        try{
          localStorage.setItem("lxx_last_book", currentBook?.href || "");
          localStorage.setItem("lxx_last_idx", String(idx));
        }catch{}
      }catch(e){
        textEl.innerHTML = '<p class="muted">Kon dit hoofdstuk niet laden.</p>';
        setStatus("Hoofdstuk laden mislukt");
      }finally{
        showLoader(false);
      }
    }

    // Vorige/Volgende
    prevBtn.addEventListener("click", ()=>{ if (currentChapIdx>0) loadChapter(currentChapIdx-1); });
    nextBtn.addEventListener("click", ()=>{ if (currentChapIdx<chapters.length-1) loadChapter(currentChapIdx+1); });

    // Init: boeken laden, en trachten laatste selectie te herstellen
    (async function init(){
      await loadBooks();
      try{
        const lastBook = localStorage.getItem("lxx_last_book");
        const lastIdx = parseInt(localStorage.getItem("lxx_last_idx")||"", 10);
        if (lastBook && books.length){
          const b = books.find(x=>x.href===lastBook);
          const item = Array.from(bookListEl.querySelectorAll(".book")).find(el => el.querySelector(".name")?.textContent === b?.name);
          if (b && item){
            await selectBook(b, item);
            if (!isNaN(lastIdx) && lastIdx>=0 && lastIdx<chapters.length){
              // activeer corresponderende chip
              const chip = item.nextElementSibling?.querySelectorAll(".chap")[lastIdx];
              if (chip){ chip.click(); }
            }
          }
        }
      }catch{}
    })();
  </script>
</body>
</html>
