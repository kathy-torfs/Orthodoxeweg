<script>
  const dbRef = firebase.firestore().collection("bijbel_LXX");
  const bookListEl = document.getElementById("bookList");
  const readerEl = document.getElementById("reader");
  const titleEl = document.getElementById("title");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  let books = [];
  let currentBook = null;
  let currentChap = null;

  // ðŸ“œ VASTE CANONIEKE VOLGORDE VAN LXX-BOEKEN
  const LXX_ORDER = [
    "genesis","exodus","leviticus","numbers","deuteronomy",
    "joshua","judges","ruth",
    "i_kingdoms","ii_kingdoms","iii_kingdoms","iv_kingdoms",
    "i_chronicles","ii_chronicles","i_esdras","ii_esdras","nehemiah",
    "tobit","judith","esther",
    "i_maccabees","ii_maccabees","iii_maccabees",
    "psalms","job","proverbs","ecclesiastes","song_of_solomon",
    "wisdom_of_solomon","wisdom_of_sirach",
    "isaiah","jeremiah","lamentations","baruch","ezekiel","daniel",
    "hosea","joel","amos","obadiah","jonah","micah","nahum",
    "habakkuk","zephaniah","haggai","zechariah","malachi"
  ];

  function normalizeBookName(name) {
    return name.toLowerCase().replace(/\s+/g,"_").replace(/[^\w_]/g,"");
  }

  async function loadBookList() {
    try {
      const snap = await dbRef.get();
      const allDocs = snap.docs.map(d => d.id);
      const map = {};

      allDocs.forEach(id => {
        const [book, chapRaw] = id.split("_");
        const chap = parseInt(chapRaw.replace(/^h/, ""), 10) || 1;
        const key = normalizeBookName(book);
        if (!map[key]) map[key] = [];
        map[key].push(chap);
      });

      books = Object.entries(map).map(([book, chapters]) => ({
        name: book,
        chapters: chapters.sort((a,b)=>a-b)
      }));

      // ðŸ“˜ Sorteer volgens vaste LXX-volgorde
      books.sort((a,b)=>{
        const ai = LXX_ORDER.indexOf(a.name);
        const bi = LXX_ORDER.indexOf(b.name);
        if (ai === -1 && bi === -1) return a.name.localeCompare(b.name);
        if (ai === -1) return 1;
        if (bi === -1) return -1;
        return ai - bi;
      });

      renderBookList();
    } catch (err) {
      bookListEl.innerHTML =
        `<div class="muted">Kon boeken niet laden.<br>${err.message}</div>`;
    }
  }

  function renderBookList() {
    bookListEl.innerHTML = "";
    books.forEach(b => {
      const div = document.createElement("div");
      div.className = "book";
      const label = b.name.replace(/_/g," ").replace(/\b\w/g,c=>c.toUpperCase());
      div.textContent = label;
      div.addEventListener("click", () => showChapters(b, div));
      bookListEl.appendChild(div);
    });
  }

  function showChapters(book, bookEl) {
    currentBook = book;
    const box = document.createElement("div");
    box.className = "chapters";
    book.chapters.forEach(c => {
      const chip = document.createElement("button");
      chip.className = "chap";
      chip.textContent = c;
      chip.addEventListener("click", () => {
        box.querySelectorAll(".chap").forEach(ch => ch.classList.remove("active"));
        chip.classList.add("active");
        loadChapter(book.name, c);
      });
      box.appendChild(chip);
    });
    const next = bookEl.nextElementSibling;
    if (next && next.classList.contains("chapters")) next.remove();
    bookEl.insertAdjacentElement("afterend", box);
  }

  async function loadChapter(book, chap) {
    titleEl.textContent = `${book} â€“ hoofdstuk ${chap}`;
    readerEl.innerHTML = `<div class="muted">Ladenâ€¦</div>`;
    prevBtn.disabled = nextBtn.disabled = true;

    try {
      const id = `${book}_h${chap}`;
      const doc = await dbRef.doc(id).get();
      if (!doc.exists) {
        readerEl.innerHTML = `<div class="muted">Geen tekst gevonden voor ${book} ${chap}.</div>`;
        return;
      }
      const data = doc.data();
      const verzen = data.verzen || {};
      const frag = document.createDocumentFragment();
      for (const [n, txt] of Object.entries(verzen)) {
        const p = document.createElement("div");
        p.className = "verse";
        p.innerHTML = `<span class="num">${n}.</span>${txt}`;
        frag.appendChild(p);
      }
      readerEl.innerHTML = "";
      readerEl.appendChild(frag);

      currentChap = chap;
      const list = currentBook.chapters;
      const idx = list.indexOf(chap);
      prevBtn.disabled = idx <= 0;
      nextBtn.disabled = idx >= list.length - 1;

      localStorage.setItem("lxx_last_book", book);
      localStorage.setItem("lxx_last_chap", chap);
    } catch (err) {
      readerEl.innerHTML = `<div class="muted">Fout bij laden: ${err.message}</div>`;
    }
  }

  prevBtn.addEventListener("click", () => {
    if (!currentBook) return;
    const idx = currentBook.chapters.indexOf(currentChap);
    if (idx > 0) loadChapter(currentBook.name, currentBook.chapters[idx - 1]);
  });
  nextBtn.addEventListener("click", () => {
    if (!currentBook) return;
    const idx = currentBook.chapters.indexOf(currentChap);
    if (idx < currentBook.chapters.length - 1) loadChapter(currentBook.name, currentBook.chapters[idx + 1]);
  });

  // ðŸš€ Start
  loadBookList().then(() => {
    const lastBook = localStorage.getItem("lxx_last_book");
    const lastChap = parseInt(localStorage.getItem("lxx_last_chap") || "1", 10);
    if (lastBook) {
      const found = books.find(b => b.name === normalizeBookName(lastBook));
      if (found) loadChapter(found.name, lastChap);
    }
  });
</script>
