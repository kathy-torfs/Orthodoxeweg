<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Orthodoxe Tuin – Orthodoxeweg</title>
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png">
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#e6f5e1; color:#333; }
    #map { height:100vh; width:100%; }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Gemeenschappelijke header -->
  <div id="volwassen-header"></div>
  <script src="https://kathy-torfs.github.io/Orthodoxeweg/volwassenmodus/common/layout.js"></script>

  <div id="map"></div>

  <script>
    // ==== Firebase config ====
    const firebaseConfig = {
      apiKey: "AIzaSyBG1iQBmruHUZI1OeW8RgbJ_TPit_7a2LQ",
      authDomain: "orthodoxeweg.firebaseapp.com",
      projectId: "orthodoxeweg",
      storageBucket: "orthodoxeweg.appspot.com",
      messagingSenderId: "408582263618",
      appId: "1:408582263618:web:0a20f4bf0704989d3ceedb"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let map;
    let infoWindow; // popup venster

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 50.85, lng: 4.35 },
        zoom: 8,
        mapTypeId: "roadmap",
        zoomControl: true,
        zoomControlOptions: { position: google.maps.ControlPosition.RIGHT_BOTTOM },
        styles: [
          // Geen wegen, POI’s, transit
          { featureType: "road", stylers: [{ visibility: "off" }] },
          { featureType: "poi", stylers: [{ visibility: "off" }] },
          { featureType: "transit", stylers: [{ visibility: "off" }] },

          // Land & water
          { featureType: "landscape", elementType: "geometry", stylers: [{ color: "#f0fff0" }] },
          { featureType: "water", elementType: "geometry", stylers: [{ color: "#9fd3f6" }] },

          // Provinciegrenzen weg
          { featureType: "administrative", elementType: "geometry", stylers: [{ visibility: "off" }] },

          // Grote steden zichtbaar vanaf zoom 10
          { featureType: "administrative.locality", elementType: "labels.text.fill",
            stylers: [{ visibility: "simplified" }, { color: "#222222" }] },
          { featureType: "administrative.locality", elementType: "labels.text.stroke",
            stylers: [{ visibility: "off" }] },

          // Middelgrote steden zichtbaar vanaf zoom 11
          { featureType: "administrative.neighborhood", elementType: "labels.text.fill",
            stylers: [{ visibility: "simplified" }, { color: "#555555" }] },
          { featureType: "administrative.neighborhood", elementType: "labels.text.stroke",
            stylers: [{ visibility: "off" }] },

          // Dorpen/gemeenten zichtbaar vanaf zoom 13
          { featureType: "administrative.land_parcel", elementType: "labels.text.fill",
            stylers: [{ visibility: "simplified" }, { color: "#777777" }] },
          { featureType: "administrative.land_parcel", elementType: "labels.text.stroke",
            stylers: [{ visibility: "off" }] }
        ]
      });

      infoWindow = new google.maps.InfoWindow();

      // Laad provincies van België
      map.data.loadGeoJson("provincesprovincies-belgium.geojson", {}, function(features) {
        features.forEach(f => {
          map.data.overrideStyle(f, {
            fillColor: "#6cc96c",
            fillOpacity: 1,
            strokeColor: "#004d00",
            strokeWeight: 2
          });
        });

        const bounds = new google.maps.LatLngBounds();
        features.forEach(f => f.getGeometry().forEachLatLng(latlng => bounds.extend(latlng)));
        map.fitBounds(bounds);

        // Masker: lichte rand rond België
        const outerBounds = [
          { lat: 60, lng: -10 },
          { lat: 60, lng: 15 },
          { lat: 45, lng: 15 },
          { lat: 45, lng: -10 }
        ];
        const belgieCoords = [];
        features.forEach(f => {
          const path = [];
          f.getGeometry().forEachLatLng(latlng => path.push({lat: latlng.lat(), lng: latlng.lng()}));
          belgieCoords.push(path);
        });
        new google.maps.Polygon({
          map,
          paths: [outerBounds, ...belgieCoords],
          strokeColor: "#99cc99",
          strokeWeight: 1,
          fillColor: "#eaf6ea",
          fillOpacity: 1,
          clickable: false
        });

        // Na kaart: parochies en leden laden
        laadParochies();
      });
    }

    // === Parochies ophalen ===
    async function laadParochies() {
      const snap = await db.collection("parochies").get();
      snap.forEach(async paroDoc => {
        const parochie = paroDoc.data();
        if (parochie.adres) {
          const adres = encodeURIComponent(parochie.adres + ", België");
          fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${adres}&key=AIzaSyB41mcK4sxdDX2LcAnnflE4lvNmwiZjKLg`)
            .then(res => res.json())
            .then(data => {
              if (data.results && data.results[0]) {
                const locatie = data.results[0].geometry.location;
                const marker = new google.maps.Marker({
                  position: locatie,
                  map,
                  icon: {
                    url: "https://maps.google.com/mapfiles/kml/shapes/church_maps.png",
                    scaledSize: new google.maps.Size(28, 28)
                  },
                  title: parochie.naam
                });

                // Klik op kerk = popup (alleen naam + adres)
                marker.addListener("click", () => {
                  infoWindow.setContent(
                    `<b>${parochie.naam}</b><br>📍 ${parochie.adres}`
                  );
                  infoWindow.open(map, marker);
                });
              }
            });

          // Leden van deze parochie laden
          laadLeden(paroDoc.id);
        }
      });
    }

    // === Leden ophalen ===
    async function laadLeden(parochieId) {
      const ledenSnap = await db.collection("parochies").doc(parochieId).collection("leden").get();
      ledenSnap.forEach(lidDoc => {
        const lid = lidDoc.data();
        if (lid.gemeente && lid.postcode && lid.bloemen) {
          const adres = encodeURIComponent(lid.postcode + " " + lid.gemeente + ", België");
          fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${adres}&key=AIzaSyB41mcK4sxdDX2LcAnnflE4lvNmwiZjKLg`)
            .then(res => res.json())
            .then(data => {
              if (data.results && data.results[0]) {
                const locatie = data.results[0].geometry.location;
                const marker = new google.maps.Marker({
                  position: locatie,
                  map,
                  label: {
                    text: lid.bloemen,
                    fontSize: "16px"
                  },
                  title: lid.voornaam || "Onbekend"
                });

                // Klik op bloem = popup (alleen voornaam + bloem)
                marker.addListener("click", () => {
                  infoWindow.setContent(
                    `<b>${lid.voornaam || "Onbekend"}</b><br>🌸 ${lid.bloemen}`
                  );
                  infoWindow.open(map, marker);
                });
              }
            });
        }
      });
    }
  </script>

  <!-- Google Maps API -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB41mcK4sxdDX2LcAnnflE4lvNmwiZjKLg&callback=initMap"></script>
</body>
</html>
