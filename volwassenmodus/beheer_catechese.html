<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Beheer Catechese ‚Äì Orthodoxeweg</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="https://kathy-torfs.github.io/Orthodoxeweg/images/kruis.png">
  <style>
    body {margin:0;font-family:Arial,sans-serif;background:#f5e9b8;color:#6f4e1a}
    .container{max-width:1100px;margin:20px auto;padding:0 20px}
    h1{text-align:center;color:#4e2710}
    .tabs{display:flex;justify-content:center;gap:12px;margin:20px 0}
    .tabs button{padding:8px 14px;border:none;border-radius:6px;cursor:pointer;font-weight:bold}
    .tabs button.actief{background:#7bb235;color:#fff}
    .parochie-selector{background:#fff;padding:10px;border:1px solid #dab97a;border-radius:8px;max-height:200px;overflow-y:auto;margin-bottom:10px}
    .les-lijst{margin:20px 0;display:flex;flex-direction:column;gap:8px}
    .les-kaart{background:#fff;border:2px solid #dab97a;border-radius:10px;padding:10px}
    .les-kaart h3{margin:0;color:#7a5f35;cursor:pointer}
    .les-kaart small{color:#8f7437}
    form{background:#fff8eb;border:2px solid #dab97a;border-radius:12px;padding:16px;margin-top:20px}
    label{display:block;margin:8px 0 4px}
    input[type=text],textarea{width:100%;padding:8px;border:1px solid #dab97a;border-radius:6px;background:#fffdf6}
    textarea{min-height:80px;resize:vertical}
    button{background:#7bb235;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:bold;margin:4px}
    button:hover{background:#5e8e29}
    .delete{background:#e24343}
    .delete:hover{background:#b72828}
  </style>
</head>
<body>
  <!-- Header -->
  <div id="volwassen-header" data-header-src="common/header.html"></div>
  <script src="common/layout.js" defer></script>

  <div class="container">
    <h1>üìñ Beheer Catechese</h1>

    <!-- Tabs -->
    <div class="tabs">
      <button id="tabKleuters" class="actief" onclick="wisselDoelgroep('kleuters')">üë∂ Kleuters</button>
      <button id="tabLagere" onclick="wisselDoelgroep('lagere')">üìö Lagere school</button>
      <button id="tabVolwassen" onclick="wisselDoelgroep('volwassenen')">‚úâ Volwassenen</button>
    </div>

    <!-- Overzicht -->
    <div id="lessenOverzicht" class="les-lijst">Laden‚Ä¶</div>

    <!-- Formulier -->
    <form id="lesForm">
      <h2 id="formTitel">Nieuwe les toevoegen</h2>

      <label>Titel</label>
      <input type="text" id="lesTitel" required>

      <label>Inhoud</label>
      <textarea id="lesInhoud"></textarea>

      <label><input type="checkbox" id="lesZichtbaar"> Zichtbaar</label>

      <h3>Kies parochies</h3>
      <div><button type="button" onclick="selecteerAlle()">Selecteer alle</button></div>
      <div id="parochieSelector" class="parochie-selector">‚è≥ Laden...</div>

      <div style="margin-top:10px;">
        <button type="submit">üìå Opslaan</button>
        <button type="button" class="delete" onclick="verwijderLes()">üóë Verwijderen</button>
        <button type="button" onclick="annuleerBewerking()">‚ùå Annuleren</button>
      </div>
    </form>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey:"AIzaSyBKEakRzmnPZ3DY8NUkZrZr_YtqBbNVHL4",
      authDomain:"orthodoxeweg.firebaseapp.com",
      projectId:"orthodoxeweg"
    };
    if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();

    let huidigDoelgroep="kleuters";
    let editId=null;
    let geselecteerdeParochies=[];
    let alleParochies=[];

    const overzicht=document.getElementById("lessenOverzicht");
    const form=document.getElementById("lesForm");
    const titelInput=document.getElementById("lesTitel");
    const inhoudInput=document.getElementById("lesInhoud");
    const zichtbaarChk=document.getElementById("lesZichtbaar");
    const parochieSelector=document.getElementById("parochieSelector");
    const formTitel=document.getElementById("formTitel");

    // Tabs wisselen
    function wisselDoelgroep(d){
      huidigDoelgroep=d;
      ["Kleuters","Lagere","Volwassen"].forEach(n=>{
        document.getElementById("tab"+n).classList.toggle("actief", n.toLowerCase().includes(d));
      });
      laadLessen();
    }

    // Parochies laden
    async function laadParochies(){
      const snap=await db.collection("parochies").get();
      alleParochies=[];
      parochieSelector.innerHTML="";
      snap.forEach(doc=>{
        alleParochies.push({id:doc.id,...doc.data()});
        const d=doc.data();
        const lbl=document.createElement("label");
        lbl.innerHTML=`<input type="checkbox" value="${doc.id}"> ${d.naam||doc.id}`;
        parochieSelector.appendChild(lbl);
      });
    }

    function selecteerAlle(){
      parochieSelector.querySelectorAll("input[type=checkbox]").forEach(cb=>cb.checked=true);
    }

    // Lessen laden
    async function laadLessen(){
      overzicht.innerHTML="‚è≥ Laden...";
      overzicht.innerHTML="";
      for(const par of alleParochies){
        const coll=(huidigDoelgroep==="volwassenen"?"priesterbrieven":"catecheselessen");
        const q=huidigDoelgroep==="volwassenen"
          ? db.collection("parochies").doc(par.id).collection(coll)
          : db.collection("parochies").doc(par.id).collection(coll).where("doelgroep","==",huidigDoelgroep);

        const snap=await q.get();
        snap.forEach(doc=>{
          const d=doc.data();
          const kaart=document.createElement("div");
          kaart.className="les-kaart";
          kaart.innerHTML=`
            <h3 onclick="bewerkLes('${doc.id}','${par.id}')">${d.titel}</h3>
            <small>${par.naam} ‚Ä¢ ${d.zichtbaar?"‚úÖ":"üö´"} ${(d.inhoud||"").replace(/<br>/g," ").substring(0,50)}</small>
          `;
          overzicht.appendChild(kaart);
        });
      }
    }

    // Bewerken
    async function bewerkLes(id,parochieId){
      const coll=(huidigDoelgroep==="volwassenen"?"priesterbrieven":"catecheselessen");
      const docRef=await db.collection("parochies").doc(parochieId).collection(coll).doc(id).get();
      if(!docRef.exists) return;
      const d=docRef.data();
      editId=id;
      formTitel.textContent="Les bewerken";
      titelInput.value=d.titel;
      inhoudInput.value=(d.inhoud||"").replace(/<br>/g,"\n");
      zichtbaarChk.checked=d.zichtbaar;

      // Parochies terug aanvinken (nog niet perfect, we nemen alle)
      parochieSelector.querySelectorAll("input[type=checkbox]").forEach(cb=>{
        cb.checked=true;
      });
    }

    // Opslaan
    form.addEventListener("submit",async e=>{
      e.preventDefault();
      const titel=titelInput.value.trim();
      if(!titel) return alert("Titel verplicht!");
      const inhoud=inhoudInput.value.trim().replace(/\n/g,"<br>");
      const zichtbaar=zichtbaarChk.checked;
      geselecteerdeParochies=[...parochieSelector.querySelectorAll("input[type=checkbox]:checked")].map(cb=>cb.value);
      if(geselecteerdeParochies.length===0) return alert("Selecteer minstens √©√©n parochie");

      const docId=editId||titel.toLowerCase().replace(/\s+/g,"-");
      const data={titel,inhoud,zichtbaar,aangemaaktOp:new Date()};
      if(huidigDoelgroep!=="volwassenen") data.doelgroep=huidigDoelgroep;

      for(const pid of geselecteerdeParochies){
        const coll=(huidigDoelgroep==="volwassenen"?"priesterbrieven":"catecheselessen");
        await db.collection("parochies").doc(pid).collection(coll).doc(docId).set(data);
      }

      alert("Les opgeslagen in "+geselecteerdeParochies.length+" parochie(s).");
      form.reset();editId=null;formTitel.textContent="Nieuwe les toevoegen";
      laadLessen();
    });

    // Verwijderen
    async function verwijderLes(){
      if(!editId) return alert("Geen les geselecteerd.");
      if(!confirm("Les verwijderen uit ALLE geselecteerde parochies?")) return;
      const docId=editId;
      for(const pid of geselecteerdeParochies){
        const coll=(huidigDoelgroep==="volwassenen"?"priesterbrieven":"catecheselessen");
        await db.collection("parochies").doc(pid).collection(coll).doc(docId).delete();
      }
      alert("Les verwijderd.");
      form.reset();editId=null;formTitel.textContent="Nieuwe les toevoegen";
      laadLessen();
    }

    // Annuleren
    function annuleerBewerking(){
      form.reset();editId=null;formTitel.textContent="Nieuwe les toevoegen";
    }

    // Init
    laadParochies().then(laadLessen);
  </script>
</body>
</html>
