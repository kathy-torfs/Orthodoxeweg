// Globale variabelen voor zonsopgangtijd (in minuten na middernacht)
let zonsopgangMinuten = null;

// Na ophalen van weer:
async function updateWeather(lat, lon) {
  try {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=sunrise&timezone=Europe%2FBerlin`;
    const response = await fetch(url);
    const data = await response.json();

    // Temperatuur
    if (data.current_weather && data.current_weather.temperature !== undefined) {
      document.getElementById('temperatuur').textContent = `${Math.round(data.current_weather.temperature)}°C`;
    } else {
      document.getElementById('temperatuur').textContent = '...';
    }

    // Zonsopgang
    if (data.daily && data.daily.sunrise && data.daily.sunrise.length > 0) {
      const sunriseISO = data.daily.sunrise[0];
      const sunriseDate = new Date(sunriseISO);
      const hh = sunriseDate.getHours().toString().padStart(2, '0');
      const mm = sunriseDate.getMinutes().toString().padStart(2, '0');
      document.getElementById('zonsopgang').textContent = `zonsopgang ${hh}:${mm}`;

      // Sla minuten-na-middernacht op
      zonsopgangMinuten = sunriseDate.getHours() * 60 + sunriseDate.getMinutes();
    } else {
      document.getElementById('zonsopgang').textContent = 'zonsopgang ...';
      zonsopgangMinuten = null;
    }
  } catch (e) {
    document.getElementById('temperatuur').textContent = '...';
    document.getElementById('zonsopgang').textContent = 'zonsopgang ...';
    zonsopgangMinuten = null;
  }
}

// Bepaal gebedsmoment op basis van zonsopgang en huidige tijd
function bepaalGebedsmomentMetZonsopgang() {
  if (zonsopgangMinuten === null) return "nacht"; // fallback

  const nu = new Date();
  const nuMinuten = nu.getHours() * 60 + nu.getMinutes();

  // Tijden in minuten na zonsopgang
  const momentTijden = [
    { naam: "eerste_uur", offset: 0 },
    { naam: "derde_uur", offset: 180 },
    { naam: "zesde_uur", offset: 360 },
    { naam: "negende_uur", offset: 540 },
    { naam: "vespers", offset: 720 },
    { naam: "complet", offset: 1020 } // 17u na zonsopgang (meestal na zonsondergang)
  ];

  // Loop van laatste naar eerste om juiste blok te vinden
  for (let i = momentTijden.length - 1; i >= 0; i--) {
    if (nuMinuten >= zonsopgangMinuten + momentTijden[i].offset) {
      return momentTijden[i].naam;
    }
  }
  // Vóór zonsopgang
  return "nacht";
}

// Pas je updateHorologionEnVastenregel aan:
async function updateHorologionEnVastenregel() {
  const nu = new Date();
  const datum = nu.toISOString().slice(0,10).replace(/-/g, "");
  // Nu GEBASEERD OP ZONSOPGANG:
  const moment = bepaalGebedsmomentMetZonsopgang();

  // Gebed (horologion)
  db.collection("gebeden_uren").doc(moment).get().then(doc => {
    if (doc.exists && doc.data().tekst_NL) {
      document.getElementById('horologion').textContent = doc.data().tekst_NL;
    } else {
      document.getElementById('horologion').textContent = "Geen horologion gevonden voor dit uur.";
    }
  }).catch(() => {
    document.getElementById('horologion').textContent = "Geen horologion gevonden.";
  });

  // Vastenregel (zoals gewoonlijk)
  db.collection("kalender2025").doc(String(datum)).get().then(doc => {
    if (doc.exists && doc.data()["Vastenregel NL"]) {
      document.getElementById('vastenregel').textContent = doc.data()["Vastenregel NL"];
    } else {
      document.getElementById('vastenregel').textContent = "Geen vastenregel gevonden voor deze dag.";
    }
  }).catch(() => {
    document.getElementById('vastenregel').textContent = "Geen vastenregel gevonden.";
  });
}
